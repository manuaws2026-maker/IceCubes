<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - IceCubes</title>
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-sidebar: #0f0f1a;
      --text-primary: #e8e8e8;
      --text-secondary: #a0a0a0;
      --accent: #4ade80;
      --accent-hover: #22c55e;
      --border: rgba(255, 255, 255, 0.1);
      --danger: #ef4444;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }
    
    .settings-container {
      display: flex;
      height: 100vh;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .settings-sidebar {
      width: 200px;
      background: var(--bg-sidebar);
      padding: 20px 12px;
      display: flex;
      flex-direction: column;
      -webkit-app-region: drag;
    }
    
    .settings-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      padding: 0 8px;
      padding-top: 24px;
    }
    
    .settings-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
      -webkit-app-region: no-drag;
      flex: 1;
    }
    
    .settings-theme-toggle {
      display: flex;
      gap: 4px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      margin-top: auto;
      -webkit-app-region: no-drag;
    }
    
    .theme-toggle-btn {
      flex: 1;
      padding: 8px 4px;
      border: 2px solid transparent;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
      font-size: 10px;
      transition: all 0.2s;
    }
    
    .theme-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }
    
    .theme-toggle-btn.active {
      background: rgba(74, 222, 128, 0.1);
      border: 2px solid var(--accent);
      color: var(--text-primary);
    }
    
    .theme-toggle-btn .theme-icon {
      font-size: 16px;
    }
    
    .settings-nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      text-align: left;
      transition: all 0.2s;
    }
    
    .settings-nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }
    
    .settings-nav-item.active {
      background: var(--accent);
      color: #000;
    }
    
    .nav-icon {
      font-size: 16px;
    }
    
    .settings-main {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      padding-top: 48px;
      -webkit-app-region: no-drag;
      position: relative;
    }
    
    /* Draggable title bar area at top of main content */
    .settings-titlebar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 48px;
      -webkit-app-region: drag;
      z-index: 1;
    }
    
    
    .settings-tab {
      display: none;
    }
    
    .settings-tab.active {
      display: block;
    }
    
    .settings-section {
      margin-bottom: 32px;
    }
    
    .settings-section h3 {
      font-size: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .settings-desc {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }
    
    
    /* Provider Toggle */
    .provider-toggle-group {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .provider-toggle-btn {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    
    .provider-toggle-btn:hover {
      border-color: rgba(74, 222, 128, 0.5);
    }
    
    .provider-toggle-btn.selected {
      border-color: var(--accent);
      background: rgba(74, 222, 128, 0.1);
    }
    
    .provider-icon {
      font-size: 20px;
    }
    
    .provider-name {
      font-size: 14px;
      font-weight: 500;
    }
    
    .provider-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    
    .provider-badge.cloud {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }
    
    .provider-badge.local {
      background: rgba(74, 222, 128, 0.2);
      color: #4ade80;
    }
    
    /* Active Status */
    .active-provider-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(74, 222, 128, 0.1);
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .active-label {
      color: var(--text-secondary);
    }
    
    .active-provider-name {
      color: var(--accent);
      font-weight: 500;
    }
    
    /* Provider Config */
    .provider-config {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 16px;
      margin-top: 12px;
    }
    
    .provider-config.hidden {
      display: none;
    }
    
    .provider-config-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .config-title {
      font-weight: 500;
      font-size: 14px;
    }
    
    .config-info {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    
    .config-success {
      color: var(--accent);
    }
    
    /* Status */
    .settings-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }
    
    .settings-status.connected .status-dot {
      background: var(--accent);
    }
    
    .settings-status.error .status-dot {
      background: var(--danger);
    }
    
    /* Input Group */
    .settings-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .settings-input-group input {
      flex: 1;
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
    }
    
    .settings-input-group input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* Buttons */
    .settings-btn {
      padding: 10px 16px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: #000;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .settings-btn:hover {
      background: var(--accent-hover);
    }
    
    .settings-btn-full {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: #000;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .settings-btn-full:hover {
      background: var(--accent-hover);
    }
    
    .settings-btn-danger {
      padding: 8px 12px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 6px;
      color: var(--danger);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .settings-btn-danger:hover {
      background: rgba(239, 68, 68, 0.2);
    }
    
    .settings-btn-danger.hidden {
      display: none;
    }
    
    .provider-config-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .settings-link {
      color: var(--accent);
      font-size: 12px;
      text-decoration: none;
    }
    
    .settings-link:hover {
      text-decoration: underline;
    }
    
    /* Progress Bar */
    .settings-progress-bar {
      height: 6px;
      background: var(--bg-primary);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .settings-progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      transition: width 0.3s;
    }
    
    .settings-progress-fill.llm-progress-indeterminate {
      width: 40%;
      animation: indeterminate 1.5s infinite linear;
    }
    
    @keyframes indeterminate {
      0% {
        transform: translateX(-100%);
      }
      50% {
        transform: translateX(150%);
      }
      100% {
        transform: translateX(-100%);
      }
    }
    
    .settings-progress-text {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Calendar section */
    .section-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .reset-btn {
      padding: 4px 10px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
    }
    
    .reset-btn:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .calendars-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .calendar-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }
    
    .calendar-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    
    .calendar-name {
      flex: 1;
      font-size: 13px;
    }
    
    .calendar-toggle {
      width: 36px;
      height: 20px;
      background: var(--bg-primary);
      border-radius: 10px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    
    .calendar-toggle.active {
      background: var(--accent);
    }
    
    .calendar-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .calendar-toggle.active::after {
      left: 18px;
    }
    
    /* Language selects */
    .settings-select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
    }
    
    .settings-select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .settings-checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
    }
    
    .settings-checkbox-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }
    
    .settings-checkbox-group label {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    /* Notification settings */
    .notification-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .notification-toggle:last-child {
      border-bottom: none;
    }
    
    .notification-info h4 {
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .notification-info p {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .toggle-switch {
      width: 44px;
      height: 24px;
      background: var(--bg-primary);
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    
    .toggle-switch.active {
      background: var(--accent);
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .toggle-switch.active::after {
      left: 22px;
    }
  </style>
</head>
<body>
  <div class="settings-container">
    <div class="settings-sidebar">
      <div class="settings-title">Settings</div>
      <div class="settings-nav">
        <button class="settings-nav-item active" data-tab="transcription">
          <span class="nav-icon">üéôÔ∏è</span> Transcription
        </button>
        <button class="settings-nav-item" data-tab="ai">
          <span class="nav-icon">ü§ñ</span> AI Notes
        </button>
        <button class="settings-nav-item" data-tab="calendar">
          <span class="nav-icon">üìÖ</span> Calendar
        </button>
        <button class="settings-nav-item" data-tab="notifications">
          <span class="nav-icon">üîî</span> Notifications
        </button>
        <button class="settings-nav-item" data-tab="search">
          <span class="nav-icon">üîç</span> Search
        </button>
        <button class="settings-nav-item" data-tab="templates">
          <span class="nav-icon">üìã</span> Templates
        </button>
      </div>
      <div class="settings-theme-toggle" id="sidebarThemeToggle">
        <button class="theme-toggle-btn" data-theme="light">
          <span class="theme-icon">‚òÄÔ∏è</span>
          <span>Light</span>
        </button>
        <button class="theme-toggle-btn active" data-theme="system">
          <span class="theme-icon">üíª</span>
          <span>System</span>
        </button>
        <button class="theme-toggle-btn" data-theme="dark">
          <span class="theme-icon">üåô</span>
          <span>Dark</span>
        </button>
      </div>
    </div>
    
    <div class="settings-main">
      <!-- Draggable title bar area -->
      <div class="settings-titlebar"></div>
      
      <!-- Transcription Tab -->
      <div class="settings-tab active" id="settingsTabTranscription">
        <div class="settings-section">
          <h3>üéôÔ∏è Transcription Provider</h3>
          <p class="settings-desc">Choose how your meetings are transcribed</p>
          
          <div class="provider-toggle-group">
            <button class="provider-toggle-btn selected" id="transcriptionProviderDeepgram" data-provider="deepgram">
              <span class="provider-icon">‚òÅÔ∏è</span>
              <span class="provider-name">Deepgram</span>
              <span class="provider-badge cloud">Cloud</span>
            </button>
            <button class="provider-toggle-btn" id="transcriptionProviderParakeet" data-provider="parakeet">
              <span class="provider-icon">üíª</span>
              <span class="provider-name">Parakeet</span>
              <span class="provider-badge local">Local</span>
            </button>
          </div>
          
          <div class="active-provider-status" id="transcriptionActiveStatus">
            <span class="active-label">Active:</span>
            <span class="active-provider-name" id="transcriptionActiveName">Checking...</span>
          </div>
          
          <!-- Deepgram Config -->
          <div class="provider-config" id="deepgramConfig">
            <div class="provider-config-header">
              <span class="config-title">Deepgram API Key</span>
              <div class="settings-status" id="deepgramStatus">
                <span class="status-dot"></span>
                <span id="deepgramStatusText">Not configured</span>
              </div>
            </div>
            <div class="settings-input-group">
              <input type="password" id="deepgramKeyInput" placeholder="Enter Deepgram API key">
              <button class="settings-btn" id="deepgramSaveBtn">Save</button>
            </div>
            <div class="provider-config-footer">
              <a href="#" class="settings-link" id="deepgramLink">Get a free API key ‚Üí</a>
              <button class="settings-btn-danger hidden" id="deepgramClearBtn">Clear Key</button>
            </div>
          </div>
          
          <!-- Parakeet Config -->
          <div class="provider-config hidden" id="parakeetConfig">
            <div class="provider-config-header">
              <span class="config-title">Parakeet Local Model</span>
              <div class="settings-status" id="parakeetStatus">
                <span class="status-dot"></span>
                <span id="parakeetStatusText">Not downloaded</span>
              </div>
            </div>
            <div id="parakeetNotDownloaded">
              <p class="config-info">~670 MB download ‚Ä¢ 25 European languages ‚Ä¢ 100% private</p>
              <button class="settings-btn-full" id="parakeetDownloadBtn">Download Model</button>
            </div>
            <div id="parakeetDownloading" class="hidden">
              <div class="settings-progress-bar"><div class="settings-progress-fill" id="parakeetProgressFill"></div></div>
              <p class="settings-progress-text" id="parakeetProgressText">Downloading...</p>
            </div>
            <div id="parakeetDownloaded" class="hidden">
              <p class="config-info config-success">‚úì Model ready for local transcription</p>
              <button class="settings-btn-danger" id="parakeetDeleteBtn">Delete Model</button>
            </div>
          </div>
        </div>
        
        <!-- Transcription Language -->
        <div class="settings-section">
          <h3>üåê Transcription Language</h3>
          <p class="settings-desc">Language spoken in your meetings</p>
          <select class="settings-select" id="transcriptionLangSelect">
            <option value="en">English</option>
          </select>
          <p style="font-size: 11px; color: var(--text-secondary); margin-top: 6px;" id="transcriptionLangNote">
            Languages available depend on selected provider.
          </p>
          
          <div class="settings-checkbox-group" style="margin-top: 12px;">
            <input type="checkbox" id="autoDetectLang">
            <label for="autoDetectLang">Auto-detect language (may be slower)</label>
          </div>
        </div>
      </div>
      
      <!-- AI Notes Tab -->
      <div class="settings-tab" id="settingsTabAi">
        <div class="settings-section">
          <h3>ü§ñ AI Provider</h3>
          <p class="settings-desc">Choose how your notes are enhanced</p>
          
          <div class="provider-toggle-group">
            <button class="provider-toggle-btn selected" id="aiProviderOpenAI" data-provider="openai">
              <span class="provider-icon">‚òÅÔ∏è</span>
              <span class="provider-name">OpenAI</span>
              <span class="provider-badge cloud">Cloud</span>
            </button>
            <button class="provider-toggle-btn" id="aiProviderLocal" data-provider="local">
              <span class="provider-icon">üíª</span>
              <span class="provider-name">Qwen2.5</span>
              <span class="provider-badge local">Local</span>
            </button>
          </div>
          
          <div class="active-provider-status" id="aiActiveStatus">
            <span class="active-label">Active:</span>
            <span class="active-provider-name" id="aiActiveName">Checking...</span>
          </div>
          
          <!-- OpenAI Config -->
          <div class="provider-config" id="openaiConfig">
            <div class="provider-config-header">
              <span class="config-title">OpenAI API Key</span>
              <div class="settings-status" id="openaiStatus">
                <span class="status-dot"></span>
                <span id="openaiStatusText">Not configured</span>
              </div>
            </div>
            <div class="settings-input-group">
              <input type="password" id="openaiKeyInput" placeholder="Enter OpenAI API key">
              <button class="settings-btn" id="openaiSaveBtn">Save</button>
            </div>
            <div class="provider-config-footer">
              <a href="#" class="settings-link" id="openaiLink">Get an API key ‚Üí</a>
              <button class="settings-btn-danger hidden" id="openaiClearBtn">Clear Key</button>
            </div>
          </div>
          
          <!-- Local LLM Config -->
          <div class="provider-config hidden" id="localLLMConfig">
            <div class="provider-config-header">
              <span class="config-title">Qwen2.5 3B Local Model</span>
              <div class="settings-status" id="localLLMStatus">
                <span class="status-dot"></span>
                <span id="localLLMStatusText">Not downloaded</span>
              </div>
            </div>
            <div id="localLLMNotDownloaded">
              <p class="config-info">~2 GB download ‚Ä¢ Metal accelerated ‚Ä¢ 100% private</p>
              <button class="settings-btn-full" id="localLLMDownloadBtn">Download Model</button>
            </div>
            <div id="localLLMDownloading" class="hidden">
              <div class="settings-progress-bar"><div class="settings-progress-fill llm-progress-indeterminate" id="localLLMProgressFill"></div></div>
              <p class="settings-progress-text" id="localLLMProgressText">Downloading...</p>
            </div>
            <div id="localLLMDownloaded" class="hidden">
              <p class="config-info config-success">‚úì Model ready for local AI notes</p>
              <button class="settings-btn-danger" id="localLLMDeleteBtn">Delete Model</button>
            </div>
          </div>
        </div>
        
        <!-- AI Notes Language -->
        <div class="settings-section">
          <h3>üåê Output Language</h3>
          <p class="settings-desc">Language for generated notes</p>
          <select class="settings-select" id="aiNotesLangSelect">
            <option value="same">Same as transcription</option>
          </select>
          <p style="font-size: 11px; color: var(--text-secondary); margin-top: 6px;" id="aiNotesLangNote">
            Languages available depend on selected provider.
          </p>
        </div>
      </div>
      
      <!-- Calendar Tab -->
      <div class="settings-tab" id="settingsTabCalendar">
        <div class="settings-section">
          <h3>üìÖ Google Calendar</h3>
          <p class="settings-desc">Connect your calendar to see upcoming meetings</p>
          <div class="settings-status" id="calendarStatus">
            <span class="status-dot"></span>
            <span id="calendarStatusText">Checking...</span>
          </div>
          <button class="settings-btn-full" id="calendarConnectBtn" style="margin-top: 12px;">Connect Google Calendar</button>
        </div>
        
        <div class="settings-section hidden" id="visibleCalendarsSection">
          <div class="section-header-row">
            <h3>Visible Calendars</h3>
            <button class="reset-btn" id="resetCalendarsBtn">Reset</button>
          </div>
          <div class="calendars-list" id="calendarsList"></div>
        </div>
      </div>
      
      <!-- Notifications Tab -->
      <div class="settings-tab" id="settingsTabNotifications">
        <div class="settings-section">
          <h3>üîî Notification Settings</h3>
          <p class="settings-desc">Configure when you receive notifications</p>
          
          <div class="notification-toggle">
            <div class="notification-info">
              <h4>Meeting Reminders</h4>
              <p>Get notified before meetings start</p>
            </div>
            <div class="toggle-switch active" id="toggleMeetingReminders"></div>
          </div>
          
          <div class="notification-toggle">
            <div class="notification-info">
              <h4>Recording Complete</h4>
              <p>Notification when transcription is ready</p>
            </div>
            <div class="toggle-switch active" id="toggleRecordingComplete"></div>
          </div>
          
        </div>
      </div>
      
      <!-- Search Tab -->
      <div class="settings-tab" id="settingsTabSearch">
        <div class="settings-section">
          <h3>üîç Search & Indexing</h3>
          <p class="settings-desc">Configure how your notes are indexed for search</p>
          
          <!-- Embedding Provider Selection -->
          <div class="provider-selector" style="margin-top: 16px;">
            <div class="provider-label" style="font-size: 14px; margin-bottom: 8px; color: var(--text-secondary);">Embedding Model</div>
            <div class="provider-buttons" style="display: flex; gap: 8px;">
              <button class="provider-btn" id="settingsEmbeddingLocal" data-provider="local" style="flex: 1; padding: 12px; border: 2px solid transparent; border-radius: 8px; background: var(--bg-tertiary); cursor: pointer; text-align: left;">
                <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">üíª Local (MiniLM)</div>
                <div style="font-size: 12px; color: var(--text-secondary);">Works offline, ~90MB download</div>
              </button>
              <button class="provider-btn" id="settingsEmbeddingOpenAI" data-provider="openai" style="flex: 1; padding: 12px; border: 2px solid transparent; border-radius: 8px; background: var(--bg-tertiary); cursor: pointer; text-align: left;">
                <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">‚òÅÔ∏è Cloud (OpenAI)</div>
                <div style="font-size: 12px; color: var(--text-secondary);">Best quality, requires API key</div>
              </button>
            </div>
          </div>
          
          <!-- Local Embedding Model Status -->
          <div id="localEmbeddingSection" style="margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Local Embedding Model</div>
                <div id="embeddingModelStatus" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Checking...</div>
              </div>
              <button id="embeddingDownloadBtn" class="small-btn" style="padding: 8px 16px; border-radius: 6px; background: var(--accent); color: #000; border: none; cursor: pointer; font-weight: 500;">Download</button>
            </div>
            
            <!-- Download Progress -->
            <div id="embeddingDownloadProgress" class="hidden" style="margin-top: 12px;">
              <div style="height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                <div id="embeddingProgressBar" style="height: 100%; background: var(--accent); width: 0%; transition: width 0.3s;"></div>
              </div>
              <div id="embeddingProgressText" style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Downloading...</div>
            </div>
          </div>
          
          <!-- Index Stats -->
          <div style="margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Search Index</div>
                <div id="indexStats" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Loading...</div>
              </div>
              <button id="reindexBtn" class="small-btn" style="padding: 8px 16px; border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); cursor: pointer; font-weight: 500;">Reindex All</button>
            </div>
            <div id="reindexProgress" class="hidden" style="margin-top: 12px; font-size: 12px; color: var(--text-secondary);">Reindexing...</div>
          </div>
          
        </div>
      </div>
      
      <!-- Templates Tab -->
      <div class="settings-tab" id="settingsTabTemplates">
        <!-- List View -->
        <div id="templatesListView">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <h3 style="margin: 0; font-size: 18px; color: var(--text-primary);">üìã Templates</h3>
              <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-secondary);">Manage AI note templates</p>
            </div>
            <button id="newTemplateBtn" style="padding: 8px 16px; border-radius: 8px; border: none; background: var(--accent); color: #000; font-size: 13px; font-weight: 500; cursor: pointer;">+ New</button>
          </div>
          
          <div style="margin-bottom: 24px;">
            <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">My Templates</div>
            <div id="myTemplatesList" style="display: flex; flex-direction: column; gap: 6px;">
              <!-- Custom templates -->
            </div>
          </div>
          
          <div>
            <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Built-in</div>
            <div id="builtInTemplatesList" style="display: flex; flex-direction: column; gap: 6px;">
              <!-- Built-in templates -->
            </div>
          </div>
        </div>
        
        <!-- Editor View (hidden by default) -->
        <div id="templatesEditorView" class="hidden">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <button id="templatesBackBtn" style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text-primary); font-size: 13px; cursor: pointer;">
              ‚Üê Back
            </button>
            <button id="deleteTemplateBtn" class="hidden" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ef4444; background: transparent; color: #ef4444; font-size: 13px; cursor: pointer;">Delete</button>
          </div>
          
          <!-- Template Header -->
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 28px;">
            <button id="templateIconBtn" style="width: 56px; height: 56px; border-radius: 12px; border: 2px solid var(--border); background: var(--accent); font-size: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: border-color 0.15s;">üìù</button>
            <div style="flex: 1;">
              <input type="text" id="templateNameInput" placeholder="Template name" style="width: 100%; padding: 0; border: none; background: transparent; color: var(--text-primary); font-size: 22px; font-weight: 600; outline: none;">
              <div id="templateOwnerLabel" style="font-size: 13px; color: var(--text-secondary); margin-top: 2px;">Me</div>
            </div>
          </div>
          
          <!-- Meeting Context -->
          <div style="margin-bottom: 28px;">
            <label style="display: block; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">Meeting Context</label>
            <textarea id="templateContextInput" placeholder="Give the AI an overview of the meeting and your goals for it" style="width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; font-family: inherit; resize: none; min-height: 70px; box-sizing: border-box; outline: none; transition: border-color 0.15s;"></textarea>
          </div>
          
          <!-- Sections -->
          <div style="margin-bottom: 28px;">
            <label style="display: block; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">Sections</label>
            <div id="templateSectionsContainer" style="display: flex; flex-direction: column; gap: 8px;">
              <!-- Sections rendered here -->
            </div>
            <button id="addSectionBtn" style="display: flex; align-items: center; gap: 8px; padding: 10px 14px; margin-top: 10px; background: transparent; border: 1px dashed var(--border); border-radius: 8px; color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: all 0.15s; width: 100%;">
              <span>+</span>
              <span>Add Section</span>
            </button>
          </div>
          
          <!-- Actions -->
          <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid var(--border);">
            <button id="cancelTemplateBtn" style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-primary); font-size: 14px; cursor: pointer;">Cancel</button>
            <button id="saveTemplateBtn" style="padding: 10px 20px; border-radius: 8px; border: none; background: var(--accent); color: #000; font-size: 14px; font-weight: 500; cursor: pointer;">Save Changes</button>
          </div>
        </div>
        
        <!-- Icon Picker -->
        <div id="iconPickerDropdown" class="hidden" style="position: fixed; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 9999; display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px;"></div>
      </div>
      
    </div>
  </div>

  <script>
    console.log('[Settings] Script starting...');
    const { ipcRenderer, shell } = require('electron');
    
    // Tab navigation
    document.querySelectorAll('.settings-nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const tab = item.dataset.tab;
        if (!tab) return;
        
        document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`settingsTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
      });
    });
    
    // Theme toggle in sidebar
    const sidebarThemeToggle = document.getElementById('sidebarThemeToggle');
    sidebarThemeToggle?.addEventListener('click', async (e) => {
      const btn = e.target.closest('.theme-toggle-btn');
      if (!btn) return;
      
      const theme = btn.dataset.theme;
      document.querySelectorAll('.theme-toggle-btn').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      
      await ipcRenderer.invoke('theme-set', theme);
    });
    
    // State
    let settingsState = {
      transcriptionEngine: 'deepgram',
      aiEngine: 'openai',
      deepgramKey: false,
      openaiKey: false,
      parakeetReady: false,
      localLLMReady: false,
      embeddingEngine: 'local',
      embeddingDownloaded: false,
      embeddingReady: false,
    };
    
    // Language definitions by provider
    const LANGUAGES = {
      // Deepgram supports 30+ languages
      deepgram: [
        { code: 'en', name: 'English' },
        { code: 'en-US', name: 'English (US)' },
        { code: 'en-GB', name: 'English (UK)' },
        { code: 'en-AU', name: 'English (Australia)' },
        { code: 'en-IN', name: 'English (India)' },
        { code: 'es', name: 'Spanish' },
        { code: 'es-419', name: 'Spanish (Latin America)' },
        { code: 'fr', name: 'French' },
        { code: 'fr-CA', name: 'French (Canada)' },
        { code: 'de', name: 'German' },
        { code: 'it', name: 'Italian' },
        { code: 'pt', name: 'Portuguese' },
        { code: 'pt-BR', name: 'Portuguese (Brazil)' },
        { code: 'nl', name: 'Dutch' },
        { code: 'hi', name: 'Hindi' },
        { code: 'ja', name: 'Japanese' },
        { code: 'zh', name: 'Chinese (Mandarin)' },
        { code: 'ko', name: 'Korean' },
        { code: 'pl', name: 'Polish' },
        { code: 'ru', name: 'Russian' },
        { code: 'uk', name: 'Ukrainian' },
        { code: 'tr', name: 'Turkish' },
        { code: 'sv', name: 'Swedish' },
        { code: 'da', name: 'Danish' },
        { code: 'no', name: 'Norwegian' },
        { code: 'fi', name: 'Finnish' },
        { code: 'id', name: 'Indonesian' },
        { code: 'ms', name: 'Malay' },
        { code: 'vi', name: 'Vietnamese' },
        { code: 'th', name: 'Thai' },
        { code: 'ta', name: 'Tamil' },
        { code: 'te', name: 'Telugu' },
        { code: 'tl', name: 'Filipino/Tagalog' },
      ],
      // Parakeet supports 25 European languages
      parakeet: [
        { code: 'en', name: 'English' },
        { code: 'de', name: 'German' },
        { code: 'es', name: 'Spanish' },
        { code: 'fr', name: 'French' },
        { code: 'it', name: 'Italian' },
        { code: 'pt', name: 'Portuguese' },
        { code: 'nl', name: 'Dutch' },
        { code: 'pl', name: 'Polish' },
        { code: 'ru', name: 'Russian' },
        { code: 'uk', name: 'Ukrainian' },
        { code: 'cs', name: 'Czech' },
        { code: 'ro', name: 'Romanian' },
        { code: 'hu', name: 'Hungarian' },
        { code: 'el', name: 'Greek' },
        { code: 'sv', name: 'Swedish' },
        { code: 'da', name: 'Danish' },
        { code: 'fi', name: 'Finnish' },
        { code: 'no', name: 'Norwegian' },
        { code: 'sk', name: 'Slovak' },
        { code: 'hr', name: 'Croatian' },
        { code: 'sl', name: 'Slovenian' },
        { code: 'lt', name: 'Lithuanian' },
        { code: 'lv', name: 'Latvian' },
        { code: 'et', name: 'Estonian' },
        { code: 'bg', name: 'Bulgarian' },
      ],
      // OpenAI GPT-4 supports 90+ languages
      openai: [
        { code: 'en', name: 'English' },
        { code: 'es', name: 'Spanish' },
        { code: 'fr', name: 'French' },
        { code: 'de', name: 'German' },
        { code: 'it', name: 'Italian' },
        { code: 'pt', name: 'Portuguese' },
        { code: 'nl', name: 'Dutch' },
        { code: 'pl', name: 'Polish' },
        { code: 'ru', name: 'Russian' },
        { code: 'uk', name: 'Ukrainian' },
        { code: 'ja', name: 'Japanese' },
        { code: 'ko', name: 'Korean' },
        { code: 'zh', name: 'Chinese (Simplified)' },
        { code: 'zh-TW', name: 'Chinese (Traditional)' },
        { code: 'ar', name: 'Arabic' },
        { code: 'hi', name: 'Hindi' },
        { code: 'bn', name: 'Bengali' },
        { code: 'ta', name: 'Tamil' },
        { code: 'te', name: 'Telugu' },
        { code: 'mr', name: 'Marathi' },
        { code: 'gu', name: 'Gujarati' },
        { code: 'kn', name: 'Kannada' },
        { code: 'ml', name: 'Malayalam' },
        { code: 'pa', name: 'Punjabi' },
        { code: 'ur', name: 'Urdu' },
        { code: 'vi', name: 'Vietnamese' },
        { code: 'th', name: 'Thai' },
        { code: 'id', name: 'Indonesian' },
        { code: 'ms', name: 'Malay' },
        { code: 'tl', name: 'Filipino/Tagalog' },
        { code: 'tr', name: 'Turkish' },
        { code: 'he', name: 'Hebrew' },
        { code: 'fa', name: 'Persian' },
        { code: 'sw', name: 'Swahili' },
        { code: 'cs', name: 'Czech' },
        { code: 'ro', name: 'Romanian' },
        { code: 'hu', name: 'Hungarian' },
        { code: 'el', name: 'Greek' },
        { code: 'sv', name: 'Swedish' },
        { code: 'da', name: 'Danish' },
        { code: 'fi', name: 'Finnish' },
        { code: 'no', name: 'Norwegian' },
        { code: 'sk', name: 'Slovak' },
        { code: 'hr', name: 'Croatian' },
        { code: 'sl', name: 'Slovenian' },
        { code: 'bg', name: 'Bulgarian' },
        { code: 'lt', name: 'Lithuanian' },
        { code: 'lv', name: 'Latvian' },
        { code: 'et', name: 'Estonian' },
        { code: 'ca', name: 'Catalan' },
        { code: 'gl', name: 'Galician' },
        { code: 'eu', name: 'Basque' },
        { code: 'af', name: 'Afrikaans' },
      ],
      // Qwen2.5 supports 29 languages
      qwen: [
        { code: 'en', name: 'English' },
        { code: 'zh', name: 'Chinese (Simplified)' },
        { code: 'zh-TW', name: 'Chinese (Traditional)' },
        { code: 'es', name: 'Spanish' },
        { code: 'fr', name: 'French' },
        { code: 'de', name: 'German' },
        { code: 'it', name: 'Italian' },
        { code: 'pt', name: 'Portuguese' },
        { code: 'nl', name: 'Dutch' },
        { code: 'pl', name: 'Polish' },
        { code: 'ru', name: 'Russian' },
        { code: 'ja', name: 'Japanese' },
        { code: 'ko', name: 'Korean' },
        { code: 'ar', name: 'Arabic' },
        { code: 'vi', name: 'Vietnamese' },
        { code: 'th', name: 'Thai' },
        { code: 'id', name: 'Indonesian' },
        { code: 'ms', name: 'Malay' },
        { code: 'tr', name: 'Turkish' },
        { code: 'cs', name: 'Czech' },
        { code: 'ro', name: 'Romanian' },
        { code: 'hu', name: 'Hungarian' },
        { code: 'el', name: 'Greek' },
        { code: 'sv', name: 'Swedish' },
        { code: 'da', name: 'Danish' },
        { code: 'fi', name: 'Finnish' },
        { code: 'no', name: 'Norwegian' },
        { code: 'he', name: 'Hebrew' },
        { code: 'uk', name: 'Ukrainian' },
      ],
    };
    
    // Update language dropdown based on provider
    function updateLanguageDropdowns() {
      const transcriptionSelect = document.getElementById('transcriptionLangSelect');
      const aiNotesSelect = document.getElementById('aiNotesLangSelect');
      const transcriptionNote = document.getElementById('transcriptionLangNote');
      const aiNotesNote = document.getElementById('aiNotesLangNote');
      
      // Get current selections to preserve them if possible
      const currentTransLang = transcriptionSelect?.value || 'en';
      const currentAILang = aiNotesSelect?.value || 'same';
      
      // Update transcription languages
      const transProvider = settingsState.transcriptionEngine;
      const transLangs = LANGUAGES[transProvider] || LANGUAGES.deepgram;
      
      if (transcriptionSelect) {
        transcriptionSelect.innerHTML = transLangs.map(l => 
          `<option value="${l.code}">${l.name}</option>`
        ).join('');
        
        // Restore selection if available, else default to English
        if (transLangs.some(l => l.code === currentTransLang)) {
          transcriptionSelect.value = currentTransLang;
        } else {
          transcriptionSelect.value = 'en';
        }
      }
      
      if (transcriptionNote) {
        if (transProvider === 'parakeet') {
          transcriptionNote.textContent = 'Parakeet supports 25 European languages with auto-detection.';
        } else {
          transcriptionNote.textContent = 'Deepgram supports 30+ languages including regional variants.';
        }
      }
      
      // Update AI notes languages
      const aiProvider = settingsState.aiEngine;
      const aiLangs = aiProvider === 'local' ? LANGUAGES.qwen : LANGUAGES.openai;
      
      if (aiNotesSelect) {
        aiNotesSelect.innerHTML = '<option value="same">Same as transcription</option>' +
          aiLangs.map(l => `<option value="${l.code}">${l.name}</option>`).join('');
        
        // Restore selection if available
        if (currentAILang === 'same' || aiLangs.some(l => l.code === currentAILang)) {
          aiNotesSelect.value = currentAILang;
        } else {
          aiNotesSelect.value = 'same';
        }
      }
      
      if (aiNotesNote) {
        if (aiProvider === 'local') {
          aiNotesNote.textContent = 'Qwen2.5 supports 29 languages with strong multilingual capabilities.';
        } else {
          aiNotesNote.textContent = 'OpenAI GPT-4 supports 90+ languages with excellent quality.';
        }
      }
    }
    
    // Load state
    async function loadState() {
      try {
        settingsState.transcriptionEngine = await ipcRenderer.invoke('transcription-get-engine') || 'deepgram';
        settingsState.aiEngine = await ipcRenderer.invoke('ai-get-engine') || 'openai';
        settingsState.deepgramKey = await ipcRenderer.invoke('has-deepgram-key');
        settingsState.openaiKey = await ipcRenderer.invoke('openai-has-key');
        settingsState.parakeetReady = await ipcRenderer.invoke('parakeet-check-downloaded');
        settingsState.localLLMReady = await ipcRenderer.invoke('llm-is-downloaded');
        settingsState.embeddingEngine = await ipcRenderer.invoke('embedding-get-engine') || 'local';
        settingsState.embeddingDownloaded = await ipcRenderer.invoke('embedding-check-downloaded');
        settingsState.embeddingReady = await ipcRenderer.invoke('embedding-is-ready');
        
        // Load language settings
        const langSettings = await ipcRenderer.invoke('lang-get-settings');
        console.log('[Settings] Loaded language settings:', langSettings);
        settingsState.transcriptionLang = langSettings?.transcriptionLang || 'en';
        settingsState.aiNotesLang = langSettings?.aiNotesLang || 'same';
        settingsState.autoDetect = langSettings?.autoDetect || false;
        
        updateUI();
        updateLanguageDropdowns();
        
        // Set language dropdown values after dropdowns are populated
        const transcriptionSelect = document.getElementById('transcriptionLangSelect');
        const aiNotesSelect = document.getElementById('aiNotesLangSelect');
        const autoDetectCheckbox = document.getElementById('autoDetectLang');
        
        if (transcriptionSelect) transcriptionSelect.value = settingsState.transcriptionLang;
        if (aiNotesSelect) aiNotesSelect.value = settingsState.aiNotesLang;
        if (autoDetectCheckbox) autoDetectCheckbox.checked = settingsState.autoDetect;
        
      } catch (e) {
        console.error('Error loading settings state:', e);
      }
    }
    
    function updateUI() {
      // Transcription toggle
      const deepgramBtn = document.getElementById('transcriptionProviderDeepgram');
      const parakeetBtn = document.getElementById('transcriptionProviderParakeet');
      const deepgramConfig = document.getElementById('deepgramConfig');
      const parakeetConfig = document.getElementById('parakeetConfig');
      
      if (settingsState.transcriptionEngine === 'deepgram') {
        deepgramBtn?.classList.add('selected');
        parakeetBtn?.classList.remove('selected');
        deepgramConfig?.classList.remove('hidden');
        parakeetConfig?.classList.add('hidden');
      } else {
        deepgramBtn?.classList.remove('selected');
        parakeetBtn?.classList.add('selected');
        deepgramConfig?.classList.add('hidden');
        parakeetConfig?.classList.remove('hidden');
      }
      
      // AI toggle
      const openaiBtn = document.getElementById('aiProviderOpenAI');
      const localBtn = document.getElementById('aiProviderLocal');
      const openaiConfig = document.getElementById('openaiConfig');
      const localLLMConfig = document.getElementById('localLLMConfig');
      
      if (settingsState.aiEngine === 'openai') {
        openaiBtn?.classList.add('selected');
        localBtn?.classList.remove('selected');
        openaiConfig?.classList.remove('hidden');
        localLLMConfig?.classList.add('hidden');
      } else {
        openaiBtn?.classList.remove('selected');
        localBtn?.classList.add('selected');
        openaiConfig?.classList.add('hidden');
        localLLMConfig?.classList.remove('hidden');
      }
      
      // Transcription status
      const transcriptionActiveName = document.getElementById('transcriptionActiveName');
      if (settingsState.transcriptionEngine === 'deepgram' && settingsState.deepgramKey) {
        transcriptionActiveName.textContent = 'Deepgram (Cloud)';
      } else if (settingsState.transcriptionEngine === 'parakeet' && settingsState.parakeetReady) {
        transcriptionActiveName.textContent = 'Parakeet (Local)';
      } else {
        transcriptionActiveName.textContent = 'Not configured';
      }
      
      // AI status
      const aiActiveName = document.getElementById('aiActiveName');
      if (settingsState.aiEngine === 'openai' && settingsState.openaiKey) {
        aiActiveName.textContent = 'OpenAI (Cloud)';
      } else if (settingsState.aiEngine === 'local' && settingsState.localLLMReady) {
        aiActiveName.textContent = 'Qwen2.5 (Local)';
      } else {
        aiActiveName.textContent = 'Not configured';
      }
      
      // Deepgram status
      const deepgramStatus = document.getElementById('deepgramStatus');
      const deepgramStatusText = document.getElementById('deepgramStatusText');
      const deepgramClearBtn = document.getElementById('deepgramClearBtn');
      if (settingsState.deepgramKey) {
        deepgramStatus?.classList.add('connected');
        deepgramStatusText.textContent = 'Connected';
        deepgramClearBtn?.classList.remove('hidden');
      } else {
        deepgramStatus?.classList.remove('connected');
        deepgramStatusText.textContent = 'Not configured';
        deepgramClearBtn?.classList.add('hidden');
      }
      
      // OpenAI status
      const openaiStatus = document.getElementById('openaiStatus');
      const openaiStatusText = document.getElementById('openaiStatusText');
      const openaiClearBtn = document.getElementById('openaiClearBtn');
      if (settingsState.openaiKey) {
        openaiStatus?.classList.add('connected');
        openaiStatusText.textContent = 'Connected';
        openaiClearBtn?.classList.remove('hidden');
      } else {
        openaiStatus?.classList.remove('connected');
        openaiStatusText.textContent = 'Not configured';
        openaiClearBtn?.classList.add('hidden');
      }
      
      // Parakeet status
      const parakeetStatus = document.getElementById('parakeetStatus');
      const parakeetStatusText = document.getElementById('parakeetStatusText');
      const parakeetNotDownloaded = document.getElementById('parakeetNotDownloaded');
      const parakeetDownloaded = document.getElementById('parakeetDownloaded');
      if (settingsState.parakeetReady) {
        parakeetStatus?.classList.add('connected');
        parakeetStatusText.textContent = 'Ready';
        parakeetNotDownloaded?.classList.add('hidden');
        parakeetDownloaded?.classList.remove('hidden');
      } else {
        parakeetStatus?.classList.remove('connected');
        parakeetStatusText.textContent = 'Not downloaded';
        parakeetNotDownloaded?.classList.remove('hidden');
        parakeetDownloaded?.classList.add('hidden');
      }
      
      // Local LLM status
      const localLLMStatus = document.getElementById('localLLMStatus');
      const localLLMStatusText = document.getElementById('localLLMStatusText');
      const localLLMNotDownloaded = document.getElementById('localLLMNotDownloaded');
      const localLLMDownloaded = document.getElementById('localLLMDownloaded');
      if (settingsState.localLLMReady) {
        localLLMStatus?.classList.add('connected');
        localLLMStatusText.textContent = 'Ready';
        localLLMNotDownloaded?.classList.add('hidden');
        localLLMDownloaded?.classList.remove('hidden');
      } else {
        localLLMStatus?.classList.remove('connected');
        localLLMStatusText.textContent = 'Not downloaded';
        localLLMNotDownloaded?.classList.remove('hidden');
        localLLMDownloaded?.classList.add('hidden');
      }
    }
    
    // Transcription provider toggle
    document.getElementById('transcriptionProviderDeepgram')?.addEventListener('click', async () => {
      settingsState.transcriptionEngine = 'deepgram';
      await ipcRenderer.invoke('transcription-set-engine', 'deepgram');
      updateUI();
      updateLanguageDropdowns();
    });
    
    document.getElementById('transcriptionProviderParakeet')?.addEventListener('click', async () => {
      settingsState.transcriptionEngine = 'parakeet';
      await ipcRenderer.invoke('transcription-set-engine', 'parakeet');
      updateUI();
      updateLanguageDropdowns();
    });
    
    // AI provider toggle
    document.getElementById('aiProviderOpenAI')?.addEventListener('click', async () => {
      settingsState.aiEngine = 'openai';
      await ipcRenderer.invoke('ai-set-engine', 'openai');
      updateUI();
      updateLanguageDropdowns();
    });
    
    document.getElementById('aiProviderLocal')?.addEventListener('click', async () => {
      settingsState.aiEngine = 'local';
      await ipcRenderer.invoke('ai-set-engine', 'local');
      updateUI();
      updateLanguageDropdowns();
    });
    
    // Language settings - save on change
    document.getElementById('transcriptionLangSelect')?.addEventListener('change', async (e) => {
      settingsState.transcriptionLang = e.target.value;
      console.log('[Settings] Saving transcription language:', settingsState.transcriptionLang);
      await ipcRenderer.invoke('lang-save-settings', {
        transcriptionLang: settingsState.transcriptionLang,
        aiNotesLang: settingsState.aiNotesLang,
        autoDetect: settingsState.autoDetect
      });
    });
    
    document.getElementById('aiNotesLangSelect')?.addEventListener('change', async (e) => {
      settingsState.aiNotesLang = e.target.value;
      console.log('[Settings] Saving AI notes language:', settingsState.aiNotesLang);
      await ipcRenderer.invoke('lang-save-settings', {
        transcriptionLang: settingsState.transcriptionLang,
        aiNotesLang: settingsState.aiNotesLang,
        autoDetect: settingsState.autoDetect
      });
    });
    
    document.getElementById('autoDetectLang')?.addEventListener('change', async (e) => {
      settingsState.autoDetect = e.target.checked;
      console.log('[Settings] Saving auto-detect:', settingsState.autoDetect);
      await ipcRenderer.invoke('lang-save-settings', {
        transcriptionLang: settingsState.transcriptionLang,
        aiNotesLang: settingsState.aiNotesLang,
        autoDetect: settingsState.autoDetect
      });
    });
    
    // Save Deepgram key
    document.getElementById('deepgramSaveBtn')?.addEventListener('click', async () => {
      const input = document.getElementById('deepgramKeyInput');
      const key = input.value.trim();
      if (key) {
        await ipcRenderer.invoke('save-deepgram-key', key);
        input.value = '';
        settingsState.deepgramKey = true;
        updateUI();
      }
    });
    
    // Save OpenAI key
    document.getElementById('openaiSaveBtn')?.addEventListener('click', async () => {
      const input = document.getElementById('openaiKeyInput');
      const key = input.value.trim();
      if (key) {
        await ipcRenderer.invoke('save-openai-key', key);
        input.value = '';
        settingsState.openaiKey = true;
        updateUI();
      }
    });
    
    // Clear keys
    document.getElementById('deepgramClearBtn')?.addEventListener('click', async () => {
      const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
        title: 'Clear Deepgram API Key',
        message: 'Are you sure you want to clear your Deepgram API key?\n\nYou will need to re-enter it to use cloud transcription.',
        okLabel: 'Clear Key',
        cancelLabel: 'Cancel'
      });
      
      if (confirmed) {
        await ipcRenderer.invoke('clear-deepgram-key');
        settingsState.deepgramKey = false;
        updateUI();
      }
    });
    
    document.getElementById('openaiClearBtn')?.addEventListener('click', async () => {
      // Check if local models are available
      const localEmbeddingReady = await ipcRenderer.invoke('embedding-check-downloaded');
      const localLLMReady = await ipcRenderer.invoke('llm-is-downloaded');
      
      // BOTH local models must be downloaded to allow clearing OpenAI key
      if (!localEmbeddingReady || !localLLMReady) {
        const missing = [];
        if (!localEmbeddingReady) missing.push('‚Ä¢ Local Embedding Model (Settings ‚Üí Search)');
        if (!localLLMReady) missing.push('‚Ä¢ Qwen2.5 AI Model (Settings ‚Üí AI Notes)');
        
        await ipcRenderer.invoke('show-alert-dialog', {
          title: 'Cannot Clear OpenAI Key',
          message: `Please download the following local models first:\n\n${missing.join('\n')}\n\nThese are required for the app to function without OpenAI.`,
          type: 'warning'
        });
        return;
      }
      
      // Build warning message based on what will change
      let warningParts = [];
      if (settingsState.embeddingEngine === 'openai') {
        warningParts.push('‚Ä¢ Search will switch to local embeddings');
      }
      if (settingsState.aiEngine === 'openai') {
        warningParts.push('‚Ä¢ AI notes will switch to local Qwen model');
      }
      
      const warningMessage = warningParts.length > 0 
        ? `Are you sure you want to clear your OpenAI API key?\n\n${warningParts.join('\n')}\n\nYou will need to re-enter it to use cloud features.`
        : 'Are you sure you want to clear your OpenAI API key?\n\nYou will need to re-enter it to use cloud AI features.';
      
      const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
        title: 'Clear OpenAI API Key',
        message: warningMessage,
        okLabel: 'Clear Key',
        cancelLabel: 'Cancel'
      });
      
      if (confirmed) {
        // Switch to local models
        if (settingsState.embeddingEngine === 'openai') {
          await ipcRenderer.invoke('embedding-set-engine', 'local');
          settingsState.embeddingEngine = 'local';
        }
        if (settingsState.aiEngine === 'openai') {
          await ipcRenderer.invoke('ai-set-engine', 'local');
          settingsState.aiEngine = 'local';
        }
        
        // Now clear the key - FIXED: was 'clear-openai-key', should be 'openai-clear-key'
        await ipcRenderer.invoke('openai-clear-key');
        settingsState.openaiKey = false;
        updateUI();
      }
    });
    
    // Download Parakeet
    document.getElementById('parakeetDownloadBtn')?.addEventListener('click', async () => {
      console.log('[Settings] Starting Parakeet download...');
      document.getElementById('parakeetNotDownloaded')?.classList.add('hidden');
      document.getElementById('parakeetDownloading')?.classList.remove('hidden');
      
      const progressFill = document.getElementById('parakeetProgressFill');
      const progressText = document.getElementById('parakeetProgressText');
      
      try {
        // Start download (returns immediately, runs in background)
        await ipcRenderer.invoke('parakeet-download-model');
        
        // Poll for completion
        const checkProgress = setInterval(async () => {
          const progress = await ipcRenderer.invoke('parakeet-get-download-progress');
          console.log('[Settings] Parakeet progress:', progress);
          
          // Update progress bar
          if (progressFill && progress.percent > 0) {
            progressFill.style.width = `${progress.percent}%`;
          }
          if (progressText) {
            if (progress.isDownloading) {
              const mb = (progress.bytesDownloaded / 1024 / 1024).toFixed(1);
              progressText.textContent = `Downloading... ${mb} MB (${progress.percent}%)`;
            }
          }
          
          // Check for completion
          const isDownloaded = await ipcRenderer.invoke('parakeet-check-downloaded');
          if (isDownloaded && !progress.isDownloading) {
            clearInterval(checkProgress);
            console.log('[Settings] Parakeet download complete!');
            settingsState.parakeetReady = true;
            document.getElementById('parakeetDownloading')?.classList.add('hidden');
            updateUI();
            
            await ipcRenderer.invoke('show-alert-dialog', {
              title: 'Download Complete',
              message: 'Parakeet model downloaded successfully!',
              type: 'info'
            });
          } else if (progress.error) {
            clearInterval(checkProgress);
            console.error('[Settings] Parakeet download error:', progress.error);
            document.getElementById('parakeetDownloading')?.classList.add('hidden');
            document.getElementById('parakeetNotDownloaded')?.classList.remove('hidden');
            
            await ipcRenderer.invoke('show-alert-dialog', {
              title: 'Download Failed',
              message: 'Failed to download Parakeet model: ' + progress.error,
              type: 'error'
            });
          }
        }, 1000);
      } catch (e) {
        console.error('[Settings] Parakeet download exception:', e);
        document.getElementById('parakeetDownloading')?.classList.add('hidden');
        document.getElementById('parakeetNotDownloaded')?.classList.remove('hidden');
        
        await ipcRenderer.invoke('show-alert-dialog', {
          title: 'Download Failed',
          message: 'Failed to download model: ' + e.message,
          type: 'error'
        });
      }
    });
    
    // Delete Parakeet
    document.getElementById('parakeetDeleteBtn')?.addEventListener('click', async () => {
      // Check if Deepgram key is configured first
      const hasDeepgramKey = await ipcRenderer.invoke('has-deepgram-key');
      if (!hasDeepgramKey) {
        await ipcRenderer.invoke('show-alert-dialog', {
          title: 'Cannot Delete',
          message: 'You need to configure a Deepgram API key first to ensure transcription functionality.',
          type: 'warning'
        });
        return;
      }
      
      const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
        title: 'Delete Parakeet Model',
        message: 'Delete the Parakeet model (~670 MB)?\n\nThis will free up disk space but you\'ll need to re-download it to use local transcription again.',
        okLabel: 'Delete',
        cancelLabel: 'Cancel'
      });
      
      if (confirmed) {
        await ipcRenderer.invoke('parakeet-delete-model');
        settingsState.parakeetReady = false;
        // Switch to Deepgram
        await ipcRenderer.invoke('transcription-set-engine', 'deepgram');
        settingsState.transcriptionEngine = 'deepgram';
        updateUI();
        
        await ipcRenderer.invoke('show-alert-dialog', {
          title: 'Model Deleted',
          message: 'Parakeet model deleted successfully.',
          type: 'info'
        });
      }
    });
    
    // Download Local LLM
    document.getElementById('localLLMDownloadBtn')?.addEventListener('click', async () => {
      console.log('[Settings] Starting LLM download/init...');
      document.getElementById('localLLMNotDownloaded')?.classList.add('hidden');
      document.getElementById('localLLMDownloading')?.classList.remove('hidden');
      
      const progressText = document.getElementById('localLLMProgressText');
      
      try {
        // llm-init downloads and loads the model (handled by mistralrs)
        await ipcRenderer.invoke('llm-init');
        
        // Poll for completion
        const checkProgress = setInterval(async () => {
          const progress = await ipcRenderer.invoke('llm-get-init-progress');
          console.log('[Settings] LLM init progress:', progress);
          
          if (progressText && progress.status) {
            progressText.textContent = progress.status;
          }
          
          if (progress.status === 'Model ready' || (!progress.isLoading && !progress.error)) {
            clearInterval(checkProgress);
            console.log('[Settings] LLM init complete!');
            settingsState.localLLMReady = await ipcRenderer.invoke('llm-is-downloaded');
            document.getElementById('localLLMDownloading')?.classList.add('hidden');
            updateUI();
            
            if (settingsState.localLLMReady) {
              await ipcRenderer.invoke('show-alert-dialog', {
                title: 'Model Ready',
                message: 'Qwen2.5 3B model is ready for local AI notes!',
                type: 'info'
              });
            }
          } else if (progress.error) {
            clearInterval(checkProgress);
            console.error('[Settings] LLM init error:', progress.error);
            document.getElementById('localLLMDownloading')?.classList.add('hidden');
            document.getElementById('localLLMNotDownloaded')?.classList.remove('hidden');
            
            await ipcRenderer.invoke('show-alert-dialog', {
              title: 'Download Failed',
              message: 'Failed to download/initialize model: ' + progress.error,
              type: 'error'
            });
          }
        }, 1000);
      } catch (e) {
        console.error('[Settings] LLM init exception:', e);
        document.getElementById('localLLMDownloading')?.classList.add('hidden');
        document.getElementById('localLLMNotDownloaded')?.classList.remove('hidden');
        
        await ipcRenderer.invoke('show-alert-dialog', {
          title: 'Download Failed',
          message: 'Failed to download model: ' + e.message,
          type: 'error'
        });
      }
    });
    
    // Delete Local LLM
    console.log('[Settings] Setting up LLM Delete button...');
    const llmDeleteBtn = document.getElementById('localLLMDeleteBtn');
    console.log('[Settings] LLM Delete button element:', llmDeleteBtn);
    console.log('[Settings] LLM Delete button found:', !!llmDeleteBtn);
    
    if (llmDeleteBtn) {
      console.log('[Settings] Adding click listener to LLM Delete button');
      llmDeleteBtn.onclick = async function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('[Settings] LLM Delete button clicked');
        
        // Check if OpenAI key is configured first
        const hasOpenAIKey = await ipcRenderer.invoke('openai-has-key');
        console.log('[Settings] Has OpenAI key:', hasOpenAIKey);
        
        if (!hasOpenAIKey) {
          await ipcRenderer.invoke('show-alert-dialog', {
            title: 'Cannot Delete',
            message: 'You need to configure an OpenAI API key first to ensure AI notes functionality.',
            type: 'warning'
          });
          return;
        }
        
        const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
          title: 'Delete Qwen Model',
          message: 'Delete the Qwen2.5 3B model (~2GB)?\n\nThis will free up disk space but you\'ll need to re-download it to use local AI again.',
          okLabel: 'Delete',
          cancelLabel: 'Cancel'
        });
        
        if (!confirmed) return;
        
        try {
          console.log('[Settings] Calling llm-delete-model...');
          const result = await ipcRenderer.invoke('llm-delete-model');
          console.log('[Settings] Delete result:', result);
          
          if (result) {
            await ipcRenderer.invoke('show-alert-dialog', {
              title: 'Model Deleted',
              message: 'Qwen model deleted successfully.',
              type: 'info'
            });
            // Switch to OpenAI since local model is gone
            await ipcRenderer.invoke('ai-set-engine', 'openai');
            loadState();
          } else {
            await ipcRenderer.invoke('show-alert-dialog', {
              title: 'Not Found',
              message: 'Model not found or already deleted.',
              type: 'info'
            });
          }
        } catch (err) {
          console.error('[Settings] Delete error:', err);
          await ipcRenderer.invoke('show-alert-dialog', {
            title: 'Error',
            message: 'Failed to delete model: ' + err.message,
            type: 'error'
          });
        }
      };
    }
    
    // External links
    document.getElementById('deepgramLink')?.addEventListener('click', (e) => {
      e.preventDefault();
      shell.openExternal('https://console.deepgram.com/signup');
    });
    
    document.getElementById('openaiLink')?.addEventListener('click', (e) => {
      e.preventDefault();
      shell.openExternal('https://platform.openai.com/api-keys');
    });
    
    // Calendar
    const calendarStatus = document.getElementById('calendarStatus');
    const calendarStatusText = document.getElementById('calendarStatusText');
    const calendarConnectBtn = document.getElementById('calendarConnectBtn');
    
    async function checkCalendarStatus() {
      try {
        // First check if Google OAuth credentials are configured
        const hasClientId = await ipcRenderer.invoke('calendar-has-client-id');
        
        if (!hasClientId) {
          calendarStatus?.classList.add('error');
          calendarStatus?.classList.remove('connected');
          calendarStatusText.textContent = 'Not configured (requires Google OAuth credentials)';
          calendarConnectBtn.textContent = 'Setup Required';
          calendarConnectBtn.disabled = true;
          calendarConnectBtn.style.opacity = '0.5';
          calendarConnectBtn.style.cursor = 'not-allowed';
          return;
        }
        
        calendarConnectBtn.disabled = false;
        calendarConnectBtn.style.opacity = '1';
        calendarConnectBtn.style.cursor = 'pointer';
        
        const connected = await ipcRenderer.invoke('calendar-is-connected');
        if (connected) {
          calendarStatus?.classList.add('connected');
          calendarStatus?.classList.remove('error');
          calendarStatusText.textContent = 'Connected';
          calendarConnectBtn.textContent = 'Reconnect Google Calendar';
          // Load calendar list when connected
          loadCalendarList();
        } else {
          calendarStatus?.classList.remove('connected');
          calendarStatus?.classList.remove('error');
          calendarStatusText.textContent = 'Not connected';
          calendarConnectBtn.textContent = 'Connect Google Calendar';
          visibleCalendarsSection?.classList.add('hidden');
        }
      } catch (e) {
        calendarStatus?.classList.remove('connected');
        calendarStatus?.classList.add('error');
        calendarStatusText.textContent = 'Error checking status';
      }
    }
    
    calendarConnectBtn?.addEventListener('click', async () => {
      if (calendarConnectBtn.disabled) return;
      
      calendarStatusText.textContent = 'Connecting...';
      try {
        const result = await ipcRenderer.invoke('calendar-connect');
        if (result) {
          await checkCalendarStatus();
        } else {
          calendarStatusText.textContent = 'Connection failed';
        }
      } catch (e) {
        calendarStatusText.textContent = 'Connection failed';
      }
    });
    
    // Load calendar list
    const visibleCalendarsSection = document.getElementById('visibleCalendarsSection');
    const calendarsList = document.getElementById('calendarsList');
    const resetCalendarsBtn = document.getElementById('resetCalendarsBtn');
    
    async function loadCalendarList() {
      try {
        const calendars = await ipcRenderer.invoke('calendar-get-list');
        console.log('[Settings] Got calendars:', calendars);
        
        if (calendars && calendars.length > 0) {
          visibleCalendarsSection?.classList.remove('hidden');
          
          calendarsList.innerHTML = calendars.map(cal => `
            <div class="calendar-item" data-id="${cal.id}">
              <div class="calendar-color" style="background: ${cal.backgroundColor || '#4285f4'}"></div>
              <span class="calendar-name">${cal.summary || cal.name || 'Unnamed Calendar'}</span>
              <div class="calendar-toggle ${cal.selected !== false ? 'active' : ''}" data-id="${cal.id}"></div>
            </div>
          `).join('');
          
          // Add toggle handlers
          calendarsList.querySelectorAll('.calendar-toggle').forEach(toggle => {
            toggle.addEventListener('click', async () => {
              const calId = toggle.dataset.id;
              const isActive = toggle.classList.contains('active');
              toggle.classList.toggle('active');
              await ipcRenderer.invoke('calendar-set-selected', calId, !isActive);
            });
          });
        } else {
          visibleCalendarsSection?.classList.add('hidden');
        }
      } catch (e) {
        console.error('[Settings] Error loading calendars:', e);
        visibleCalendarsSection?.classList.add('hidden');
      }
    }
    
    resetCalendarsBtn?.addEventListener('click', async () => {
      // Reset all calendars to selected
      const toggles = calendarsList.querySelectorAll('.calendar-toggle');
      for (const toggle of toggles) {
        toggle.classList.add('active');
        await ipcRenderer.invoke('calendar-set-selected', toggle.dataset.id, true);
      }
    });
    
    // Check calendar status on load
    checkCalendarStatus();
    
    // Load calendar list if connected
    (async () => {
      const connected = await ipcRenderer.invoke('calendar-is-connected');
      if (connected) {
        loadCalendarList();
      }
    })();
    
    // ============================================================================
    // SEARCH TAB - Embedding & Indexing
    // ============================================================================
    
    const embeddingLocalBtn = document.getElementById('settingsEmbeddingLocal');
    const embeddingOpenAIBtn = document.getElementById('settingsEmbeddingOpenAI');
    const embeddingModelStatus = document.getElementById('embeddingModelStatus');
    const embeddingDownloadBtn = document.getElementById('embeddingDownloadBtn');
    const embeddingDownloadProgress = document.getElementById('embeddingDownloadProgress');
    const embeddingProgressBar = document.getElementById('embeddingProgressBar');
    const embeddingProgressText = document.getElementById('embeddingProgressText');
    const indexStats = document.getElementById('indexStats');
    const reindexBtn = document.getElementById('reindexBtn');
    const reindexProgress = document.getElementById('reindexProgress');
    
    // Update embedding UI
    function updateEmbeddingUI() {
      // Provider selection styling
      if (settingsState.embeddingEngine === 'local') {
        embeddingLocalBtn?.classList.add('selected');
        embeddingLocalBtn?.style.setProperty('border-color', 'var(--accent)');
        embeddingLocalBtn?.style.setProperty('background', 'rgba(74, 222, 128, 0.1)');
        embeddingOpenAIBtn?.classList.remove('selected');
        embeddingOpenAIBtn?.style.setProperty('border-color', 'transparent');
        embeddingOpenAIBtn?.style.setProperty('background', 'var(--bg-tertiary)');
      } else {
        embeddingOpenAIBtn?.classList.add('selected');
        embeddingOpenAIBtn?.style.setProperty('border-color', 'var(--accent)');
        embeddingOpenAIBtn?.style.setProperty('background', 'rgba(74, 222, 128, 0.1)');
        embeddingLocalBtn?.classList.remove('selected');
        embeddingLocalBtn?.style.setProperty('border-color', 'transparent');
        embeddingLocalBtn?.style.setProperty('background', 'var(--bg-tertiary)');
      }
      
      // Disable OpenAI button if no API key
      if (!settingsState.openaiKey) {
        embeddingOpenAIBtn?.style.setProperty('opacity', '0.5');
        embeddingOpenAIBtn?.style.setProperty('cursor', 'not-allowed');
        // Update the description to indicate API key required
        const openaiDesc = embeddingOpenAIBtn?.querySelector('div:last-child');
        if (openaiDesc) openaiDesc.textContent = 'Requires API key (not configured)';
      } else {
        embeddingOpenAIBtn?.style.setProperty('opacity', '1');
        embeddingOpenAIBtn?.style.setProperty('cursor', 'pointer');
        const openaiDesc = embeddingOpenAIBtn?.querySelector('div:last-child');
        if (openaiDesc) openaiDesc.textContent = 'Best quality, requires API key';
      }
      
      // Disable Local button if model not downloaded
      if (!settingsState.embeddingDownloaded) {
        embeddingLocalBtn?.style.setProperty('opacity', '0.5');
        embeddingLocalBtn?.style.setProperty('cursor', 'not-allowed');
        const localDesc = embeddingLocalBtn?.querySelector('div:last-child');
        if (localDesc) localDesc.textContent = 'Not downloaded (~90MB)';
      } else {
        embeddingLocalBtn?.style.setProperty('opacity', '1');
        embeddingLocalBtn?.style.setProperty('cursor', 'pointer');
        const localDesc = embeddingLocalBtn?.querySelector('div:last-child');
        if (localDesc) localDesc.textContent = 'Works offline, ~90MB download';
      }
      
      // Model status
      if (settingsState.embeddingDownloaded) {
        if (settingsState.embeddingReady) {
          embeddingModelStatus.textContent = '‚úÖ Downloaded & Ready (all-MiniLM-L6-v2, 384 dimensions)';
          embeddingDownloadBtn.textContent = 'Delete Model';
          embeddingDownloadBtn.style.background = 'var(--bg-secondary)';
          embeddingDownloadBtn.style.color = 'var(--text-primary)';
          embeddingDownloadBtn.disabled = false;
        } else {
          embeddingModelStatus.textContent = '‚è≥ Downloaded, initializing...';
          embeddingDownloadBtn.textContent = 'Initializing...';
          embeddingDownloadBtn.disabled = true;
        }
      } else {
        embeddingModelStatus.textContent = '‚ùå Not downloaded (~90MB)';
        embeddingDownloadBtn.textContent = 'Download Model';
        embeddingDownloadBtn.style.background = 'var(--accent)';
        embeddingDownloadBtn.style.color = '#000';
        embeddingDownloadBtn.disabled = false;
      }
    }
    
    // Provider selection handlers
    embeddingLocalBtn?.addEventListener('click', async () => {
      if (settingsState.embeddingEngine === 'local') return;
      
      if (!settingsState.embeddingDownloaded) {
        await ipcRenderer.invoke('show-alert-dialog', {
          title: 'Local Embedding Not Available',
          message: 'Please download the local embedding model first.\n\nGo to the Search tab and click "Download Model".',
          type: 'warning'
        });
        return;
      }
      
      const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
        title: 'Switch to Local Embeddings',
        message: 'Switching to local embeddings (MiniLM) will reindex all your notes.\n\nThis may take a few minutes. Continue?',
        okLabel: 'Switch & Reindex',
        cancelLabel: 'Cancel'
      });
      if (!confirmed) return;
      
      const result = await ipcRenderer.invoke('embedding-set-engine', 'local');
      if (result?.success) {
        settingsState.embeddingEngine = 'local';
        updateEmbeddingUI();
        if (result.needsReindex) {
          startReindex();
        }
      }
    });
    
    embeddingOpenAIBtn?.addEventListener('click', async () => {
      if (settingsState.embeddingEngine === 'openai') return;
      
      if (!settingsState.openaiKey) {
        await ipcRenderer.invoke('show-alert-dialog', {
          title: 'OpenAI API Key Required',
          message: 'Please configure your OpenAI API key in the AI Notes tab first.\n\nOpenAI embeddings require an active API key.',
          type: 'warning'
        });
        return;
      }
      
      const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
        title: 'Switch to OpenAI Embeddings',
        message: 'Switching to OpenAI embeddings will reindex all your notes.\n\nThis uses your OpenAI API key and may incur costs. Continue?',
        okLabel: 'Switch & Reindex',
        cancelLabel: 'Cancel'
      });
      if (!confirmed) return;
      
      const result = await ipcRenderer.invoke('embedding-set-engine', 'openai');
      if (result?.success) {
        settingsState.embeddingEngine = 'openai';
        updateEmbeddingUI();
        if (result.needsReindex) {
          startReindex();
        }
      }
    });
    
    // Download/Delete button handler
    embeddingDownloadBtn?.addEventListener('click', async () => {
      if (settingsState.embeddingDownloaded) {
        // Check if we can delete - need OpenAI key if currently using local embeddings
        if (settingsState.embeddingEngine === 'local' && !settingsState.openaiKey) {
          await ipcRenderer.invoke('show-alert-dialog', {
            title: 'Cannot Delete Embedding Model',
            message: 'You are currently using local embeddings and have no OpenAI API key configured.\n\nPlease add an OpenAI API key first, or keep using local embeddings.',
            type: 'warning'
          });
          return;
        }
        
        // Delete model
        const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
          title: 'Delete Embedding Model',
          message: 'Delete the local embedding model (~90MB)?\n\nYou will need to re-download it to use local search again.',
          okLabel: 'Delete',
          cancelLabel: 'Cancel'
        });
        if (!confirmed) return;
        
        await ipcRenderer.invoke('embedding-delete-model');
        settingsState.embeddingDownloaded = false;
        settingsState.embeddingReady = false;
        // Switch to OpenAI if local model was selected and we have a key
        if (settingsState.embeddingEngine === 'local' && settingsState.openaiKey) {
          settingsState.embeddingEngine = 'openai';
          await ipcRenderer.invoke('embedding-set-engine', 'openai');
        }
        updateEmbeddingUI();
      } else {
        // Start download
        embeddingDownloadProgress?.classList.remove('hidden');
        embeddingProgressText.textContent = 'Starting download...';
        embeddingProgressBar.style.width = '0%';
        embeddingDownloadBtn.disabled = true;
        embeddingDownloadBtn.textContent = 'Downloading...';
        
        await ipcRenderer.invoke('embedding-download-model');
        
        // Poll for progress
        const progressInterval = setInterval(async () => {
          const progress = await ipcRenderer.invoke('embedding-get-download-progress');
          
          if (progress.error) {
            clearInterval(progressInterval);
            embeddingProgressText.textContent = 'Error: ' + progress.error;
            embeddingDownloadBtn.disabled = false;
            embeddingDownloadBtn.textContent = 'Retry Download';
            return;
          }
          
          embeddingProgressBar.style.width = progress.percent + '%';
          embeddingProgressText.textContent = `Downloading ${progress.currentFile}... ${progress.percent}%`;
          
          if (progress.percent >= 100 || !progress.isDownloading) {
            clearInterval(progressInterval);
            settingsState.embeddingDownloaded = true;
            embeddingDownloadProgress?.classList.add('hidden');
            
            // Initialize the model
            embeddingModelStatus.textContent = '‚è≥ Initializing model...';
            await ipcRenderer.invoke('embedding-init');
            settingsState.embeddingReady = await ipcRenderer.invoke('embedding-is-ready');
            updateEmbeddingUI();
            
            // Auto-switch to local if not using OpenAI
            if (settingsState.embeddingReady && !settingsState.openaiKey) {
              settingsState.embeddingEngine = 'local';
              await ipcRenderer.invoke('embedding-set-engine', 'local');
              updateEmbeddingUI();
              startReindex();
            }
          }
        }, 500);
      }
    });
    
    // Reindex function
    async function startReindex() {
      reindexBtn.disabled = true;
      reindexBtn.textContent = 'Reindexing...';
      reindexProgress?.classList.remove('hidden');
      reindexProgress.textContent = 'Reindexing all notes...';
      
      try {
        const result = await ipcRenderer.invoke('vector-search-reindex-all');
        
        // Build a more helpful message
        const engineName = result.engine === 'local' ? 'Local (MiniLM)' : 'OpenAI';
        
        if (result.indexed === 0 && result.errors === 0) {
          reindexProgress.textContent = `‚úÖ Index ready ‚Ä¢ No notes to reindex ‚Ä¢ Using ${engineName}`;
        } else if (result.errors === 0) {
          reindexProgress.textContent = `‚úÖ Successfully indexed ${result.indexed} note${result.indexed !== 1 ? 's' : ''} ‚Ä¢ Using ${engineName}`;
        } else {
          reindexProgress.textContent = `‚ö†Ô∏è Indexed ${result.indexed} note${result.indexed !== 1 ? 's' : ''}, ${result.errors} error${result.errors !== 1 ? 's' : ''} ‚Ä¢ Using ${engineName}`;
        }
        
        // Update stats
        loadIndexStats();
      } catch (e) {
        reindexProgress.textContent = '‚ùå Reindex failed: ' + (e.message || 'Unknown error');
      }
      
      reindexBtn.disabled = false;
      reindexBtn.textContent = 'Reindex All';
      
      setTimeout(() => {
        reindexProgress?.classList.add('hidden');
      }, 5000);
    }
    
    reindexBtn?.addEventListener('click', () => {
      startReindex();
    });
    
    // Load index stats
    async function loadIndexStats() {
      try {
        const stats = await ipcRenderer.invoke('vector-search-stats');
        const engine = await ipcRenderer.invoke('embedding-get-engine');
        indexStats.textContent = `${stats?.noteCount || 0} notes indexed (${stats?.totalItems || 0} chunks) ‚Ä¢ Engine: ${engine}`;
      } catch (e) {
        indexStats.textContent = 'Unable to load stats';
      }
    }
    
    // Load embedding status on tab switch
    document.querySelector('[data-tab="search"]')?.addEventListener('click', () => {
      updateEmbeddingUI();
      loadIndexStats();
    });
    
    // Load settings on init
    loadState();
    
    // Also initialize embedding UI after load
    setTimeout(() => {
      updateEmbeddingUI();
      loadIndexStats();
    }, 500);
    
    // Load saved theme
    (async () => {
      const theme = await ipcRenderer.invoke('theme-get');
      if (theme) {
        document.querySelectorAll('.theme-toggle-btn').forEach(t => {
          t.classList.toggle('active', t.dataset.theme === theme);
        });
      }
    })();
    
    // ============================================================================
    // TEMPLATES TAB - Stack Navigation
    // ============================================================================
    
    let allTemplates = [];
    let editingTemplate = null;
    let editingIsNew = false;
    let draggedSectionIndex = null;
    
    // Elements
    const templatesListView = document.getElementById('templatesListView');
    const templatesEditorView = document.getElementById('templatesEditorView');
    const myTemplatesList = document.getElementById('myTemplatesList');
    const builtInTemplatesList = document.getElementById('builtInTemplatesList');
    const newTemplateBtn = document.getElementById('newTemplateBtn');
    const templatesBackBtn = document.getElementById('templatesBackBtn');
    const deleteTemplateBtn = document.getElementById('deleteTemplateBtn');
    const templateIconBtn = document.getElementById('templateIconBtn');
    const templateNameInput = document.getElementById('templateNameInput');
    const templateOwnerLabel = document.getElementById('templateOwnerLabel');
    const templateContextInput = document.getElementById('templateContextInput');
    const templateSectionsContainer = document.getElementById('templateSectionsContainer');
    const addSectionBtn = document.getElementById('addSectionBtn');
    const cancelTemplateBtn = document.getElementById('cancelTemplateBtn');
    const saveTemplateBtn = document.getElementById('saveTemplateBtn');
    const iconPickerDropdown = document.getElementById('iconPickerDropdown');
    
    // Icon options
    const iconOptions = ['üìù', 'üë•', 'üßç', 'üîç', 'üíº', 'üí∞', 'üìä', 'üéØ', 'üí°', 'üìû', 'ü§ù', 'üìà', 'üóìÔ∏è', '‚ù§Ô∏è', '‚úèÔ∏è', 'üé®', 'üîß', 'üì±'];
    if (iconPickerDropdown) {
      iconPickerDropdown.innerHTML = iconOptions.map(icon => 
        `<button class="icon-opt" data-icon="${icon}" style="padding: 10px; border: none; background: transparent; font-size: 20px; cursor: pointer; border-radius: 6px; transition: background 0.15s;">${icon}</button>`
      ).join('');
    }
    
    // Load templates
    async function loadTemplates() {
      allTemplates = await ipcRenderer.invoke('templates-get-all');
      renderTemplatesList();
    }
    
    function renderTemplatesList() {
      const myTemplates = allTemplates.filter(t => !t.isBuiltIn);
      const builtIn = allTemplates.filter(t => t.isBuiltIn);
      
      if (myTemplatesList) {
        myTemplatesList.innerHTML = myTemplates.length > 0 
          ? myTemplates.map(renderTemplateCard).join('')
          : '<div style="padding: 12px 16px; font-size: 13px; color: var(--text-muted); font-style: italic; background: var(--bg-secondary); border-radius: 8px;">No custom templates yet</div>';
      }
      
      if (builtInTemplatesList) {
        builtInTemplatesList.innerHTML = builtIn.map(renderTemplateCard).join('');
      }
      
      // Add click handlers
      document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', () => openTemplate(card.dataset.id));
      });
    }
    
    function renderTemplateCard(t) {
      return `
        <div class="template-card" data-id="${t.id}" style="display: flex; align-items: center; gap: 14px; padding: 12px 14px; background: var(--bg-secondary); border-radius: 10px; cursor: pointer; transition: all 0.15s; border: 1px solid transparent;">
          <div style="width: 40px; height: 40px; border-radius: 10px; background: ${t.isBuiltIn ? 'var(--bg-tertiary)' : 'var(--accent)'}; display: flex; align-items: center; justify-content: center; font-size: 20px;">${t.icon}</div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 500; color: var(--text-primary); font-size: 14px;">${t.name}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${t.isBuiltIn ? 'IceCubes' : 'Me'} ‚Ä¢ ${t.sections?.length || 0} sections</div>
          </div>
          <div style="color: var(--text-muted); font-size: 18px;">‚Ä∫</div>
        </div>
      `;
    }
    
    // Navigation
    function showListView() {
      templatesEditorView?.classList.add('hidden');
      templatesListView?.classList.remove('hidden');
      editingTemplate = null;
    }
    
    function showEditorView() {
      templatesListView?.classList.add('hidden');
      templatesEditorView?.classList.remove('hidden');
    }
    
    // Open template for editing
    function openTemplate(id) {
      const template = allTemplates.find(t => t.id === id);
      if (!template) return;
      
      editingTemplate = JSON.parse(JSON.stringify(template));
      editingIsNew = false;
      
      populateEditor();
      showEditorView();
    }
    
    // Create new template
    function createNewTemplate() {
      editingTemplate = {
        id: null,
        name: 'Untitled template',
        icon: 'üìù',
        description: '',
        sections: [{ id: 's1', title: 'Summary', instructions: 'Brief overview of the meeting' }],
        isBuiltIn: false,
        isDefault: false
      };
      editingIsNew = true;
      
      populateEditor();
      showEditorView();
      templateNameInput?.focus();
      templateNameInput?.select();
    }
    
    // Populate editor with template data
    function populateEditor() {
      if (!editingTemplate) return;
      
      const isReadOnly = editingTemplate.isBuiltIn;
      
      templateIconBtn.textContent = editingTemplate.icon;
      templateIconBtn.style.cursor = isReadOnly ? 'default' : 'pointer';
      templateIconBtn.style.background = isReadOnly ? 'var(--bg-tertiary)' : 'var(--accent)';
      
      templateNameInput.value = editingTemplate.name;
      templateNameInput.readOnly = isReadOnly;
      
      templateOwnerLabel.textContent = isReadOnly ? 'IceCubes ‚Ä¢ ' + (editingTemplate.sections?.length || 0) + ' sections' : 'Me ‚Ä¢ ' + (editingTemplate.sections?.length || 0) + ' sections';
      
      templateContextInput.value = editingTemplate.description || '';
      templateContextInput.readOnly = isReadOnly;
      
      deleteTemplateBtn?.classList.toggle('hidden', isReadOnly || editingIsNew);
      addSectionBtn.style.display = isReadOnly ? 'none' : 'flex';
      saveTemplateBtn.style.display = isReadOnly ? 'none' : 'block';
      cancelTemplateBtn.textContent = isReadOnly ? 'Close' : 'Cancel';
      
      renderSections();
    }
    
    // Render sections with drag-drop
    function renderSections() {
      if (!editingTemplate || !templateSectionsContainer) return;
      
      const isReadOnly = editingTemplate.isBuiltIn;
      
      templateSectionsContainer.innerHTML = editingTemplate.sections.map((section, i) => `
        <div class="section-card" data-index="${i}" draggable="${!isReadOnly}" style="display: flex; align-items: flex-start; gap: 10px; padding: 14px 16px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border); transition: all 0.15s;">
          <div class="drag-handle" style="cursor: ${isReadOnly ? 'default' : 'grab'}; padding: 2px; color: var(--text-muted); user-select: none; opacity: ${isReadOnly ? '0.3' : '0.6'};">‚ãÆ‚ãÆ</div>
          <div style="flex: 1;">
            <input type="text" class="section-title" data-index="${i}" value="${section.title}" placeholder="Section title" ${isReadOnly ? 'readonly' : ''} style="width: 100%; padding: 4px 0; border: none; background: transparent; color: var(--text-primary); font-size: 14px; font-weight: 500; outline: none;">
            <textarea class="section-instructions" data-index="${i}" placeholder="Instructions for this section..." ${isReadOnly ? 'readonly' : ''} style="width: 100%; padding: 4px 0; border: none; background: transparent; color: var(--text-secondary); font-size: 13px; font-family: inherit; resize: none; min-height: 32px; outline: none;">${section.instructions || ''}</textarea>
          </div>
          ${!isReadOnly ? `<button class="remove-section" data-index="${i}" style="padding: 4px 8px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-size: 18px; opacity: 0.5; transition: opacity 0.15s;" ${editingTemplate.sections.length <= 1 ? 'disabled' : ''}>√ó</button>` : ''}
        </div>
      `).join('');
      
      if (!isReadOnly) {
        // Input handlers
        templateSectionsContainer.querySelectorAll('.section-title').forEach(input => {
          input.addEventListener('input', e => {
            editingTemplate.sections[parseInt(e.target.dataset.index)].title = e.target.value;
          });
        });
        
        templateSectionsContainer.querySelectorAll('.section-instructions').forEach(input => {
          input.addEventListener('input', e => {
            editingTemplate.sections[parseInt(e.target.dataset.index)].instructions = e.target.value;
            // Auto-resize
            e.target.style.height = 'auto';
            e.target.style.height = e.target.scrollHeight + 'px';
          });
        });
        
        templateSectionsContainer.querySelectorAll('.remove-section').forEach(btn => {
          btn.addEventListener('click', e => {
            editingTemplate.sections.splice(parseInt(e.target.dataset.index), 1);
            renderSections();
            updateOwnerLabel();
          });
          btn.addEventListener('mouseenter', () => btn.style.opacity = '1');
          btn.addEventListener('mouseleave', () => btn.style.opacity = '0.5');
        });
        
        // Drag and drop
        templateSectionsContainer.querySelectorAll('.section-card').forEach(card => {
          card.addEventListener('dragstart', handleDragStart);
          card.addEventListener('dragend', handleDragEnd);
          card.addEventListener('dragover', handleDragOver);
          card.addEventListener('dragenter', handleDragEnter);
          card.addEventListener('dragleave', handleDragLeave);
          card.addEventListener('drop', handleDrop);
        });
      }
    }
    
    function updateOwnerLabel() {
      if (templateOwnerLabel && editingTemplate) {
        const isReadOnly = editingTemplate.isBuiltIn;
        templateOwnerLabel.textContent = (isReadOnly ? 'IceCubes' : 'Me') + ' ‚Ä¢ ' + (editingTemplate.sections?.length || 0) + ' sections';
      }
    }
    
    // Drag handlers
    function handleDragStart(e) {
      draggedSectionIndex = parseInt(e.target.dataset.index);
      e.target.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
      e.target.style.opacity = '1';
      document.querySelectorAll('.section-card').forEach(card => {
        card.style.borderColor = 'var(--border)';
        card.style.background = 'var(--bg-secondary)';
      });
      draggedSectionIndex = null;
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }
    
    function handleDragEnter(e) {
      e.preventDefault();
      const card = e.target.closest('.section-card');
      if (card && parseInt(card.dataset.index) !== draggedSectionIndex) {
        card.style.borderColor = 'var(--accent)';
        card.style.background = 'var(--bg-tertiary)';
      }
    }
    
    function handleDragLeave(e) {
      const card = e.target.closest('.section-card');
      if (card) {
        card.style.borderColor = 'var(--border)';
        card.style.background = 'var(--bg-secondary)';
      }
    }
    
    function handleDrop(e) {
      e.preventDefault();
      const card = e.target.closest('.section-card');
      if (!card) return;
      
      const targetIndex = parseInt(card.dataset.index);
      if (draggedSectionIndex === null || draggedSectionIndex === targetIndex) return;
      
      const [removed] = editingTemplate.sections.splice(draggedSectionIndex, 1);
      editingTemplate.sections.splice(targetIndex, 0, removed);
      
      renderSections();
    }
    
    // Event listeners
    newTemplateBtn?.addEventListener('click', createNewTemplate);
    templatesBackBtn?.addEventListener('click', showListView);
    cancelTemplateBtn?.addEventListener('click', showListView);
    
    addSectionBtn?.addEventListener('click', () => {
      if (!editingTemplate || editingTemplate.isBuiltIn) return;
      editingTemplate.sections.push({
        id: 's' + Date.now(),
        title: '',
        instructions: ''
      });
      renderSections();
      updateOwnerLabel();
      // Focus the new section
      const inputs = templateSectionsContainer.querySelectorAll('.section-title');
      inputs[inputs.length - 1]?.focus();
    });
    
    // Icon picker
    templateIconBtn?.addEventListener('click', e => {
      if (editingTemplate?.isBuiltIn) return;
      e.stopPropagation();
      const rect = templateIconBtn.getBoundingClientRect();
      iconPickerDropdown.style.top = (rect.bottom + 8) + 'px';
      iconPickerDropdown.style.left = rect.left + 'px';
      iconPickerDropdown.classList.toggle('hidden');
    });
    
    iconPickerDropdown?.querySelectorAll('.icon-opt').forEach(btn => {
      btn.addEventListener('mouseenter', () => btn.style.background = 'var(--bg-secondary)');
      btn.addEventListener('mouseleave', () => btn.style.background = 'transparent');
      btn.addEventListener('click', () => {
        if (editingTemplate && !editingTemplate.isBuiltIn) {
          editingTemplate.icon = btn.dataset.icon;
          templateIconBtn.textContent = btn.dataset.icon;
        }
        iconPickerDropdown.classList.add('hidden');
      });
    });
    
    document.addEventListener('click', () => iconPickerDropdown?.classList.add('hidden'));
    
    // Delete
    deleteTemplateBtn?.addEventListener('click', async () => {
      if (!editingTemplate || editingTemplate.isBuiltIn) return;
      
      const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
        title: 'Delete Template',
        message: `Delete "${editingTemplate.name}"?\n\nThis cannot be undone.`,
        okLabel: 'Delete',
        cancelLabel: 'Cancel'
      });
      
      if (confirmed) {
        await ipcRenderer.invoke('templates-delete', editingTemplate.id);
        await loadTemplates();
        showListView();
      }
    });
    
    // Save
    saveTemplateBtn?.addEventListener('click', async () => {
      if (!editingTemplate || editingTemplate.isBuiltIn) return;
      
      editingTemplate.name = templateNameInput.value.trim() || 'Untitled Template';
      editingTemplate.description = templateContextInput.value.trim();
      editingTemplate.sections = editingTemplate.sections.filter(s => s.title.trim());
      
      if (editingTemplate.sections.length === 0) {
        editingTemplate.sections.push({ id: 's1', title: 'Summary', instructions: '' });
      }
      
      try {
        if (editingIsNew) {
          await ipcRenderer.invoke('templates-create', editingTemplate);
        } else {
          await ipcRenderer.invoke('templates-update', editingTemplate.id, editingTemplate);
        }
        
        await loadTemplates();
        
        saveTemplateBtn.textContent = '‚úì Saved';
        setTimeout(() => {
          saveTemplateBtn.textContent = 'Save Changes';
          showListView();
        }, 800);
      } catch (err) {
        console.error('[Templates] Save error:', err);
        await ipcRenderer.invoke('show-alert-dialog', {
          title: 'Error',
          message: 'Failed to save template: ' + err.message,
          type: 'error'
        });
      }
    });
    
    // Load on tab open
    document.querySelector('[data-tab="templates"]')?.addEventListener('click', () => {
      loadTemplates();
      showListView();
    });
  </script>
</body>
</html>

