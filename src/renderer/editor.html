<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IceCubes</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root, [data-theme="light"] {
      --bg: #f8f9fa;
      --bg-secondary: #f0f2f5;
      --bg-hover: #e8eaed;
      --bg-tertiary: #e4e6e9;
      --bg-sidebar: #1e1e2e;
      --bg-sidebar-hover: #2a2a3e;
      --sidebar-bg: #f0f2f5;
      --text: #1a1a2e;
      --text-secondary: #555;
      --text-muted: #888;
      --text-sidebar: #e8e8f0;
      --text-sidebar-muted: #9090a0;
      --border: #dde1e6;
      --accent: #10b981;
      --accent-bg: #ecfdf5;
      /* Setup screen colors */
      --setup-complete-bg: #ecfdf5;
      --setup-complete-border: #a7f3d0;
      --setup-complete-text: #047857;
      --setup-error-bg: #fef2f2;
      --setup-error-border: #fecaca;
    }
    
    [data-theme="dark"] {
      --bg: #1a1a2e;
      --bg-secondary: #252538;
      --bg-hover: #2a2a40;
      --bg-sidebar: #15152a;
      --bg-sidebar-hover: #1e1e35;
      --sidebar-bg: #15152a;
      --text: #e8e8f0;
      --text-secondary: #a0a0b0;
      --text-muted: #707080;
      --text-sidebar: #e8e8f0;
      --text-sidebar-muted: #9090a0;
      --border: #3a3a50;
      --accent: #10b981;
      --accent-bg: rgba(16, 185, 129, 0.15);
      /* Setup screen colors */
      --setup-complete-bg: rgba(16, 185, 129, 0.15);
      --setup-complete-border: rgba(16, 185, 129, 0.4);
      --setup-complete-text: #6ee7b7;
      --setup-error-bg: rgba(239, 68, 68, 0.15);
      --setup-error-border: rgba(239, 68, 68, 0.4);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }
    
    /* Slim, minimal scrollbars */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
    
    /* Hide scrollbar when not scrolling (macOS style) */
    .editor-scroll::-webkit-scrollbar-thumb,
    .tiptap-editor::-webkit-scrollbar-thumb,
    .transcript-content::-webkit-scrollbar-thumb {
      background: transparent;
    }
    
    .editor-scroll:hover::-webkit-scrollbar-thumb,
    .tiptap-editor:hover::-webkit-scrollbar-thumb,
    .transcript-content:hover::-webkit-scrollbar-thumb {
      background: var(--border);
    }
    
    .app {
      display: flex;
      height: 100%;
    }
    
    /* Left Sidebar - Navigation */
    .sidebar {
      width: 240px;
      background: var(--bg-sidebar);
      display: flex;
      flex-direction: column;
      transition: margin-left 0.25s ease;
      border-right: 1px solid var(--border);
    }
    
    .sidebar.collapsed {
      margin-left: -240px;
    }
    
    .sidebar-header {
      padding: 20px 16px 16px 16px;
      margin-top: 32px; /* Space for traffic lights */
      -webkit-app-region: drag;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    
    .sidebar-title {
      color: var(--text-sidebar);
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .sidebar-title img {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }
    
    /* Navigation items */
    .sidebar-nav {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
    }
    
    .nav-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 12px 4px;
    }
    
    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-sidebar-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .add-folder-btn {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: none;
      background: transparent;
      color: var(--text-sidebar-muted);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .add-folder-btn:hover {
      background: var(--bg-hover);
      color: var(--text);
    }
    
    .add-folder-btn-large {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 10px 12px;
      margin-top: 8px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .add-folder-btn-large:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .add-folder-btn-large span {
      font-size: 18px;
      font-weight: 300;
    }
    
    .folders-list {
      margin-top: 4px;
    }
    
    .folder-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 2px;
      transition: all 0.15s;
      position: relative;
    }
    
    .folder-item:hover {
      background: var(--bg-sidebar-hover);
    }
    
    .folder-item.active {
      background: var(--accent);
      color: white;
    }
    
    .folder-item.active:hover {
      background: var(--accent);
    }
    
    .folder-item-icon {
      margin-right: 8px;
      font-size: 14px;
    }
    
    .folder-item-name {
      flex: 1;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text-sidebar);
    }
    
    .folder-item.active .folder-item-name {
      color: white;
    }
    
    .folder-item-count {
      font-size: 12px;
      color: var(--text-sidebar-muted);
      margin-left: 8px;
    }
    
    .folder-item.active .folder-item-count {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .folder-menu-btn {
      display: none;
      width: 20px;
      height: 20px;
      border: none;
      background: transparent;
      color: var(--text-sidebar-muted);
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
      margin-left: 4px;
      flex-shrink: 0;
    }
    
    .folder-menu-btn:hover {
      background: var(--bg-sidebar-hover);
      color: var(--text-sidebar);
    }
    
    .folder-item:hover .folder-menu-btn {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .folder-item.active .folder-menu-btn {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .folder-item.active .folder-menu-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    
    
    /* Entity list view (People/Companies list) */
    
    .entity-list-search {
      padding: 12px 0;
      margin: -24px -32px 0 -32px;
      padding-left: 32px;
      padding-right: 32px;
    }
    
    .entity-list-search-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }
    
    .entity-list-search-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .entity-list-search-input::placeholder {
      color: var(--text-muted);
    }
    
    /* Table header */
    .entity-table-header {
      display: grid;
      grid-template-columns: 1fr 120px 80px;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .entity-table-header .sortable-col {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: color 0.15s;
    }
    
    .entity-table-header .sortable-col:hover {
      color: var(--text);
    }
    
    .entity-table-header .sortable-col.active {
      color: var(--accent);
    }
    
    .entity-table-header .sort-indicator {
      font-size: 10px;
      opacity: 0.5;
    }
    
    .entity-table-header .sortable-col.active .sort-indicator {
      opacity: 1;
    }
    
    .entity-list-items {
      padding: 0;
    }
    
    .entity-list-item {
      display: grid;
      grid-template-columns: 1fr 120px 80px;
      align-items: center;
      padding: 16px 24px;
      cursor: pointer;
      transition: background 0.15s;
      border-bottom: 1px solid var(--border);
    }
    
    .entity-list-item:hover {
      background: var(--bg-hover);
    }
    
    .entity-list-item-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .entity-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #4a5568;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }
    
    .entity-avatar.company {
      background: #2d3748;
      font-size: 18px;
    }
    
    .entity-list-item-info {
      flex: 1;
      min-width: 0;
    }
    
    .entity-list-item-name {
      font-size: 15px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .entity-list-item-email {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .entity-list-item-date {
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .entity-list-item-count {
      font-size: 14px;
      color: var(--text-muted);
      text-align: right;
    }
    
    .entity-list-empty {
      padding: 32px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }
    
    /* Entity detail view (Person/Company notes) */
    .entity-detail-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 24px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-secondary);
      flex-wrap: wrap;
    }
    
    .entity-back-btn {
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      color: var(--accent);
      font-size: 14px;
      cursor: pointer;
      padding: 0;
      margin-bottom: 12px;
    }
    
    .entity-back-btn:hover {
      text-decoration: underline;
    }
    
    .entity-detail-icon {
      font-size: 48px;
      width: 72px;
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      border-radius: 50%;
      border: 2px solid var(--border);
    }
    
    .entity-detail-info {
      flex: 1;
    }
    
    .entity-detail-name {
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
      margin: 0 0 4px 0;
    }
    
    .entity-detail-count {
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .entity-notes-search {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
    }
    
    .entity-notes-search-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }
    
    .entity-notes-search-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .entity-notes-search-input::placeholder {
      color: var(--text-muted);
    }
    
    .entity-notes-list {
      padding: 8px;
    }
    
    .entity-notes-list .note-item {
      margin-bottom: 4px;
    }
    
    /* Nav entity links */
    .nav-entity-link {
      margin-top: 4px;
    }
    
    .nav-item-count {
      font-size: 12px;
      color: var(--text-muted);
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: auto;
    }
    
    .nav-item.active .nav-item-count {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    
    /* Create folder modal */
    .folder-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    
    .folder-modal.hidden {
      display: none;
    }
    
    .folder-modal-content {
      background: var(--bg);
      border-radius: 16px;
      padding: 24px;
      width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .folder-modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text);
    }
    
    .folder-modal-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text);
      font-size: 14px;
      margin-bottom: 12px;
    }
    
    .folder-modal-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .folder-icon-picker {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .folder-icon-option {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 2px solid transparent;
      background: var(--bg-secondary);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .folder-icon-option:hover {
      background: var(--bg-hover);
    }
    
    .folder-icon-option.selected {
      border-color: var(--accent);
      background: var(--accent-bg);
    }
    
    .folder-modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .folder-modal-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .folder-modal-btn-cancel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text);
    }
    
    .folder-modal-btn-cancel:hover {
      background: var(--bg-hover);
    }
    
    .folder-modal-btn-create {
      background: var(--accent);
      border: none;
      color: white;
    }
    
    .folder-modal-btn-create:hover {
      opacity: 0.9;
    }
    
    .folder-form-group {
      margin-bottom: 16px;
    }
    
    .folder-form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 6px;
    }
    
    .label-hint {
      font-weight: 400;
      color: var(--text-muted);
      font-size: 11px;
    }
    
    .folder-description-input {
      min-height: 60px;
      resize: vertical;
      font-family: inherit;
    }
    
    .folder-desc-counter {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
      margin-top: 4px;
    }
    
    .folder-desc-counter.over-limit {
      color: #ef4444;
      font-weight: 500;
    }
    
    .folder-icon-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 10px;
    }
    
    .folder-icon-tab {
      padding: 6px 12px;
      border: none;
      background: var(--bg-secondary);
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .folder-icon-tab:hover {
      background: var(--bg-hover);
    }
    
    .folder-icon-tab.active {
      background: var(--accent);
      color: white;
    }
    
    .icon-tab-content {
      display: none;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .icon-tab-content.active {
      display: flex;
    }
    
    .folder-icon-option.color-ball {
      border-radius: 50%;
      color: transparent;
      box-shadow: inset 0 -2px 4px rgba(0,0,0,0.2), inset 0 2px 4px rgba(255,255,255,0.3);
    }
    
    .folder-icon-option.color-ball.selected {
      box-shadow: inset 0 -2px 4px rgba(0,0,0,0.2), inset 0 2px 4px rgba(255,255,255,0.3), 0 0 0 3px var(--accent);
    }
    
    .folder-default-toggle {
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 10px;
      margin-top: 8px;
    }
    
    .folder-toggle-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }
    
    .folder-toggle-label input[type="checkbox"] {
      display: none;
    }
    
    .toggle-switch {
      width: 40px;
      height: 22px;
      background: var(--border);
      border-radius: 11px;
      position: relative;
      transition: background 0.2s;
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      left: 2px;
      top: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .folder-toggle-label input:checked + .toggle-switch {
      background: var(--accent);
    }
    
    .folder-toggle-label input:checked + .toggle-switch::after {
      transform: translateX(18px);
    }
    
    .toggle-text {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }
    
    .folder-default-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
      margin-left: 50px;
    }
    
    .folder-default-warning {
      font-size: 12px;
      color: #f59e0b;
      margin-top: 8px;
      padding: 8px 10px;
      background: rgba(245, 158, 11, 0.1);
      border-radius: 6px;
    }
    
    .folder-default-warning.hidden {
      display: none;
    }
    
    /* Folder AI Q&A panel */
    .folder-qa-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin: 16px 0;
      overflow: hidden;
    }
    
    .folder-qa-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .folder-qa-header-icon {
      font-size: 16px;
    }
    
    .folder-qa-header-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    
    .folder-qa-input-row {
      display: flex;
      padding: 12px;
      gap: 8px;
    }
    
    .folder-qa-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }
    
    .folder-qa-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .folder-qa-btn {
      padding: 10px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .folder-qa-btn:hover {
      opacity: 0.9;
    }
    
    .folder-qa-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .folder-qa-answer {
      padding: 16px;
      border-top: 1px solid var(--border);
      font-size: 14px;
      line-height: 1.6;
      color: var(--text);
    }
    
    .folder-qa-sources {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .folder-qa-source {
      display: inline-block;
      padding: 4px 8px;
      background: var(--bg);
      border-radius: 4px;
      margin-right: 8px;
      margin-bottom: 4px;
    }
    
    /* Templates Modal */
    .templates-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
    }
    
    .templates-modal.hidden {
      display: none;
    }
    
    .templates-modal-content {
      background: var(--bg);
      border-radius: 16px;
      width: 900px;
      max-width: 95vw;
      height: 650px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }
    
    .templates-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    
    .templates-modal-header h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }
    
    .templates-close-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--bg-secondary);
      border-radius: 8px;
      font-size: 22px;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .templates-close-btn:hover {
      background: var(--bg-hover);
      color: var(--text);
    }
    
    .templates-modal-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .templates-modal-sidebar {
      width: 260px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: var(--bg-secondary);
    }
    
    .templates-modal-editor {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      background: var(--bg);
    }
    
    .templates-new-btn {
      margin: 12px;
      padding: 10px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    
    .templates-new-btn:hover {
      opacity: 0.9;
    }
    
    .templates-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 8px 12px;
    }
    
    .templates-list-section {
      margin-top: 16px;
    }
    
    .templates-list-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0 8px 6px;
      letter-spacing: 0.5px;
    }
    
    .template-list-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .template-list-item:hover {
      background: var(--bg-hover);
    }
    
    .template-list-item.active {
      background: var(--accent);
    }
    
    .template-list-item.active .template-list-name,
    .template-list-item.active .template-list-owner {
      color: white;
    }
    
    .template-list-icon {
      font-size: 20px;
      width: 28px;
      text-align: center;
    }
    
    .template-list-info {
      flex: 1;
      min-width: 0;
    }
    
    .template-list-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .template-list-owner {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .template-default-badge {
      font-size: 9px;
      padding: 2px 6px;
      background: var(--accent);
      color: white;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .templates-editor {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }
    
    .templates-empty-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      font-size: 14px;
    }
    
    .template-edit-header {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .template-edit-icon-picker {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      background: var(--bg-secondary);
      border: 2px dashed var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }
    
    .template-edit-icon-picker:hover {
      border-color: var(--accent);
      background: var(--bg-hover);
    }
    
    .template-edit-icon-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      display: none;
      flex-wrap: wrap;
      gap: 4px;
      width: 200px;
      z-index: 100;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    
    .template-edit-icon-dropdown.show {
      display: flex;
    }
    
    .template-icon-choice {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
    }
    
    .template-icon-choice:hover {
      background: var(--bg-hover);
    }
    
    .template-edit-title-group {
      flex: 1;
    }
    
    .template-edit-name {
      width: 100%;
      font-size: 20px;
      font-weight: 600;
      padding: 8px 0;
      border: none;
      background: transparent;
      color: var(--text);
      border-bottom: 2px solid transparent;
    }
    
    .template-edit-name:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }
    
    .template-edit-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }
    
    .template-edit-owner {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .template-edit-owner-avatar {
      width: 20px;
      height: 20px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      font-weight: 600;
    }
    
    .template-edit-default-toggle {
      font-size: 12px;
      padding: 4px 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      color: var(--text);
    }
    
    .template-edit-default-toggle:hover {
      background: var(--bg-hover);
    }
    
    .template-edit-default-toggle.is-default {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .template-edit-section-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 10px;
      margin-top: 20px;
    }
    
    .template-context-input {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--bg-secondary);
      color: var(--text);
      font-size: 14px;
      resize: vertical;
      font-family: inherit;
    }
    
    .template-context-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .template-context-input::placeholder {
      color: var(--text-muted);
    }
    
    .template-sections-list {
      margin-top: 12px;
    }
    
    .template-section-item {
      display: flex;
      gap: 12px;
      padding: 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 10px;
      align-items: flex-start;
    }
    
    .template-section-item:hover {
      border-color: var(--accent);
    }
    
    .template-section-drag {
      color: var(--text-muted);
      cursor: grab;
      padding: 4px;
      font-size: 14px;
    }
    
    .template-section-drag:active {
      cursor: grabbing;
    }
    
    .template-section-item.dragging {
      opacity: 0.5;
      border-style: dashed;
    }
    
    .template-section-item.drag-over {
      border-color: var(--accent);
      background: var(--accent-bg);
    }
    
    .template-section-item[draggable="true"] {
      cursor: default;
    }
    
    .template-section-item[draggable="true"] .template-section-drag {
      cursor: grab;
    }
    
    .template-section-content {
      flex: 1;
    }
    
    .template-section-title-input {
      width: 100%;
      font-size: 14px;
      font-weight: 600;
      padding: 6px 0;
      border: none;
      background: transparent;
      color: var(--text);
    }
    
    .template-section-title-input:focus {
      outline: none;
    }
    
    .template-section-instructions-input {
      width: 100%;
      font-size: 13px;
      padding: 6px 0;
      border: none;
      background: transparent;
      color: var(--text-muted);
      resize: none;
      min-height: 40px;
    }
    
    .template-section-instructions-input:focus {
      outline: none;
      color: var(--text);
    }
    
    .template-section-delete {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 6px;
      font-size: 16px;
    }
    
    .template-section-delete:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }
    
    .template-add-section-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      width: 100%;
      border: 2px dashed var(--border);
      border-radius: 10px;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .template-add-section-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .template-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    
    .template-save-btn {
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    
    .template-save-btn:hover {
      opacity: 0.9;
    }
    
    .template-delete-btn {
      padding: 10px 20px;
      background: transparent;
      color: #ef4444;
      border: 1px solid #ef4444;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .template-delete-btn:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    
    .nav-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
      color: var(--text-sidebar);
      transition: background 0.15s;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }
    
    .nav-item:hover {
      background: var(--bg-sidebar-hover);
    }
    
    .nav-item.active {
      background: var(--accent);
      font-weight: 500;
    }
    
    .nav-item-icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }
    
    .nav-section-title {
      padding: 16px 12px 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-sidebar-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Notes Panel - Shows notes list (moved from left sidebar) */
    .notes-home {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto; /* Make scrollable */
      padding: 24px 32px;
    }
    
    .notes-home-header {
      margin-bottom: 24px;
    }
    
    .notes-home-title {
      font-size: 32px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .notes-home-subtitle {
      font-size: 15px;
      color: var(--text-muted);
    }
    
    .notes-list {
      flex: 1;
      overflow-y: visible; /* Allow scrolling from parent */
      padding-right: 12px;
    }
    
    /* Date group headers */
    .date-header {
      padding: 12px 12px 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .date-header:not(:first-child) {
      margin-top: 16px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
    }
    
    .note-item {
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      margin-bottom: 6px;
      color: var(--text);
      background: var(--bg-secondary);
      transition: all 0.15s;
      border: 1px solid transparent;
    }
    
    .note-item:hover {
      background: var(--bg-hover);
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    
    .note-item.active {
      background: var(--accent-bg);
      border-color: var(--accent);
    }
    
    .note-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
      color: var(--text);
      background: var(--bg);
      transition: all 0.15s;
      border: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      gap: 10px;
      /* No max-width - use full available width to minimize white space */
    }
    
    .note-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: var(--bg-hover);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .note-item.active .note-icon {
      background: var(--accent);
      color: white;
    }
    
    .note-content {
      flex: 1;
      min-width: 0;
    }
    
    .note-item-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }
    
    .note-item-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      gap: 6px;
      align-items: center;
    }
    
    .note-item.active .note-item-meta {
      color: var(--text-secondary);
    }
    
    .note-time {
      color: var(--text-secondary);
      margin-left: auto;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      padding-right: 28px; /* Space for menu button */
    }
    
    .note-item.active .note-time {
      color: var(--text);
    }
    
    .note-item-preview {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.4;
    }
    
    .note-item.active .note-item-preview {
      color: var(--text-secondary);
    }
    
    .note-menu-btn {
      display: none;
      position: absolute;
      right: 8px;
      bottom: 8px;
      width: 22px;
      height: 22px;
      border: none;
      background: var(--bg-secondary);
      color: var(--text-muted);
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
    }
    
    .note-menu-btn:hover {
      background: var(--bg-hover);
      color: var(--text);
    }
    
    .note-item:hover .note-menu-btn {
      display: flex;
    }
    
    .note-menu {
      position: absolute;
      right: 8px;
      top: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 120px;
      display: none;
    }
    
    .note-menu.show {
      display: block;
    }
    
    .note-menu-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text);
      transition: background 0.15s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .note-menu-item:hover {
      background: var(--bg-hover);
    }
    
    .note-menu-item:first-child {
      border-radius: 8px 8px 0 0;
    }
    
    .note-menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }
    
    .note-menu-item.danger {
      color: #ef4444;
    }
    
    .note-menu-item.danger:hover {
      background: #fef2f2;
    }
    
    .note-item {
      position: relative;
    }
    
    .notes-empty {
      padding: 20px;
      text-align: center;
      color: var(--text-sidebar-muted);
      font-size: 13px;
    }
    
    .folder-empty-state {
      padding: 48px 24px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    
    .folder-empty-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }
    
    .folder-empty-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }
    
    .folder-empty-desc {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    
    .folder-empty-cta {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: opacity 0.15s;
    }
    
    .folder-empty-cta:hover {
      opacity: 0.9;
    }
    
    /* Folder Search Floating Panel - like AI Q&A panel */
    .folder-search-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
      z-index: 1000;
      animation: folderSearchSlideIn 0.2s ease-out;
      display: flex;
      flex-direction: column;
    }
    
    .folder-search-panel.hidden {
      display: none;
    }
    
    @keyframes folderSearchSlideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }
    
    .folder-search-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    
    .folder-search-overlay.hidden {
      display: none;
    }
    
    .folder-search-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .folder-search-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .folder-search-close {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
    }
    
    .folder-search-close:hover {
      background: var(--bg-hover);
      color: var(--text);
    }
    
    .folder-search-content {
      padding: 16px 20px;
      flex: 1;
      overflow-y: auto;
    }
    
    .folder-search-input-wrapper {
      display: flex;
      gap: 8px;
    }
    
    .folder-search-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--bg-secondary);
      color: var(--text);
      font-size: 14px;
    }
    
    .folder-search-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .folder-search-input::placeholder {
      color: var(--text-muted);
    }
    
    .folder-search-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    
    .folder-search-btn:hover {
      opacity: 0.9;
    }
    
    .folder-search-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .folder-search-shortcut {
      font-size: 11px;
      opacity: 0.7;
    }
    
    .folder-search-results {
      margin-top: 16px;
      max-height: 40vh;
      overflow-y: auto;
    }
    
    /* Folder Ask Trigger Button */
    .folder-ask-trigger {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      background: var(--bg-secondary);
    }
    
    .folder-ask-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 14px 18px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .folder-ask-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
      color: var(--text);
    }
    
    .folder-ask-icon {
      font-size: 16px;
    }
    
    .folder-search-result {
      padding: 12px;
      border-radius: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .folder-search-result:hover {
      border-color: var(--accent);
    }
    
    .folder-search-result-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .folder-search-result-snippet {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.5;
    }
    
    .folder-search-result-snippet mark {
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent);
      padding: 1px 2px;
      border-radius: 2px;
    }
    
    .folder-search-loading {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 13px;
    }
    
    .folder-search-empty {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 13px;
    }
    
    /* Main content */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Header */
    .header {
      padding: 12px 20px 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg);
      -webkit-app-region: drag;
      min-height: 52px;
    }
    
    /* When sidebar is collapsed, add padding for traffic lights */
    .sidebar.collapsed + .main .header {
      padding-left: 80px;
    }
    
    /* Logo shown when sidebar collapsed */
    .collapsed-logo {
      display: none;
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      align-items: center;
      gap: 6px;
    }
    
    .collapsed-logo img {
      width: 28px;
      height: 28px;
      object-fit: contain;
    }
    
    .sidebar.collapsed + .main .collapsed-logo {
      display: inline-flex;
    }
    
    /* Hide new note button when sidebar is visible (not collapsed) */
    .new-note-btn {
      display: none;
    }
    
    /* Show new note button when sidebar is collapsed */
    .sidebar.collapsed + .main .new-note-btn {
      display: flex;
    }
    
    /* Always show search when window is wide enough (> 650px) */
    .global-search-wrapper {
      display: flex;
    }
    
    /* On narrow screens (< 650px), hide search when sidebar is open */
    @media (max-width: 650px) {
      .global-search-wrapper {
        display: none;
      }
      
      .sidebar.collapsed + .main .global-search-wrapper {
        display: flex;
      }
    }
    
    /* On very narrow screens (< 500px), hide logo to make room */
    @media (max-width: 500px) {
      .collapsed-logo {
        display: none !important;
      }
      
      body.viewing-note .collapsed-logo,
      body.recording-mode .collapsed-logo,
      .sidebar.collapsed + .main .collapsed-logo {
        display: none !important;
      }
      
      /* Reduce header padding on narrow screens */
      .sidebar.collapsed + .main .header,
      body.viewing-note .header,
      body.recording-mode .header {
        padding-left: 70px;
      }
      
      /* Hide New button when viewing a note on narrow screens */
      body.viewing-note .new-note-btn {
        display: none !important;
      }
      
      /* Show New button when NOT viewing a note (home screen) */
      .sidebar.collapsed + .main .new-note-btn {
        display: flex;
      }
      
      /* Shrink search on narrow screens */
      .global-search-wrapper {
        max-width: 150px;
        min-width: 100px;
      }
      
      /* Compact header buttons on narrow screens */
      .header-btn {
        padding: 6px 10px;
        font-size: 12px;
      }
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .back-btn {
      width: 32px;
      height: 32px;
      display: none; /* Hidden by default */
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      -webkit-app-region: no-drag;
      transition: all 0.15s;
    }
    
    .back-btn:not(.hidden) {
      display: flex; /* Show when not hidden */
    }
    
    body.viewing-note .back-btn {
      display: flex; /* Show when viewing a note */
    }
    
    .back-btn:hover {
      background: var(--bg-secondary);
      color: var(--text);
    }
    
    .toggle-sidebar-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 16px;
      -webkit-app-region: no-drag;
    }
    
    .toggle-sidebar-btn:hover {
      background: var(--bg-secondary);
    }
    
    /* Global Search Styles */
    .global-search-wrapper {
      flex: 1;
      max-width: 400px;
      margin: 0 16px;
    }
    
    .global-search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: all 0.15s;
      -webkit-app-region: no-drag;
    }
    
    .global-search-input::placeholder {
      color: var(--text-muted);
    }
    
    .global-search-input:focus {
      border-color: var(--accent);
      background: var(--bg);
    }
    
    .global-search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }
    
    .global-search-wrapper {
      position: relative;
    }
    
    /* Search Results in Right Panel */
    .search-results-view {
      padding: 16px 24px;
    }
    
    .search-results-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .search-back-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    
    .search-back-btn:hover {
      background: var(--bg-secondary);
      color: var(--text);
    }
    
    .search-results-title {
      font-size: 14px;
      color: var(--text-muted);
      flex: 1;
    }
    
    .search-results-clear {
      flex-shrink: 0;
    }
    
    .search-results-clear {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .search-results-clear:hover {
      background: var(--bg-secondary);
    }
    
    .search-date-group {
      margin-bottom: 24px;
    }
    
    .search-date-header {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .search-result-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 8px;
    }
    
    .search-result-item:hover {
      background: var(--bg-secondary);
    }
    
    .search-result-icon {
      width: 40px;
      height: 40px;
      background: var(--bg-secondary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .search-result-icon svg {
      width: 20px;
      height: 20px;
      color: var(--text-muted);
    }
    
    .search-result-content {
      flex: 1;
      min-width: 0;
    }
    
    .search-result-title {
      font-weight: 500;
      font-size: 14px;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .search-result-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    
    .search-result-snippet {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    .search-result-snippet mark {
      background: rgba(250, 204, 21, 0.3);
      color: var(--text);
      padding: 0 2px;
      border-radius: 2px;
    }
    
    .search-result-time {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .search-section {
      margin-bottom: 24px;
    }
    
    .search-section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .search-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    
    .search-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-right: 12px;
      -webkit-app-region: no-drag;
      position: relative;
      z-index: 10;
    }
    
    .window-controls {
      display: flex;
      gap: 4px;
      margin-left: 8px;
    }
    
    .window-ctrl-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 6px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .window-ctrl-btn:hover {
      background: var(--border);
      color: var(--text);
    }
    
    .window-ctrl-btn.close:hover {
      background: #ef4444;
      color: white;
    }
    
    .header-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 16px;
    }
    
    .header-btn:hover {
      background: var(--bg-secondary);
    }
    
    .save-status {
      font-size: 12px;
      color: var(--text-muted);
      padding: 4px 8px;
    }
    
    .header-icon-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: background 0.15s;
      opacity: 0.7;
      -webkit-app-region: no-drag;
      position: relative;
      z-index: 10;
    }
    
    .header-icon-btn:hover {
      background: var(--bg-secondary);
      opacity: 1;
    }
    
    /* Notes View Toggle (Raw Notes vs AI Enhanced) */
    .notes-view-toggle-wrapper {
      display: none;
      align-items: center;
      gap: 8px;
      -webkit-app-region: no-drag;
    }
    
    .notes-view-toggle-wrapper.visible {
      display: flex;
    }
    
    .notes-view-toggle {
      display: flex;
      align-items: center;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 4px;
      gap: 2px;
    }
    
    .notes-view-toggle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
    }
    
    .notes-view-toggle-btn:hover {
      background: var(--bg-hover);
      color: var(--text);
    }
    
    .notes-view-toggle-btn.active {
      background: var(--accent);
      color: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .notes-view-toggle-btn svg {
      width: 18px;
      height: 18px;
    }
    
    /* Template dropdown in toggle area */
    .template-dropdown-wrapper {
      position: relative;
    }
    
    .template-dropdown-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    
    .template-dropdown-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
    }
    
    .template-dropdown-btn svg {
      width: 12px;
      height: 12px;
      opacity: 0.6;
    }
    
    .template-dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      min-width: 260px;
      max-height: 350px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .template-dropdown-menu.show {
      display: block;
    }
    
    .template-dropdown-header {
      padding: 10px 14px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      letter-spacing: 0.5px;
    }
    
    .template-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      color: var(--text);
      font-size: 14px;
    }
    
    .template-dropdown-item:hover {
      background: var(--bg-hover);
    }
    
    .template-dropdown-item.ai-suggested {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
      border-bottom: 1px solid var(--border);
    }
    
    .template-dropdown-item.ai-suggested:hover {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.1));
    }
    
    .template-dropdown-item .template-icon {
      font-size: 18px;
    }
    
    .template-dropdown-item .template-name {
      flex: 1;
    }
    
    .template-dropdown-item .ai-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--accent);
      color: white;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .template-dropdown-item.current {
      background: var(--accent-bg);
    }
    
    .template-dropdown-item.current::after {
      content: '';
      color: var(--accent);
      font-weight: 600;
    }
    
    .template-dropdown-loading {
      padding: 16px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }
    
    .template-dropdown-no-suggestion {
      padding: 12px 14px;
      color: var(--text-muted);
      font-size: 12px;
      font-style: italic;
      border-bottom: 1px solid var(--border);
    }
    
    .template-dropdown-ai-loading {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      color: var(--text-muted);
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), transparent);
    }
    
    .spinner-small {
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    .header-btn {
      background: var(--bg-secondary);
      color: var(--text);
      border: 1px solid var(--border);
      -webkit-app-region: no-drag;
      position: relative;
      z-index: 10;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      padding: 6px 20px;
      border-radius: 6px;
      transition: all 0.15s;
      white-space: nowrap;
      min-width: fit-content;
    }
    
    .header-btn:hover {
      background: var(--bg-hover);
      border-color: var(--text-muted);
    }
    
    .header-btn:active {
      transform: translateY(0);
    }
    
    /* Editor content */
    .editor-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      min-height: 0; /* Critical: allow shrinking below content size */
      overflow: hidden;
    }
    
    .editor-scroll {
      flex: 1;
      overflow-y: auto;
      display: flex;
      justify-content: center;
      min-height: 0; /* Allow flex shrinking */
    }
    
    .editor-inner {
      width: 100%;
      max-width: 900px;
      padding: 32px 40px 40px;
    }
    
    /* Recording mode - narrower window, more compact layout */
    /* Force sidebar to be hidden in recording mode */
    /* Default: Show home screen (notes panel visible, main content hidden) */
    /* Default state - show notes list */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }
    
    .notes-home {
      display: flex;
    }
    
    /* When viewing a note, hide notes list and show editor */
    body.viewing-note .notes-home {
      display: none;
    }
    
    body.viewing-note .editor-content {
      display: flex !important;
    }
    
    /* When viewing a note (editor active), hide sidebar */
    body.viewing-note .sidebar {
      display: none;
    }
    
    body.viewing-note .main {
      width: 100%;
    }
    
    body.viewing-note .back-btn {
      display: flex !important;
    }
    
    body.viewing-note .toggle-sidebar-btn {
      display: none;
    }
    
    body.viewing-note .collapsed-logo {
      display: inline-flex !important;
    }
    
    /* Add padding for traffic lights when viewing a note (sidebar hidden) */
    body.viewing-note .header {
      padding-left: 80px;
    }
    
    /* Recording mode - hide sidebar only */
    body.recording-mode .sidebar {
      margin-left: -240px !important;
    }
    
    /* Show logo when in recording mode since sidebar is hidden */
    body.recording-mode .collapsed-logo {
      display: inline-flex !important;
    }
    
    /* Add padding for traffic lights in recording mode */
    body.recording-mode .header {
      padding-left: 80px;
    }
    
    body.recording-mode .editor-inner {
      max-width: none;
      padding: 24px 16px 80px;
    }
    
    body.recording-mode .meeting-title {
      font-size: 22px;
    }
    
    body.recording-mode .notes-area {
      margin-top: 12px;
    }
    
    body.recording-mode .tiptap-editor {
      min-height: 200px;
      max-height: none;
      font-size: 15px;
      padding: 12px 14px;
    }
    
    body.recording-mode .editor-toolbar {
      padding: 6px 10px;
      gap: 2px;
    }
    
    body.recording-mode .toolbar-btn {
      width: 28px;
      height: 28px;
      font-size: 12px;
    }
    
    body.recording-mode .transcript-section {
      margin-top: 8px;
    }
    
    .meeting-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 12px;
      outline: none;
      line-height: 1.3;
    }
    
    .meeting-title:empty:before {
      content: attr(data-placeholder);
      color: var(--text-muted);
    }
    
    .meeting-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text);
      font-size: 13px;
      font-weight: 500;
      cursor: default;
      transition: all 0.15s;
    }
    
    .meta-badge:hover {
      background: var(--bg-secondary);
    }
    
    .meta-badge-icon {
      font-size: 14px;
    }
    
    .meta-badge.participants {
      padding-left: 6px;
    }
    
    .meta-badge .avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 11px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .meta-badge.add-folder {
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .meta-badge.add-folder:hover {
      border-color: #9ca3af;
    }
    
    .meta-badge.add-folder.has-folder {
      color: var(--text);
      background: var(--bg-hover);
      border-color: var(--accent);
    }
    
    /* Attendees Badge & Dropdown */
    .attendees-wrapper {
      position: relative;
    }
    
    .attendees-badge {
      cursor: pointer;
      background: #374151;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    .attendees-badge:hover {
      background: #4b5563;
    }
    
    .attendees-icon {
      font-size: 12px;
    }
    
    .attendees-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      min-width: 320px;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 100;
      overflow: hidden;
    }
    
    .attendees-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #374151;
      font-weight: 500;
      color: #e5e7eb;
    }
    
    .attendees-add-btn {
      background: none;
      border: none;
      color: #60a5fa;
      font-size: 13px;
      cursor: pointer;
    }
    
    .attendees-add-btn:hover {
      color: #93c5fd;
    }
    
    .attendees-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .attendees-org {
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    
    .attendees-org:hover {
      background: #374151;
    }
    
    .attendee-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      cursor: pointer;
    }
    
    .attendee-item:hover {
      background: #374151;
    }
    
    .attendee-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #e5e7eb;
      flex-shrink: 0;
    }
    
    .attendee-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .attendee-avatar.group {
      background: #374151;
      font-size: 16px;
    }
    
    .attendee-info {
      flex: 1;
      min-width: 0;
    }
    
    .attendee-name {
      font-size: 14px;
      font-weight: 500;
      color: #e5e7eb;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .attendee-detail {
      font-size: 12px;
      color: #9ca3af;
    }
    
    .attendee-self {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .attendee-actions {
      display: flex;
      gap: 8px;
    }
    
    .attendee-action-btn {
      width: 32px;
      height: 32px;
      border: 1px solid #4b5563;
      border-radius: 6px;
      background: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #9ca3af;
      font-size: 14px;
    }
    
    .attendee-action-btn:hover {
      background: #4b5563;
      color: #e5e7eb;
    }
    
    .notes-area {
      flex: 1;
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      min-height: 400px; /* Ensure substantial height */
    }
    
    /* Editor Toolbar - minimal, floating style */
    .editor-toolbar {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      background: var(--bg-secondary);
      border-radius: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      border: 1px solid var(--border);
    }
    
    .toolbar-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }
    
    .toolbar-btn:hover {
      background: var(--bg-hover);
      color: var(--text);
    }
    
    .toolbar-btn.is-active {
      background: var(--accent);
      color: white;
    }
    
    .toolbar-divider {
      width: 1px;
      height: 20px;
      background: var(--border);
      margin: 0 4px;
    }
    
    /* TipTap Editor Container - borderless, clean */
    .tiptap-editor {
      flex: 1;
      min-height: 350px;
      overflow-y: auto;
      padding: 0;
      border: none;
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      font-size: 16px;
      line-height: 1.7;
      color: var(--text);
    }
    
    .tiptap-editor:focus {
      outline: none;
    }
    
    /* TipTap Content Styles */
    .tiptap-editor .ProseMirror {
      outline: none;
      min-height: 250px;
    }
    
    .tiptap-editor .ProseMirror p.is-editor-empty:first-child::before {
      content: attr(data-placeholder);
      color: #9ca3af;
      pointer-events: none;
      float: left;
      height: 0;
    }
    
    .tiptap-editor h1 {
      font-size: 1.875rem;
      font-weight: 700;
      margin: 1rem 0 0.5rem;
      line-height: 1.3;
    }
    
    .tiptap-editor h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 1rem 0 0.5rem;
      line-height: 1.35;
    }
    
    .tiptap-editor h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0.75rem 0 0.5rem;
      line-height: 1.4;
    }
    
    .tiptap-editor p {
      margin: 0.5rem 0;
    }
    
    .tiptap-editor ul, .tiptap-editor ol {
      padding-left: 1.5rem;
      margin: 0.5rem 0;
    }
    
    .tiptap-editor li {
      margin: 0.25rem 0;
    }
    
    .tiptap-editor ul[data-type="taskList"] {
      list-style: none;
      padding-left: 0;
    }
    
    .tiptap-editor ul[data-type="taskList"] li {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    
    .tiptap-editor ul[data-type="taskList"] li > label {
      flex-shrink: 0;
      margin-top: 4px;
    }
    
    .tiptap-editor ul[data-type="taskList"] li > div {
      flex: 1;
    }
    
    .tiptap-editor ul[data-type="taskList"] input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    
    .tiptap-editor blockquote {
      border-left: 3px solid var(--accent);
      padding-left: 1rem;
      margin: 0.75rem 0;
      color: var(--text-secondary);
      font-style: italic;
    }
    
    .tiptap-editor code {
      background: var(--bg-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.9em;
    }
    
    .tiptap-editor pre {
      background: #1e1e2e;
      color: #e8e8f0;
      padding: 12px 16px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 0.75rem 0;
    }
    
    .tiptap-editor pre code {
      background: none;
      padding: 0;
      color: inherit;
    }
    
    .tiptap-editor hr {
      border: none;
      border-top: 2px solid var(--border);
      margin: 1.5rem 0;
    }
    
    .tiptap-editor a {
      color: var(--accent);
      text-decoration: underline;
    }
    
    .tiptap-editor strong {
      font-weight: 600;
    }
    
    .tiptap-editor em {
      font-style: italic;
    }
    
    .tiptap-editor s {
      text-decoration: line-through;
    }
    
    .tiptap-editor u {
      text-decoration: underline;
    }
    
    .tiptap-editor img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 12px 0;
      cursor: pointer;
      transition: box-shadow 0.2s ease;
    }
    
    .tiptap-editor img:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }
    
    .tiptap-editor img.ProseMirror-selectednode {
      outline: 3px solid var(--accent);
      outline-offset: 2px;
    }
    
    /* Image resize handles */
    .tiptap-editor .image-resizer {
      display: inline-block;
      position: relative;
    }
    
    .tiptap-editor .image-resizer img {
      display: block;
    }
    
    /* Legacy textarea (hidden but kept for compatibility) */
    .notes-editor {
      width: 100%;
      min-height: 400px;
      border: none;
      font-size: 16px;
      line-height: 1.8;
      color: var(--text);
      resize: none;
      outline: none;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      background: transparent;
    }
    
    .notes-editor::placeholder {
      color: #9ca3af;
    }
    
    /* Markdown-style formatting in contenteditable */
    .rich-editor {
      min-height: 400px;
      outline: none;
      font-size: 16px;
      line-height: 1.8;
      color: var(--text);
    }
    
    .rich-editor:empty:before {
      content: 'Write notes...';
      color: #9ca3af;
    }
    
    .rich-editor h1 {
      font-size: 24px;
      font-weight: 600;
      margin: 24px 0 8px;
    }
    
    .rich-editor h2 {
      font-size: 20px;
      font-weight: 600;
      margin: 20px 0 8px;
    }
    
    .rich-editor ul, .rich-editor ol {
      margin: 8px 0;
      padding-left: 24px;
    }
    
    .rich-editor li {
      margin: 4px 0;
    }
    
    .rich-editor p {
      margin: 8px 0;
    }
    
    /* Header actions (Share, Link, More) */
    .editor-header-actions {
      position: absolute;
      top: 20px;
      right: 24px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .header-action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .header-action-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--border);
    }
    
    .header-action-btn.icon-only {
      padding: 8px 10px;
    }
    
    /* Footer */
    .footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      background: var(--bg);
      min-height: 72px;
    }
    
    .footer-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .recording-status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-radius: 24px;
    }
    
    .audio-indicator {
      display: flex;
      align-items: center;
      gap: 3px;
      height: 16px;
    }
    
    .audio-bar {
      width: 4px;
      height: 16px;
      background: var(--accent);
      border-radius: 2px;
      transform-origin: center;
      animation: audioWave 0.5s ease-in-out infinite;
    }
    
    .audio-bar:nth-child(1) { animation-delay: 0s; }
    .audio-bar:nth-child(2) { animation-delay: 0.1s; }
    .audio-bar:nth-child(3) { animation-delay: 0.2s; }
    
    @keyframes audioWave {
      0%, 100% { transform: scaleY(0.5); }
      50% { transform: scaleY(1); }
    }
    
    .audio-indicator.paused .audio-bar {
      animation: none;
      transform: scaleY(0.5);
      background: var(--text-muted);
    }
    
    .stop-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--text);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
    }
    
    .stop-btn:hover {
      opacity: 0.8;
    }
    
    .ask-input {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border-radius: 24px;
      margin-left: 16px;
    }
    
    .ask-input input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 14px;
      color: var(--text);
      outline: none;
    }
    
    .ask-input input::placeholder {
      color: var(--text-muted);
    }
    
    .quick-action {
      padding: 6px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .quick-action:hover {
      background: var(--bg-secondary);
    }
    
    .show-transcript-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--accent);
      border: none;
      border-radius: 20px;
      color: white;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }
    
    .show-transcript-btn:hover {
      opacity: 0.9;
    }
    
    /* Scrollbar */
    .sidebar ::-webkit-scrollbar {
      width: 6px;
    }
    
    .sidebar ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .sidebar ::-webkit-scrollbar-thumb {
      background: #3a3a4a;
      border-radius: 3px;
    }
    
    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 40px;
      overflow-y: auto;
    }
    
    .empty-state.centered {
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    /* Calendar section - "Coming up" area */
    .calendar-section {
      margin-bottom: 24px;
      padding: 20px 24px;
      background: var(--bg-secondary);
      border-radius: 16px;
      border: 1px solid var(--border);
    }
    
    [data-theme="dark"] .calendar-section {
      background: rgba(255, 255, 255, 0.03);
      border-color: rgba(255, 255, 255, 0.08);
    }
    
    [data-theme="light"] .calendar-section {
      background: rgba(0, 0, 0, 0.015);
      border-color: rgba(0, 0, 0, 0.05);
    }
    
    [data-theme="light"] .note-item {
      background: #fff;
      border-color: #e0e4e8;
    }
    
    [data-theme="light"] .calendar-event {
      background: #fff;
      border-color: #e0e4e8;
    }
    
    /* Templates modal theme support */
    [data-theme="light"] .templates-modal-content {
      background: #fff;
    }
    
    [data-theme="light"] .templates-modal-sidebar {
      background: #f5f5f7;
    }
    
    [data-theme="light"] .template-section-item {
      background: #f5f5f7;
    }
    
    [data-theme="light"] .template-list-item {
      background: transparent;
    }
    
    [data-theme="light"] .template-list-item:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    
    [data-theme="light"] .template-list-item.active {
      background: var(--accent);
    }
    
    [data-theme="dark"] .templates-modal-content {
      background: #1e1e2e;
    }
    
    [data-theme="dark"] .templates-modal-sidebar {
      background: #151520;
    }
    
    [data-theme="dark"] .template-section-item {
      background: #252538;
      border-color: #353548;
    }
    
    [data-theme="dark"] .template-context-input {
      background: #252538;
      border-color: #353548;
    }
    
    [data-theme="dark"] .template-edit-icon-picker {
      background: #252538;
      border-color: #353548;
    }
    
    [data-theme="dark"] .template-edit-icon-dropdown {
      background: #1e1e2e;
      border-color: #353548;
    }
    
    /* Past notes section styling */
    .past-notes-wrapper {
      margin-top: 8px;
    }
    
    .past-notes-wrapper .date-header:first-child {
      margin-top: 0;
      border-top: none;
      padding-top: 0;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .section-header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .section-title {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
    }
    
    .show-more-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 14px;
      cursor: pointer;
      padding: 4px 8px;
    }
    
    .show-more-btn:hover {
      text-decoration: underline;
    }
    
    .btn-connect-calendar:hover {
      background: var(--bg-hover) !important;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }
    
    .connect-btn {
      padding: 8px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
    }
    
    .connect-btn:hover {
      opacity: 0.9;
    }
    
    .calendar-events {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .calendar-day-header {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
      margin-bottom: -4px;
    }
    
    .calendar-day-header:first-child {
      margin-top: 0;
    }
    
    .calendar-event {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s;
      width: 100%; /* Scale with container width */
    }
    
    .calendar-event:hover {
      border-color: var(--accent);
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    
    .calendar-event.now {
      border-color: var(--accent);
      background: var(--accent-bg);
    }
    
    .event-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px 10px;
      background: var(--bg-secondary);
      border-radius: 8px;
      min-width: 52px;
      flex-shrink: 0;
    }
    
    .event-date.now {
      background: var(--accent);
      color: white;
    }
    
    .event-month {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .event-day {
      font-size: 22px;
      font-weight: 700;
      line-height: 1;
    }
    
    .event-info {
      flex: 1;
      min-width: 0; /* Allow text truncation */
    }
    
    .event-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .event-time {
      font-size: 12px;
      color: var(--accent);
      font-weight: 500;
    }
    
    .event-time.now-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .event-time.now-badge::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .event-join {
      padding: 6px 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.15s;
      flex-shrink: 0;
    }
    
    .calendar-event:hover .event-join {
      opacity: 1;
    }
    
    .no-events {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
    
    .no-events-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    .empty-icon {
      width: 80px;
      height: 80px;
      margin-bottom: 24px;
      opacity: 0.8;
    }
    
    .empty-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .empty-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
    }
    
    .empty-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 32px;
      max-width: 300px;
      line-height: 1.5;
    }
    
    .empty-cta {
      padding: 14px 28px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    
    .empty-cta:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .empty-hint {
      margin-top: 24px;
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Setup/Permissions Screen */
    .setup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .setup-container {
      max-width: 520px;
      padding: 24px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .setup-icon {
      width: 60px;
      height: 60px;
      margin-bottom: 16px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    }
    
    .setup-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .setup-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }
    
    .setup-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    /* Step indicator */
    .setup-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      gap: 0;
    }
    
    .setup-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    
    .setup-step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    
    .setup-step.active .setup-step-number {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .setup-step.complete .setup-step-number {
      background: #4caf50;
      border-color: #4caf50;
      color: white;
    }
    
    .setup-step-label {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .setup-step.active .setup-step-label {
      color: var(--text);
      font-weight: 600;
    }
    
    .setup-step-line {
      width: 40px;
      height: 2px;
      background: var(--border);
      margin: 0 8px;
      margin-bottom: 20px;
    }
    
    /* Setup screens */
    .setup-screen {
      text-align: left;
    }
    
    .setup-screen-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 16px;
      text-align: center;
    }
    
    .setup-nav-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .setup-btn-secondary {
      flex: 1;
      padding: 12px 32px;
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .setup-btn-secondary:hover {
      background: var(--bg-hover);
    }
    
    .setup-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      font-family: 'SF Mono', Monaco, monospace;
      transition: all 0.2s;
    }
    
    .setup-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-secondary);
    }
    
    .setup-input::placeholder {
      color: var(--text-muted);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .setup-link {
      font-size: 11px;
      color: var(--accent);
      text-decoration: none;
      margin-top: 6px;
      display: inline-block;
      transition: opacity 0.2s;
    }
    
    .setup-link:hover {
      opacity: 0.8;
    }
    
    .setup-checklist {
      text-align: left;
      margin-bottom: 20px;
    }
    
    .setup-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    
    .setup-item.complete {
      background: var(--setup-complete-bg, #ecfdf5);
      border-color: var(--setup-complete-border, #a7f3d0);
    }
    
    .setup-item.error {
      background: var(--setup-error-bg, #fef2f2);
      border-color: var(--setup-error-border, #fecaca);
    }
    
    .setup-item-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: var(--bg-hover);
      color: var(--text-secondary);
      flex-shrink: 0;
    }
    
    .setup-item.complete .setup-item-icon {
      background: var(--accent);
      color: white;
      font-size: 16px;
      font-weight: bold;
    }
    
    .setup-item.error .setup-item-icon {
      background: #ef4444;
      color: white;
    }
    
    .setup-item-text {
      flex: 1;
    }
    
    .setup-item-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
      margin-bottom: 2px;
    }
    
    .setup-item.complete .setup-item-title {
      color: var(--setup-complete-text, #047857);
    }
    
    .setup-item-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .setup-item-action {
      padding: 7px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 7px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    
    .setup-item-action:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .setup-item.complete .setup-item-action {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
    }
    
    /* Transcription Choice Styles */
    .setup-item-choice {
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
    }
    
    .setup-choice-buttons {
      display: flex;
      gap: 10px;
      width: 100%;
    }
    
    .setup-choice-btn {
      flex: 1;
      padding: 12px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    
    .setup-choice-btn:hover {
      border-color: var(--accent);
      background: rgba(76, 158, 255, 0.05);
    }
    
    .setup-choice-btn.selected {
      border-color: var(--accent);
      background: rgba(76, 158, 255, 0.1);
    }
    
    .setup-choice-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }
    
    .setup-choice-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
    }
    
    .setup-choice-badge {
      padding: 2px 7px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .setup-badge-cloud {
      background: rgba(76, 158, 255, 0.2);
      color: var(--accent);
    }
    
    .setup-badge-local {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }
    
    .setup-badge-beta {
      background: rgba(255, 152, 0, 0.2);
      color: #ff9800;
    }
    
    .setup-choice-benefit {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.3;
    }
    
    /* Parakeet inline download */
    .parakeet-download-inline {
      margin-top: 12px;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    
    .parakeet-info-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 12px;
      font-size: 11px;
      margin-bottom: 12px;
    }
    
    .parakeet-info-label {
      color: var(--text-muted);
    }
    
    .parakeet-info-value {
      color: var(--text);
      font-weight: 500;
    }
    
    .parakeet-progress {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .parakeet-progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s;
      border-radius: 3px;
    }
    
    /* Animated indeterminate progress bar */
    .parakeet-progress-indeterminate .parakeet-progress-animated,
    .llm-progress-indeterminate {
      width: 30%;
      animation: indeterminate 1.5s infinite ease-in-out;
    }
    
    @keyframes indeterminate {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(400%); }
    }
    
    .setup-progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .setup-progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s;
      border-radius: 3px;
    }
    
    .setup-progress-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
      text-align: center;
    }
    
    .parakeet-progress-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
      text-align: center;
    }
    
    .setup-btn-danger {
      padding: 8px 16px;
      background: transparent;
      color: #ef4444;
      border: 1px solid #ef4444;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .setup-btn-danger:hover {
      background: #ef4444;
      color: white;
    }
    
    .setup-btn {
      padding: 12px 32px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .setup-btn:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .setup-btn:disabled {
      background: var(--bg-hover);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }
    
    /* Settings Modal Overlay */
    .settings-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .settings-overlay.hidden {
      display: none;
    }
    
    .settings-panel {
      position: relative;
      width: 100%;
      max-width: 800px;
      min-height: 500px;
      max-height: calc(100vh - 40px);
      background: var(--bg-sidebar);
      border-radius: 16px;
      display: flex;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }
    
    .settings-sidebar {
      width: 200px;
      background: var(--bg-sidebar);
      display: flex;
      flex-direction: column;
      padding: 16px 0;
      flex-shrink: 0;
      border-right: 1px solid rgba(255,255,255,0.1);
    }
    
    .settings-title {
      font-size: 18px;
      font-weight: 700;
      padding: 8px 16px 16px;
      color: var(--text-sidebar);
    }
    
    .settings-nav {
      flex: 1;
    }
    
    .settings-nav-section {
      padding: 8px 16px 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-sidebar-muted);
    }
    
    .settings-nav-item {
      width: calc(100% - 16px);
      margin: 0 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: none;
      border: none;
      font-size: 14px;
      color: var(--text-sidebar);
      cursor: pointer;
      text-align: left;
      border-radius: 8px;
      transition: background 0.15s;
    }
    
    .settings-nav-item:hover {
      background: var(--bg-sidebar-hover);
    }
    
    .settings-nav-item.active {
      background: var(--accent);
      color: white;
    }
    
    .nav-icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }
    
    .settings-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      color: var(--text-sidebar);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      pointer-events: auto;
    }
    
    .settings-close-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .settings-close-btn:active {
      background: rgba(255,255,255,0.3);
      transform: scale(0.95);
    }
    
    .settings-main {
      flex: 1;
      padding: 24px 32px;
      overflow-y: auto;
      position: relative;
      background: var(--bg-sidebar);
    }
    
    .settings-main h3 {
      color: var(--text-sidebar);
    }
    
    .settings-main .settings-desc {
      color: var(--text-sidebar-muted);
    }
    
    .settings-tab {
      display: none;
    }
    
    .settings-tab.active {
      display: block;
    }
    
    /* Theme Selector */
    .theme-selector {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }
    
    .theme-option {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 20px 16px;
      background: var(--bg-sidebar-hover);
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text-sidebar);
    }
    
    .theme-option:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .theme-option.active {
      border-color: var(--accent);
      background: rgba(16, 185, 129, 0.15);
    }
    
    .theme-icon {
      font-size: 28px;
    }
    
    /* Calendar List in Settings */
    .section-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .section-header-row h3 {
      margin: 0;
    }
    
    .reset-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 13px;
      cursor: pointer;
    }
    
    .calendar-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .calendar-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .calendar-color {
      width: 12px;
      height: 12px;
      border-radius: 4px;
      flex-shrink: 0;
    }
    
    .calendar-name {
      flex: 1;
      font-size: 14px;
      color: var(--text-sidebar);
    }
    
    .calendar-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: #444;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .calendar-toggle.active {
      background: var(--accent);
    }
    
    .calendar-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    
    .calendar-toggle.active::after {
      transform: translateX(20px);
    }
    
    .settings-section {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .settings-section h3 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-sidebar);
    }
    
    .settings-desc {
      font-size: 13px;
      color: var(--text-sidebar-muted);
      margin-bottom: 12px;
    }
    
    .settings-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 13px;
      color: var(--text-sidebar-muted);
    }
    
    .settings-status .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }
    
    .settings-status .status-dot.active {
      background: #10b981;
    }
    
    .settings-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .settings-input-group input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      font-size: 13px;
      background: rgba(255,255,255,0.05);
      color: var(--text-sidebar);
    }
    
    .settings-input-group input::placeholder {
      color: var(--text-sidebar-muted);
    }
    
    .settings-input-group input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .settings-btn {
      padding: 10px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    
    .settings-btn:hover {
      opacity: 0.9;
    }
    
    .settings-btn-full {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    
    .settings-btn-full:hover {
      opacity: 0.9;
    }
    
    .settings-btn-full.connected {
      background: rgba(255,255,255,0.1);
      color: var(--text-sidebar);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .settings-link {
      font-size: 12px;
      color: var(--accent);
      text-decoration: none;
    }
    
    .settings-link:hover {
      text-decoration: underline;
    }
    
    /* Provider Toggle Buttons */
    .provider-toggle-group {
      display: flex;
      gap: 8px;
      margin: 12px 0;
    }
    
    .provider-toggle-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px 8px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .provider-toggle-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.2);
    }
    
    .provider-toggle-btn.selected {
      background: rgba(76, 175, 80, 0.15);
      border-color: #4CAF50;
    }
    
    .provider-toggle-btn .provider-icon {
      font-size: 20px;
    }
    
    .provider-toggle-btn .provider-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-sidebar);
    }
    
    .provider-toggle-btn .provider-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .provider-badge.cloud {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }
    
    .provider-badge.local {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }
    
    /* Active Provider Status */
    .active-provider-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(76, 175, 80, 0.1);
      border-radius: 6px;
      margin-bottom: 12px;
    }
    
    .active-provider-status .active-label {
      font-size: 12px;
      color: var(--text-sidebar-muted);
    }
    
    .active-provider-status .active-provider-name {
      font-size: 13px;
      font-weight: 600;
      color: #4CAF50;
    }
    
    /* Provider Config Sections */
    .provider-config {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
    }
    
    .provider-config-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .provider-config-header .config-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-sidebar);
    }
    
    .provider-config-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }
    
    .config-info {
      font-size: 12px;
      color: var(--text-sidebar-muted);
      margin: 8px 0;
    }
    
    .config-info.config-success {
      color: #4CAF50;
    }
    
    /* Danger Button */
    .settings-btn-danger {
      padding: 6px 12px;
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .settings-btn-danger:hover {
      background: rgba(239, 68, 68, 0.25);
      border-color: rgba(239, 68, 68, 0.5);
    }
    
    .settings-btn-danger:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Settings Progress Bar */
    .settings-progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .settings-progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s;
      border-radius: 3px;
    }
    
    .settings-progress-text {
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }
    
    /* Notification Settings */
    .settings-tab-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-sidebar);
      margin-bottom: 16px;
    }
    
    .setting-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      padding: 16px 0;
    }
    
    .setting-info {
      flex: 1;
    }
    
    .setting-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-sidebar);
      margin-bottom: 4px;
    }
    
    .setting-desc {
      font-size: 13px;
      color: var(--text-sidebar-muted);
      line-height: 1.4;
    }
    
    .setting-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: #444;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    
    .setting-toggle.active {
      background: var(--accent);
    }
    
    .setting-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    
    .setting-toggle.active::after {
      transform: translateX(20px);
    }
    
    .setting-divider {
      height: 1px;
      background: rgba(255,255,255,0.1);
    }
    
    .muted-apps-section {
      padding: 16px 0 0;
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: 16px;
    }
    
    .muted-apps-label {
      font-size: 13px;
      color: var(--text-sidebar-muted);
      margin-bottom: 12px;
    }
    
    .muted-apps-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .muted-app-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      font-size: 13px;
      color: var(--text-sidebar);
    }
    
    .muted-app-tag .remove-app {
      cursor: pointer;
      opacity: 0.6;
      font-size: 14px;
    }
    
    .muted-app-tag .remove-app:hover {
      opacity: 1;
    }
    
    .app-select-wrapper {
      position: relative;
    }
    
    .app-select {
      width: 100%;
      padding: 10px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--accent);
      border-radius: 8px;
      font-size: 14px;
      color: var(--text-sidebar);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }
    
    .app-select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .app-select option {
      background: #1e1e2e;
      color: var(--text-sidebar);
      padding: 8px;
    }
    
    /* Settings Select (language dropdowns) */
    .settings-select {
      width: 100%;
      padding: 12px 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      font-size: 14px;
      color: var(--text-sidebar);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      margin-top: 8px;
    }
    
    .settings-select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .settings-select option {
      background: #1e1e2e;
      color: var(--text-sidebar);
      padding: 10px;
    }
    
    .settings-hint {
      font-size: 12px;
      color: var(--text-sidebar-muted);
      margin-top: 8px;
      font-style: italic;
    }
    
    /* Generate Notes Button - shown above transcript */
    .generate-notes-wrapper {
      margin-top: 24px;
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .generate-notes-wrapper.hidden {
      display: none;
    }
    
    .generate-btn-with-dropdown {
      display: flex;
      align-items: stretch;
      position: relative;
    }
    
    .generate-notes-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 24px 0 0 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .generate-notes-btn:hover {
      filter: brightness(1.05);
    }
    
    .generate-template-dropdown-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 14px 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-left: 1px solid rgba(255,255,255,0.2);
      border-radius: 0 24px 24px 0;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .generate-template-dropdown-btn:hover {
      filter: brightness(1.1);
      background: var(--accent);
    }
    
    .generate-template-dropdown-btn svg {
      width: 14px;
      height: 14px;
      opacity: 0.8;
    }
    
    
    .generate-template-menu {
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 -4px 24px rgba(0,0,0,0.25);
      min-width: 240px;
      max-height: 320px;
      overflow-y: auto;
      z-index: 10000;
      display: none;
    }
    
    .generate-template-menu.show {
      display: block;
    }
    
    .generate-template-menu-header {
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      letter-spacing: 0.5px;
    }
    
    .generate-template-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      color: var(--text);
      font-size: 14px;
    }
    
    .generate-template-menu-item:hover {
      background: var(--bg-hover);
    }
    
    .generate-template-menu-item.selected {
      background: var(--accent-bg);
    }
    
    .generate-template-menu-item.selected::after {
      content: '';
      margin-left: auto;
      color: var(--accent);
      font-weight: 600;
    }
    
    .generate-template-menu-item .template-icon {
      font-size: 18px;
    }
    
    .generate-template-menu-item.ai-suggested {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
      border-bottom: 1px solid var(--border);
    }
    
    .generate-template-menu-item.ai-suggested:hover {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.1));
    }
    
    .generate-template-menu-item .ai-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--accent);
      color: white;
      border-radius: 4px;
      font-weight: 600;
      margin-left: auto;
    }
    
    .generate-template-menu-loading {
      padding: 16px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }
    
    .generate-notes-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    .generate-notes-btn svg {
      width: 20px;
      height: 20px;
    }
    
    .generate-notes-btn .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    /* Integrated Transcript Section */
    .transcript-section {
      margin-top: 32px;
      margin-bottom: 8px; /* Reduced from 24px to bring closer to bottom bar when collapsed */
      border-radius: 12px;
      background: var(--bg-secondary);
      overflow: hidden; /* Clip content to border-radius */
    }
    
    .transcript-header {
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      border-radius: 12px;
      user-select: none;
      transition: all 0.15s;
    }
    
    .transcript-section:not(.collapsed) .transcript-header {
      border-radius: 12px 12px 0 0;
    }
    
    .transcript-header:hover {
      background: var(--bg-hover);
    }
    
    .transcript-toggle {
      font-size: 10px;
      transition: transform 0.2s;
    }
    
    .transcript-section.collapsed .transcript-toggle {
      transform: rotate(-90deg);
    }
    
    .transcript-section.collapsed .transcript-content {
      display: none;
    }
    
    .transcript-count {
      margin-left: auto;
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .transcript-content {
      max-height: 280px;
      overflow-y: auto;
      padding: 16px 18px 20px;
      background: var(--bg-secondary);
      border-radius: 0 0 12px 12px;
      margin-bottom: 4px; /* Ensure bottom border visible */
    }
    
    .transcript-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 32px;
      color: var(--text-muted);
      font-size: 13px;
    }
    
    .transcript-bubbles {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .transcript-bubble {
      padding: 10px 14px;
      background: var(--bg);
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text);
    }
    
    .transcript-turn {
      padding: 14px 18px;
      background: var(--surface);
      border-radius: 12px;
      margin-bottom: 10px;
      border-left: 3px solid var(--speaker-color);
    }
    
    /* Timestamp without speaker label */
    .transcript-timestamp-only {
      font-size: 11px;
      font-weight: 400;
      color: var(--text-muted);
      opacity: 0.6;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Speaker label styling */
    .transcript-speaker {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-muted);
    }
    
    .speaker-badge {
      display: none;  /* Hidden - just show Speaker N text */
    }
    
    /* Interim (non-final) text shown in light grey */
    .interim-text {
      color: #999;
      font-style: italic;
    }
    
    .transcript-speaker .transcript-timestamp {
      margin-left: auto;
      font-weight: 400;
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.7;
    }
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .speaker-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .transcript-text {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text);
      font-weight: 400;
    }
    
    .transcript-timestamp {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }
    
    /* Interim (in-progress) transcript - shown in grey while Deepgram processes */
    .transcript-turn.transcript-interim {
      opacity: 0.6;
      border-style: dashed;
    }
    
    .transcript-turn.transcript-interim .transcript-text {
      color: var(--text-muted);
    }
    
    /* Speaker-colored left border */
    .transcript-turn[data-speaker] {
      border-left: 3px solid var(--speaker-color, var(--border));
    }
    
    /* AI Generating Banner */
    .ai-generating-banner {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      margin-bottom: 16px;
      font-size: 14px;
      font-weight: 500;
      animation: pulse-glow 2s ease-in-out infinite;
    }
    
    @keyframes pulse-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }
    
    .generating-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .transcript-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .transcript-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }
    
    .transcript-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      font-size: 14px;
    }
    
    .transcript-paused-msg {
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .transcript-bubble {
      background: var(--bg);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text);
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    
    .transcript-bubble:last-child {
      margin-bottom: 0;
    }
    
    .transcript-consent {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      margin: 16px 20px;
    }
    
    .transcript-consent a {
      color: var(--accent);
      text-decoration: none;
    }
    
    /* New Footer with Mic Controls */
    .editor-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg);
      flex-shrink: 0;
    }
    
    /* Footer - flex child at bottom */
    .editor-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--bg);
      border-top: 1px solid var(--border);
      flex-shrink: 0; /* Don't shrink, stay at bottom */
    }
    
    .footer-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .footer-center {
      flex: 1;
      max-width: 400px;
      margin: 0 20px;
    }
    
    .ask-input-wrapper {
      width: 100%;
      cursor: pointer;
    }
    
    .ask-input {
      width: 100%;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      color: var(--text);
      outline: none;
      transition: all 0.15s;
      cursor: pointer;
    }
    
    .ask-input:hover {
      background: var(--bg);
      border-color: var(--accent);
    }
    
    .ask-input::placeholder {
      color: #9ca3af;
    }
    
    /* AI Q&A Panel */
    .ai-qa-panel {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 600px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.15);
      z-index: 100;
      animation: slideUp 0.25s ease-out;
    }
    
    .ai-qa-panel.hidden {
      display: none;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    .ai-qa-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .ai-qa-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
    }
    
    .ai-qa-close {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 16px;
    }
    
    .ai-qa-close:hover {
      background: var(--bg-hover);
      color: var(--text);
    }
    
    .ai-qa-content {
      padding: 16px;
    }
    
    .ai-qa-question-area {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    
    .ai-qa-textarea {
      flex: 1;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      color: var(--text);
      resize: none;
      outline: none;
      line-height: 1.5;
      min-height: 44px;
      max-height: 120px;
    }
    
    .ai-qa-textarea:focus {
      border-color: var(--accent);
      background: var(--bg);
    }
    
    .ai-qa-textarea::placeholder {
      color: var(--text-muted);
    }
    
    .ai-qa-submit {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 12px 18px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    
    .ai-qa-submit:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .ai-qa-submit:disabled {
      background: var(--bg-hover);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }
    
    .ai-qa-shortcut {
      font-size: 11px;
      opacity: 0.7;
    }
    
    .ai-qa-answer {
      margin-top: 16px;
      padding: 14px;
      background: var(--accent-bg);
      border-radius: 10px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .ai-qa-answer-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .ai-qa-answer-content {
      font-size: 14px;
      line-height: 1.6;
      color: var(--text);
    }
    
    /* Markdown content styling */
    .ai-qa-answer-content h1,
    .ai-qa-answer-content h2,
    .ai-qa-answer-content h3,
    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3 {
      margin: 0 0 10px 0;
      font-weight: 600;
      color: var(--text);
    }
    
    .ai-qa-answer-content h1,
    .markdown-content h1 {
      font-size: 18px;
    }
    
    .ai-qa-answer-content h2,
    .markdown-content h2 {
      font-size: 16px;
    }
    
    .ai-qa-answer-content h3,
    .markdown-content h3 {
      font-size: 14px;
    }
    
    .ai-qa-answer-content ul,
    .ai-qa-answer-content ol,
    .markdown-content ul,
    .markdown-content ol {
      margin: 8px 0;
      padding-left: 20px;
    }
    
    .ai-qa-answer-content li,
    .markdown-content li {
      margin: 4px 0;
    }
    
    .ai-qa-answer-content p,
    .markdown-content p {
      margin: 0 0 10px 0;
    }
    
    .ai-qa-answer-content p:last-child,
    .markdown-content p:last-child {
      margin-bottom: 0;
    }
    
    .ai-qa-answer-content strong,
    .markdown-content strong {
      font-weight: 600;
      color: var(--text);
    }
    
    .ai-qa-answer-content em,
    .markdown-content em {
      font-style: italic;
    }
    
    .ai-qa-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .ai-qa-action-btn {
      padding: 6px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .ai-qa-action-btn:hover {
      background: var(--bg-secondary);
      color: var(--text);
      border-color: var(--accent);
    }
    
    .ai-qa-loading {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      padding: 14px;
      background: var(--bg-secondary);
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .ai-qa-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Recording mode adjustments for AI panel */
    body.recording-mode .ai-qa-panel {
      width: 95%;
      max-width: none;
      left: 50%;
    }
    
    .footer-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .quick-action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .quick-action-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--border);
    }
    
    .quick-action-icon {
      font-size: 14px;
    }
    
    .mic-control {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .mic-control:hover {
      background: var(--bg-secondary);
      border-color: var(--border);
    }
    
    .mic-control.recording {
      background: rgba(16, 185, 129, 0.08);
      border-color: #10b981;
    }
    
    .mic-icon {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    
    .mic-bar {
      width: 3px;
      height: 14px;
      background: #9ca3af;
      border-radius: 2px;
    }
    
    .mic-control.recording .mic-bar {
      background: #10b981;
      animation: micPulse 0.5s ease-in-out infinite alternate;
    }
    
    @keyframes micPulse {
      0% { transform: scaleY(0.5); }
      100% { transform: scaleY(1); }
    }
    
    .mic-bar:nth-child(2) { animation-delay: 0.1s; }
    .mic-bar:nth-child(3) { animation-delay: 0.2s; }
    
    .mic-chevron {
      font-size: 10px;
      color: #9ca3af;
      margin-left: 2px;
    }
    
    .mic-label {
      font-size: 14px;
      font-weight: 500;
      color: #10b981;
    }
    
    .mic-control.recording .mic-label {
      color: #10b981;
    }
    
    .language-selector {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 6px;
      transition: background 0.15s;
    }
    
    .language-selector:hover {
      background: var(--bg-secondary);
    }
    
    /* AI Notes Panel */
    .ai-notes-panel {
      margin-top: 20px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      padding: 16px;
    }
    
    .ai-notes-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .ai-notes-title {
      font-size: 14px;
      font-weight: 600;
      color: #8b5cf6;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-notes-badge {
      font-size: 10px;
      background: #8b5cf6;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 500;
    }
    
    .ai-generating {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .ai-generating .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid rgba(139, 92, 246, 0.3);
      border-top-color: #8b5cf6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .ai-notes-content {
      font-size: 13px;
      line-height: 1.6;
    }
    
    .ai-section {
      margin-bottom: 12px;
    }
    
    .ai-section:last-child {
      margin-bottom: 0;
    }
    
    .ai-section-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    
    .ai-section-content {
      color: var(--text);
    }
    
    .ai-list {
      margin: 0;
      padding-left: 20px;
    }
    
    .ai-list li {
      margin-bottom: 4px;
    }
    
    .ai-action-item {
      background: rgba(34, 197, 94, 0.1);
      border-left: 3px solid #22c55e;
      padding: 6px 10px;
      margin-bottom: 6px;
      border-radius: 0 6px 6px 0;
      font-size: 12px;
    }
    
    .ai-decision {
      background: rgba(59, 130, 246, 0.1);
      border-left: 3px solid #3b82f6;
      padding: 6px 10px;
      margin-bottom: 6px;
      border-radius: 0 6px 6px 0;
      font-size: 12px;
    }
    
    .ai-notes-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(139, 92, 246, 0.2);
    }
    
    .ai-btn {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
    }
    
    .ai-btn-primary {
      background: #8b5cf6;
      color: white;
    }
    
    .ai-btn-primary:hover {
      background: #7c3aed;
    }
    
    .ai-btn-secondary {
      background: rgba(139, 92, 246, 0.1);
      color: #8b5cf6;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }
    
    .ai-btn-secondary:hover {
      background: rgba(139, 92, 246, 0.2);
    }
    
    /* Floating Recording Indicator */
    .floating-recording-indicator {
      position: fixed;
      top: 80px; /* Moved down to avoid header drag region */
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: auto;
      -webkit-app-region: no-drag; /* Critical: prevent drag region from capturing clicks */
    }
    
    .floating-recording-indicator.hidden {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
      pointer-events: none;
    }
    
    .floating-recording-content {
      background: #2a2a3e;
      border-radius: 24px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      cursor: grab;
      transition: all 0.2s;
      pointer-events: auto;
      -webkit-app-region: no-drag; /* Allow clicks but prevent window dragging */
    }
    
    .floating-recording-content:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4);
    }
    
    .floating-recording-icon {
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
      pointer-events: none;
    }
    
    .recording-pulse-small {
      position: absolute;
      left: -4px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: translateY(-50%) scale(1); }
      50% { opacity: 0.5; transform: translateY(-50%) scale(1.2); }
    }
    
    .recording-bars {
      display: flex;
      align-items: center;
      gap: 3px;
      margin-left: 8px;
    }
    
    .recording-bars .bar {
      width: 3px;
      height: 14px;
      background: #10b981;
      border-radius: 2px;
      animation: barPulse 0.6s ease-in-out infinite alternate;
    }
    
    .recording-bars .bar:nth-child(2) {
      animation-delay: 0.1s;
    }
    
    .recording-bars .bar:nth-child(3) {
      animation-delay: 0.2s;
    }
    
    @keyframes barPulse {
      0% { height: 8px; }
      100% { height: 16px; }
    }
    
    .floating-recording-title {
      color: #e8e8f0;
      font-size: 14px;
      font-weight: 500;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      pointer-events: none;
    }
    
    .floating-recording-close {
      background: none;
      border: none;
      color: #e8e8f0;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.15s;
      opacity: 0.7;
      margin-left: 4px;
      pointer-events: auto;
    }
    
    .floating-recording-close:hover {
      background: rgba(255, 255, 255, 0.1);
      opacity: 1;
    }
    
    .ai-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 20px;
      font-size: 13px;
    }
    
    .ai-empty-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <!-- Floating Recording Indicator (shown when recording but not viewing editor) -->
  <div class="floating-recording-indicator hidden" id="floatingRecordingIndicator">
    <div class="floating-recording-content" id="floatingRecordingContent">
      <div class="floating-recording-icon">
        <div class="recording-pulse-small"></div>
        <span class="recording-bars">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </span>
      </div>
      <div class="floating-recording-title" id="floatingRecordingTitle">Untitled</div>
      <button class="floating-recording-close" id="floatingRecordingClose" title="Stop recording"></button>
    </div>
  </div>
  
  <!-- Setup/Permissions Overlay -->
  <div class="setup-overlay hidden" id="setupOverlay">
    <div class="setup-container">
      <div class="setup-icon"><img src="assets/logo.png" alt="IceCubes"></div>
      <div class="setup-title">Welcome to IceCubes</div>
      <div class="setup-subtitle">
        IceCubes needs a few things set up before it can record and transcribe your meetings.
      </div>
      
      <!-- Step indicator -->
      <div class="setup-steps">
        <div class="setup-step active" id="stepIndicator1">
          <div class="setup-step-number">1</div>
          <div class="setup-step-label">Permissions</div>
        </div>
        <div class="setup-step-line"></div>
        <div class="setup-step" id="stepIndicator2">
          <div class="setup-step-number">2</div>
          <div class="setup-step-label">Transcription</div>
        </div>
        <div class="setup-step-line"></div>
        <div class="setup-step" id="stepIndicator3">
          <div class="setup-step-number">3</div>
          <div class="setup-step-label">AI Setup</div>
        </div>
      </div>
      
      <!-- Step 1: Permissions -->
      <div class="setup-screen" id="setupScreen1">
        <div class="setup-screen-title">Grant Permissions</div>
      <div class="setup-checklist">
        <div class="setup-item" id="setupMic">
          <div class="setup-item-icon"></div>
          <div class="setup-item-text">
            <div class="setup-item-title">Microphone Access</div>
            <div class="setup-item-desc">Required to capture audio</div>
          </div>
          <button class="setup-item-action" id="setupMicBtn">Grant</button>
        </div>
        
        <div class="setup-item" id="setupScreen">
          <div class="setup-item-icon"></div>
          <div class="setup-item-text">
            <div class="setup-item-title">Screen Recording</div>
            <div class="setup-item-desc">Required to detect meetings</div>
          </div>
          <button class="setup-item-action" id="setupScreenBtn">Grant</button>
          </div>
        </div>
        <button class="setup-btn" id="setupNextBtn1" disabled>Next</button>
        </div>
        
      <!-- Step 2: Transcription Engine -->
      <div class="setup-screen hidden" id="setupScreen2">
        <div class="setup-screen-title">Choose Transcription</div>
        <div class="setup-checklist">
          <div class="setup-item setup-item-choice" id="setupTranscription">
          <div class="setup-item-icon"></div>
            <div class="setup-item-text">
              <div class="setup-item-title">Transcription Engine</div>
              <div class="setup-item-desc">Choose how to transcribe your meetings</div>
            </div>
            <div class="setup-choice-buttons">
              <button class="setup-choice-btn" id="setupChoiceDeepgram" data-engine="deepgram">
                <div class="setup-choice-header">
                  <span class="setup-choice-title">Deepgram</span>
                  <span class="setup-choice-badge setup-badge-cloud">Cloud</span>
                </div>
                <div class="setup-choice-benefit">Fast, accurate transcription with speaker detection in 35+ languages</div>
              </button>
              <button class="setup-choice-btn" id="setupChoiceParakeet" data-engine="parakeet">
                <div class="setup-choice-header">
                  <span class="setup-choice-title">Parakeet</span>
                  <span class="setup-choice-badge setup-badge-local">Local</span>
                  <span class="setup-choice-badge setup-badge-beta">Beta</span>
                </div>
                <div class="setup-choice-benefit">100% private offline transcription - free after ~670MB download</div>
              </button>
            </div>
          </div>
          
          <!-- Deepgram API Key (shown when Deepgram selected) -->
          <div class="setup-item hidden" id="setupDeepgram" style="margin-top: 12px; flex-direction: column; align-items: stretch;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
              <div class="setup-item-icon"></div>
          <div class="setup-item-text">
            <div class="setup-item-title">Deepgram API Key</div>
                <div class="setup-item-desc">Required for cloud transcription</div>
          </div>
            </div>
            <input 
              type="password" 
              id="deepgramApiInput" 
              class="setup-input" 
              placeholder="Enter your Deepgram API key"
              autocomplete="off"
              spellcheck="false"
            />
            <a href="https://console.deepgram.com/" target="_blank" class="setup-link">Get API key from Deepgram </a>
        </div>
        
          <!-- Parakeet Model Download (shown when Parakeet selected) -->
          <div class="setup-item hidden" id="setupParakeet" style="margin-top: 12px; flex-direction: column; align-items: stretch;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div class="setup-item-icon"></div>
              <div class="setup-item-text">
                <div class="setup-item-title">Parakeet Model</div>
                <div class="setup-item-desc">Download for local transcription</div>
              </div>
            </div>
            
            <!-- Parakeet download UI -->
            <div class="parakeet-download-inline" id="parakeetDownloadUI">
              <div id="parakeetNotDownloaded">
                <div class="parakeet-info-grid">
                  <span class="parakeet-info-label">Status:</span>
                  <span class="parakeet-info-value" style="color: #ef4444;">Model not downloaded</span>
                  
                  <span class="parakeet-info-label">Size:</span>
                  <span class="parakeet-info-value">~670 MB</span>
                  
                  <span class="parakeet-info-label">Languages:</span>
                  <span class="parakeet-info-value">25 European</span>
                </div>
                <button class="setup-item-action" id="setupParakeetDownloadBtn" style="width: 100%;">
                  Download Model (~670 MB)
                </button>
              </div>
              
              <div id="parakeetDownloading" class="hidden">
                <div class="parakeet-progress parakeet-progress-indeterminate">
                  <div class="parakeet-progress-fill parakeet-progress-animated" id="parakeetProgressFill"></div>
                </div>
                <div class="parakeet-progress-text" id="parakeetProgressText">
                  Downloading ~670 MB... This may take a few minutes
                </div>
                <p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; text-align: center;">
                  Model downloads from HuggingFace in the background
                </p>
              </div>
              
              <div id="parakeetDownloaded" class="hidden">
                <div class="parakeet-info-grid">
                  <span class="parakeet-info-label">Status:</span>
                  <span class="parakeet-info-value" style="color: #4caf50;"> Model ready</span>
                  
                  <span class="parakeet-info-label">Size:</span>
                  <span class="parakeet-info-value" id="parakeetModelSize">~670 MB</span>
                </div>
                <button class="setup-btn-danger" id="setupParakeetDeleteBtn" style="width: 100%; margin-top: 8px;">
                   Delete Model
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="setup-nav-buttons">
          <button class="setup-btn-secondary" id="setupBackBtn2">Back</button>
          <button class="setup-btn" id="setupNextBtn2" disabled>Next</button>
        </div>
      </div>
      
      <!-- Step 3: AI Configuration -->
      <div class="setup-screen hidden" id="setupScreen3">
        <div class="setup-screen-title">AI-Enhanced Notes</div>
        <p class="setup-screen-desc" style="margin-bottom: 16px; color: #888;">Choose how to power your AI note enhancement</p>
        
        <!-- AI Engine Selection -->
        <div class="setup-choice-buttons" id="aiEngineChoice">
          <button class="setup-choice-button" id="setupChoiceOpenAI" data-engine="openai">
            <div class="choice-icon"></div>
            <div class="choice-title">OpenAI (Cloud)</div>
            <div class="choice-desc">Best quality, requires API key</div>
          </button>
          <button class="setup-choice-button" id="setupChoiceLocalLLM" data-engine="local">
            <div class="choice-icon"></div>
            <div class="choice-title">Local LLM</div>
            <div class="choice-desc">Free & private, ~2GB download</div>
          </button>
        </div>
        
        <!-- OpenAI Configuration -->
        <div class="setup-checklist hidden" id="setupOpenAIConfig">
          <div class="setup-item" id="setupOpenAI" style="flex-direction: column; align-items: stretch;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
              <div class="setup-item-icon"></div>
              <div class="setup-item-text">
                <div class="setup-item-title">OpenAI API Key</div>
                <div class="setup-item-desc">Required for cloud AI</div>
              </div>
              <div class="setup-status" id="openaiKeyStatus"></div>
            </div>
            <input type="password" id="openaiApiInput" class="setup-input" placeholder="sk-..." autocomplete="off" spellcheck="false"/>
            <a href="https://platform.openai.com/api-keys" target="_blank" class="setup-link">Get API key from OpenAI </a>
          </div>
        </div>
        
        <!-- Local LLM Configuration -->
        <div class="setup-checklist hidden" id="setupLocalLLMConfig">
          <div class="setup-item" style="flex-direction: column; align-items: stretch;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
              <div class="setup-item-icon"></div>
              <div class="setup-item-text">
                <div class="setup-item-title">Qwen2.5 3B</div>
                <div class="setup-item-desc">Local AI model</div>
              </div>
              <div class="setup-status" id="localLLMStatus"></div>
            </div>
            <div id="localLLMNotDownloaded">
              <div style="margin: 8px 0; font-size: 13px; color: #888;">
                <strong>Size:</strong> ~2 GB &bull; <strong>Privacy:</strong> 100% local
              </div>
              <button class="setup-btn" id="setupLLMDownloadBtn">Download Model</button>
            </div>
            <div id="localLLMDownloading" class="hidden">
              <div class="setup-progress-bar"><div class="setup-progress-fill llm-progress-indeterminate" id="llmProgressFill"></div></div>
              <div class="setup-progress-text" id="llmProgressText">Downloading...</div>
            </div>
            <div id="localLLMDownloaded" class="hidden" style="color: #4CAF50; font-size: 13px; margin: 8px 0;">
               Model ready! AI runs locally on your Mac.
            </div>
          </div>
        </div>
        
        <div class="setup-nav-buttons">
          <button class="setup-btn-secondary" id="setupBackBtn3">Back</button>
          <button class="setup-btn" id="setupContinueBtn" disabled>Continue to IceCubes</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Create Folder Modal -->
  <div class="folder-modal hidden" id="folderModal">
    <div class="folder-modal-content">
      <div class="folder-modal-title" id="folderModalTitle">Create Folder</div>
      
      <div class="folder-form-group">
        <label class="folder-form-label">Name</label>
        <input type="text" class="folder-modal-input" id="folderNameInput" placeholder="e.g. Product Meetings">
      </div>
      
      <div class="folder-form-group">
        <label class="folder-form-label">Description <span class="label-hint">(helps AI suggest this folder)</span></label>
        <textarea class="folder-modal-input folder-description-input" id="folderDescInput" placeholder="e.g. Weekly product syncs, roadmap discussions, feature planning..." maxlength="1500"></textarea>
        <div class="folder-desc-counter" id="folderDescCounter">
          <span id="folderWordCount">0</span> / 200 words
        </div>
      </div>
      
      <div class="folder-form-group">
        <label class="folder-form-label">Icon</label>
        <div class="folder-icon-tabs">
          <button class="folder-icon-tab active" data-tab="colors">Colors</button>
          <button class="folder-icon-tab" data-tab="emoji">Emoji</button>
        </div>
        <div class="folder-icon-picker" id="folderIconPicker">
          <!-- Color balls - shown by default -->
          <div class="icon-tab-content active" data-tab="colors">
            <button class="folder-icon-option color-ball selected" data-icon="" style="background: #ef4444;"></button>
            <button class="folder-icon-option color-ball" data-icon="" style="background: #f97316;"></button>
            <button class="folder-icon-option color-ball" data-icon="" style="background: #eab308;"></button>
            <button class="folder-icon-option color-ball" data-icon="" style="background: #22c55e;"></button>
            <button class="folder-icon-option color-ball" data-icon="" style="background: #3b82f6;"></button>
            <button class="folder-icon-option color-ball" data-icon="" style="background: #a855f7;"></button>
            <button class="folder-icon-option color-ball" data-icon="" style="background: #ec4899;"></button>
            <button class="folder-icon-option color-ball" data-icon="" style="background: #a16207;"></button>
            <button class="folder-icon-option color-ball" data-icon="" style="background: #374151;"></button>
            <button class="folder-icon-option color-ball" data-icon="" style="background: #e5e7eb;"></button>
            <button class="folder-icon-option color-ball" data-icon="" style="background: #06b6d4;"></button>
            <button class="folder-icon-option color-ball" data-icon="" style="background: #fb923c;"></button>
          </div>
          <!-- Emoji icons -->
          <div class="icon-tab-content" data-tab="emoji" style="max-height: 240px; overflow-y: auto;">
            <!-- Work & Business -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Communication -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Writing & Notes -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Tech & Science -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Ideas & Goals -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Creative & Media -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Education & Learning -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- People & Teams -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Health & Wellness -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Time & Planning -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Security & Status -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Travel & Transport -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Nature & Weather -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Food & Drink -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Fun & Celebration -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Animals -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Smileys & Expressions -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <!-- Misc Objects -->
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
            <button class="folder-icon-option" data-icon=""></button>
          </div>
        </div>
      </div>
      
      <div class="folder-form-group folder-default-toggle">
        <label class="folder-toggle-label">
          <input type="checkbox" id="folderDefaultToggle">
          <span class="toggle-switch"></span>
          <span class="toggle-text">Set as default folder</span>
        </label>
        <div class="folder-default-hint">New notes will be automatically added to this folder</div>
        <div class="folder-default-warning hidden" id="folderDefaultWarning">
           "<span id="currentDefaultName"></span>" is currently the default. This will replace it.
        </div>
      </div>
      
      <div class="folder-modal-actions">
        <button class="folder-modal-btn folder-modal-btn-cancel" id="folderCancelBtn">Cancel</button>
        <button class="folder-modal-btn folder-modal-btn-create" id="folderCreateBtn">Create</button>
      </div>
    </div>
  </div>
  
  <!-- Delete Folder Modal -->
  <div class="folder-modal hidden" id="deleteFolderModal">
    <div class="folder-modal-content" style="width: 380px;">
      <div class="folder-modal-title" style="color: #ef4444;">
        <span id="deleteFolderIcon"></span> Delete "<span id="deleteFolderName"></span>"?
      </div>
      
      <div style="margin: 16px 0; font-size: 14px; color: var(--text-muted); line-height: 1.5;">
        This folder contains <strong id="deleteFolderNoteCount">0</strong> note(s). What would you like to do?
      </div>
      
      <div class="delete-folder-options">
        <button class="delete-option-btn" id="deleteFolderOnlyBtn" style="
          width: 100%;
          padding: 14px 16px;
          border: 1px solid var(--border);
          border-radius: 10px;
          background: var(--bg-secondary);
          color: var(--text);
          font-size: 14px;
          cursor: pointer;
          text-align: left;
          margin-bottom: 10px;
          transition: all 0.15s;
        ">
          <div style="font-weight: 600; margin-bottom: 4px;"> Delete folder only</div>
          <div style="font-size: 12px; color: var(--text-muted);">Notes will be moved to "All Notes" (unassigned)</div>
        </button>
        
        <button class="delete-option-btn" id="deleteFolderWithNotesBtn" style="
          width: 100%;
          padding: 14px 16px;
          border: 1px solid #fecaca;
          border-radius: 10px;
          background: #fef2f2;
          color: #991b1b;
          font-size: 14px;
          cursor: pointer;
          text-align: left;
          transition: all 0.15s;
        ">
          <div style="font-weight: 600; margin-bottom: 4px;"> Delete folder and all notes</div>
          <div style="font-size: 12px; color: #b91c1c;">This cannot be undone!</div>
        </button>
      </div>
      
      <div class="folder-modal-actions" style="margin-top: 16px;">
        <button class="folder-modal-btn folder-modal-btn-cancel" id="deleteFolderCancelBtn">Cancel</button>
      </div>
    </div>
  </div>
  
  <div class="app">
    <!-- Left Sidebar - Navigation -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title"><img src="assets/logo.png" alt="IceCubes"> IceCubes</div>
      </div>
      <div class="sidebar-nav">
        <div class="nav-item active" data-folder-id="all" id="navAllNotes">
          <span class="nav-item-icon"></span>
          <span>All Notes</span>
        </div>
        
        <div class="nav-section-header" style="margin-top: 16px;">
          <span class="nav-section-title">FOLDERS</span>
        </div>
        
        <div class="folders-list" id="foldersList">
          <!-- Folders will be populated here -->
        </div>
        
        <button class="add-folder-btn-large" id="addFolderBtn">
          <span>+</span> Add Folder
        </button>
        
        <!-- People Link -->
        <div class="nav-item nav-entity-link" id="navPeople" style="margin-top: 24px; cursor: pointer;" onclick="window.handlePeopleClick && window.handlePeopleClick()">
          <span class="nav-item-icon"></span>
          <span>People</span>
          <span class="nav-item-count" id="peopleCount">0</span>
        </div>
        
        <!-- Companies Link -->
        <div class="nav-item nav-entity-link" id="navCompanies" style="cursor: pointer;" onclick="window.handleCompaniesClick && window.handleCompaniesClick()">
          <span class="nav-item-icon"></span>
          <span>Companies</span>
          <span class="nav-item-count" id="companiesCount">0</span>
        </div>
      </div>
    </div>
    
    <!-- Main Content Area - Shows notes list OR editor -->
    <div class="main">
      <div class="header">
        <div class="header-left">
          <button class="back-btn hidden" id="backBtn"></button>
          <button class="toggle-sidebar-btn" id="toggleSidebarBtn"></button>
          <span class="collapsed-logo" id="collapsedLogo"><img src="assets/logo.png" alt="IceCubes"> IceCubes</span>
        </div>
        <div class="global-search-wrapper" id="globalSearchWrapper">
          <svg class="global-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <input type="text" class="global-search-input" id="globalSearchInput" placeholder="Search notes, people, companies...">
        </div>
        <div class="header-right">
          <span class="save-status" id="saveStatus"></span>
          
          <!-- Notes View Toggle (Raw Notes vs AI Enhanced) -->
          <div class="notes-view-toggle-wrapper" id="notesViewToggleWrapper">
            <div class="notes-view-toggle" id="notesViewToggle">
              <button class="notes-view-toggle-btn" id="rawNotesBtn" title="Your notes">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <line x1="3" y1="12" x2="21" y2="12"></line>
                  <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
              </button>
              <button class="notes-view-toggle-btn active" id="aiNotesBtn" title="AI enhanced notes">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2L9.5 9.5L2 12L9.5 14.5L12 22L14.5 14.5L22 12L14.5 9.5L12 2Z"/>
                </svg>
              </button>
            </div>
            <div class="template-dropdown-wrapper">
              <button class="template-dropdown-btn" id="templateDropdownBtn" title="Change template">
                <span id="currentTemplateIcon"></span>
                <span id="currentTemplateName">General</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 9l6 6 6-6"/>
                </svg>
              </button>
              <div class="template-dropdown-menu" id="templateDropdownMenu">
                <div class="template-dropdown-header">Regenerate with template</div>
                <div id="templateDropdownContent">
                  <div class="template-dropdown-loading">Loading templates...</div>
                </div>
              </div>
            </div>
          </div>
          
          <button class="header-btn new-note-btn" id="newNoteBtn" title="Create a new note">New</button>
          <button class="header-icon-btn" id="settingsBtn" title="Settings"></button>
        </div>
      </div>
      
      <!-- Settings Modal -->
      <div class="settings-overlay hidden" id="settingsOverlay">
        <div class="settings-panel" id="settingsPanel">
          <button class="settings-close-btn" id="settingsCloseBtn"></button>
          <div class="settings-sidebar">
            <div class="settings-title">Settings</div>
            <div class="settings-nav">
              <button class="settings-nav-item active" data-tab="general">
                <span class="nav-icon"></span> General
              </button>
              <button class="settings-nav-item" data-tab="calendar">
                <span class="nav-icon"></span> Calendar
              </button>
              <button class="settings-nav-item" data-tab="notifications">
                <span class="nav-icon"></span> Notifications
              </button>
              <button class="settings-nav-item" data-tab="language">
                <span class="nav-icon"></span> Language
              </button>
              <button class="settings-nav-item" id="manageTemplatesBtn">
                <span class="nav-icon"></span> Manage Templates
              </button>
            </div>
          </div>
        <div class="settings-main">
          <!-- General Tab -->
          <div class="settings-tab active" id="settingsTabGeneral">
            <div class="settings-section">
              <h3> Appearance</h3>
              <p class="settings-desc">Choose your preferred theme</p>
              <div class="theme-selector" id="themeSelector">
                <button class="theme-option" data-theme="light">
                  <span class="theme-icon"></span>
                  <span>Light</span>
                </button>
                <button class="theme-option active" data-theme="system">
                  <span class="theme-icon"></span>
                  <span>System</span>
                </button>
                <button class="theme-option" data-theme="dark">
                  <span class="theme-icon"></span>
                  <span>Dark</span>
                </button>
              </div>
            </div>
            
            <!-- Transcription Provider Section -->
            <div class="settings-section">
              <h3> Transcription</h3>
              <p class="settings-desc">Choose your transcription provider</p>
              
              <!-- Provider Toggle -->
              <div class="provider-toggle-group">
                <button class="provider-toggle-btn" id="transcriptionProviderDeepgram" data-provider="deepgram">
                  <span class="provider-icon"></span>
                  <span class="provider-name">Deepgram</span>
                  <span class="provider-badge cloud">Cloud</span>
                </button>
                <button class="provider-toggle-btn" id="transcriptionProviderParakeet" data-provider="parakeet">
                  <span class="provider-icon"></span>
                  <span class="provider-name">Parakeet</span>
                  <span class="provider-badge local">Local</span>
                </button>
              </div>
              
              <!-- Active Provider Status -->
              <div class="active-provider-status" id="transcriptionActiveStatus">
                <span class="active-label">Active:</span>
                <span class="active-provider-name" id="transcriptionActiveName">Checking...</span>
              </div>
              
              <!-- Deepgram Config -->
              <div class="provider-config" id="deepgramConfig">
                <div class="provider-config-header">
                  <span class="config-title">Deepgram API Key</span>
                  <div class="settings-status" id="deepgramStatus">
                    <span class="status-dot"></span>
                    <span id="deepgramStatusText">Not configured</span>
                  </div>
                </div>
                <div class="settings-input-group">
                  <input type="password" id="deepgramKeyInput" placeholder="Enter Deepgram API key">
                  <button class="settings-btn" id="deepgramSaveBtn">Save</button>
                </div>
                <div class="provider-config-footer">
                  <a href="#" class="settings-link" id="deepgramLink">Get a free API key </a>
                  <button class="settings-btn-danger hidden" id="deepgramClearBtn">Clear Key</button>
                </div>
              </div>
              
              <!-- Parakeet Config -->
              <div class="provider-config hidden" id="parakeetConfig">
                <div class="provider-config-header">
                  <span class="config-title">Parakeet Local Model</span>
                  <div class="settings-status" id="parakeetSettingsStatus">
                    <span class="status-dot"></span>
                    <span id="parakeetSettingsStatusText">Not downloaded</span>
                  </div>
                </div>
                <div id="parakeetSettingsNotDownloaded">
                  <p class="config-info">~670 MB download  25 languages  100% private</p>
                  <button class="settings-btn-full" id="parakeetSettingsDownloadBtn">Download Model</button>
                </div>
                <div id="parakeetSettingsDownloading" class="hidden">
                  <div class="settings-progress-bar"><div class="settings-progress-fill" id="parakeetSettingsProgressFill"></div></div>
                  <p class="settings-progress-text" id="parakeetSettingsProgressText">Downloading...</p>
                </div>
                <div id="parakeetSettingsDownloaded" class="hidden">
                  <p class="config-info config-success"> Model ready for local transcription</p>
                  <button class="settings-btn-danger" id="parakeetSettingsDeleteBtn">Delete Model</button>
                </div>
              </div>
            </div>
            
            <!-- AI Notes Provider Section -->
            <div class="settings-section">
              <h3> AI Notes</h3>
              <p class="settings-desc">Choose your AI provider for note enhancement</p>
              
              <!-- Provider Toggle -->
              <div class="provider-toggle-group">
                <button class="provider-toggle-btn" id="aiProviderOpenAI" data-provider="openai">
                  <span class="provider-icon"></span>
                  <span class="provider-name">OpenAI</span>
                  <span class="provider-badge cloud">Cloud</span>
                </button>
                <button class="provider-toggle-btn" id="aiProviderLocal" data-provider="local">
                  <span class="provider-icon"></span>
                  <span class="provider-name">Qwen2.5</span>
                  <span class="provider-badge local">Local</span>
                </button>
              </div>
              
              <!-- Active Provider Status -->
              <div class="active-provider-status" id="aiActiveStatus">
                <span class="active-label">Active:</span>
                <span class="active-provider-name" id="aiActiveName">Checking...</span>
              </div>
              
              <!-- OpenAI Config -->
              <div class="provider-config" id="openaiConfig">
                <div class="provider-config-header">
                  <span class="config-title">OpenAI API Key</span>
                  <div class="settings-status" id="openaiStatus">
                    <span class="status-dot"></span>
                    <span id="openaiStatusText">Not configured</span>
                  </div>
                </div>
                <div class="settings-input-group">
                  <input type="password" id="openaiKeyInput" placeholder="Enter OpenAI API key">
                  <button class="settings-btn" id="openaiSaveBtn">Save</button>
                </div>
                <div class="provider-config-footer">
                  <a href="#" class="settings-link" id="openaiLink">Get an API key </a>
                  <button class="settings-btn-danger hidden" id="openaiClearBtn">Clear Key</button>
                </div>
              </div>
              
              <!-- Local LLM Config -->
              <div class="provider-config hidden" id="localLLMConfig">
                <div class="provider-config-header">
                  <span class="config-title">Qwen2.5 3B Local Model</span>
                  <div class="settings-status" id="localLLMSettingsStatus">
                    <span class="status-dot"></span>
                    <span id="localLLMSettingsStatusText">Not downloaded</span>
                  </div>
                </div>
                <div id="localLLMSettingsNotDownloaded">
                  <p class="config-info">~2 GB download  Metal accelerated  100% private</p>
                  <button class="settings-btn-full" id="localLLMSettingsDownloadBtn">Download Model</button>
                </div>
                <div id="localLLMSettingsDownloading" class="hidden">
                  <div class="settings-progress-bar"><div class="settings-progress-fill llm-progress-indeterminate" id="localLLMSettingsProgressFill"></div></div>
                  <p class="settings-progress-text" id="localLLMSettingsProgressText">Downloading...</p>
                </div>
                <div id="localLLMSettingsDownloaded" class="hidden">
                  <p class="config-info config-success"> Model ready for local AI notes</p>
                  <button class="settings-btn-danger" id="localLLMSettingsDeleteBtn">Delete Model</button>
                </div>
              </div>
            </div>
            
          </div>
          
          <!-- Calendar Tab -->
          <div class="settings-tab" id="settingsTabCalendar">
            <div class="settings-section">
              <h3> Google Calendar</h3>
              <p class="settings-desc">Connect your calendar to see upcoming meetings</p>
              <div class="settings-status" id="calendarStatus">
                <span class="status-dot"></span>
                <span id="calendarStatusText">Checking...</span>
              </div>
              <button class="settings-btn-full" id="calendarConnectBtn">Connect Google Calendar</button>
            </div>
            
            <div class="settings-section" id="visibleCalendarsSection" style="display: none;">
              <div class="section-header-row">
                <h3>Visible Calendars</h3>
                <button class="reset-btn" id="resetCalendarsBtn">Reset</button>
              </div>
              <div class="calendar-list" id="calendarListSettings">
                <!-- Calendar items will be populated here -->
              </div>
            </div>
          </div>
          
          <!-- Notifications Tab -->
          <div class="settings-tab" id="settingsTabNotifications">
            <h3 class="settings-tab-title">Meeting notifications</h3>
            
            <div class="settings-section">
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-title">Scheduled meetings</div>
                  <div class="setting-desc">Show notifications 3 minutes before meetings start based on your Calendar</div>
                </div>
                <div class="setting-toggle active" id="toggleScheduledNotifs"></div>
              </div>
              
              <div class="setting-divider"></div>
              
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-title">Auto-detected meetings</div>
                  <div class="setting-desc">Show notifications when a call is detected. You can mute specific apps below.</div>
                </div>
                <div class="setting-toggle active" id="toggleAutoDetectNotifs"></div>
              </div>
              
              <div class="muted-apps-section" id="mutedAppsSection">
                <div class="muted-apps-label">Don't notify me when a call is detected in these apps:</div>
                <div class="muted-apps-list" id="mutedAppsList">
                  <!-- Muted apps will be shown here as tags -->
                </div>
                <div class="app-select-wrapper">
                  <select class="app-select" id="appSelect">
                    <option value="">Select an app</option>
                    <option value="Chrome">Chrome</option>
                    <option value="Safari">Safari</option>
                    <option value="Arc">Arc</option>
                    <option value="Firefox">Firefox</option>
                    <option value="Slack">Slack</option>
                    <option value="Zoom">Zoom</option>
                    <option value="Microsoft Teams">Microsoft Teams</option>
                    <option value="Webex">Webex</option>
                    <option value="Discord">Discord</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Language Tab (placeholder) -->
          <div class="settings-tab" id="settingsTabLanguage">
            <h3 class="settings-tab-title">Language Settings</h3>
            
            <div class="settings-section">
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-title"> Transcription Language</div>
                  <div class="setting-desc">The language Deepgram will listen for during meetings</div>
                </div>
              </div>
              <select class="settings-select" id="transcriptionLangSelect">
                <option value="en">English</option>
                <option value="en-US">English (US)</option>
                <option value="en-GB">English (UK)</option>
                <option value="en-AU">English (Australia)</option>
                <option value="es">Spanish</option>
                <option value="es-419">Spanish (Latin America)</option>
                <option value="fr">French</option>
                <option value="fr-CA">French (Canada)</option>
                <option value="de">German</option>
                <option value="it">Italian</option>
                <option value="pt">Portuguese</option>
                <option value="pt-BR">Portuguese (Brazil)</option>
                <option value="nl">Dutch</option>
                <option value="ja">Japanese</option>
                <option value="zh">Chinese (Mandarin)</option>
                <option value="zh-TW">Chinese (Traditional)</option>
                <option value="ko">Korean</option>
                <option value="ru">Russian</option>
                <option value="hi">Hindi</option>
                <option value="pl">Polish</option>
                <option value="uk">Ukrainian</option>
                <option value="sv">Swedish</option>
                <option value="da">Danish</option>
                <option value="no">Norwegian</option>
                <option value="fi">Finnish</option>
                <option value="tr">Turkish</option>
                <option value="id">Indonesian</option>
                <option value="th">Thai</option>
                <option value="vi">Vietnamese</option>
              </select>
              
              <div class="setting-row" style="margin-top: 16px;">
                <div class="setting-info">
                  <div class="setting-title">Auto-detect language</div>
                  <div class="setting-desc">Let Deepgram automatically detect the spoken language (may be less accurate)</div>
                </div>
                <div class="setting-toggle" id="toggleAutoDetectLang"></div>
              </div>
            </div>
            
            <div class="settings-section">
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-title"> AI Notes Language</div>
                  <div class="setting-desc">Language for AI-generated summaries and notes</div>
                </div>
              </div>
              <select class="settings-select" id="aiNotesLangSelect">
                <option value="same">Same as transcription</option>
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="it">Italian</option>
                <option value="pt">Portuguese</option>
                <option value="nl">Dutch</option>
                <option value="ja">Japanese</option>
                <option value="zh">Chinese (Simplified)</option>
                <option value="ko">Korean</option>
                <option value="ru">Russian</option>
                <option value="hi">Hindi</option>
                <option value="ar">Arabic</option>
                <option value="pl">Polish</option>
                <option value="tr">Turkish</option>
              </select>
              <p class="settings-hint">When set to a different language, AI will translate the notes</p>
            </div>
          </div>
          
        </div>
        </div>
      </div>
      
      <!-- Templates Modal -->
      <div class="templates-modal hidden" id="templatesModal">
        <div class="templates-modal-content">
          <div class="templates-modal-header">
            <h2>Manage Templates</h2>
            <button class="templates-close-btn" id="closeTemplatesBtn"></button>
          </div>
          <div class="templates-modal-body">
            <div class="templates-modal-sidebar">
              <button class="templates-new-btn" id="newTemplateBtn">+ New Template</button>
              <div class="templates-list" id="templatesList"></div>
            </div>
            <div class="templates-modal-editor" id="templatesEditor">
              <div class="templates-empty-state">
                <p>Select a template to edit or create a new one</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Home Screen - Notes List (default view) -->
      <div class="notes-home" id="notesHome">
        <!-- Calendar Section - Coming Up -->
        <div class="calendar-section" id="calendarSection" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">Coming up</h2>
            <div class="section-header-actions">
              <button class="show-more-btn" id="showLessEventsBtn" style="display: none;">Show less</button>
              <button class="show-more-btn" id="showMoreEventsBtn" style="display: none;">Show more</button>
            </div>
          </div>
          <div class="calendar-events" id="calendarEvents">
            <!-- Calendar events will be populated here -->
          </div>
        </div>
        
        <!-- Connect Calendar Button (shown when not connected) -->
        <button class="btn-connect-calendar" id="connectCalendarBtn" style="display: none; width: 100%; background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border); padding: 12px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; margin-bottom: 24px; text-align: center;">
           Connect Google Calendar to see upcoming meetings
        </button>
        
        <div class="notes-list" id="notesList">
          <!-- Notes will be populated here -->
        </div>
        
        <!-- Ask AI Button (shown when viewing a specific folder) -->
        <div class="folder-ask-trigger" id="folderAskTrigger" style="display: none;">
          <button class="folder-ask-btn" id="folderAskBtn">
            <span class="folder-ask-icon"></span>
            <span>Ask AI about this folder...</span>
          </button>
        </div>
      </div>
      
      <!-- Folder Search Floating Panel -->
      <div class="folder-search-overlay hidden" id="folderSearchOverlay"></div>
      <div class="folder-search-panel hidden" id="folderSearchPanel">
        <div class="folder-search-header">
          <span class="folder-search-title">
            <span></span>
            <span id="folderSearchTitle">Ask AI about this folder</span>
          </span>
          <button class="folder-search-close" id="folderSearchClose"></button>
        </div>
        <div class="folder-search-content">
          <div class="folder-search-input-wrapper">
            <input type="text" class="folder-search-input" id="folderSearchInput" placeholder="Ask anything about notes in this folder...">
            <button class="folder-search-btn" id="folderSearchBtn">
              <span>Ask</span>
              <span class="folder-search-shortcut"></span>
            </button>
          </div>
          <div class="folder-search-results" id="folderSearchResults"></div>
        </div>
      </div>
      
      <!-- Editor content - shown when viewing a note -->
      <div class="editor-content hidden" id="editorContent">
        
        <div class="editor-scroll">
          <div class="editor-inner">
            <div class="meeting-title" contenteditable="true" data-placeholder="Meeting Title" id="meetingTitle"></div>
            
            <div class="meeting-meta" id="meetingMeta">
              <div class="meta-badge" id="dateBadge">
                <span class="meta-badge-icon"></span>
                <span id="dateLabel">Today</span>
              </div>
              <div class="attendees-wrapper" id="attendeesWrapper" style="display: none;">
                <div class="meta-badge attendees-badge" id="attendeesBadge">
                  <span class="attendees-icon"></span>
                  <span id="attendeesLabel">No attendees</span>
                </div>
                <div class="attendees-dropdown hidden" id="attendeesDropdown">
                  <div class="attendees-header">
                    <span>Attendees</span>
                  </div>
                  <div class="attendees-list" id="attendeesList">
                    <!-- Attendees will be populated here -->
                  </div>
                </div>
              </div>
              <div class="meta-badge add-folder" id="addToFolderBtn">+ Add to folder</div>
            </div>
            
            <div class="notes-area">
              <!-- TipTap Editor Toolbar -->
              <div class="editor-toolbar" id="editorToolbar">
                <button class="toolbar-btn" data-action="bold" title="Bold (B)"><b>B</b></button>
                <button class="toolbar-btn" data-action="italic" title="Italic (I)"><i>I</i></button>
                <button class="toolbar-btn" data-action="underline" title="Underline (U)"><u>U</u></button>
                <button class="toolbar-btn" data-action="strike" title="Strikethrough"><s>S</s></button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" data-action="heading1" title="Heading 1">H1</button>
                <button class="toolbar-btn" data-action="heading2" title="Heading 2">H2</button>
                <button class="toolbar-btn" data-action="heading3" title="Heading 3">H3</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" data-action="bulletList" title="Bullet List"></button>
                <button class="toolbar-btn" data-action="orderedList" title="Numbered List">1.</button>
                <button class="toolbar-btn" data-action="taskList" title="Task List"></button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" data-action="code" title="Code">&lt;/&gt;</button>
                <button class="toolbar-btn" data-action="blockquote" title="Quote">"</button>
                <button class="toolbar-btn" data-action="horizontalRule" title="Divider"></button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" data-action="image" title="Insert Image">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                </button>
              </div>
              <!-- Hidden file input for image picker -->
              <input type="file" id="imagePickerInput" accept="image/*" multiple style="display: none;">
              <!-- TipTap Editor Content -->
              <div class="tiptap-editor" id="notesEditor"></div>
              <!-- Hidden textarea for compatibility -->
              <textarea id="notesEditorHidden" style="display:none;"></textarea>
            </div>
            
            <!-- Generate Notes Button (shown when transcript exists but no AI notes yet) -->
            <div class="generate-notes-wrapper hidden" id="generateNotesWrapper">
              <div class="generate-btn-with-dropdown">
                <button class="generate-notes-btn" id="generateNotesBtn">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L9.5 9.5L2 12L9.5 14.5L12 22L14.5 14.5L22 12L14.5 9.5L12 2Z"/>
                  </svg>
                  <span id="generateNotesBtnText">Generate notes</span>
                </button>
                <button class="generate-template-dropdown-btn" id="generateTemplateDropdownBtn" title="Choose template">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                  </svg>
                </button>
                <div class="generate-template-menu" id="generateTemplateMenu">
                  <div class="generate-template-menu-header">Choose Template</div>
                  <div id="generateTemplateMenuContent">
                    <!-- Templates loaded dynamically -->
                  </div>
                </div>
              </div>
            </div>
            <!-- Hidden select for compatibility -->
            <select id="templateSelector" style="display:none;"></select>
            
            <!-- Live Transcript Section (collapsed by default) -->
            <div class="transcript-section collapsed" id="transcriptSection">
              <div class="transcript-header" id="transcriptHeader">
                <span class="transcript-toggle"></span>
                <span>Live Transcript</span>
                <span class="transcript-count" id="transcriptCount">0 segments</span>
              </div>
              <div class="transcript-content" id="transcriptContent">
                <div class="transcript-empty" id="transcriptEmpty">
                  <span></span>
                  <span>Transcript will appear here when you start recording</span>
                </div>
                <div class="transcript-bubbles" id="transcriptBubbles"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- AI Notes Panel -->
        <div class="ai-notes-panel hidden" id="aiNotesPanel">
          <div class="ai-notes-header">
            <div class="ai-notes-title">
              <span></span>
              <span>AI Notes</span>
              <span class="ai-notes-badge">GPT-4o</span>
            </div>
            <div class="ai-generating hidden" id="aiGenerating">
              <div class="spinner"></div>
              <span>Generating...</span>
            </div>
          </div>
          
          <div class="ai-notes-content" id="aiNotesContent">
            <div class="ai-empty" id="aiEmpty">
              <div class="ai-empty-icon"></div>
              <div>AI will generate notes as your meeting progresses</div>
            </div>
            
            <div class="ai-results hidden" id="aiResults">
              <div class="ai-section" id="aiSummarySection">
                <div class="ai-section-label">Summary</div>
                <div class="ai-section-content" id="aiSummary"></div>
              </div>
              
              <div class="ai-section" id="aiKeyPointsSection">
                <div class="ai-section-label">Key Points</div>
                <ul class="ai-list" id="aiKeyPoints"></ul>
              </div>
              
              <div class="ai-section" id="aiActionItemsSection">
                <div class="ai-section-label">Action Items</div>
                <div id="aiActionItems"></div>
              </div>
              
              <div class="ai-section" id="aiDecisionsSection">
                <div class="ai-section-label">Decisions</div>
                <div id="aiDecisions"></div>
              </div>
            </div>
          </div>
          
          <div class="ai-notes-actions hidden" id="aiNotesActions">
            <button class="ai-btn ai-btn-primary" id="aiAppendBtn"> Append to Notes</button>
            <button class="ai-btn ai-btn-secondary" id="aiRegenerateBtn"> Regenerate</button>
          </div>
        </div>
        
        <!-- AI Q&A Panel (slides up when asking) -->
        <div class="ai-qa-panel hidden" id="aiQAPanel">
          <div class="ai-qa-header">
            <span class="ai-qa-title"> Ask AI</span>
            <button class="ai-qa-close" id="aiQAClose"></button>
          </div>
          <div class="ai-qa-content">
            <div class="ai-qa-question-area">
              <textarea class="ai-qa-textarea" id="aiQATextarea" placeholder="Ask anything about your meeting notes or transcript..." rows="2"></textarea>
              <button class="ai-qa-submit" id="aiQASubmit">
                <span>Ask</span>
                <span class="ai-qa-shortcut"></span>
              </button>
            </div>
            <div class="ai-qa-answer hidden" id="aiQAAnswer">
              <div class="ai-qa-answer-header">
                <span class="ai-qa-answer-icon"></span>
                <span>Answer</span>
              </div>
              <div class="ai-qa-answer-content" id="aiQAAnswerContent"></div>
              <div class="ai-qa-actions">
                <button class="ai-qa-action-btn" id="aiQACopy"> Copy</button>
              </div>
            </div>
            <div class="ai-qa-loading hidden" id="aiQALoading">
              <div class="ai-qa-spinner"></div>
              <span>Thinking...</span>
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="editor-footer hidden" id="editorFooter">
          <div class="footer-left">
            <div class="mic-control" id="micControl">
              <div class="mic-icon">
                <div class="mic-bar"></div>
                <div class="mic-bar"></div>
                <div class="mic-bar"></div>
              </div>
              <span class="mic-chevron"></span>
              <span class="mic-label" id="micLabel">Resume</span>
            </div>
          </div>
          <div class="footer-center">
            <div class="ask-input-wrapper" id="askInputWrapper">
              <input type="text" class="ask-input" placeholder=" Ask anything about this meeting..." id="askInput" readonly>
            </div>
          </div>
          <div class="footer-right">
            <!-- Follow-up email button removed -->
          </div>
        </div>
      </div> <!-- Close editor-content -->
    </div>
  </div>
  
  <script>
    const { ipcRenderer, shell } = require('electron');
    
    // ============================================================================
    // TIPTAP EDITOR SETUP
    // ============================================================================
    const { Editor } = require('@tiptap/core');
    const StarterKit = require('@tiptap/starter-kit').default;
    const Placeholder = require('@tiptap/extension-placeholder').default;
    const TaskList = require('@tiptap/extension-task-list').default;
    const TaskItem = require('@tiptap/extension-task-item').default;
    const Underline = require('@tiptap/extension-underline').default;
    const Link = require('@tiptap/extension-link').default;
    const Image = require('@tiptap/extension-image').default;
    
    let tiptapEditor = null;
    
    function initTiptapEditor() {
      const editorElement = document.getElementById('notesEditor');
      if (!editorElement || tiptapEditor) return;
      
      tiptapEditor = new Editor({
        element: editorElement,
        extensions: [
          StarterKit.configure({
            heading: { levels: [1, 2, 3] },
          }),
          Placeholder.configure({
            placeholder: 'Write your meeting notes...',
          }),
          TaskList,
          TaskItem.configure({
            nested: true,
          }),
          Underline,
          Link.configure({
            openOnClick: true,
          }),
          Image.configure({
            inline: false,
            allowBase64: true,
          }),
        ],
        content: '',
        editorProps: {
          attributes: {
            class: 'ProseMirror',
          },
          handleDrop: (view, event, slice, moved) => {
            // Handle image drops
            if (!moved && event.dataTransfer && event.dataTransfer.files && event.dataTransfer.files.length > 0) {
              const files = Array.from(event.dataTransfer.files);
              const images = files.filter(file => file.type.startsWith('image/'));
              
              if (images.length > 0) {
                event.preventDefault();
                
                images.forEach(file => {
                  const reader = new FileReader();
                  reader.onload = (e) => {
                    const base64 = e.target.result;
                    // Insert image at drop position
                    const { pos } = view.posAtCoords({ left: event.clientX, top: event.clientY });
                    if (pos !== null) {
                      const node = view.state.schema.nodes.image.create({ src: base64 });
                      const transaction = view.state.tr.insert(pos, node);
                      view.dispatch(transaction);
                    }
                  };
                  reader.readAsDataURL(file);
                });
                
                return true;
              }
            }
            return false;
          },
          handlePaste: (view, event) => {
            // Handle image paste from clipboard
            const items = event.clipboardData?.items;
            if (!items) return false;
            
            for (const item of items) {
              if (item.type.startsWith('image/')) {
                event.preventDefault();
                const file = item.getAsFile();
                if (file) {
                  const reader = new FileReader();
                  reader.onload = (e) => {
                    const base64 = e.target.result;
                    tiptapEditor.chain().focus().setImage({ src: base64 }).run();
                  };
                  reader.readAsDataURL(file);
                }
                return true;
              }
            }
            return false;
          },
        },
        onUpdate: ({ editor }) => {
          // Sync to hidden textarea for compatibility
          const hidden = document.getElementById('notesEditorHidden');
          if (hidden) {
            hidden.value = editor.getHTML();
          }
          // Skip auto-save if we're just toggling between views
          if (typeof isTogglingView !== 'undefined' && isTogglingView) {
            return;
          }
          // Trigger auto-save
          hasUnsavedChanges = true;
          scheduleAutoSave();
        },
      });
      
      // Setup toolbar buttons
      setupEditorToolbar();
      
      console.log('[TipTap] Editor initialized');
    }
    
    function setupEditorToolbar() {
      const toolbar = document.getElementById('editorToolbar');
      if (!toolbar || !tiptapEditor) return;
      
      toolbar.querySelectorAll('.toolbar-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const action = btn.dataset.action;
          
          switch(action) {
            case 'bold':
              tiptapEditor.chain().focus().toggleBold().run();
              break;
            case 'italic':
              tiptapEditor.chain().focus().toggleItalic().run();
              break;
            case 'underline':
              tiptapEditor.chain().focus().toggleUnderline().run();
              break;
            case 'strike':
              tiptapEditor.chain().focus().toggleStrike().run();
              break;
            case 'heading1':
              tiptapEditor.chain().focus().toggleHeading({ level: 1 }).run();
              break;
            case 'heading2':
              tiptapEditor.chain().focus().toggleHeading({ level: 2 }).run();
              break;
            case 'heading3':
              tiptapEditor.chain().focus().toggleHeading({ level: 3 }).run();
              break;
            case 'bulletList':
              tiptapEditor.chain().focus().toggleBulletList().run();
              break;
            case 'orderedList':
              tiptapEditor.chain().focus().toggleOrderedList().run();
              break;
            case 'taskList':
              tiptapEditor.chain().focus().toggleTaskList().run();
              break;
            case 'code':
              tiptapEditor.chain().focus().toggleCode().run();
              break;
            case 'blockquote':
              tiptapEditor.chain().focus().toggleBlockquote().run();
              break;
            case 'horizontalRule':
              tiptapEditor.chain().focus().setHorizontalRule().run();
              break;
            case 'image':
              // Trigger the file picker
              document.getElementById('imagePickerInput')?.click();
              return; // Don't update toolbar state
          }
          
          updateToolbarState();
        });
      });
      
      // Handle image picker file selection
      const imagePickerInput = document.getElementById('imagePickerInput');
      if (imagePickerInput) {
        imagePickerInput.addEventListener('change', (e) => {
          const files = Array.from(e.target.files || []);
          files.forEach(file => {
            if (file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = (event) => {
                const base64 = event.target.result;
                tiptapEditor.chain().focus().setImage({ src: base64 }).run();
              };
              reader.readAsDataURL(file);
            }
          });
          // Reset input so same file can be selected again
          imagePickerInput.value = '';
        });
      }
      
      // Update toolbar state on selection change
      tiptapEditor.on('selectionUpdate', updateToolbarState);
      tiptapEditor.on('update', updateToolbarState);
    }
    
    function updateToolbarState() {
      if (!tiptapEditor) return;
      
      const toolbar = document.getElementById('editorToolbar');
      if (!toolbar) return;
      
      toolbar.querySelectorAll('.toolbar-btn').forEach(btn => {
        const action = btn.dataset.action;
        let isActive = false;
        
        switch(action) {
          case 'bold':
            isActive = tiptapEditor.isActive('bold');
            break;
          case 'italic':
            isActive = tiptapEditor.isActive('italic');
            break;
          case 'underline':
            isActive = tiptapEditor.isActive('underline');
            break;
          case 'strike':
            isActive = tiptapEditor.isActive('strike');
            break;
          case 'heading1':
            isActive = tiptapEditor.isActive('heading', { level: 1 });
            break;
          case 'heading2':
            isActive = tiptapEditor.isActive('heading', { level: 2 });
            break;
          case 'heading3':
            isActive = tiptapEditor.isActive('heading', { level: 3 });
            break;
          case 'bulletList':
            isActive = tiptapEditor.isActive('bulletList');
            break;
          case 'orderedList':
            isActive = tiptapEditor.isActive('orderedList');
            break;
          case 'taskList':
            isActive = tiptapEditor.isActive('taskList');
            break;
          case 'code':
            isActive = tiptapEditor.isActive('code');
            break;
          case 'blockquote':
            isActive = tiptapEditor.isActive('blockquote');
            break;
        }
        
        btn.classList.toggle('is-active', isActive);
      });
    }
    
    // Helper functions for TipTap
    function getEditorContent() {
      if (tiptapEditor) {
        return tiptapEditor.getHTML();
      }
      return document.getElementById('notesEditorHidden')?.value || '';
    }
    
    function setEditorContent(content) {
      if (tiptapEditor) {
        tiptapEditor.commands.setContent(content || '');
      }
      const hidden = document.getElementById('notesEditorHidden');
      if (hidden) {
        hidden.value = content || '';
      }
    }
    
    // Convert markdown to HTML for TipTap
    function convertMarkdownToHTML(markdown) {
      if (!markdown) return '';
      
      // Clean up excessive whitespace first
      let cleaned = markdown
        .replace(/\n{3,}/g, '\n\n')  // Max 2 newlines
        .trim();
      
      // Split into lines and process
      const lines = cleaned.split('\n');
      let html = '';
      let inList = false;
      let listType = 'ul';
      
      for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue; // Skip empty lines
        
        // Headers
        if (line.startsWith('### ')) {
          if (inList) { html += `</${listType}>`; inList = false; }
          html += `<h3>${line.slice(4)}</h3>`;
        } else if (line.startsWith('## ')) {
          if (inList) { html += `</${listType}>`; inList = false; }
          html += `<h2>${line.slice(3)}</h2>`;
        } else if (line.startsWith('# ')) {
          if (inList) { html += `</${listType}>`; inList = false; }
          html += `<h1>${line.slice(2)}</h1>`;
        }
        // Task list items
        else if (line.match(/^- \[ \] /)) {
          if (!inList || listType !== 'taskList') {
            if (inList) html += `</${listType}>`;
            html += '<ul data-type="taskList">';
            inList = true;
            listType = 'taskList';
          }
          const content = line.slice(6);
          html += `<li data-type="taskItem" data-checked="false"><label><input type="checkbox"></label><div>${formatInline(content)}</div></li>`;
        } else if (line.match(/^- \[x\] /i)) {
          if (!inList || listType !== 'taskList') {
            if (inList) html += `</${listType}>`;
            html += '<ul data-type="taskList">';
            inList = true;
            listType = 'taskList';
          }
          const content = line.slice(6);
          html += `<li data-type="taskItem" data-checked="true"><label><input type="checkbox" checked></label><div>${formatInline(content)}</div></li>`;
        }
        // Bullet list items
        else if (line.startsWith('- ') || line.startsWith(' ')) {
          if (!inList || listType !== 'ul') {
            if (inList) html += `</${listType}>`;
            html += '<ul>';
            inList = true;
            listType = 'ul';
          }
          const content = line.slice(2);
          html += `<li>${formatInline(content)}</li>`;
        }
        // Numbered list items
        else if (line.match(/^\d+\. /)) {
          if (!inList || listType !== 'ol') {
            if (inList) html += `</${listType}>`;
            html += '<ol>';
            inList = true;
            listType = 'ol';
          }
          const content = line.replace(/^\d+\. /, '');
          html += `<li>${formatInline(content)}</li>`;
        }
        // Blockquote
        else if (line.startsWith('> ')) {
          if (inList) { html += `</${listType}>`; inList = false; }
          html += `<blockquote>${formatInline(line.slice(2))}</blockquote>`;
        }
        // Horizontal rule
        else if (line === '---') {
          if (inList) { html += `</${listType}>`; inList = false; }
          html += '<hr>';
        }
        // Regular paragraph
        else {
          if (inList) { html += `</${listType}>`; inList = false; }
          html += `<p>${formatInline(line)}</p>`;
        }
      }
      
      // Close any open list
      if (inList) html += `</${listType}>`;
      
      return html;
    }
    
    function formatInline(text) {
      return text
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/__(.+?)__/g, '<strong>$1</strong>')
        .replace(/_(.+?)_/g, '<em>$1</em>');
    }
    
    // Initialize TipTap when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initTiptapEditor, 100);
    });
    
    // ============================================================================
    // SETUP/PERMISSIONS CHECK
    // ============================================================================
    const setupOverlay = document.getElementById('setupOverlay');
    const setupMic = document.getElementById('setupMic');
    const setupScreen = document.getElementById('setupScreen');
    const setupDeepgram = document.getElementById('setupDeepgram');
    const setupParakeetItem = document.getElementById('setupParakeet');
    const setupOpenAI = document.getElementById('setupOpenAI');
    const setupMicBtn = document.getElementById('setupMicBtn');
    const setupScreenBtn = document.getElementById('setupScreenBtn');
    const setupDeepgramBtn = document.getElementById('setupDeepgramBtn');
    const setupParakeetDownloadBtn = document.getElementById('setupParakeetDownloadBtn');
    const setupParakeetCancelBtn = document.getElementById('setupParakeetCancelBtn');
    const deepgramApiInput = document.getElementById('deepgramApiInput');
    const openaiApiInput = document.getElementById('openaiApiInput');
    const setupContinueBtn = document.getElementById('setupContinueBtn');
    const setupNextBtn1 = document.getElementById('setupNextBtn1');
    const setupNextBtn2 = document.getElementById('setupNextBtn2');
    const setupBackBtn2 = document.getElementById('setupBackBtn2');
    const setupBackBtn3 = document.getElementById('setupBackBtn3');
    
    let currentStep = 1;
    
    function showStep(step) {
      currentStep = step;
      
      // Hide all screens
      document.getElementById('setupScreen1').classList.add('hidden');
      document.getElementById('setupScreen2').classList.add('hidden');
      document.getElementById('setupScreen3').classList.add('hidden');
      
      // Show current screen
      document.getElementById(`setupScreen${step}`).classList.remove('hidden');
      
      // Update step indicators
      for (let i = 1; i <= 3; i++) {
        const indicator = document.getElementById(`stepIndicator${i}`);
        if (i < step) {
          indicator.classList.add('complete');
          indicator.classList.remove('active');
        } else if (i === step) {
          indicator.classList.add('active');
          indicator.classList.remove('complete');
        } else {
          indicator.classList.remove('active', 'complete');
        }
      }
    }
    
    let setupState = {
      microphone: false,
      screenRecording: false,
      deepgramKey: false,
      openaiKey: false,
      parakeetReady: false,
      selectedEngine: null
    };
    
    async function checkSetup() {
      // Check permissions
      const perms = await ipcRenderer.invoke('check-permissions');
      setupState.microphone = perms.microphone;
      setupState.screenRecording = perms.screenRecording;
      
      // Check API keys
      setupState.deepgramKey = await ipcRenderer.invoke('has-deepgram-key');
      setupState.openaiKey = await ipcRenderer.invoke('openai-has-key');
      
      // Populate input fields if keys exist
      if (setupState.deepgramKey && deepgramApiInput) {
        deepgramApiInput.value = ''; // Show masked value
        deepgramApiInput.disabled = true; // Disable editing once set
      }
      if (setupState.openaiKey && openaiApiInput) {
        openaiApiInput.value = ''; // Show masked value
        openaiApiInput.disabled = true; // Disable editing once set
      }
      
      // Check Parakeet model
      setupState.parakeetReady = await ipcRenderer.invoke('parakeet-check-downloaded');
      
      // Get current transcription engine if not selected yet
      if (!setupState.selectedEngine) {
        setupState.selectedEngine = await ipcRenderer.invoke('transcription-get-engine') || 'deepgram';
        selectTranscriptionEngine(setupState.selectedEngine);
      }
      
      // Check AI engine and local LLM state
      setupState.selectedAIEngine = await ipcRenderer.invoke('ai-get-engine') || 'openai';
      setupState.localLLMReady = await ipcRenderer.invoke('llm-is-ready');
      
      // Select AI engine in UI if we have a preference
      if (typeof selectAIEngine === 'function' && setupState.selectedAIEngine) {
        await selectAIEngine(setupState.selectedAIEngine);
      }
      
      updateSetupUI();
      
      // Check if all requirements are met:
      // 1. Both permissions granted
      // 2. One transcription engine configured (Deepgram key OR Parakeet model)
      // 3. AI engine configured (OpenAI key OR local LLM ready)
      const permissionsOk = setupState.microphone && setupState.screenRecording;
      const transcriptionOk = setupState.deepgramKey || setupState.parakeetReady;
      const aiOk = setupState.openaiKey || setupState.localLLMReady;
      
      const allSetupComplete = permissionsOk && transcriptionOk && aiOk;
      
      if (allSetupComplete) {
        setupOverlay.classList.add('hidden');
        return true;
      } else {
        setupOverlay.classList.remove('hidden');
        return false;
      }
    }
    
    function updateSetupUI() {
      // Microphone
      if (setupState.microphone) {
        setupMic.classList.add('complete');
        setupMic.classList.remove('error');
        setupMic.querySelector('.setup-item-icon').textContent = '';
        setupMicBtn.textContent = 'Granted';
        setupMicBtn.disabled = true;
      } else {
        setupMic.classList.remove('complete');
        setupMicBtn.textContent = 'Grant';
        setupMicBtn.disabled = false;
      }
      
      // Screen Recording
      if (setupState.screenRecording) {
        setupScreen.classList.add('complete');
        setupScreen.classList.remove('error');
        setupScreen.querySelector('.setup-item-icon').textContent = '';
        setupScreenBtn.textContent = 'Granted';
        setupScreenBtn.disabled = true;
      } else {
        setupScreen.classList.remove('complete');
        setupScreenBtn.textContent = 'Grant';
        setupScreenBtn.disabled = false;
      }
      
      // Deepgram
      if (setupState.deepgramKey) {
        setupDeepgram.classList.add('complete');
        setupDeepgram.classList.remove('error');
        setupDeepgram.querySelector('.setup-item-icon').textContent = '';
      } else {
        setupDeepgram.classList.remove('complete');
        setupDeepgram.querySelector('.setup-item-icon').textContent = '';
      }
      
      // Parakeet
      if (setupState.parakeetReady) {
        document.getElementById('parakeetNotDownloaded').classList.add('hidden');
        document.getElementById('parakeetDownloading').classList.add('hidden');
        document.getElementById('parakeetDownloaded').classList.remove('hidden');
        setupParakeetItem.classList.add('complete');
      } else {
        document.getElementById('parakeetNotDownloaded').classList.remove('hidden');
        document.getElementById('parakeetDownloading').classList.add('hidden');
        document.getElementById('parakeetDownloaded').classList.add('hidden');
        setupParakeetItem.classList.remove('complete');
      }
      
      // OpenAI
      if (setupState.openaiKey) {
        setupOpenAI.classList.add('complete');
        setupOpenAI.classList.remove('error');
        setupOpenAI.querySelector('.setup-item-icon').textContent = '';
      } else {
        setupOpenAI.classList.remove('complete');
        setupOpenAI.querySelector('.setup-item-icon').textContent = '';
      }
      
      // Step 1: Permissions complete? (REQUIRED)
      const step1Complete = setupState.microphone && setupState.screenRecording;
      setupNextBtn1.disabled = !step1Complete;
      if (!step1Complete) {
        setupNextBtn1.textContent = 'Grant permissions to continue';
      } else {
        setupNextBtn1.textContent = 'Next';
      }
      
      // Step 2: Engine selected and configured? (REQUIRED)
      let step2Complete = false;
      if (setupState.selectedEngine === 'deepgram') {
        step2Complete = setupState.deepgramKey; // Must have API key
      } else if (setupState.selectedEngine === 'parakeet') {
        step2Complete = setupState.parakeetReady; // Must have model downloaded
      }
      setupNextBtn2.disabled = !step2Complete;
      if (!setupState.selectedEngine) {
        setupNextBtn2.textContent = 'Choose transcription engine';
      } else if (!step2Complete) {
        setupNextBtn2.textContent = setupState.selectedEngine === 'deepgram' 
          ? 'Enter Deepgram API key' 
          : 'Download model to continue';
      } else {
        setupNextBtn2.textContent = 'Next';
      }
      
      // Step 3: AI Engine selected and configured? (REQUIRED for AI-enhanced notes)
      let step3Complete = false;
      if (setupState.selectedAIEngine === 'openai') {
        step3Complete = setupState.openaiKey; // Must have OpenAI API key
      } else if (setupState.selectedAIEngine === 'local') {
        step3Complete = setupState.localLLMReady; // Must have model downloaded
      }
      // Also allow if OpenAI key is set regardless (backward compatibility)
      if (setupState.openaiKey) step3Complete = true;
      
      setupContinueBtn.disabled = !step3Complete;
      if (!setupState.selectedAIEngine) {
        setupContinueBtn.textContent = 'Choose AI engine';
      } else if (!step3Complete) {
        setupContinueBtn.textContent = setupState.selectedAIEngine === 'openai' 
          ? 'Enter API key to continue' 
          : 'Download model to continue';
      } else {
        setupContinueBtn.textContent = 'Continue to IceCubes';
      }
    }
    
    // Transcription engine selection
    let selectedEngine = null;
    const setupChoiceDeepgram = document.getElementById('setupChoiceDeepgram');
    const setupChoiceParakeet = document.getElementById('setupChoiceParakeet');
    const setupDeepgramItem = document.getElementById('setupDeepgram');
    // setupParakeetItem already declared at the top
    
    function selectTranscriptionEngine(engine) {
      selectedEngine = engine;
      setupState.selectedEngine = engine;
      
      // Update button states
      if (engine === 'deepgram') {
        setupChoiceDeepgram.classList.add('selected');
        setupChoiceParakeet.classList.remove('selected');
        // Show Deepgram config, hide Parakeet
        setupDeepgramItem.classList.remove('hidden');
        setupParakeetItem.classList.add('hidden');
      } else if (engine === 'parakeet') {
        setupChoiceDeepgram.classList.remove('selected');
        setupChoiceParakeet.classList.add('selected');
        // Show Parakeet config, hide Deepgram
        setupDeepgramItem.classList.add('hidden');
        setupParakeetItem.classList.remove('hidden');
      }
      
      updateSetupUI();
    }
    
    setupChoiceDeepgram?.addEventListener('click', () => selectTranscriptionEngine('deepgram'));
    setupChoiceParakeet?.addEventListener('click', () => selectTranscriptionEngine('parakeet'));
    
    // API key input handlers
    deepgramApiInput?.addEventListener('input', async (e) => {
      const apiKey = e.target.value.trim();
      if (apiKey.length > 10) { // Basic validation
        // Save the API key
        const saved = await ipcRenderer.invoke('save-deepgram-key', apiKey);
        if (saved) {
          setupState.deepgramKey = true;
          setupDeepgram.classList.add('complete');
          updateSetupUI();
        }
      } else {
        setupState.deepgramKey = false;
        setupDeepgram.classList.remove('complete');
        updateSetupUI();
      }
    });
    
    openaiApiInput?.addEventListener('input', async (e) => {
      const apiKey = e.target.value.trim();
      if (apiKey.length > 10) { // Basic validation
        // Save the API key
        const saved = await ipcRenderer.invoke('openai-save-key', apiKey);
        if (saved) {
          setupState.openaiKey = true;
          setupOpenAI.classList.add('complete');
          updateSetupUI();
        }
      } else {
        setupState.openaiKey = false;
        setupOpenAI.classList.remove('complete');
        updateSetupUI();
      }
    });
    
    // AI Engine selection (OpenAI vs Local LLM)
    let selectedAIEngine = null;
    const setupChoiceOpenAI = document.getElementById('setupChoiceOpenAI');
    const setupChoiceLocalLLM = document.getElementById('setupChoiceLocalLLM');
    const setupOpenAIConfig = document.getElementById('setupOpenAIConfig');
    const setupLocalLLMConfig = document.getElementById('setupLocalLLMConfig');
    const localLLMNotDownloaded = document.getElementById('localLLMNotDownloaded');
    const localLLMDownloading = document.getElementById('localLLMDownloading');
    const localLLMDownloaded = document.getElementById('localLLMDownloaded');
    const setupLLMDownloadBtn = document.getElementById('setupLLMDownloadBtn');
    const llmProgressFill = document.getElementById('llmProgressFill');
    const llmProgressText = document.getElementById('llmProgressText');
    
    setupState.selectedAIEngine = null;
    setupState.localLLMReady = false;
    
    async function selectAIEngine(engine) {
      selectedAIEngine = engine;
      setupState.selectedAIEngine = engine;
      
      // Update button states
      if (engine === 'openai') {
        setupChoiceOpenAI?.classList.add('selected');
        setupChoiceLocalLLM?.classList.remove('selected');
        setupOpenAIConfig?.classList.remove('hidden');
        setupLocalLLMConfig?.classList.add('hidden');
      } else if (engine === 'local') {
        setupChoiceOpenAI?.classList.remove('selected');
        setupChoiceLocalLLM?.classList.add('selected');
        setupOpenAIConfig?.classList.add('hidden');
        setupLocalLLMConfig?.classList.remove('hidden');
        
        // Check if local LLM is ready
        const isReady = await ipcRenderer.invoke('llm-is-ready');
        setupState.localLLMReady = isReady;
        updateLocalLLMUI(isReady);
      }
      
      // Save engine preference
      await ipcRenderer.invoke('ai-set-engine', engine);
      updateSetupUI();
    }
    
    function updateLocalLLMUI(isReady) {
      if (isReady) {
        localLLMNotDownloaded?.classList.add('hidden');
        localLLMDownloading?.classList.add('hidden');
        localLLMDownloaded?.classList.remove('hidden');
      } else {
        localLLMNotDownloaded?.classList.remove('hidden');
        localLLMDownloading?.classList.add('hidden');
        localLLMDownloaded?.classList.add('hidden');
      }
    }
    
    setupChoiceOpenAI?.addEventListener('click', () => selectAIEngine('openai'));
    setupChoiceLocalLLM?.addEventListener('click', () => selectAIEngine('local'));
    
    // LLM Download button
    setupLLMDownloadBtn?.addEventListener('click', async () => {
      // Show downloading state
      localLLMNotDownloaded?.classList.add('hidden');
      localLLMDownloading?.classList.remove('hidden');
      localLLMDownloaded?.classList.add('hidden');
      llmProgressText.textContent = 'Initializing download...';
      llmProgressFill.style.width = '0%';
      
      try {
        // Start the LLM init (downloads model from HuggingFace if not cached)
        const started = await ipcRenderer.invoke('llm-init');
        
        if (started) {
          // Poll for progress
          const pollProgress = setInterval(async () => {
            const progress = await ipcRenderer.invoke('llm-get-init-progress');
            
            if (progress.error) {
              clearInterval(pollProgress);
              llmProgressText.textContent = 'Download failed: ' + progress.error;
              localLLMNotDownloaded?.classList.remove('hidden');
              localLLMDownloading?.classList.add('hidden');
              return;
            }
            
            llmProgressText.textContent = progress.status || 'Downloading...';
            
            if (!progress.isLoading) {
              clearInterval(pollProgress);
              
              // Check if ready
              const isReady = await ipcRenderer.invoke('llm-is-ready');
              setupState.localLLMReady = isReady;
              updateLocalLLMUI(isReady);
              updateSetupUI();
            }
          }, 1000);
        }
      } catch (e) {
        console.error('[Setup] LLM init error:', e);
        llmProgressText.textContent = 'Error: ' + e.message;
        localLLMNotDownloaded?.classList.remove('hidden');
        localLLMDownloading?.classList.add('hidden');
      }
    });
    
    // Navigation buttons
    setupNextBtn1?.addEventListener('click', () => showStep(2));
    setupNextBtn2?.addEventListener('click', () => {
      showStep(3);
      updateSetupUI(); // Refresh to show correct config items
    });
    setupBackBtn2?.addEventListener('click', () => showStep(1));
    setupBackBtn3?.addEventListener('click', () => showStep(2));
    
    setupMicBtn?.addEventListener('click', async () => {
      // Open System Settings to Microphone permissions
      ipcRenderer.send('open-microphone-settings');
      // Keep checking until permission is granted
      const checkMicPermission = setInterval(async () => {
        const setup = await checkSetup();
        if (setup || setupState.microphone) {
          clearInterval(checkMicPermission);
        }
      }, 2000);
    });
    
    setupScreenBtn?.addEventListener('click', async () => {
      // Request and trigger screen recording permission prompt
      await ipcRenderer.invoke('request-screen-recording-permission');
      // Open System Settings to Screen Recording permissions
      ipcRenderer.send('open-screen-recording-settings');
      // Keep checking until permission is granted
      const checkScreenPermission = setInterval(async () => {
        const setup = await checkSetup();
        if (setup || setupState.screenRecording) {
          clearInterval(checkScreenPermission);
        }
      }, 2000);
    });
    
    let downloadProgressInterval = null;
    
    setupParakeetDownloadBtn?.addEventListener('click', async () => {
      // Show downloading state immediately with real progress bar
      document.getElementById('parakeetNotDownloaded').classList.add('hidden');
      document.getElementById('parakeetDownloading').classList.remove('hidden');
      
      // Switch to determinate progress bar
      const progressBar = document.querySelector('.parakeet-progress');
      const progressFill = document.getElementById('parakeetProgressFill');
      progressBar.classList.remove('parakeet-progress-indeterminate');
      progressFill.classList.remove('parakeet-progress-animated');
      progressFill.style.width = '0%';
      document.getElementById('parakeetProgressText').textContent = 'Starting download...';
      
      // Start download first (returns immediately, runs in background thread)
      try {
        const result = await ipcRenderer.invoke('parakeet-download-model');
        console.log('[Parakeet] Download started:', result);
        
        if (!result.success || !result.started) {
          document.getElementById('parakeetDownloading').classList.add('hidden');
          document.getElementById('parakeetNotDownloaded').classList.remove('hidden');
          alert(`Failed to start download: ${result.error || 'Unknown error'}`);
          return;
        }
      } catch (e) {
        console.error('[Parakeet] Download start error:', e);
        document.getElementById('parakeetDownloading').classList.add('hidden');
        document.getElementById('parakeetNotDownloaded').classList.remove('hidden');
        alert(`Failed to start download: ${e.message || e}`);
        return;
      }
      
      // Start polling for progress (download runs in background thread)
      downloadProgressInterval = setInterval(async () => {
        try {
          const progress = await ipcRenderer.invoke('parakeet-get-download-progress');
          console.log('[Parakeet] Progress:', progress);
          
          if (progress.isDownloading) {
            // Update progress bar
            progressFill.style.width = `${progress.percent}%`;
            
            // Update text with current file and percentage
            const downloadedMB = (progress.bytesDownloaded / (1024 * 1024)).toFixed(1);
            const totalMB = (progress.totalBytes / (1024 * 1024)).toFixed(0);
            const fileInfo = progress.currentFile ? `${progress.currentFile} (${progress.currentFileIndex + 1}/${progress.totalFiles})` : 'Starting...';
            document.getElementById('parakeetProgressText').textContent = 
              `Downloading ${fileInfo} - ${downloadedMB}/${totalMB} MB (${progress.percent}%)`;
          } else if (progress.error) {
            // Download failed
            clearInterval(downloadProgressInterval);
            downloadProgressInterval = null;
            document.getElementById('parakeetDownloading').classList.add('hidden');
            document.getElementById('parakeetNotDownloaded').classList.remove('hidden');
            alert(`Download failed: ${progress.error}`);
          } else if (!progress.isDownloading && progress.percent >= 100) {
            // Download complete
            clearInterval(downloadProgressInterval);
            downloadProgressInterval = null;
            handleParakeetDownloadComplete();
          }
        } catch (e) {
          console.error('[Parakeet] Progress poll error:', e);
        }
      }, 500); // Poll every 500ms
    });
    
    async function handleParakeetDownloadComplete() {
      document.getElementById('parakeetDownloading').classList.add('hidden');
      document.getElementById('parakeetDownloaded').classList.remove('hidden');
      
      setupState.parakeetReady = true;
      setupParakeetItem.classList.add('complete');
      setupParakeetItem.querySelector('.setup-item-icon').textContent = '';
      
      // Get model size
      const info = await ipcRenderer.invoke('parakeet-get-info');
      document.getElementById('parakeetModelSize').textContent = formatBytes(info.size);
      
      updateSetupUI();
    }
    
    // Listen for Parakeet download events (backup to polling)
    ipcRenderer.on('parakeet-download-complete', async () => {
      if (downloadProgressInterval) {
        clearInterval(downloadProgressInterval);
        downloadProgressInterval = null;
      }
      handleParakeetDownloadComplete();
    });
    
    ipcRenderer.on('parakeet-download-error', (event, error) => {
      if (downloadProgressInterval) {
        clearInterval(downloadProgressInterval);
        downloadProgressInterval = null;
      }
      document.getElementById('parakeetDownloading').classList.add('hidden');
      document.getElementById('parakeetNotDownloaded').classList.remove('hidden');
      alert(`Download failed: ${error}`);
    });
    
    // Delete model button
    const setupParakeetDeleteBtn = document.getElementById('setupParakeetDeleteBtn');
    setupParakeetDeleteBtn?.addEventListener('click', async () => {
      const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
        title: 'Delete Parakeet Model',
        message: 'Are you sure you want to delete the Parakeet model (~670 MB)?\n\nYou will need to download it again to use local transcription.',
        okLabel: 'Delete',
        cancelLabel: 'Cancel'
      });
      
      if (!confirmed) {
        return;
      }
      
      try {
        const result = await ipcRenderer.invoke('parakeet-delete-model');
        if (result) {
          // Reset UI
          document.getElementById('parakeetDownloaded').classList.add('hidden');
          document.getElementById('parakeetNotDownloaded').classList.remove('hidden');
          
          setupState.parakeetReady = false;
          setupParakeetItem.classList.remove('complete');
          setupParakeetItem.querySelector('.setup-item-icon').textContent = '';
          
          updateSetupUI();
        } else {
          alert('Failed to delete model');
        }
      } catch (e) {
        console.error('[Parakeet] Delete error:', e);
        alert(`Failed to delete model: ${e.message || e}`);
      }
    });
    
    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    setupContinueBtn?.addEventListener('click', async () => {
      // Save selected transcription engine
      if (selectedEngine) {
        await ipcRenderer.invoke('transcription-set-engine', selectedEngine);
      }
      setupOverlay.classList.add('hidden');
    });
    
    // Check setup on load
    checkSetup();
    
    // Initialize wizard to step 1
    showStep(1);
    
    // Initialize theme on load
    (async () => {
      const theme = await ipcRenderer.invoke('theme-get') || 'system';
      if (theme === 'system') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
      }
    })();
    
    // Listen for settings saved to recheck setup
    ipcRenderer.on('settings-updated', () => {
      checkSetup();
    });
    
    // ============================================================================
    // MAIN APP
    // ============================================================================
    
    // Simple markdown to HTML converter
    function renderMarkdown(text) {
      if (!text) return '';
      
      let html = text
        // Escape HTML first
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        // Headers
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        // Bold
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        // Italic
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        // Unordered lists
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        // Wrap consecutive <li> in <ul>
        .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
        // Paragraphs (double newlines)
        .replace(/\n\n/g, '</p><p>')
        // Single newlines to <br>
        .replace(/\n/g, '<br>');
      
      // Wrap in paragraph if not already structured
      if (!html.startsWith('<h') && !html.startsWith('<ul') && !html.startsWith('<p>')) {
        html = '<p>' + html + '</p>';
      }
      
      return html;
    }
    
    const sidebar = document.getElementById('sidebar');
    const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
    const backBtn = document.getElementById('backBtn');
    const globalSearchInput = document.getElementById('globalSearchInput');
    const meetingTitle = document.getElementById('meetingTitle');
    const notesEditor = document.getElementById('notesEditor');
    const micControl = document.getElementById('micControl');
    const micLabel = document.getElementById('micLabel');
    // Transcript elements (may not exist if hidden)
    const transcriptSection = document.getElementById('transcriptSection');
    const transcriptContent = document.getElementById('transcriptContent');
    const transcriptEmpty = document.getElementById('transcriptEmpty');
    const transcriptStatus = document.getElementById('transcriptStatus');
    const transcriptBubbles = document.getElementById('transcriptBubbles');
    // Note: These elements are removed in simplified UI but code handles null gracefully
    const nextMeeting = document.getElementById('nextMeeting');
    const nextMeetingTime = document.getElementById('nextMeetingTime');
    const notesList = document.getElementById('notesList');
    const notesHome = document.getElementById('notesHome');
    const editorContent = document.getElementById('editorContent');
    const editorFooter = document.getElementById('editorFooter');
    const newNoteBtn = document.getElementById('newNoteBtn');
    const saveStatus = document.getElementById('saveStatus');
    
    // Settings panel elements
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsOverlay = document.getElementById('settingsOverlay');
    const settingsPanel = document.getElementById('settingsPanel');
    const settingsCloseBtn = document.getElementById('settingsCloseBtn');
    const deepgramKeyInput = document.getElementById('deepgramKeyInput');
    const deepgramSaveBtn = document.getElementById('deepgramSaveBtn');
    const deepgramStatus = document.getElementById('deepgramStatus');
    const deepgramStatusText = document.getElementById('deepgramStatusText');
    const deepgramLink = document.getElementById('deepgramLink');
    const openaiKeyInput = document.getElementById('openaiKeyInput');
    const openaiSaveBtn = document.getElementById('openaiSaveBtn');
    const openaiStatus = document.getElementById('openaiStatus');
    const openaiStatusText = document.getElementById('openaiStatusText');
    const openaiLink = document.getElementById('openaiLink');
    const calendarConnectBtn = document.getElementById('calendarConnectBtn');
    const calendarStatus = document.getElementById('calendarStatus');
    const calendarStatusText = document.getElementById('calendarStatusText');
    
    // Calendar panel elements (home screen)
    const calendarEvents = document.getElementById('calendarEvents');
    const connectCalendarBtn = document.getElementById('connectCalendarBtn');
    
    // AI Q&A panel elements
    const aiQAPanel = document.getElementById('aiQAPanel');
    const aiQAClose = document.getElementById('aiQAClose');
    const aiQATextarea = document.getElementById('aiQATextarea');
    const aiQASubmit = document.getElementById('aiQASubmit');
    const aiQAAnswer = document.getElementById('aiQAAnswer');
    const aiQAAnswerContent = document.getElementById('aiQAAnswerContent');
    const aiQALoading = document.getElementById('aiQALoading');
    
    // Folder elements
    const foldersList = document.getElementById('foldersList');
    const addFolderBtn = document.getElementById('addFolderBtn');
    const folderModal = document.getElementById('folderModal');
    const folderModalTitle = document.getElementById('folderModalTitle');
    const folderNameInput = document.getElementById('folderNameInput');
    const folderDescInput = document.getElementById('folderDescInput');
    const folderIconPicker = document.getElementById('folderIconPicker');
    const folderCancelBtn = document.getElementById('folderCancelBtn');
    const folderCreateBtn = document.getElementById('folderCreateBtn');
    const folderDefaultToggle = document.getElementById('folderDefaultToggle');
    const folderDefaultWarning = document.getElementById('folderDefaultWarning');
    const currentDefaultName = document.getElementById('currentDefaultName');
    const navAllNotes = document.getElementById('navAllNotes');
    
    // Folder state
    let folders = [];
    let currentFolderId = 'all'; // 'all', 'shared', or a folder ID
    let selectedFolderIcon = '';
    let editingFolderId = null;
    let currentDefaultFolder = null;
    const aiQACopy = document.getElementById('aiQACopy');
    const askInput = document.getElementById('askInput');
    const askInputWrapper = document.getElementById('askInputWrapper');
    
    // Meeting meta elements
    const dateBadge = document.getElementById('dateBadge');
    const dateLabel = document.getElementById('dateLabel');
    const participantsBadge = document.getElementById('participantsBadge');
    const participantsLabel = document.getElementById('participantsLabel');
    const meetingDatetime = document.getElementById('meetingDatetime');
    const meetingActions = document.getElementById('meetingActions');
    const openCalendarBtn = document.getElementById('openCalendarBtn');
    const joinMeetingBtn = document.getElementById('joinMeetingBtn');
    
    // Attendees elements
    const attendeesWrapper = document.getElementById('attendeesWrapper');
    const attendeesBadge = document.getElementById('attendeesBadge');
    const attendeesLabel = document.getElementById('attendeesLabel');
    const attendeesDropdown = document.getElementById('attendeesDropdown');
    const attendeesList = document.getElementById('attendeesList');
    
    let transcript = [];
    let currentMeetingLink = null;
    let currentCalendarLink = null;
    let currentMeetingInfo = null;
    let isMicActive = false;
    let scheduledStartTimer = null;
    let lastTranscriptTime = null;
    let silenceTimer = null;
    const SILENCE_TIMEOUT = 15 * 60 * 1000; // 15 minutes
    let isRecording = false;
    let recordingStartTime = null; // Track when recording started for timestamps
    let notes = [];
    let currentNoteId = null;
    let currentNoteFolderId = null; // Track folder so it's preserved on save
    let autoSaveTimer = null;
    let hasUnsavedChanges = false;
    let calendarConnected = false;
    
    // AI Notes state
    let aiNotesInterval = null;
    let currentAINotes = null;
    let hasOpenAIKey = false;
    let currentSuggestedFolder = null; // { folderId, confidence, reason }
    
    // Folder suggestion cache: { noteId: { contentHash, suggestion } }
    const folderSuggestionCache = new Map();
    
    // Simple hash function for content
    function hashContent(content) {
      let hash = 0;
      const str = content || '';
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return hash.toString(16);
    }
    
    // AI Notes elements
    const aiNotesPanel = document.getElementById('aiNotesPanel');
    const aiGenerating = document.getElementById('aiGenerating');
    const aiEmpty = document.getElementById('aiEmpty');
    const aiResults = document.getElementById('aiResults');
    const aiSummary = document.getElementById('aiSummary');
    const aiKeyPoints = document.getElementById('aiKeyPoints');
    const aiActionItems = document.getElementById('aiActionItems');
    const aiDecisions = document.getElementById('aiDecisions');
    const aiNotesActions = document.getElementById('aiNotesActions');
    const aiAppendBtn = document.getElementById('aiAppendBtn');
    const aiRegenerateBtn = document.getElementById('aiRegenerateBtn');
    
    // Floating recording indicator
    const floatingRecordingIndicator = document.getElementById('floatingRecordingIndicator');
    const floatingRecordingTitle = document.getElementById('floatingRecordingTitle');
    const floatingRecordingClose = document.getElementById('floatingRecordingClose');
    const floatingRecordingContent = document.getElementById('floatingRecordingContent');
    
    console.log('[FloatingIndicator] Elements found:', {
      indicator: !!floatingRecordingIndicator,
      title: !!floatingRecordingTitle,
      close: !!floatingRecordingClose,
      content: !!floatingRecordingContent
    });
    
    // Update floating indicator
    function updateFloatingIndicator() {
      if (!floatingRecordingIndicator) return;
      
      // Show if recording but not viewing editor
      const shouldShow = isRecording && notesHome && notesHome.style.display !== 'none';
      
      if (shouldShow) {
        const title = meetingTitle?.textContent?.trim() || 'Untitled';
        if (floatingRecordingTitle) floatingRecordingTitle.textContent = title;
        floatingRecordingIndicator.classList.remove('hidden');
      } else {
        floatingRecordingIndicator.classList.add('hidden');
      }
    }
    
    // Make floating indicator draggable
    let isDragging = false;
    let dragStartTime = 0;
    let dragStartX = 0;
    let dragStartY = 0;
    let indicatorLeft = null;
    let indicatorTop = null;
    
    if (floatingRecordingContent) {
      console.log('[FloatingIndicator] Setting up drag and click handlers');
      
      floatingRecordingContent.addEventListener('mousedown', (e) => {
        // Don't drag if clicking close button
        if (e.target === floatingRecordingClose || e.target.closest('.floating-recording-close')) {
          return;
        }
        
        isDragging = false;
        dragStartTime = Date.now();
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        
        // Get current position
        const rect = floatingRecordingIndicator.getBoundingClientRect();
        indicatorLeft = rect.left;
        indicatorTop = rect.top;
        
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', (e) => {
        if (dragStartTime === 0) return;
        
        const deltaX = Math.abs(e.clientX - dragStartX);
        const deltaY = Math.abs(e.clientY - dragStartY);
        
        // Start dragging if moved more than 5px
        if (!isDragging && (deltaX > 5 || deltaY > 5)) {
          isDragging = true;
          floatingRecordingContent.style.cursor = 'grabbing';
        }
        
        if (isDragging) {
          const newLeft = indicatorLeft + (e.clientX - dragStartX);
          const newTop = indicatorTop + (e.clientY - dragStartY);
          
          // Update position
          floatingRecordingIndicator.style.left = newLeft + 'px';
          floatingRecordingIndicator.style.top = newTop + 'px';
          floatingRecordingIndicator.style.transform = 'none'; // Remove centering transform
        }
      });
      
      document.addEventListener('mouseup', (e) => {
        if (dragStartTime === 0) return;
        
        const wasDragging = isDragging;
        isDragging = false;
        dragStartTime = 0;
        floatingRecordingContent.style.cursor = 'pointer';
        
        // If it was a click (not a drag), open editor
        if (!wasDragging) {
          // Don't trigger if clicking close button
          if (e.target === floatingRecordingClose || e.target.closest('.floating-recording-close')) {
            console.log('[FloatingIndicator] Close button clicked, not opening editor');
            return;
          }
          
          console.log('[FloatingIndicator] Content clicked - showing editor and focusing window');
          
          // Show the editor view
          showEditor();
          
          // Focus the window
          ipcRenderer.send('focus-editor-window');
          
          updateFloatingIndicator();
        }
      });
      
      console.log('[FloatingIndicator] Drag and click handlers attached');
    } else {
      console.error('[FloatingIndicator] Content element not found');
    }
    
    // Close button on floating indicator stops recording
    if (floatingRecordingClose) {
      floatingRecordingClose.addEventListener('click', async (e) => {
        e.stopPropagation();
        e.preventDefault();
        console.log('[FloatingIndicator] Close clicked - stopping recording');
        if (isRecording) {
          await stopTranscription();
        }
        updateFloatingIndicator();
      });
    } else {
      console.error('[FloatingIndicator] Close button not found');
    }
    
    // Show/hide home screen vs editor
    function showEmptyState() {
      if (notesHome) notesHome.style.display = 'flex';
      if (editorContent) editorContent.classList.add('hidden');
      if (editorFooter) editorFooter.classList.add('hidden');
      // Remove viewing-note class to show sidebar again
      document.body.classList.remove('viewing-note');
      // Hide back button on home page (only show for People/Companies views)
      backBtn?.classList.add('hidden');
      // Hide notes toggle wrapper on home screen
      const toggleWrapper = document.getElementById('notesViewToggleWrapper');
      if (toggleWrapper) {
        toggleWrapper.style.display = 'none';
        toggleWrapper.classList.remove('visible');
      }
      // Also hide the generate notes wrapper
      const genWrapper = document.getElementById('generateNotesWrapper');
      if (genWrapper) genWrapper.classList.add('hidden');
      updateFloatingIndicator(); // Update floating indicator when switching views
    }
    
    function showEditor() {
      if (notesHome) notesHome.style.display = 'none';
      if (editorContent) editorContent.classList.remove('hidden');
      // Always show footer (it contains the mic control)
      if (editorFooter) editorFooter.classList.remove('hidden');
      // Update visibility of the ask input based on recording state and content
      updateAskInputVisibility();
      // Add class to body to hide sidebar when viewing a note
      document.body.classList.add('viewing-note');
      // Hide toggle wrapper until we know if this note has AI notes
      const toggleWrapper = document.getElementById('notesViewToggleWrapper');
      if (toggleWrapper) toggleWrapper.classList.remove('visible');
      updateFloatingIndicator(); // Update floating indicator when switching views
    }
    
    // Update ask input visibility based on recording state and content
    function updateAskInputVisibility() {
      const askInputWrapper = document.getElementById('askInputWrapper');
      if (!askInputWrapper) return;
      
      // Hide ask input if recording is in progress
      if (isRecording || isMicActive) {
        askInputWrapper.style.visibility = 'hidden';
        return;
      }
      
      // Show ask input only if there's content available (transcript, notes, or AI notes)
      const hasTranscript = transcript && transcript.length > 0;
      const hasNotes = getEditorContent && getEditorContent().trim().length > 0;
      const hasAINotes = !!currentAINotes;
      
      if (hasTranscript || hasNotes || hasAINotes) {
        askInputWrapper.style.visibility = 'visible';
      } else {
        askInputWrapper.style.visibility = 'hidden';
      }
    }
    
    // Back button - return to All Notes from People/Companies/Folders
    backBtn?.addEventListener('click', () => {
      // Clear any active filters
      currentPersonFilter = null;
      currentCompanyFilter = null;
      
      // Go back to home and show floating indicator
      currentNoteId = null;
      
      // If we're in recording mode, exit it to restore window position
      if (document.body.classList.contains('recording-mode')) {
        console.log('[BackBtn] Exiting recording mode to restore window position');
        ipcRenderer.send('exit-recording-mode');
        document.body.classList.remove('recording-mode');
      }
      
      // Select "All Notes" folder
      selectFolder('all');
      
      // Show home and render notes
      showEmptyState();
      renderNotesList();
      
      // Remove viewing-note class to show sidebars again
      document.body.classList.remove('viewing-note');
      updateFloatingIndicator(); // Show floating indicator if recording
    });
    
    function showSettings() {
      settingsOverlay?.classList.remove('hidden');
      loadSettingsStatus();
      // Load provider states for transcription/AI toggles
      if (typeof loadSettingsProviderState === 'function') {
        loadSettingsProviderState();
      }
    }
    
    function hideSettings() {
      settingsOverlay?.classList.add('hidden');
    }
    
    async function loadSettingsStatus() {
      // Deepgram status
      const hasDeepgram = await ipcRenderer.invoke('has-deepgram-key');
      deepgramStatus?.querySelector('.status-dot')?.classList.toggle('active', hasDeepgram);
      if (deepgramStatusText) deepgramStatusText.textContent = hasDeepgram ? 'API key configured' : 'Not configured';
      
      // OpenAI status
      const hasOpenAI = await ipcRenderer.invoke('openai-has-key');
      openaiStatus?.querySelector('.status-dot')?.classList.toggle('active', hasOpenAI);
      if (openaiStatusText) openaiStatusText.textContent = hasOpenAI ? 'API key configured' : 'Not configured';
      
      // Calendar status
      const hasCalendar = await ipcRenderer.invoke('calendar-is-connected');
      calendarStatus?.querySelector('.status-dot')?.classList.toggle('active', hasCalendar);
      if (calendarStatusText) calendarStatusText.textContent = hasCalendar ? 'Connected' : 'Not connected';
      if (calendarConnectBtn) {
        calendarConnectBtn.textContent = hasCalendar ? 'Disconnect Calendar' : 'Connect Google Calendar';
        calendarConnectBtn.classList.toggle('connected', hasCalendar);
      }
      
      // Load calendar list if connected
      const visibleCalendarsSection = document.getElementById('visibleCalendarsSection');
      if (hasCalendar && visibleCalendarsSection) {
        visibleCalendarsSection.style.display = 'block';
        loadCalendarList();
      } else if (visibleCalendarsSection) {
        visibleCalendarsSection.style.display = 'none';
      }
      
      // Load theme
      loadTheme();
      
      // Load notification settings
      loadNotificationSettings();
      
      // Load language settings
      loadLanguageSettings();
    }
    
    // Settings Tab Navigation
    const settingsNavItems = document.querySelectorAll('.settings-nav-item');
    const settingsTabs = document.querySelectorAll('.settings-tab');
    
    settingsNavItems.forEach(item => {
      item.addEventListener('click', async () => {
        const tabName = item.dataset.tab;
        
        // Update nav active state
        settingsNavItems.forEach(nav => nav.classList.remove('active'));
        item.classList.add('active');
        
        // Show correct tab
        settingsTabs.forEach(tab => {
          if (tab.id === `settingsTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });
        
      });
    });
    
    // Theme handling
    const themeOptions = document.querySelectorAll('.theme-option');
    let currentTheme = 'system';
    
    async function loadTheme() {
      currentTheme = await ipcRenderer.invoke('theme-get') || 'system';
      themeOptions.forEach(opt => {
        opt.classList.toggle('active', opt.dataset.theme === currentTheme);
      });
      applyTheme(currentTheme);
    }
    
    function applyTheme(theme) {
      if (theme === 'system') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
      }
    }
    
    themeOptions.forEach(opt => {
      opt.addEventListener('click', async () => {
        const theme = opt.dataset.theme;
        await ipcRenderer.invoke('theme-set', theme);
        currentTheme = theme;
        themeOptions.forEach(o => o.classList.toggle('active', o.dataset.theme === theme));
        applyTheme(theme);
      });
    });
    
    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (currentTheme === 'system') {
        applyTheme('system');
      }
    });
    
    // Listen for theme changes from main process
    ipcRenderer.on('theme-changed', (_, theme) => {
      currentTheme = theme;
      themeOptions.forEach(o => o.classList.toggle('active', o.dataset.theme === theme));
      applyTheme(theme);
    });
    
    // Calendar list in settings
    const calendarListSettings = document.getElementById('calendarListSettings');
    const resetCalendarsBtn = document.getElementById('resetCalendarsBtn');
    
    async function loadCalendarList() {
      const calendars = await ipcRenderer.invoke('calendar-get-list');
      if (!calendars || !calendarListSettings) return;
      
      calendarListSettings.innerHTML = calendars.map(cal => `
        <div class="calendar-item" data-id="${cal.id}">
          <div class="calendar-color" style="background: ${cal.backgroundColor || '#4285f4'}"></div>
          <div class="calendar-name">${cal.summary}${cal.primary ? ' (primary)' : ''}</div>
          <div class="calendar-toggle ${cal.selected ? 'active' : ''}" data-id="${cal.id}"></div>
        </div>
      `).join('');
      
      // Add toggle handlers
      calendarListSettings.querySelectorAll('.calendar-toggle').forEach(toggle => {
        toggle.addEventListener('click', async () => {
          const calId = toggle.dataset.id;
          const isNowSelected = toggle.classList.contains('active');
          toggle.classList.toggle('active');
          await ipcRenderer.invoke('calendar-set-selected', calId, !isNowSelected);
          // Refresh events
          loadCalendarEvents();
        });
      });
    }
    
    resetCalendarsBtn?.addEventListener('click', async () => {
      // Reset all calendars to primary only
      const calendars = await ipcRenderer.invoke('calendar-get-list');
      for (const cal of calendars) {
        await ipcRenderer.invoke('calendar-set-selected', cal.id, cal.primary || false);
      }
      loadCalendarList();
      loadCalendarEvents();
    });
    
    // ============================================================================
    // NOTIFICATION SETTINGS
    // ============================================================================
    const toggleScheduledNotifs = document.getElementById('toggleScheduledNotifs');
    const toggleAutoDetectNotifs = document.getElementById('toggleAutoDetectNotifs');
    const mutedAppsList = document.getElementById('mutedAppsList');
    const mutedAppsSection = document.getElementById('mutedAppsSection');
    const appSelect = document.getElementById('appSelect');
    
    let notifSettings = {
      scheduledMeetings: true,
      autoDetectedMeetings: true,
      mutedApps: []
    };
    
    async function loadNotificationSettings() {
      notifSettings = await ipcRenderer.invoke('notif-get-settings') || notifSettings;
      
      // Update toggles
      toggleScheduledNotifs?.classList.toggle('active', notifSettings.scheduledMeetings);
      toggleAutoDetectNotifs?.classList.toggle('active', notifSettings.autoDetectedMeetings);
      
      // Update muted apps section visibility
      if (mutedAppsSection) {
        mutedAppsSection.style.display = notifSettings.autoDetectedMeetings ? 'block' : 'none';
      }
      
      // Render muted apps
      renderMutedApps();
    }
    
    function renderMutedApps() {
      if (!mutedAppsList) return;
      
      if (notifSettings.mutedApps.length === 0) {
        mutedAppsList.innerHTML = '<span style="color: var(--text-sidebar-muted); font-size: 13px;">No apps muted</span>';
      } else {
        mutedAppsList.innerHTML = notifSettings.mutedApps.map(app => `
          <div class="muted-app-tag">
            <span>${app}</span>
            <span class="remove-app" data-app="${app}"></span>
          </div>
        `).join('');
        
        // Add remove handlers
        mutedAppsList.querySelectorAll('.remove-app').forEach(btn => {
          btn.addEventListener('click', async () => {
            const app = btn.dataset.app;
            notifSettings.mutedApps = notifSettings.mutedApps.filter(a => a !== app);
            await ipcRenderer.invoke('notif-save-settings', notifSettings);
            renderMutedApps();
          });
        });
      }
    }
    
    toggleScheduledNotifs?.addEventListener('click', async () => {
      notifSettings.scheduledMeetings = !notifSettings.scheduledMeetings;
      toggleScheduledNotifs.classList.toggle('active', notifSettings.scheduledMeetings);
      await ipcRenderer.invoke('notif-save-settings', notifSettings);
    });
    
    toggleAutoDetectNotifs?.addEventListener('click', async () => {
      notifSettings.autoDetectedMeetings = !notifSettings.autoDetectedMeetings;
      toggleAutoDetectNotifs.classList.toggle('active', notifSettings.autoDetectedMeetings);
      if (mutedAppsSection) {
        mutedAppsSection.style.display = notifSettings.autoDetectedMeetings ? 'block' : 'none';
      }
      await ipcRenderer.invoke('notif-save-settings', notifSettings);
    });
    
    appSelect?.addEventListener('change', async () => {
      const app = appSelect.value;
      if (app && !notifSettings.mutedApps.includes(app)) {
        notifSettings.mutedApps.push(app);
        await ipcRenderer.invoke('notif-save-settings', notifSettings);
        renderMutedApps();
      }
      appSelect.value = ''; // Reset select
    });
    
    // ============================================================================
    // LANGUAGE SETTINGS
    // ============================================================================
    const transcriptionLangSelect = document.getElementById('transcriptionLangSelect');
    const aiNotesLangSelect = document.getElementById('aiNotesLangSelect');
    const toggleAutoDetectLang = document.getElementById('toggleAutoDetectLang');
    
    let langSettings = {
      transcriptionLang: 'en',
      aiNotesLang: 'same',
      autoDetect: false
    };
    
    async function loadLanguageSettings() {
      langSettings = await ipcRenderer.invoke('lang-get-settings') || langSettings;
      
      // Update UI
      if (transcriptionLangSelect) transcriptionLangSelect.value = langSettings.transcriptionLang;
      if (aiNotesLangSelect) aiNotesLangSelect.value = langSettings.aiNotesLang;
      toggleAutoDetectLang?.classList.toggle('active', langSettings.autoDetect);
      
      // Disable transcription select if auto-detect is on
      if (transcriptionLangSelect) {
        transcriptionLangSelect.disabled = langSettings.autoDetect;
        transcriptionLangSelect.style.opacity = langSettings.autoDetect ? '0.5' : '1';
      }
    }
    
    transcriptionLangSelect?.addEventListener('change', async () => {
      langSettings.transcriptionLang = transcriptionLangSelect.value;
      await ipcRenderer.invoke('lang-save-settings', langSettings);
    });
    
    aiNotesLangSelect?.addEventListener('change', async () => {
      langSettings.aiNotesLang = aiNotesLangSelect.value;
      await ipcRenderer.invoke('lang-save-settings', langSettings);
    });
    
    toggleAutoDetectLang?.addEventListener('click', async () => {
      langSettings.autoDetect = !langSettings.autoDetect;
      toggleAutoDetectLang.classList.toggle('active', langSettings.autoDetect);
      
      // Disable/enable transcription select
      if (transcriptionLangSelect) {
        transcriptionLangSelect.disabled = langSettings.autoDetect;
        transcriptionLangSelect.style.opacity = langSettings.autoDetect ? '0.5' : '1';
      }
      
      await ipcRenderer.invoke('lang-save-settings', langSettings);
    });
    
    // Settings button click
    settingsBtn?.addEventListener('click', showSettings);
    
    // Settings close button
    settingsCloseBtn?.addEventListener('click', hideSettings);
    
    // Close settings when clicking overlay background
    settingsOverlay?.addEventListener('click', (e) => {
      if (e.target === settingsOverlay) {
        hideSettings();
      }
    });
    
    // Deepgram save
    deepgramSaveBtn?.addEventListener('click', async () => {
      const key = deepgramKeyInput.value.trim();
      if (!key) return;
      await ipcRenderer.invoke('save-deepgram-key', key);
      deepgramKeyInput.value = '';
      loadSettingsStatus();
      checkSetup(); // Recheck setup status
    });
    
    // OpenAI save  
    openaiSaveBtn?.addEventListener('click', async () => {
      const key = openaiKeyInput.value.trim();
      if (!key) return;
      await ipcRenderer.invoke('openai-save-key', key);
      openaiKeyInput.value = '';
      loadSettingsStatus();
      checkSetup(); // Recheck setup status
    });
    
    // =========================================================================
    // Provider Selection and Management (Settings Page)
    // =========================================================================
    
    // Transcription Provider Toggle
    const transcriptionProviderDeepgram = document.getElementById('transcriptionProviderDeepgram');
    const transcriptionProviderParakeet = document.getElementById('transcriptionProviderParakeet');
    const deepgramConfig = document.getElementById('deepgramConfig');
    const parakeetConfig = document.getElementById('parakeetConfig');
    const deepgramClearBtn = document.getElementById('deepgramClearBtn');
    const parakeetSettingsDownloadBtn = document.getElementById('parakeetSettingsDownloadBtn');
    const parakeetSettingsDeleteBtn = document.getElementById('parakeetSettingsDeleteBtn');
    
    // AI Provider Toggle
    const aiProviderOpenAI = document.getElementById('aiProviderOpenAI');
    const aiProviderLocal = document.getElementById('aiProviderLocal');
    const openaiConfig = document.getElementById('openaiConfig');
    const localLLMConfig = document.getElementById('localLLMConfig');
    const openaiClearBtn = document.getElementById('openaiClearBtn');
    const localLLMSettingsDownloadBtn = document.getElementById('localLLMSettingsDownloadBtn');
    const localLLMSettingsDeleteBtn = document.getElementById('localLLMSettingsDeleteBtn');
    
    // Track settings state
    let settingsState = {
      transcriptionEngine: 'deepgram',
      aiEngine: 'openai',
      deepgramKey: false,
      openaiKey: false,
      parakeetReady: false,
      localLLMReady: false
    };
    
    // Select transcription provider in settings
    async function selectTranscriptionProviderSettings(provider) {
      settingsState.transcriptionEngine = provider;
      
      // Update toggle buttons
      if (provider === 'deepgram') {
        transcriptionProviderDeepgram?.classList.add('selected');
        transcriptionProviderParakeet?.classList.remove('selected');
        deepgramConfig?.classList.remove('hidden');
        parakeetConfig?.classList.add('hidden');
      } else {
        transcriptionProviderDeepgram?.classList.remove('selected');
        transcriptionProviderParakeet?.classList.add('selected');
        deepgramConfig?.classList.add('hidden');
        parakeetConfig?.classList.remove('hidden');
      }
      
      // Save preference and switch engine
      await ipcRenderer.invoke('transcription-set-engine', provider);
      updateSettingsProviderStatus();
    }
    
    // Select AI provider in settings
    async function selectAIProviderSettings(provider) {
      settingsState.aiEngine = provider;
      
      // Update toggle buttons
      if (provider === 'openai') {
        aiProviderOpenAI?.classList.add('selected');
        aiProviderLocal?.classList.remove('selected');
        openaiConfig?.classList.remove('hidden');
        localLLMConfig?.classList.add('hidden');
      } else {
        aiProviderOpenAI?.classList.remove('selected');
        aiProviderLocal?.classList.add('selected');
        openaiConfig?.classList.add('hidden');
        localLLMConfig?.classList.remove('hidden');
      }
      
      // Save preference
      await ipcRenderer.invoke('ai-set-engine', provider);
      updateSettingsProviderStatus();
    }
    
    // Update provider status displays
    function updateSettingsProviderStatus() {
      const transcriptionActiveName = document.getElementById('transcriptionActiveName');
      const aiActiveName = document.getElementById('aiActiveName');
      
      // Transcription active status
      if (settingsState.transcriptionEngine === 'deepgram' && settingsState.deepgramKey) {
        transcriptionActiveName.textContent = 'Deepgram (Cloud)';
      } else if (settingsState.transcriptionEngine === 'parakeet' && settingsState.parakeetReady) {
        transcriptionActiveName.textContent = 'Parakeet (Local)';
      } else {
        transcriptionActiveName.textContent = 'Not configured';
        transcriptionActiveName.style.color = '#ef4444';
      }
      
      // AI active status
      if (settingsState.aiEngine === 'openai' && settingsState.openaiKey) {
        aiActiveName.textContent = 'OpenAI (Cloud)';
      } else if (settingsState.aiEngine === 'local' && settingsState.localLLMReady) {
        aiActiveName.textContent = 'Qwen2.5 (Local)';
      } else {
        aiActiveName.textContent = 'Not configured';
        aiActiveName.style.color = '#ef4444';
      }
      
      // Show/hide clear buttons based on whether local fallback is available
      if (settingsState.deepgramKey) {
        deepgramClearBtn?.classList.remove('hidden');
        // Disable clear if Parakeet not ready
        if (deepgramClearBtn) {
          deepgramClearBtn.disabled = !settingsState.parakeetReady;
          deepgramClearBtn.title = settingsState.parakeetReady 
            ? 'Clear Deepgram API key' 
            : 'Download Parakeet model first to enable clearing';
        }
      } else {
        deepgramClearBtn?.classList.add('hidden');
      }
      
      if (settingsState.openaiKey) {
        openaiClearBtn?.classList.remove('hidden');
        // Disable clear if local LLM not ready
        if (openaiClearBtn) {
          openaiClearBtn.disabled = !settingsState.localLLMReady;
          openaiClearBtn.title = settingsState.localLLMReady 
            ? 'Clear OpenAI API key' 
            : 'Download local LLM model first to enable clearing';
        }
      } else {
        openaiClearBtn?.classList.add('hidden');
      }
      
      // Update Parakeet status in settings
      const parakeetSettingsStatus = document.getElementById('parakeetSettingsStatus');
      const parakeetSettingsStatusText = document.getElementById('parakeetSettingsStatusText');
      if (settingsState.parakeetReady) {
        parakeetSettingsStatus?.querySelector('.status-dot')?.classList.add('active');
        if (parakeetSettingsStatusText) parakeetSettingsStatusText.textContent = 'Downloaded';
        document.getElementById('parakeetSettingsNotDownloaded')?.classList.add('hidden');
        document.getElementById('parakeetSettingsDownloading')?.classList.add('hidden');
        document.getElementById('parakeetSettingsDownloaded')?.classList.remove('hidden');
        
        // Disable delete button if Deepgram key not configured
        if (parakeetSettingsDeleteBtn) {
          parakeetSettingsDeleteBtn.disabled = !settingsState.deepgramKey;
          parakeetSettingsDeleteBtn.title = settingsState.deepgramKey 
            ? 'Delete local Parakeet model' 
            : 'Configure Deepgram API key first to enable deletion';
        }
      } else {
        parakeetSettingsStatus?.querySelector('.status-dot')?.classList.remove('active');
        if (parakeetSettingsStatusText) parakeetSettingsStatusText.textContent = 'Not downloaded';
        document.getElementById('parakeetSettingsNotDownloaded')?.classList.remove('hidden');
        document.getElementById('parakeetSettingsDownloading')?.classList.add('hidden');
        document.getElementById('parakeetSettingsDownloaded')?.classList.add('hidden');
      }
      
      // Update Local LLM status in settings
      const localLLMSettingsStatus = document.getElementById('localLLMSettingsStatus');
      const localLLMSettingsStatusText = document.getElementById('localLLMSettingsStatusText');
      if (settingsState.localLLMReady) {
        localLLMSettingsStatus?.querySelector('.status-dot')?.classList.add('active');
        if (localLLMSettingsStatusText) localLLMSettingsStatusText.textContent = 'Downloaded';
        document.getElementById('localLLMSettingsNotDownloaded')?.classList.add('hidden');
        document.getElementById('localLLMSettingsDownloading')?.classList.add('hidden');
        document.getElementById('localLLMSettingsDownloaded')?.classList.remove('hidden');
        
        // Disable delete button if OpenAI key not configured
        if (localLLMSettingsDeleteBtn) {
          localLLMSettingsDeleteBtn.disabled = !settingsState.openaiKey;
          localLLMSettingsDeleteBtn.title = settingsState.openaiKey 
            ? 'Delete local Llama model' 
            : 'Configure OpenAI API key first to enable deletion';
        }
      } else {
        localLLMSettingsStatus?.querySelector('.status-dot')?.classList.remove('active');
        if (localLLMSettingsStatusText) localLLMSettingsStatusText.textContent = 'Not downloaded';
        document.getElementById('localLLMSettingsNotDownloaded')?.classList.remove('hidden');
        document.getElementById('localLLMSettingsDownloading')?.classList.add('hidden');
        document.getElementById('localLLMSettingsDownloaded')?.classList.add('hidden');
      }
    }
    
    // Load settings state
    async function loadSettingsProviderState() {
      try {
        settingsState.transcriptionEngine = await ipcRenderer.invoke('transcription-get-engine') || 'deepgram';
        settingsState.aiEngine = await ipcRenderer.invoke('ai-get-engine') || 'openai';
        settingsState.deepgramKey = await ipcRenderer.invoke('has-deepgram-key');
        settingsState.openaiKey = await ipcRenderer.invoke('openai-has-key');
        settingsState.parakeetReady = await ipcRenderer.invoke('parakeet-check-downloaded');
        settingsState.localLLMReady = await ipcRenderer.invoke('llm-is-ready');
        console.log('[Settings] Provider state loaded:', settingsState);
      } catch (e) {
        console.error('[Settings] Error loading provider state:', e);
      }
      
      // Update UI
      selectTranscriptionProviderSettings(settingsState.transcriptionEngine);
      selectAIProviderSettings(settingsState.aiEngine);
      updateSettingsProviderStatus();
    }
    
    // Provider toggle event listeners
    transcriptionProviderDeepgram?.addEventListener('click', () => selectTranscriptionProviderSettings('deepgram'));
    transcriptionProviderParakeet?.addEventListener('click', () => selectTranscriptionProviderSettings('parakeet'));
    aiProviderOpenAI?.addEventListener('click', () => selectAIProviderSettings('openai'));
    aiProviderLocal?.addEventListener('click', () => selectAIProviderSettings('local'));
    
    // Clear Deepgram key
    deepgramClearBtn?.addEventListener('click', async () => {
      if (!settingsState.parakeetReady) {
        alert('Please download the Parakeet model first before clearing the Deepgram API key.');
        return;
      }
      
      const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
        title: 'Clear Deepgram API Key',
        message: 'This will remove your Deepgram API key. Transcription will switch to Parakeet (local). Continue?',
        okLabel: 'Clear Key',
        cancelLabel: 'Cancel'
      });
      
      if (confirmed) {
        await ipcRenderer.invoke('clear-deepgram-key');
        await ipcRenderer.invoke('transcription-set-engine', 'parakeet');
        settingsState.deepgramKey = false;
        settingsState.transcriptionEngine = 'parakeet';
        loadSettingsStatus();
        loadSettingsProviderState();
        checkSetup();
      }
    });
    
    // Clear OpenAI key
    openaiClearBtn?.addEventListener('click', async () => {
      if (!settingsState.localLLMReady) {
        alert('Please download the local LLM model first before clearing the OpenAI API key.');
        return;
      }
      
      const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
        title: 'Clear OpenAI API Key',
        message: 'This will remove your OpenAI API key. AI notes will use local Qwen2.5 model. Continue?',
        okLabel: 'Clear Key',
        cancelLabel: 'Cancel'
      });
      
      if (confirmed) {
        await ipcRenderer.invoke('openai-clear-key');
        await ipcRenderer.invoke('ai-set-engine', 'local');
        settingsState.openaiKey = false;
        settingsState.aiEngine = 'local';
        loadSettingsStatus();
        loadSettingsProviderState();
        checkSetup();
      }
    });
    
    // Parakeet download in settings
    parakeetSettingsDownloadBtn?.addEventListener('click', async () => {
      document.getElementById('parakeetSettingsNotDownloaded')?.classList.add('hidden');
      document.getElementById('parakeetSettingsDownloading')?.classList.remove('hidden');
      document.getElementById('parakeetSettingsDownloaded')?.classList.add('hidden');
      
      const progressText = document.getElementById('parakeetSettingsProgressText');
      if (progressText) progressText.textContent = 'Starting download...';
      
      try {
        await ipcRenderer.invoke('parakeet-download-model');
        
        // Poll for progress
        const pollInterval = setInterval(async () => {
          const progress = await ipcRenderer.invoke('parakeet-get-download-progress');
          
          if (progress.error) {
            clearInterval(pollInterval);
            if (progressText) progressText.textContent = 'Error: ' + progress.error;
            document.getElementById('parakeetSettingsNotDownloaded')?.classList.remove('hidden');
            document.getElementById('parakeetSettingsDownloading')?.classList.add('hidden');
            return;
          }
          
          if (progress.isDownloading) {
            if (progressText) progressText.textContent = `Downloading ${progress.currentFile}... ${progress.percent}%`;
          }
          
          // Check if done
          const isReady = await ipcRenderer.invoke('parakeet-check-downloaded');
          if (isReady) {
            clearInterval(pollInterval);
            settingsState.parakeetReady = true;
            updateSettingsProviderStatus();
            checkSetup();
          }
        }, 1000);
      } catch (e) {
        console.error('Parakeet download error:', e);
        if (progressText) progressText.textContent = 'Download failed: ' + e.message;
      }
    });
    
    // Parakeet delete in settings
    parakeetSettingsDeleteBtn?.addEventListener('click', async () => {
      // Don't allow delete if Deepgram key isn't configured
      if (!settingsState.deepgramKey) {
        alert('Cannot delete Parakeet model - configure Deepgram API key first to ensure you have a transcription provider available.');
        return;
      }
      
      const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
        title: 'Delete Parakeet Model',
        message: 'This will delete the local Parakeet model (~670 MB). Transcription will switch to Deepgram. Continue?',
        okLabel: 'Delete',
        cancelLabel: 'Cancel'
      });
      
      if (confirmed) {
        await ipcRenderer.invoke('parakeet-delete-model');
        settingsState.parakeetReady = false;
        if (settingsState.transcriptionEngine === 'parakeet') {
          await ipcRenderer.invoke('transcription-set-engine', 'deepgram');
          settingsState.transcriptionEngine = 'deepgram';
        }
        loadSettingsProviderState();
        checkSetup();
      }
    });
    
    // Local LLM download in settings
    localLLMSettingsDownloadBtn?.addEventListener('click', async () => {
      document.getElementById('localLLMSettingsNotDownloaded')?.classList.add('hidden');
      document.getElementById('localLLMSettingsDownloading')?.classList.remove('hidden');
      document.getElementById('localLLMSettingsDownloaded')?.classList.add('hidden');
      
      const progressText = document.getElementById('localLLMSettingsProgressText');
      if (progressText) progressText.textContent = 'Initializing download...';
      
      try {
        await ipcRenderer.invoke('llm-init');
        
        // Poll for progress
        const pollInterval = setInterval(async () => {
          const progress = await ipcRenderer.invoke('llm-get-init-progress');
          
          if (progress.error) {
            clearInterval(pollInterval);
            if (progressText) progressText.textContent = 'Error: ' + progress.error;
            document.getElementById('localLLMSettingsNotDownloaded')?.classList.remove('hidden');
            document.getElementById('localLLMSettingsDownloading')?.classList.add('hidden');
            return;
          }
          
          if (progress.isLoading) {
            if (progressText) progressText.textContent = progress.status || 'Downloading...';
          }
          
          // Check if done
          const isReady = await ipcRenderer.invoke('llm-is-ready');
          if (isReady && !progress.isLoading) {
            clearInterval(pollInterval);
            settingsState.localLLMReady = true;
            updateSettingsProviderStatus();
            checkSetup();
          }
        }, 1000);
      } catch (e) {
        console.error('LLM init error:', e);
        if (progressText) progressText.textContent = 'Download failed: ' + e.message;
      }
    });
    
    // Local LLM delete in settings
    localLLMSettingsDeleteBtn?.addEventListener('click', async () => {
      // Don't allow delete if OpenAI key isn't configured
      if (!settingsState.openaiKey) {
        alert('Cannot delete local LLM model - configure OpenAI API key first to ensure you have an AI provider available.');
        return;
      }
      
      const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
        title: 'Delete Local LLM Model',
        message: 'This will delete the local Qwen2.5 model (~2 GB). AI notes will switch to OpenAI. Continue?',
        okLabel: 'Delete',
        cancelLabel: 'Cancel'
      });
      
      if (confirmed) {
        await ipcRenderer.invoke('llm-shutdown');
        // Note: We'd need to add a delete function for the LLM
        settingsState.localLLMReady = false;
        if (settingsState.aiEngine === 'local') {
          await ipcRenderer.invoke('ai-set-engine', 'openai');
          settingsState.aiEngine = 'openai';
        }
        loadSettingsProviderState();
        checkSetup();
      }
    });
    
    // Calendar connect/disconnect
    calendarConnectBtn?.addEventListener('click', async () => {
      const isConnected = await ipcRenderer.invoke('calendar-is-connected');
      if (isConnected) {
        await ipcRenderer.invoke('calendar-disconnect');
      } else {
        await ipcRenderer.invoke('calendar-connect');
      }
      loadSettingsStatus();
      checkCalendarConnection();
    });
    
    // External links
    deepgramLink?.addEventListener('click', (e) => {
      e.preventDefault();
      shell.openExternal('https://console.deepgram.com/signup');
    });
    
    openaiLink?.addEventListener('click', (e) => {
      e.preventDefault();
      shell.openExternal('https://platform.openai.com/api-keys');
    });
    
    // Update meeting meta info
    function updateMeetingMeta(meeting) {
      if (!meeting) {
        // Default state for new notes
        if (dateLabel) dateLabel.textContent = 'Today';
        if (attendeesWrapper) attendeesWrapper.style.display = 'none';
        if (participantsBadge) participantsBadge.style.display = 'none';
        if (meetingDatetime) meetingDatetime.style.display = 'none';
        if (meetingActions) meetingActions.style.display = 'none';
        currentMeetingLink = null;
        currentCalendarLink = null;
        return;
      }
      
      currentMeetingInfo = meeting;
      
      // Date label
      const noteDate = new Date(meeting.date || Date.now());
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (noteDate.toDateString() === today.toDateString()) {
        dateLabel.textContent = 'Today';
      } else if (noteDate.toDateString() === yesterday.toDateString()) {
        dateLabel.textContent = 'Yesterday';
      } else {
        dateLabel.textContent = noteDate.toLocaleDateString('en-US', { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric' 
        });
      }
      
      // Attendees
      if (meeting.attendees && meeting.attendees.length > 0) {
        updateAttendeesUI(meeting.attendees);
        if (attendeesWrapper) attendeesWrapper.style.display = 'block';
        if (participantsBadge) participantsBadge.style.display = 'none';
      } else if (meeting.participants && meeting.participants.length > 0) {
        // Fallback to old participants format
        const participantText = meeting.participants.length > 2 
          ? `${meeting.participants[0]} +${meeting.participants.length - 1}`
          : meeting.participants.join(', ');
        if (participantsLabel) participantsLabel.textContent = participantText;
        if (participantsBadge) participantsBadge.style.display = 'flex';
        if (attendeesWrapper) attendeesWrapper.style.display = 'none';
      } else {
        if (participantsBadge) participantsBadge.style.display = 'none';
        if (attendeesWrapper) attendeesWrapper.style.display = 'none';
      }
      
      // Meeting datetime
      if (meeting.startTime && meeting.endTime) {
        const start = new Date(meeting.startTime);
        const end = new Date(meeting.endTime);
        const dateStr = start.toLocaleDateString('en-US', { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric' 
        });
        const startTime = start.toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        const endTime = end.toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        if (meetingDatetime) {
          meetingDatetime.textContent = `${dateStr}  ${startTime}${endTime}`;
          meetingDatetime.style.display = 'block';
        }
      } else {
        if (meetingDatetime) meetingDatetime.style.display = 'none';
      }
      
      // Meeting actions
      currentMeetingLink = meeting.meetingLink || null;
      currentCalendarLink = meeting.calendarLink || null;
      
      if (meetingActions) {
        if (currentMeetingLink || currentCalendarLink) {
          meetingActions.style.display = 'flex';
          if (openCalendarBtn) openCalendarBtn.style.display = currentCalendarLink ? 'flex' : 'none';
          if (joinMeetingBtn) joinMeetingBtn.style.display = currentMeetingLink ? 'flex' : 'none';
        } else {
          meetingActions.style.display = 'none';
        }
      }
    }
    
    // Meeting action button handlers
    openCalendarBtn?.addEventListener('click', () => {
      if (currentCalendarLink) {
        shell.openExternal(currentCalendarLink);
      }
    });
    
    joinMeetingBtn?.addEventListener('click', () => {
      if (currentMeetingLink) {
        shell.openExternal(currentMeetingLink);
      }
    });
    
    // ============================================================================
    // ATTENDEES
    // ============================================================================
    
    function updateAttendeesUI(attendees) {
      if (!attendees || attendees.length === 0) {
        if (attendeesWrapper) attendeesWrapper.style.display = 'none';
        return;
      }
      
      // Filter out self and get display info
      const others = attendees.filter(a => !a.self);
      const selfAttendee = attendees.find(a => a.self);
      
      // Badge text - show first attendee email + count
      if (others.length > 0) {
        const first = others[0];
        const displayName = first.email || first.displayName || 'Unknown';
        const remaining = others.length - 1;
        if (attendeesLabel) {
          attendeesLabel.textContent = remaining > 0 
            ? `${displayName} +${remaining}`
            : displayName;
        }
      } else if (selfAttendee) {
        if (attendeesLabel) attendeesLabel.textContent = 'Just you';
      }
      
      // Group attendees by domain (organization)
      const byOrg = {};
      attendees.forEach(a => {
        const domain = a.email?.split('@')[1] || 'Other';
        if (!byOrg[domain]) byOrg[domain] = [];
        byOrg[domain].push(a);
      });
      
      // Render dropdown list
      if (attendeesList) {
        let html = '';
        
        Object.keys(byOrg).forEach(domain => {
          const orgAttendees = byOrg[domain];
          const orgName = domain.split('.')[0];
          const capitalizedOrg = orgName.charAt(0).toUpperCase() + orgName.slice(1);
          
          if (Object.keys(byOrg).length > 1) {
            html += `<div class="attendees-org">${capitalizedOrg} ></div>`;
          }
          
          orgAttendees.forEach(a => {
            const initial = (a.displayName || a.email || 'U')[0].toUpperCase();
            const name = a.displayName || a.email?.split('@')[0] || 'Unknown';
            const isSelf = a.self;
            const isOrganizer = a.organizer;
            
            html += `
              <div class="attendee-item" data-email="${a.email || ''}">
                <div class="attendee-avatar">${initial}</div>
                <div class="attendee-info">
                  <div class="attendee-name">${name}${isSelf ? ' <span class="attendee-self">(me)</span>' : ''}${isOrganizer ? ' ' : ''}</div>
                  <div class="attendee-detail">${a.email || ''}</div>
                </div>
                <div class="attendee-actions">
                  ${a.email ? `<button class="attendee-action-btn" data-action="email" data-email="${a.email}"></button>` : ''}
                </div>
              </div>
            `;
          });
        });
        
        attendeesList.innerHTML = html;
        
        // Add action handlers
        attendeesList.querySelectorAll('.attendee-action-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = btn.dataset.action;
            const email = btn.dataset.email;
            if (action === 'email' && email) {
              shell.openExternal(`mailto:${email}`);
            }
          });
        });
      }
    }
    
    // Toggle attendees dropdown
    attendeesBadge?.addEventListener('click', (e) => {
      e.stopPropagation();
      attendeesDropdown?.classList.toggle('hidden');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (attendeesDropdown && !attendeesDropdown.classList.contains('hidden')) {
        if (!attendeesWrapper?.contains(e.target)) {
          attendeesDropdown.classList.add('hidden');
        }
      }
    });
    
    // ============================================================================
    // MIC CONTROL & TRANSCRIPT
    // ============================================================================
    
    function updateMicUI() {
      if (isMicActive || isRecording) {
        micControl?.classList.add('recording');
        if (micLabel) micLabel.textContent = 'Stop';
        if (transcriptStatus) transcriptStatus.textContent = 'Listening...';
        if (transcriptEmpty) transcriptEmpty.style.display = transcript.length > 0 ? 'none' : 'flex';
      } else {
        micControl?.classList.remove('recording');
        if (micLabel) micLabel.textContent = transcript.length > 0 ? 'Resume' : 'Start';
        if (transcriptStatus) transcriptStatus.textContent = transcript.length > 0 ? 'Transcript Paused' : 'Click Start to begin transcribing';
        if (transcriptEmpty) transcriptEmpty.style.display = transcript.length > 0 ? 'none' : 'flex';
      }
      // Update ask input visibility whenever recording state changes
      updateAskInputVisibility();
    }
    
    // Speaker colors for diarization
    const SPEAKER_COLORS = [
      '#3b82f6', // blue
      '#10b981', // green  
      '#f59e0b', // amber
      '#ef4444', // red
      '#8b5cf6', // purple
      '#ec4899', // pink
    ];
    
    function renderTranscript() {
      const transcriptBubbles = document.getElementById('transcriptBubbles');
      const transcriptEmpty = document.getElementById('transcriptEmpty');
      const transcriptContent = document.getElementById('transcriptContent');
      const transcriptCount = document.getElementById('transcriptCount');
      
      // Skip if transcript UI elements don't exist
      if (!transcriptBubbles || !transcriptEmpty) return;
      
      if (transcript.length === 0) {
        transcriptBubbles.style.display = 'none';
        transcriptEmpty.style.display = 'flex';
        if (transcriptCount) transcriptCount.textContent = '0 segments';
        return;
      }
      
      transcriptEmpty.style.display = 'none';
      transcriptBubbles.style.display = 'flex';
      
      // Group consecutive segments by speaker/channel
      // Use Deepgram's speechFinal to determine segment boundaries
      // Each speechFinal=true marks end of an utterance (natural pause)
      // Group consecutive segments from same speaker until speechFinal
      const grouped = [];
      let currentGroup = null;
      
      for (const item of transcript) {
        // Handle both old format (string) and new format (object with speaker/isYou/speakerName)
        const text = typeof item === 'string' ? item : item.text;
        if (!text) continue;
        
        const isYou = typeof item === 'object' ? item.isYou : false;
        const speakerName = typeof item === 'object' ? item.speakerName : null;
        const channel = typeof item === 'object' ? item.channel : 0;
        const timestamp = typeof item === 'object' ? item.timestamp : null;
        const speaker = typeof item === 'object' ? item.speaker : null;
        const speechFinal = typeof item === 'object' ? item.speechFinal : false;
        const formattedTime = typeof item === 'object' ? item.formattedTime : null; // Pre-formatted timestamp from Parakeet
        
        // Group by speaker ID if available, otherwise by channel
        const groupKey = speaker !== null ? `speaker-${speaker}` : (isYou ? 'you' : `ch${channel}`);
        
        // Only continue grouping if same speaker AND previous segment wasn't speechFinal
        const shouldGroup = currentGroup && 
                           currentGroup.groupKey === groupKey &&
                           !currentGroup.speechFinal;  // Don't group after utterance end
        
        if (shouldGroup) {
          // Same speaker, not end of utterance - append to current group
          currentGroup.texts.push(text);
          currentGroup.lastTimestamp = timestamp;
          currentGroup.speechFinal = speechFinal;  // Update with latest speechFinal status
        } else {
          // New segment - create new group
          currentGroup = { 
            groupKey, 
            isYou, 
            speakerName, 
            speaker,  // diarization speaker ID
            channel, 
            texts: [text], 
            timestamp,
            lastTimestamp: timestamp,
            speechFinal: speechFinal,  // Track if this segment ends the utterance
            formattedTime: formattedTime  // Pre-formatted timestamp from Parakeet
          };
          grouped.push(currentGroup);
        }
      }
      
      // Update count
      if (transcriptCount) {
        transcriptCount.textContent = `${grouped.length} segment${grouped.length !== 1 ? 's' : ''}`;
      }
      
      // Render grouped transcripts with speaker colors
      let html = grouped.map((group, index) => {
        const combinedText = group.texts.join(' ');
        
        // Get speaker info - use colors to differentiate, no labels
        const isYouSpeaker = group.isYou;
        const speakerId = group.speaker !== undefined && group.speaker !== null ? group.speaker : null;
        const speakerColor = isYouSpeaker ? '#3b82f6' : (speakerId !== null ? SPEAKER_COLORS[speakerId % SPEAKER_COLORS.length] : '#888');
        
        // Calculate timestamp relative to first segment (recording start)
        // Use pre-formatted time from Parakeet if available, otherwise calculate from recordingStartTime
        let timestampStr = '';
        if (group.formattedTime) {
          // Parakeet provides pre-formatted time like "0:15", "1:30"
          timestampStr = group.formattedTime;
        } else if (group.timestamp && recordingStartTime) {
          const elapsedMs = group.timestamp - recordingStartTime;
          const minutes = Math.floor(elapsedMs / 60000);
          const seconds = Math.floor((elapsedMs % 60000) / 1000);
          timestampStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        } else if (index === 0) {
          timestampStr = '0:00';
        }
        
        return `
          <div class="transcript-turn" data-speaker="${speakerId}" style="--speaker-color: ${speakerColor}">
            ${timestampStr ? `<div class="transcript-timestamp-only">${timestampStr}</div>` : ''}
            <div class="transcript-text">${combinedText}</div>
          </div>
        `;
      }).join('');
      
      // Append interim text to the last bubble if same speaker, or show separately
      if (currentInterim && currentInterim.text) {
        const interimSpeakerId = currentInterim.speaker !== undefined ? currentInterim.speaker : null;
        const lastGroup = grouped[grouped.length - 1];
        const lastSpeakerId = lastGroup ? lastGroup.speaker : null;
        
        // Check if interim is from same speaker as last group
        if (lastGroup && interimSpeakerId === lastSpeakerId) {
          // Append to last bubble - re-render last bubble with interim appended in grey
          const lastBubbleHtml = html.lastIndexOf('<div class="transcript-turn"');
          if (lastBubbleHtml >= 0) {
            // Find the transcript-text div in the last bubble and append interim
            const textDivEnd = html.lastIndexOf('</div>\n          </div>');
            if (textDivEnd >= 0) {
              html = html.substring(0, textDivEnd) + 
                     ` <span class="interim-text">${currentInterim.text}</span>` + 
                     html.substring(textDivEnd);
            }
          }
        } else {
          // Different speaker - show interim in its own bubble
          let timestampStr = '';
          if (currentInterim.timestamp && recordingStartTime) {
            const elapsedMs = currentInterim.timestamp - recordingStartTime;
            const minutes = Math.floor(elapsedMs / 60000);
            const seconds = Math.floor((elapsedMs % 60000) / 1000);
            timestampStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          }
          
          const speakerColor = interimSpeakerId !== null ? SPEAKER_COLORS[interimSpeakerId % SPEAKER_COLORS.length] : '#888';
          const speakerLabel = interimSpeakerId !== null ? `Speaker ${interimSpeakerId + 1}` : 'Unknown';
          
          html += `
            <div class="transcript-turn transcript-interim" data-speaker="${interimSpeakerId}" style="--speaker-color: ${speakerColor}">
              <div class="transcript-speaker">
                <span>${speakerLabel}</span>
                ${timestampStr ? `<span class="transcript-timestamp">${timestampStr}</span>` : ''}
              </div>
              <div class="transcript-text"><span class="interim-text">${currentInterim.text}</span></div>
            </div>
          `;
        }
      }
      
      transcriptBubbles.innerHTML = html;
      
      // Auto-expand transcript section when content arrives
      if (transcriptSection?.classList.contains('collapsed')) {
        transcriptSection.classList.remove('collapsed');
      }
      
      // Scroll transcript to bottom
      if (transcriptContent) {
        transcriptContent.scrollTop = transcriptContent.scrollHeight;
      }
      
      // Also scroll editor area to show transcript section
      const editorContent = document.querySelector('.editor-content');
      if (editorContent) {
        editorContent.scrollTop = editorContent.scrollHeight;
      }
    }
    
    // Toggle transcript collapse
    const transcriptHeader = document.getElementById('transcriptHeader');
    
    transcriptHeader?.addEventListener('click', () => {
      const wasCollapsed = transcriptSection?.classList.contains('collapsed');
      transcriptSection?.classList.toggle('collapsed');
      
      // If expanding, scroll to make transcript visible
      if (wasCollapsed) {
        setTimeout(() => {
          transcriptSection?.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }, 100);
      }
    });
    
    function updateNextMeeting() {
      // Get next upcoming meeting from calendar
      if (calendarConnected) {
        ipcRenderer.invoke('calendar-get-events').then(events => {
          const now = new Date();
          const upcoming = events.find(e => new Date(e.start) > now);
          if (upcoming) {
            const startTime = new Date(upcoming.start).toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            if (nextMeetingTime) nextMeetingTime.textContent = `Starts ${startTime}`;
            if (nextMeeting) nextMeeting.style.display = 'flex';
          } else {
            if (nextMeeting) nextMeeting.style.display = 'none';
          }
        });
      }
    }
    
    // Mic control click handler
    micControl?.addEventListener('click', async () => {
      if (isMicActive || isRecording) {
        stopTranscription();
      } else {
        startTranscription();
      }
    });
    
    // ============================================================================
    // AI-ENHANCED NOTES (generated AFTER meeting ends)
    // ============================================================================
    // AI notes are generated when:
    // 1. Meeting ends (call detected as ended or user clicks stop)
    // 2. Using: transcript + user's raw notes + meeting info
    // ============================================================================
    
    let rawNotesAtStart = ''; // Store user's raw notes for highlighting
    
    async function checkOpenAIKey() {
      hasOpenAIKey = await ipcRenderer.invoke('openai-has-key');
      // Don't show AI panel during meeting - only after
    }
    
    // Called when recording starts - store initial state
    function onRecordingStart() {
      rawNotesAtStart = getEditorContent();
      // Hide AI panel during recording - notes generated after
      aiNotesPanel.classList.add('hidden');
      aiEmpty.classList.remove('hidden');
      aiResults.classList.add('hidden');
      aiNotesActions.classList.add('hidden');
      currentAINotes = null;
      // Hide generate button and toggle during recording
      hideGenerateNotesButton();
      hideNotesViewToggle();
    }
    
    // Generate notes button management
    const generateNotesWrapper = document.getElementById('generateNotesWrapper');
    const generateNotesBtn = document.getElementById('generateNotesBtn');
    const generateNotesBtnText = document.getElementById('generateNotesBtnText');
    const notesViewToggle = document.getElementById('notesViewToggle');
    
    async function showGenerateNotesButton() {
      if (!hasOpenAIKey) return; // Don't show if no API key
      generateNotesWrapper?.classList.remove('hidden');
      hideNotesViewToggle(); // Hide toggle until notes are generated
      
      // Populate template selector
      await populateTemplateSelector();
    }
    
    async function populateTemplateSelector() {
      const selector = document.getElementById('templateSelector');
      
      try {
        const allTemplates = await ipcRenderer.invoke('templates-get-all');
        const defaultTemplate = await ipcRenderer.invoke('templates-get-default');
        
        // Update hidden selector for compatibility
        if (selector) {
          selector.innerHTML = allTemplates.map(t => `
            <option value="${t.id}" ${t.id === defaultTemplate?.id ? 'selected' : ''}>
              ${t.icon} ${t.name}${t.isDefault ? ' (Default)' : ''}
            </option>
          `).join('');
        }
      } catch (err) {
        console.error('[Templates] Error loading templates:', err);
        if (selector) selector.innerHTML = '<option value="">Default Template</option>';
      }
    }
    
    // Generate template dropdown toggle
    const generateTemplateDropdownBtn = document.getElementById('generateTemplateDropdownBtn');
    const generateTemplateMenu = document.getElementById('generateTemplateMenu');
    const generateTemplateMenuContent = document.getElementById('generateTemplateMenuContent');
    
    generateTemplateDropdownBtn?.addEventListener('click', async (e) => {
      e.stopPropagation();
      const isOpen = generateTemplateMenu?.classList.contains('show');
      
      if (!isOpen) {
        // Load templates with AI suggestion
        await loadGenerateTemplateDropdown();
        generateTemplateMenu?.classList.add('show');
      } else {
        generateTemplateMenu?.classList.remove('show');
      }
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!generateTemplateMenu?.contains(e.target) && e.target !== generateTemplateDropdownBtn) {
        generateTemplateMenu?.classList.remove('show');
      }
    });
    
    async function loadGenerateTemplateDropdown() {
      if (!generateTemplateMenuContent) return;
      
      try {
        const allTemplates = await ipcRenderer.invoke('templates-get-all');
        const defaultTemplate = await ipcRenderer.invoke('templates-get-default');
        
        // Show templates immediately with AI suggestion loading
        renderGenerateTemplateMenu(allTemplates, defaultTemplate, null, true);
        
        // Fetch AI suggestion in background if we have transcript
        if (transcript.length > 0) {
          getGenerateAISuggestion().then(suggestion => {
            renderGenerateTemplateMenu(allTemplates, defaultTemplate, suggestion, false);
          });
        } else {
          // No transcript, just show templates without AI section
          renderGenerateTemplateMenu(allTemplates, defaultTemplate, null, false);
        }
      } catch (err) {
        console.error('[GenerateDropdown] Error:', err);
        generateTemplateMenuContent.innerHTML = '<div class="generate-template-menu-loading">Error loading templates</div>';
      }
    }
    
    function renderGenerateTemplateMenu(allTemplates, defaultTemplate, aiSuggestion, isLoadingAI) {
      let html = '';
      
      // Search input if more than 3 templates
      if (allTemplates.length > 3) {
        html += `
          <div style="padding: 8px 10px;">
            <input type="text" id="gen-template-search" placeholder="Search templates..." style="
              width: 100%;
              padding: 8px 10px;
              border: 1px solid var(--border);
              border-radius: 6px;
              background: var(--bg-secondary);
              color: var(--text);
              font-size: 13px;
              outline: none;
              box-sizing: border-box;
            ">
          </div>
        `;
      }
      
      // AI Suggestion section
      if (transcript.length > 0) {
        if (isLoadingAI) {
          html += `<div class="template-dropdown-ai-loading">
            <div class="spinner-small"></div>
            <span>Analyzing transcript...</span>
          </div>`;
        } else if (aiSuggestion && aiSuggestion.templateId) {
          const suggestedTemplate = allTemplates.find(t => t.id === aiSuggestion.templateId);
          if (suggestedTemplate) {
            html += `
              <button class="generate-template-menu-item ai-suggested" data-template-id="${suggestedTemplate.id}">
                <span class="template-icon">${suggestedTemplate.icon}</span>
                <span>${suggestedTemplate.name}</span>
                <span class="ai-badge">AI Pick</span>
              </button>
            `;
          }
        } else if (!isLoadingAI) {
          html += '<div class="template-dropdown-no-suggestion">No strong template match</div>';
        }
      }
      
      // All templates header
      html += '<div class="generate-template-menu-header">All Templates</div>';
      
      // All templates container
      html += '<div id="gen-template-list">';
      allTemplates.forEach(t => {
        const isSelected = t.id === (currentTemplateId || defaultTemplate?.id);
        html += `
          <button class="generate-template-menu-item ${isSelected ? 'selected' : ''}" data-template-id="${t.id}" data-name="${t.name.toLowerCase()}">
            <span class="template-icon">${t.icon}</span>
            <span>${t.name}</span>
          </button>
        `;
      });
      html += '</div>';
      
      generateTemplateMenuContent.innerHTML = html;
      
      // Add search handler
      const searchInput = generateTemplateMenuContent.querySelector('#gen-template-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase().trim();
          generateTemplateMenuContent.querySelectorAll('#gen-template-list .generate-template-menu-item').forEach(item => {
            const name = item.dataset.name || '';
            item.style.display = name.includes(query) ? '' : 'none';
          });
        });
        setTimeout(() => searchInput.focus(), 100);
      }
      
      // Add click handlers
      generateTemplateMenuContent.querySelectorAll('.generate-template-menu-item').forEach(item => {
        item.addEventListener('click', async () => {
          currentTemplateId = item.dataset.templateId;
          // Close menu immediately
          generateTemplateMenu?.classList.remove('show');
          // Hide the button and trigger generation
          hideGenerateNotesButton();
          try {
            await generateEnhancedNotes();
            showNotesViewToggle();
          } catch (err) {
            console.error('[Generate Notes] Error:', err);
            showGenerateNotesButton();
          }
        });
      });
    }
    
    // Cache for generate dropdown AI suggestion - note-specific
    // Structure: Map<noteId, { hash: string, suggestion: object }>
    const generateAISuggestionCache = new Map();
    
    async function getGenerateAISuggestion() {
      // Create content hash from transcript and raw notes
      const transcriptText = transcript.map(t => typeof t === 'string' ? t : t.text).join(' ');
      const rawNotes = stripHtml(getEditorContent());
      const contentHash = hashContent(transcriptText + rawNotes);
      
      // Use noteId for caching, fallback to 'new' for unsaved notes
      const cacheKey = currentNoteId || 'new-note';
      
      // Check cache
      const cached = generateAISuggestionCache.get(cacheKey);
      if (cached && cached.hash === contentHash) {
        console.log('[GenerateDropdown] Using cached AI suggestion for:', cacheKey);
        return cached.suggestion;
      }
      
      // Need minimum content
      if (transcriptText.length < 50) {
        return null;
      }
      
      try {
        console.log('[GenerateDropdown] Getting AI template suggestion...');
        const suggestion = await ipcRenderer.invoke('openai-suggest-template', {
          rawNotes,
          transcript: transcriptText.substring(0, 2000),
          meetingTitle: meetingTitle?.textContent || 'Meeting'
        });
        
        // Cache the result (including null)
        generateAISuggestionCache.set(cacheKey, { hash: contentHash, suggestion });
        console.log('[GenerateDropdown] Cached suggestion for:', cacheKey);
        
        return suggestion;
      } catch (err) {
        console.error('[GenerateDropdown] Error getting AI suggestion:', err);
        return null;
      }
    }
    
    function hideGenerateNotesButton() {
      generateNotesWrapper?.classList.add('hidden');
    }
    
    const notesViewToggleWrapper = document.getElementById('notesViewToggleWrapper');
    
    function showNotesViewToggle() {
      // Only show toggle if we have AI notes
      if (currentAINotes) {
        console.log('[NotesToggle] Showing toggle wrapper');
        const wrapper = document.getElementById('notesViewToggleWrapper');
        if (wrapper) {
          wrapper.style.display = 'flex';
          wrapper.classList.add('visible');
        }
        // Default to AI view (sparkle button active)
        const rawBtn = document.getElementById('rawNotesBtn');
        const aiBtn = document.getElementById('aiNotesBtn');
        rawBtn?.classList.remove('active');
        aiBtn?.classList.add('active');
        // Note: updateCurrentTemplateDisplay() should be called BEFORE showNotesViewToggle()
        // to ensure the template dropdown shows the correct template
      }
    }
    
    function hideNotesViewToggle() {
      const wrapper = document.getElementById('notesViewToggleWrapper');
      if (wrapper) {
        wrapper.style.display = 'none';
        wrapper.classList.remove('visible');
      }
    }
    
    // Current template tracking
    let currentTemplateId = null;
    let aiSuggestedTemplate = null;
    let aiTemplateSuggestionCache = new Map(); // noteId -> { hash, suggestion }
    
    async function updateCurrentTemplateDisplay() {
      const iconEl = document.getElementById('currentTemplateIcon');
      const nameEl = document.getElementById('currentTemplateName');
      if (!iconEl || !nameEl) return;
      
      // Load templates if not loaded
      if (!templates || templates.length === 0) {
        templates = await ipcRenderer.invoke('templates-get-all');
      }
      
      const template = templates.find(t => t.id === currentTemplateId) || templates.find(t => t.isDefault);
      if (template) {
        iconEl.textContent = template.icon;
        nameEl.textContent = template.name;
        console.log('[Templates] Updated display to:', template.name);
      }
    }
    
    // Template dropdown functionality
    const templateDropdownBtn = document.getElementById('templateDropdownBtn');
    const templateDropdownMenu = document.getElementById('templateDropdownMenu');
    const templateDropdownContent = document.getElementById('templateDropdownContent');
    
    templateDropdownBtn?.addEventListener('click', async (e) => {
      e.stopPropagation();
      const isOpen = templateDropdownMenu?.classList.contains('show');
      
      if (!isOpen) {
        // Load templates and AI suggestion
        await loadTemplatesForDropdown();
        templateDropdownMenu?.classList.add('show');
      } else {
        templateDropdownMenu?.classList.remove('show');
      }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      templateDropdownMenu?.classList.remove('show');
    });
    
    async function loadTemplatesForDropdown() {
      if (!templateDropdownContent) return;
      
      try {
        // Load templates first (fast)
        const allTemplates = await ipcRenderer.invoke('templates-get-all');
        
        // Show templates immediately with AI suggestion loading
        renderTemplateDropdown(allTemplates, null, true);
        
        // Then fetch AI suggestion in background
        getAITemplateSuggestion().then(suggestion => {
          renderTemplateDropdown(allTemplates, suggestion, false);
        });
        
      } catch (err) {
        console.error('[TemplateDropdown] Error:', err);
        templateDropdownContent.innerHTML = '<div class="template-dropdown-loading">Error loading templates</div>';
      }
    }
    
    function renderTemplateDropdown(allTemplates, suggestion, isLoadingAI) {
      let html = '';
      
      // Search input if more than 3 templates
      if (allTemplates.length > 3) {
        html += `
          <div style="padding: 8px 10px;">
            <input type="text" id="header-template-search" placeholder="Search templates..." style="
              width: 100%;
              padding: 8px 10px;
              border: 1px solid var(--border);
              border-radius: 6px;
              background: var(--bg-secondary);
              color: var(--text);
              font-size: 13px;
              outline: none;
              box-sizing: border-box;
            ">
          </div>
        `;
      }
      
      // AI suggestion section
      if (isLoadingAI) {
        html += `<div class="template-dropdown-ai-loading">
          <div class="spinner-small"></div>
          <span>Finding best template...</span>
        </div>`;
      } else if (suggestion && suggestion.templateId) {
        const suggestedTemplate = allTemplates.find(t => t.id === suggestion.templateId);
        if (suggestedTemplate) {
          html += `
            <button class="template-dropdown-item ai-suggested" data-template-id="${suggestedTemplate.id}">
              <span class="template-icon">${suggestedTemplate.icon}</span>
              <span class="template-name">${suggestedTemplate.name}</span>
              <span class="ai-badge">AI Pick</span>
            </button>
          `;
        }
      } else if (suggestion === null) {
        html += '<div class="template-dropdown-no-suggestion">No strong template match found</div>';
      }
      
      // All templates
      html += '<div class="template-dropdown-header">All Templates</div>';
      html += '<div id="header-template-list">';
      allTemplates.forEach(t => {
        const isCurrent = t.id === currentTemplateId || (!currentTemplateId && t.isDefault);
        html += `
          <button class="template-dropdown-item ${isCurrent ? 'current' : ''}" data-template-id="${t.id}" data-name="${t.name.toLowerCase()}">
            <span class="template-icon">${t.icon}</span>
            <span class="template-name">${t.name}</span>
          </button>
        `;
      });
      html += '</div>';
      
      templateDropdownContent.innerHTML = html;
      
      // Add search handler
      const searchInput = templateDropdownContent.querySelector('#header-template-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase().trim();
          templateDropdownContent.querySelectorAll('#header-template-list .template-dropdown-item').forEach(item => {
            const name = item.dataset.name || '';
            item.style.display = name.includes(query) ? '' : 'none';
          });
        });
        setTimeout(() => searchInput.focus(), 100);
      }
      
      // Add click handlers
      templateDropdownContent.querySelectorAll('.template-dropdown-item').forEach(item => {
        item.addEventListener('click', async () => {
          const templateId = item.dataset.templateId;
          await regenerateWithTemplate(templateId);
          templateDropdownMenu?.classList.remove('show');
        });
      });
    }
    
    async function getAITemplateSuggestion() {
      if (!currentNoteId) return null;
      
      // Create content hash
      const rawNotes = stripHtml(getEditorContent());
      const transcriptText = transcript.map(t => typeof t === 'string' ? t : t.text).join(' ');
      const contentHash = hashContent(rawNotes + transcriptText);
      
      // Check cache
      const cached = aiTemplateSuggestionCache.get(currentNoteId);
      if (cached && cached.hash === contentHash) {
        console.log('[TemplateDropdown] Using cached AI suggestion');
        return cached.suggestion;
      }
      
      // If not enough content, skip AI
      if (rawNotes.length < 20 && transcriptText.length < 50) {
        return null;
      }
      
      try {
        console.log('[TemplateDropdown] Getting AI template suggestion...');
        const suggestion = await ipcRenderer.invoke('openai-suggest-template', {
          rawNotes,
          transcript: transcriptText.substring(0, 2000),
          meetingTitle: meetingTitle?.textContent || 'Meeting'
        });
        
        // Cache the result
        aiTemplateSuggestionCache.set(currentNoteId, { hash: contentHash, suggestion });
        
        return suggestion;
      } catch (err) {
        console.error('[TemplateDropdown] Error getting AI suggestion:', err);
        return null;
      }
    }
    
    async function regenerateWithTemplate(templateId) {
      if (!hasOpenAIKey || isGeneratingAINotes) return;
      
      currentTemplateId = templateId;
      
      // Update dropdown button immediately
      await updateCurrentTemplateDisplay();
      
      // Clear current AI notes to force regeneration
      currentAINotes = null;
      isGeneratingAINotes = false; // Reset flag to allow regeneration
      
      // Regenerate with the new template
      await generateEnhancedNotes();
    }
    
    // Handle generate notes button click
    generateNotesBtn?.addEventListener('click', async () => {
      if (isGeneratingAINotes) return;
      
      // Hide the button immediately when clicked - the blue progress bar shows status
      hideGenerateNotesButton();
      
      try {
        await generateEnhancedNotes();
        // Show toggle after successful generation
        showNotesViewToggle();
      } catch (err) {
        console.error('[Generate Notes] Error:', err);
        // Show button again on error
        showGenerateNotesButton();
      }
    });
    
    // Toggle between raw notes and AI enhanced notes
    const rawNotesBtn = document.getElementById('rawNotesBtn');
    const aiNotesBtn = document.getElementById('aiNotesBtn');
    let rawNotesBackup = ''; // Store raw notes before switching to AI view
    let currentViewIsAI = true; // Default to AI view when toggle is visible
    let isTogglingView = false; // Flag to prevent auto-save during view toggle
    let storedRawNotes = ''; // Persisted raw notes content
    let storedEnhancedNotes = ''; // Persisted AI enhanced notes content
    
    rawNotesBtn?.addEventListener('click', () => {
      if (!currentAINotes) return;
      
      // Save current AI notes before switching
      storedEnhancedNotes = getEditorContent();
      
      // Switch to raw notes view
      rawNotesBtn.classList.add('active');
      aiNotesBtn.classList.remove('active');
      currentViewIsAI = false;
      
      // Show raw notes (prevent auto-save during toggle)
      isTogglingView = true;
      setEditorContent(storedRawNotes || rawNotesAtStart || '');
      setTimeout(() => { isTogglingView = false; }, 100);
    });
    
    aiNotesBtn?.addEventListener('click', () => {
      if (!currentAINotes) return;
      
      // Save current raw notes before switching
      storedRawNotes = getEditorContent();
      
      // Switch to AI enhanced view
      aiNotesBtn.classList.add('active');
      rawNotesBtn.classList.remove('active');
      currentViewIsAI = true;
      
      // Show AI notes (prevent auto-save during toggle)
      isTogglingView = true;
      if (storedEnhancedNotes) {
        setEditorContent(storedEnhancedNotes);
      } else {
        // Re-render AI notes if no stored version
        putAINotesInEditor(currentAINotes);
      }
      setTimeout(() => { isTogglingView = false; }, 100);
    });
    
    let isGeneratingAINotes = false;
    
    // Helper to strip HTML tags and get plain text
    function stripHtml(html) {
      const tmp = document.createElement('div');
      tmp.innerHTML = html || '';
      return tmp.textContent || tmp.innerText || '';
    }
    
    // Called when recording stops - generate AI-enhanced notes
    async function generateEnhancedNotes() {
      if (!hasOpenAIKey) {
        console.log('[AI Notes] No OpenAI key configured');
        return;
      }
      
      if (transcript.length === 0) {
        console.log('[AI Notes] No transcript to enhance');
        return;
      }
      
      // Capture raw notes NOW (before AI generation), not when recording started
      rawNotesAtStart = getEditorContent();
      console.log('[AI Notes] Captured raw notes:', stripHtml(rawNotesAtStart).substring(0, 100));
      
      // Prevent duplicate generation
      if (isGeneratingAINotes) {
        console.log('[AI Notes] Already generating, skipping...');
        return;
      }
      
      // Only generate once per session
      if (currentAINotes) {
        console.log('[AI Notes] Notes already generated for this session');
        return;
      }
      
      console.log('[AI Notes] Generating enhanced notes...');
      isGeneratingAINotes = true;
      
      // Show generating indicator in the editor
      const generatingBanner = document.createElement('div');
      generatingBanner.id = 'aiGeneratingBanner';
      generatingBanner.className = 'ai-generating-banner';
      generatingBanner.innerHTML = `
        <div class="generating-spinner"></div>
        <span> Analyzing meeting and selecting best template...</span>
      `;
      notesEditor.parentElement.insertBefore(generatingBanner, notesEditor);
      
      aiGenerating.classList.remove('hidden');
      aiEmpty.classList.add('hidden');
      
      try {
        // Convert transcript to string (handle both old and new format)
        // Don't include speaker labels - just the text
        const transcriptText = transcript.map(item => {
          if (typeof item === 'string') return item;
          return item.text;
        }).join('\n');
        
        // Uses: transcript + raw notes + meeting info
        // Send plain text, not HTML, for better AI processing
        const rawNotesPlainText = stripHtml(rawNotesAtStart);
        console.log('[AI Notes] Sending raw notes to AI:', rawNotesPlainText.substring(0, 100));
        
        // STEP 1: Ask AI to suggest the best template first
        let selectedTemplateId = currentTemplateId;
        
        // Only auto-suggest if no template was manually selected
        if (!selectedTemplateId) {
          console.log('[AI Notes] Step 1: Asking AI to suggest best template...');
          const templateSuggestion = await ipcRenderer.invoke('openai-suggest-template', {
            rawNotes: rawNotesPlainText,
            transcript: transcriptText,
            meetingTitle: meetingTitle.textContent || 'Meeting'
          });
          
          if (templateSuggestion && templateSuggestion.templateId) {
            selectedTemplateId = templateSuggestion.templateId;
            console.log('[AI Notes] AI suggested template:', selectedTemplateId, 'with', templateSuggestion.confidence, 'confidence');
            console.log('[AI Notes] Reason:', templateSuggestion.reason);
            
            // Update the banner to show template selection
            if (generatingBanner) {
              generatingBanner.innerHTML = `
                <div class="generating-spinner"></div>
                <span> Generating notes with AI-selected template...</span>
              `;
            }
          } else {
            console.log('[AI Notes] No strong template match, using default template');
            // Will fall back to default in the backend
          }
        } else {
          console.log('[AI Notes] Using pre-selected template:', selectedTemplateId);
        }
        
        // STEP 2: Generate enhanced notes with the selected/suggested template
        console.log('[AI Notes] Step 2: Generating enhanced notes with template:', selectedTemplateId || 'default');
        console.log('[AI Notes] Calling openai-generate-enhanced IPC...');
        const result = await ipcRenderer.invoke('openai-generate-enhanced', {
          transcript: transcriptText,
          rawNotes: rawNotesPlainText,
          meetingTitle: meetingTitle.textContent || 'Meeting',
          meetingInfo: currentMeetingInfo,
          templateId: selectedTemplateId
        });
        
        console.log('[AI Notes] IPC result:', result ? 'Got result' : 'NULL/undefined result');
        if (!result) {
          console.error('[AI Notes]  No result from AI - check if engine is configured and ready');
        }
        
        // Update current template ID (from AI suggestion or manual selection)
        if (selectedTemplateId) {
          currentTemplateId = selectedTemplateId;
        }
        
        if (result) {
          // If AI returned a template ID, use that (it confirms which template was actually used)
          if (result.templateId) {
            currentTemplateId = result.templateId;
            console.log('[AI Notes] Template used for generation:', result.templateId);
          }
          
          currentAINotes = result;
          // Put AI notes directly in the main editor
          putAINotesInEditor(result);
          console.log('[AI Notes] Enhanced notes generated and added to editor');
          
          // Hide generate button and show toggle
          hideGenerateNotesButton();
          
          // Update template display BEFORE showing toggle (so toggle shows correct template)
          await updateCurrentTemplateDisplay();
          
          // Now show the toggle with updated template display
          showNotesViewToggle();
          
          // Update ask input visibility now that AI notes are available
          updateAskInputVisibility();
          
          // Clear any cached folder suggestion since content changed
          currentSuggestedFolder = null;
          
          // Clear cached template suggestion since content changed
          if (currentNoteId) {
            aiTemplateSuggestionCache.delete(currentNoteId);
          }
        }
      } catch (err) {
        console.error('[AI Notes] Error generating enhanced notes:', err);
      } finally {
        // Remove generating banner
        const banner = document.getElementById('aiGeneratingBanner');
        if (banner) banner.remove();
        
        aiGenerating.classList.add('hidden');
        isGeneratingAINotes = false;
      }
    }
    
    // Regenerate notes with same inputs
    async function regenerateNotes() {
      await generateEnhancedNotes();
    }
    
    // Put AI notes directly in the main editor
    // Uses HTML format that TipTap can render properly
    function putAINotesInEditor(result) {
      // Build HTML content for TipTap - AI notes ONLY (no raw notes mixed in)
      // Raw notes are shown separately via the toggle
      let html = '';
      
      // PREFER enhancedNotes if available (template-formatted from OpenAI)
      // The AI already generates proper section headers in the target language
      if (result.enhancedNotes) {
        // Convert markdown to basic HTML - this contains template-specific sections
        // No hardcoded "Meeting Notes" header - the AI generates appropriate headers in the target language
        html = convertMarkdownToHTML(result.enhancedNotes);
      } else {
        // Fallback to structured fields if no enhancedNotes
        // This fallback path uses English headers (rare case)
        if (result.summary) {
          html += '<h2>Summary</h2>';
          html += '<p>' + result.summary.replace(/\n/g, '</p><p>') + '</p>';
        }
        
        if (result.keyPoints && result.keyPoints.length > 0) {
          html += '<h2>Key Points</h2><ul>';
          result.keyPoints.forEach(p => {
            html += '<li>' + p + '</li>';
          });
          html += '</ul>';
        }
        
        if (result.actionItems && result.actionItems.length > 0) {
          html += '<h2>Action Items</h2>';
          html += '<ul data-type="taskList">';
          result.actionItems.forEach(a => {
            html += '<li data-type="taskItem" data-checked="false"><label><input type="checkbox"></label><div>' + a + '</div></li>';
          });
          html += '</ul>';
        }
        
        if (result.decisions && result.decisions.length > 0) {
          html += '<h2>Decisions</h2><ul>';
          result.decisions.forEach(d => {
            html += '<li><strong></strong> ' + d + '</li>';
          });
          html += '</ul>';
        }
      }
      
      // Store the enhanced notes before setting editor content
      storedEnhancedNotes = html;
      storedRawNotes = rawNotesAtStart || storedRawNotes || '';
      
      // Put in main editor (we're now in AI view)
      currentViewIsAI = true;
      isTogglingView = true;
      setEditorContent(html);
      setTimeout(() => { isTogglingView = false; }, 100);
      
      // Hide the AI panel since notes are in editor now
      aiNotesPanel.classList.add('hidden');
      
      // Force save immediately - save both raw and enhanced notes
      hasUnsavedChanges = true;
      saveStatus.textContent = 'Saving...';
      ipcRenderer.send('save-note', {
        id: currentNoteId,
        title: meetingTitle.textContent || 'Meeting Notes',
        notes: storedRawNotes,
        enhancedNotes: storedEnhancedNotes,
        transcript: transcript,
        calendarEventId: currentMeetingInfo?.id,
        startTime: currentMeetingInfo?.startTime,
        folderId: currentNoteFolderId,
        templateId: currentTemplateId,
        attendees: currentMeetingInfo?.attendees || [],
      });
      
      console.log('[AI Notes] Saved note with AI-generated content, template:', currentTemplateId);
    }
    
    // Legacy function for separate panel display (kept for compatibility)
    function displayAINotes(result) {
      aiEmpty.classList.add('hidden');
      aiResults.classList.remove('hidden');
      aiNotesActions.classList.remove('hidden');
      
      // Summary
      if (result.summary) {
        aiSummary.textContent = result.summary;
        document.getElementById('aiSummarySection').classList.remove('hidden');
      } else {
        document.getElementById('aiSummarySection').classList.add('hidden');
      }
      
      // Key Points
      if (result.keyPoints && result.keyPoints.length > 0) {
        aiKeyPoints.innerHTML = result.keyPoints.map(p => `<li>${p}</li>`).join('');
        document.getElementById('aiKeyPointsSection').classList.remove('hidden');
      } else {
        document.getElementById('aiKeyPointsSection').classList.add('hidden');
      }
      
      // Action Items
      if (result.actionItems && result.actionItems.length > 0) {
        aiActionItems.innerHTML = result.actionItems.map(a => 
          `<div class="ai-action-item"> ${a}</div>`
        ).join('');
        document.getElementById('aiActionItemsSection').classList.remove('hidden');
      } else {
        document.getElementById('aiActionItemsSection').classList.add('hidden');
      }
      
      // Decisions
      if (result.decisions && result.decisions.length > 0) {
        aiDecisions.innerHTML = result.decisions.map(d => 
          `<div class="ai-decision"> ${d}</div>`
        ).join('');
        document.getElementById('aiDecisionsSection').classList.remove('hidden');
      } else {
        document.getElementById('aiDecisionsSection').classList.add('hidden');
      }
    }
    
    function appendAINotesToEditor() {
      if (!currentAINotes) return;
      
      // Build HTML for TipTap
      let html = '';
      
      if (currentAINotes.summary) {
        html += `<h2>Summary</h2><p>${currentAINotes.summary}</p>`;
      }
      
      if (currentAINotes.keyPoints && currentAINotes.keyPoints.length > 0) {
        html += `<h2>Key Points</h2><ul>${currentAINotes.keyPoints.map(p => `<li>${p}</li>`).join('')}</ul>`;
      }
      
      if (currentAINotes.actionItems && currentAINotes.actionItems.length > 0) {
        html += `<h2>Action Items</h2><ul data-type="taskList">${currentAINotes.actionItems.map(a => 
          `<li data-type="taskItem" data-checked="false"><label><input type="checkbox"></label><div>${a}</div></li>`
        ).join('')}</ul>`;
      }
      
      if (currentAINotes.decisions && currentAINotes.decisions.length > 0) {
        html += `<h2>Decisions</h2><ul>${currentAINotes.decisions.map(d => `<li><strong></strong> ${d}</li>`).join('')}</ul>`;
      }
      
      // Append to existing notes with HR separator
      const currentNotes = getEditorContent();
      if (currentNotes.trim() && !currentNotes.includes('<p></p>')) {
        setEditorContent(currentNotes + '<hr>' + html);
      } else {
        setEditorContent(html);
      }
      
      scheduleAutoSave();
    }
    
    // AI Notes button handlers
    aiAppendBtn?.addEventListener('click', appendAINotesToEditor);
    aiRegenerateBtn?.addEventListener('click', regenerateNotes);
    
    // Check for OpenAI key on load
    checkOpenAIKey();
    
    // Auto-save functionality
    function scheduleAutoSave() {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      hasUnsavedChanges = true;
      saveStatus.textContent = '';
      
      autoSaveTimer = setTimeout(() => {
        autoSave();
      }, 1500); // Save 1.5 seconds after user stops typing
    }
    
    function autoSave() {
      if (!hasUnsavedChanges) return;
      const content = getEditorContent();
      // Save if there's a title, content, OR transcript (for new recordings)
      if (!meetingTitle.textContent.trim() && !content.trim() && transcript.length === 0) return;
      
      saveStatus.textContent = 'Saving...';
      
      // Determine what to save based on current view
      let rawNotesToSave = storedRawNotes || rawNotesAtStart || '';
      let enhancedNotesToSave = storedEnhancedNotes || '';
      
      // Update the appropriate content based on current view
      if (currentViewIsAI && currentAINotes) {
        // In AI view - current content is enhanced notes
        enhancedNotesToSave = content;
      } else {
        // In raw view or no AI notes - current content is raw notes
        rawNotesToSave = content;
      }
      
      ipcRenderer.send('save-note', {
        id: currentNoteId,
        title: meetingTitle.textContent || 'Untitled Note',
        notes: rawNotesToSave,
        enhancedNotes: enhancedNotesToSave || undefined,
        transcript: transcript,
        calendarEventId: currentMeetingInfo?.id,
        startTime: currentMeetingInfo?.startTime,
        folderId: currentNoteFolderId,
        templateId: currentTemplateId,
        attendees: currentMeetingInfo?.attendees || [],
      });
    }
    
    // Listen for changes (TipTap handles its own via onUpdate)
    meetingTitle.addEventListener('input', () => {
      scheduleAutoSave();
      updateFloatingIndicator(); // Update floating indicator title when title changes
    });
    // Note: TipTap editor auto-save is handled in initTiptapEditor's onUpdate
    
    // Toggle sidebar
    toggleSidebarBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    });
    
    // Sidebar starts expanded when opening notes (no meeting)
    // Will be collapsed only if user manually collapses it during a recording
    
    // Create new note (if button exists)
    if (newNoteBtn) {
      newNoteBtn.addEventListener('click', async () => {
        currentNoteId = null;
        currentNoteFolderId = null; // Reset folder for new note
        meetingTitle.textContent = '';
        setEditorContent('');
        transcript = [];
        currentAINotes = null;
        currentTemplateId = null; // Reset template
        isGeneratingAINotes = false;
        // Reset stored notes for new note
        storedRawNotes = '';
        storedEnhancedNotes = '';
        rawNotesAtStart = '';
        currentViewIsAI = false;
        // Clear new-note caches
        generateAISuggestionCache.delete('new-note');
        folderSuggestionCache.delete('new-note');
        
        // Reset meeting meta and mic UI for new note
        updateMeetingMeta(null);
        renderTranscript();
        updateNextMeeting();
        updateAddToFolderButton(null); // Reset folder button
        hideNotesViewToggle(); // Hide toggle for new note
        hideGenerateNotesButton(); // Hide generate button until transcript exists
        
        showEditor();
        meetingTitle.focus();
        renderNotesList();
        
        // Auto-start recording for new note
        console.log('[Editor] Auto-starting recording for new note');
        isRecording = false; // Reset first
        isMicActive = false;
        
        // Small delay then start recording
        setTimeout(() => {
          startTranscription();
        }, 300);
      });
    }
    
    // ============================================================================
    // TEMPLATES MANAGEMENT
    // ============================================================================
    
    let templates = [];
    let selectedTemplate = null;
    let editingTemplate = null;
    
    const newTemplateBtn = document.getElementById('newTemplateBtn');
    const templatesList = document.getElementById('templatesList');
    const templatesEditor = document.getElementById('templatesEditor');
    
    // Template icons for picker
    const templateIcons = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
    
    async function loadTemplates() {
      templates = await ipcRenderer.invoke('templates-get-all');
      renderTemplatesList();
    }
    
    function renderTemplatesList() {
      if (!templatesList) return;
      
      const builtIn = templates.filter(t => t.isBuiltIn);
      const custom = templates.filter(t => !t.isBuiltIn);
      
      let html = '';
      
      if (custom.length > 0) {
        html += `<div class="templates-list-section">
          <div class="templates-list-section-title">My Templates</div>
          ${custom.map(t => renderTemplateListItem(t)).join('')}
        </div>`;
      }
      
      html += `<div class="templates-list-section">
        <div class="templates-list-section-title">Built-in Templates</div>
        ${builtIn.map(t => renderTemplateListItem(t)).join('')}
      </div>`;
      
      templatesList.innerHTML = html;
      
      // Add click handlers
      templatesList.querySelectorAll('.template-list-item').forEach(item => {
        item.addEventListener('click', () => {
          const id = item.dataset.templateId;
          selectTemplate(id);
        });
      });
    }
    
    function renderTemplateListItem(template) {
      const isActive = selectedTemplate?.id === template.id;
      return `
        <div class="template-list-item ${isActive ? 'active' : ''}" data-template-id="${template.id}">
          <span class="template-list-icon">${template.icon}</span>
          <div class="template-list-info">
            <div class="template-list-name">${template.name}</div>
            <div class="template-list-owner">${template.isBuiltIn ? 'IceCubes' : 'Me'}</div>
          </div>
          ${template.isDefault ? '<span class="template-default-badge">Default</span>' : ''}
        </div>
      `;
    }
    
    function selectTemplate(id) {
      selectedTemplate = templates.find(t => t.id === id);
      editingTemplate = selectedTemplate ? JSON.parse(JSON.stringify(selectedTemplate)) : null;
      renderTemplatesList();
      renderTemplateEditor();
    }
    
    function renderTemplateEditor() {
      if (!templatesEditor || !editingTemplate) {
        if (templatesEditor) {
          templatesEditor.innerHTML = `
            <div class="templates-empty-state">
              <p>Select a template to edit or create a new one</p>
            </div>
          `;
        }
        return;
      }
      
      const t = editingTemplate;
      const isBuiltIn = t.isBuiltIn;
      
      templatesEditor.innerHTML = `
        <div class="template-edit-header">
          <div class="template-edit-icon-picker" id="templateIconPicker">
            ${t.icon}
            <div class="template-edit-icon-dropdown" id="templateIconDropdown">
              ${templateIcons.map(icon => `
                <button class="template-icon-choice" data-icon="${icon}">${icon}</button>
              `).join('')}
            </div>
          </div>
          <div class="template-edit-title-group">
            <input type="text" class="template-edit-name" id="templateNameInput" 
                   value="${t.name}" placeholder="Template name" ${isBuiltIn ? 'readonly' : ''}>
            <div class="template-edit-meta">
              <div class="template-edit-owner">
                <span class="template-edit-owner-avatar">${isBuiltIn ? 'I' : 'M'}</span>
                ${isBuiltIn ? 'IceCubes' : 'Me'}
              </div>
              <button class="template-edit-default-toggle ${t.isDefault ? 'is-default' : ''}" id="templateDefaultToggle">
                ${t.isDefault ? ' Default' : 'Set as Default'}
              </button>
            </div>
          </div>
        </div>
        
        <div class="template-edit-section-label">Meeting Context</div>
        <textarea class="template-context-input" id="templateContextInput" 
                  placeholder="Give the AI context about this meeting type and your goals..."
                  ${isBuiltIn ? 'readonly' : ''}>${t.description}</textarea>
        
        <div class="template-edit-section-label">Sections</div>
        <div class="template-sections-list" id="templateSectionsList">
          ${t.sections.map((section, index) => renderTemplateSection(section, index, isBuiltIn)).join('')}
        </div>
        
        ${!isBuiltIn ? `
          <button class="template-add-section-btn" id="addTemplateSectionBtn">
            + Add Section
          </button>
        ` : ''}
        
        <div class="template-actions">
          ${!isBuiltIn ? `
            <button class="template-save-btn" id="saveTemplateBtn">Save Template</button>
            <button class="template-delete-btn" id="deleteTemplateBtn">Delete</button>
          ` : `
            <button class="template-save-btn" id="duplicateTemplateBtn">Duplicate & Edit</button>
          `}
        </div>
      `;
      
      // Setup event handlers
      setupTemplateEditorEvents();
    }
    
    function renderTemplateSection(section, index, isBuiltIn) {
      return `
        <div class="template-section-item" data-section-index="${index}" 
             draggable="${!isBuiltIn}" 
             ${!isBuiltIn ? 'ondragstart="handleSectionDragStart(event)" ondragover="handleSectionDragOver(event)" ondrop="handleSectionDrop(event)" ondragend="handleSectionDragEnd(event)"' : ''}>
          <div class="template-section-drag" ${!isBuiltIn ? 'title="Drag to reorder"' : ''}></div>
          <div class="template-section-content">
            <input type="text" class="template-section-title-input" 
                   value="${section.title}" placeholder="Section title"
                   data-section-index="${index}" data-field="title" ${isBuiltIn ? 'readonly' : ''}>
            <textarea class="template-section-instructions-input" 
                      placeholder="Instructions for AI..."
                      data-section-index="${index}" data-field="instructions" ${isBuiltIn ? 'readonly' : ''}>${section.instructions}</textarea>
          </div>
          ${!isBuiltIn ? `
            <button class="template-section-delete" data-section-index="${index}"></button>
          ` : ''}
        </div>
      `;
    }
    
    // Drag and drop for template sections
    let draggedSectionIndex = null;
    
    window.handleSectionDragStart = function(e) {
      draggedSectionIndex = parseInt(e.target.closest('.template-section-item').dataset.sectionIndex);
      e.target.closest('.template-section-item').classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    };
    
    window.handleSectionDragOver = function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const item = e.target.closest('.template-section-item');
      if (item) {
        // Remove highlight from all items
        document.querySelectorAll('.template-section-item').forEach(el => el.classList.remove('drag-over'));
        item.classList.add('drag-over');
      }
    };
    
    window.handleSectionDrop = function(e) {
      e.preventDefault();
      const dropTarget = e.target.closest('.template-section-item');
      if (!dropTarget || draggedSectionIndex === null) return;
      
      const dropIndex = parseInt(dropTarget.dataset.sectionIndex);
      if (draggedSectionIndex === dropIndex) return;
      
      // Reorder sections
      const sections = editingTemplate.sections;
      const [movedSection] = sections.splice(draggedSectionIndex, 1);
      sections.splice(dropIndex, 0, movedSection);
      
      // Re-render
      renderTemplateEditor();
    };
    
    window.handleSectionDragEnd = function(e) {
      draggedSectionIndex = null;
      document.querySelectorAll('.template-section-item').forEach(el => {
        el.classList.remove('dragging', 'drag-over');
      });
    };
    
    function setupTemplateEditorEvents() {
      // Icon picker
      const iconPicker = document.getElementById('templateIconPicker');
      const iconDropdown = document.getElementById('templateIconDropdown');
      if (iconPicker && iconDropdown) {
        iconPicker.addEventListener('click', (e) => {
          e.stopPropagation();
          iconDropdown.classList.toggle('show');
        });
        
        iconDropdown.querySelectorAll('.template-icon-choice').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!editingTemplate.isBuiltIn) {
              editingTemplate.icon = btn.dataset.icon;
              renderTemplateEditor();
            }
          });
        });
      }
      
      // Name input
      const nameInput = document.getElementById('templateNameInput');
      if (nameInput) {
        nameInput.addEventListener('input', () => {
          editingTemplate.name = nameInput.value;
        });
      }
      
      // Context input
      const contextInput = document.getElementById('templateContextInput');
      if (contextInput) {
        contextInput.addEventListener('input', () => {
          editingTemplate.description = contextInput.value;
        });
      }
      
      // Default toggle
      const defaultToggle = document.getElementById('templateDefaultToggle');
      if (defaultToggle) {
        defaultToggle.addEventListener('click', async () => {
          await ipcRenderer.invoke('templates-set-default', editingTemplate.id);
          templates = await ipcRenderer.invoke('templates-get-all');
          editingTemplate = templates.find(t => t.id === editingTemplate.id);
          renderTemplatesList();
          renderTemplateEditor();
        });
      }
      
      // Section inputs
      document.querySelectorAll('.template-section-title-input, .template-section-instructions-input').forEach(input => {
        input.addEventListener('input', () => {
          const index = parseInt(input.dataset.sectionIndex);
          const field = input.dataset.field;
          editingTemplate.sections[index][field] = input.value;
        });
      });
      
      // Section delete buttons
      document.querySelectorAll('.template-section-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.sectionIndex);
          editingTemplate.sections.splice(index, 1);
          renderTemplateEditor();
        });
      });
      
      // Add section button
      const addSectionBtn = document.getElementById('addTemplateSectionBtn');
      if (addSectionBtn) {
        addSectionBtn.addEventListener('click', () => {
          editingTemplate.sections.push({
            id: `s${Date.now()}`,
            title: 'Section title',
            instructions: 'Instructions for AI...'
          });
          renderTemplateEditor();
        });
      }
      
      // Save button
      const saveBtn = document.getElementById('saveTemplateBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
          if (editingTemplate.id.startsWith('custom-')) {
            await ipcRenderer.invoke('templates-update', editingTemplate.id, editingTemplate);
          } else {
            // Creating new from scratch - shouldn't happen here
            const newTemplate = await ipcRenderer.invoke('templates-create', editingTemplate);
            editingTemplate = newTemplate;
          }
          templates = await ipcRenderer.invoke('templates-get-all');
          selectedTemplate = templates.find(t => t.id === editingTemplate.id);
          renderTemplatesList();
          renderTemplateEditor();
        });
      }
      
      // Delete button
      const deleteBtn = document.getElementById('deleteTemplateBtn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
          if (confirm('Delete this template?')) {
            await ipcRenderer.invoke('templates-delete', editingTemplate.id);
            templates = await ipcRenderer.invoke('templates-get-all');
            selectedTemplate = null;
            editingTemplate = null;
            renderTemplatesList();
            renderTemplateEditor();
          }
        });
      }
      
      // Duplicate button (for built-in templates)
      const duplicateBtn = document.getElementById('duplicateTemplateBtn');
      if (duplicateBtn) {
        duplicateBtn.addEventListener('click', async () => {
          const newTemplate = await ipcRenderer.invoke('templates-create', {
            name: `${editingTemplate.name} (Copy)`,
            icon: editingTemplate.icon,
            description: editingTemplate.description,
            sections: editingTemplate.sections.map(s => ({...s, id: `s${Date.now()}-${Math.random()}`})),
            isDefault: false
          });
          templates = await ipcRenderer.invoke('templates-get-all');
          selectTemplate(newTemplate.id);
        });
      }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      const dropdown = document.getElementById('templateIconDropdown');
      if (dropdown) dropdown.classList.remove('show');
    });
    
    // Templates modal elements
    const templatesModal = document.getElementById('templatesModal');
    const manageTemplatesBtn = document.getElementById('manageTemplatesBtn');
    const closeTemplatesBtn = document.getElementById('closeTemplatesBtn');
    
    // Open templates modal
    if (manageTemplatesBtn) {
      manageTemplatesBtn.addEventListener('click', async () => {
        await loadTemplates();
        templatesModal?.classList.remove('hidden');
      });
    }
    
    // Close templates modal
    if (closeTemplatesBtn) {
      closeTemplatesBtn.addEventListener('click', () => {
        templatesModal?.classList.add('hidden');
      });
    }
    
    // Close modal when clicking outside
    if (templatesModal) {
      templatesModal.addEventListener('click', (e) => {
        if (e.target === templatesModal) {
          templatesModal.classList.add('hidden');
        }
      });
    }
    
    // New template button
    if (newTemplateBtn) {
      newTemplateBtn.addEventListener('click', async () => {
        const newTemplate = await ipcRenderer.invoke('templates-create', {
          name: 'Untitled Template',
          icon: '',
          description: '',
          sections: [
            { id: 's1', title: 'Summary', instructions: 'Brief summary of the meeting' }
          ],
          isDefault: false
        });
        templates = await ipcRenderer.invoke('templates-get-all');
        selectTemplate(newTemplate.id);
      });
    }
    
    // ============================================================================
    // FOLDER MANAGEMENT
    // ============================================================================
    
    async function loadFolders() {
      folders = await ipcRenderer.invoke('folders-get-all');
      renderFoldersList();
    }
    
    function renderFoldersList() {
      if (!foldersList) return;
      
      foldersList.innerHTML = folders.map(folder => `
        <div class="folder-item ${currentFolderId === folder.id ? 'active' : ''}" 
             data-folder-id="${folder.id}"
             title="${folder.description || folder.name}">
          <span class="folder-item-icon">${folder.icon}</span>
          <span class="folder-item-name">${folder.name}${folder.isDefault ? ' ' : ''}</span>
          <span class="folder-item-count">${folder.noteCount || 0}</span>
          <button class="folder-menu-btn" data-folder-id="${folder.id}" title="More options"></button>
        </div>
      `).join('');
      
      // Add click handlers
      foldersList.querySelectorAll('.folder-item').forEach(item => {
        item.addEventListener('click', (e) => {
          // Don't select folder if clicking menu button
          if (e.target.closest('.folder-menu-btn')) return;
          selectFolder(item.dataset.folderId);
        });
      });
      
      // Add menu button handlers
      foldersList.querySelectorAll('.folder-menu-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const rect = btn.getBoundingClientRect();
          showFolderContextMenu(btn.dataset.folderId, rect.right, rect.bottom);
        });
      });
    }
    
    function selectFolder(folderId) {
      currentFolderId = folderId;
      
      // Clear person/company filters when selecting a folder
      currentPersonFilter = null;
      currentCompanyFilter = null;
      // Clear People/Companies nav active states
      navPeople?.classList.remove('active');
      navCompanies?.classList.remove('active');
      
      // Update nav item active states
      document.querySelectorAll('.nav-item, .folder-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.folderId === folderId) {
          item.classList.add('active');
        }
      });
      
      // Hide back button for "All Notes", show for specific folders
      const isAllNotes = !folderId || folderId === 'all';
      if (isAllNotes) {
        backBtn?.classList.add('hidden');
      } else {
        backBtn?.classList.remove('hidden');
      }
      
      // Hide/show calendar section and folder ask trigger based on folder
      const calendarSection = document.querySelector('.calendar-section');
      const folderAskTrigger = document.getElementById('folderAskTrigger');
      const folderSearchPanel = document.getElementById('folderSearchPanel');
      const folderSearchOverlay = document.getElementById('folderSearchOverlay');
      const isSpecificFolder = folderId && folderId !== 'all' && folderId !== 'shared';
      
      if (isSpecificFolder) {
        // Hide calendar when viewing a specific folder
        if (calendarSection) calendarSection.style.display = 'none';
        // Show folder ask trigger
        if (folderAskTrigger) folderAskTrigger.style.display = 'block';
        // Close and reset the search panel
        if (folderSearchPanel) {
          folderSearchPanel.classList.add('hidden');
          const searchInput = document.getElementById('folderSearchInput');
          const searchResults = document.getElementById('folderSearchResults');
          if (searchInput) searchInput.value = '';
          if (searchResults) searchResults.innerHTML = '';
        }
        if (folderSearchOverlay) folderSearchOverlay.classList.add('hidden');
      } else {
        // Show calendar for "All Notes" view (if connected)
        if (calendarConnected && calendarSection) {
          calendarSection.style.display = 'block';
        }
        // Hide folder ask trigger
        if (folderAskTrigger) folderAskTrigger.style.display = 'none';
        // Close search panel
        if (folderSearchPanel) folderSearchPanel.classList.add('hidden');
        if (folderSearchOverlay) folderSearchOverlay.classList.add('hidden');
      }
      
      // Re-render notes list filtered by folder
      renderNotesList();
      
      // Update folder title in search panel
      updateFolderAIPanel();
    }
    
    function updateFolderAIPanel() {
      const isSpecificFolder = currentFolderId && currentFolderId !== 'all' && currentFolderId !== 'shared';
      const folderSearchTitle = document.getElementById('folderSearchTitle');
      
      if (isSpecificFolder && folderSearchTitle) {
        const folder = folders.find(f => f.id === currentFolderId);
        if (folder) {
          folderSearchTitle.textContent = `Search in ${folder.name}`;
        }
      }
    }
    
    function showFolderContextMenu(folderId, x, y) {
      // Don't allow editing/deleting default folders
      if (folderId === 'default-my-notes') return;
      
      const folder = folders.find(f => f.id === folderId);
      if (!folder) return;
      
      // Create context menu
      const menu = document.createElement('div');
      menu.className = 'folder-context-menu';
      menu.style.cssText = `
        position: fixed;
        left: ${x}px;
        top: ${y}px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10001;
        min-width: 150px;
      `;
      menu.innerHTML = `
        <div class="folder-menu-item" data-action="rename" style="padding: 10px 14px; cursor: pointer; font-size: 13px;">
           Rename
        </div>
        <div class="folder-menu-item" data-action="delete" style="padding: 10px 14px; cursor: pointer; font-size: 13px; color: #ef4444;">
           Delete
        </div>
      `;
      
      document.body.appendChild(menu);
      
      // Handle clicks
      menu.querySelectorAll('.folder-menu-item').forEach(item => {
        item.addEventListener('click', async () => {
          const action = item.dataset.action;
          if (action === 'rename') {
            editingFolderId = folderId;
            folderModalTitle.textContent = 'Edit Folder';
            folderNameInput.value = folder.name;
            folderDescInput.value = folder.description || '';
            folderDefaultToggle.checked = folder.isDefault || false;
            selectedFolderIcon = folder.icon || '';
            
            // Update word counter
            updateDescWordCount();
            
            // Load current default folder info
            await loadDefaultFolder();
            updateDefaultWarning();
            updateIconSelection();
            
            // Show the right tab for the icon
            const isColorIcon = ['', '', '', '', '', '', '', '', '', '', '', ''].includes(folder.icon);
            document.querySelectorAll('.folder-icon-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.folder-icon-tab[data-tab="${isColorIcon ? 'colors' : 'emoji'}"]`)?.classList.add('active');
            document.querySelectorAll('.icon-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.icon-tab-content[data-tab="${isColorIcon ? 'colors' : 'emoji'}"]`)?.classList.add('active');
            
            folderCreateBtn.textContent = 'Save';
            folderModal.classList.remove('hidden');
            folderNameInput.focus();
          } else if (action === 'delete') {
            showDeleteFolderModal(folder);
          }
          menu.remove();
        });
        
        item.addEventListener('mouseenter', () => {
          item.style.background = 'var(--bg-hover)';
        });
        item.addEventListener('mouseleave', () => {
          item.style.background = '';
        });
      });
      
      // Close on click outside
      const closeMenu = (e) => {
        if (!menu.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', closeMenu);
        }
      };
      setTimeout(() => document.addEventListener('click', closeMenu), 0);
    }
    
    // Delete folder modal
    const deleteFolderModal = document.getElementById('deleteFolderModal');
    const deleteFolderIcon = document.getElementById('deleteFolderIcon');
    const deleteFolderName = document.getElementById('deleteFolderName');
    const deleteFolderNoteCount = document.getElementById('deleteFolderNoteCount');
    const deleteFolderOnlyBtn = document.getElementById('deleteFolderOnlyBtn');
    const deleteFolderWithNotesBtn = document.getElementById('deleteFolderWithNotesBtn');
    const deleteFolderCancelBtn = document.getElementById('deleteFolderCancelBtn');
    let folderToDelete = null;
    
    function showDeleteFolderModal(folder) {
      folderToDelete = folder;
      deleteFolderIcon.textContent = folder.icon;
      deleteFolderName.textContent = folder.name;
      deleteFolderNoteCount.textContent = folder.noteCount || 0;
      deleteFolderModal.classList.remove('hidden');
    }
    
    deleteFolderCancelBtn?.addEventListener('click', () => {
      deleteFolderModal.classList.add('hidden');
      folderToDelete = null;
    });
    
    deleteFolderOnlyBtn?.addEventListener('click', async () => {
      if (!folderToDelete) return;
      
      // Delete folder only - notes stay but become unassigned
      await ipcRenderer.invoke('folders-delete', folderToDelete.id);
      
      if (currentFolderId === folderToDelete.id) {
        selectFolder('all');
      }
      
      deleteFolderModal.classList.add('hidden');
      folderToDelete = null;
      await loadFolders();
      await loadNotes();
    });
    
    deleteFolderWithNotesBtn?.addEventListener('click', async () => {
      if (!folderToDelete) return;
      
      // Delete folder AND all notes in it
      await ipcRenderer.invoke('folders-delete-with-notes', folderToDelete.id);
      
      if (currentFolderId === folderToDelete.id) {
        selectFolder('all');
      }
      
      deleteFolderModal.classList.add('hidden');
      folderToDelete = null;
      await loadFolders();
      await loadNotes();
    });
    
    // Close delete modal on escape
    deleteFolderModal?.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        deleteFolderModal.classList.add('hidden');
        folderToDelete = null;
      }
    });
    
    // Delete note confirmation modal
    function showDeleteNoteModal(noteId, noteTitle) {
      const overlay = document.createElement('div');
      overlay.className = 'delete-note-modal-overlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10010;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      const modal = document.createElement('div');
      modal.className = 'delete-note-modal';
      modal.style.cssText = `
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        max-width: 360px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      `;
      
      modal.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <span style="font-size: 28px;"></span>
          <span style="font-weight: 600; font-size: 16px; color: var(--text);">Delete Note</span>
        </div>
        <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.6; margin: 0 0 20px 0;">
          Are you sure you want to delete "<strong>${noteTitle}</strong>"? This action cannot be undone.
        </p>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button class="delete-note-cancel-btn" style="
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
          ">Cancel</button>
          <button class="delete-note-confirm-btn" style="
            padding: 10px 16px;
            background: #dc2626;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
          ">Delete</button>
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Cancel button
      modal.querySelector('.delete-note-cancel-btn').addEventListener('click', () => {
        overlay.remove();
      });
      
      // Click outside to cancel
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
      
      // Confirm delete
      modal.querySelector('.delete-note-confirm-btn').addEventListener('click', async () => {
        await ipcRenderer.invoke('delete-note', noteId);
        
        // If we deleted the current note, clear the editor
        if (noteId === currentNoteId) {
          currentNoteId = null;
          meetingTitle.textContent = '';
          setEditorContent('');
          transcript = [];
          showEmptyState();
        }
        
        // Refresh the list
        await loadNotes();
        overlay.remove();
      });
      
      // Escape key to cancel
      const handleEscape = (e) => {
        if (e.key === 'Escape') {
          overlay.remove();
          document.removeEventListener('keydown', handleEscape);
        }
      };
      document.addEventListener('keydown', handleEscape);
    }
    
    function updateIconSelection() {
      folderIconPicker.querySelectorAll('.folder-icon-option').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.icon === selectedFolderIcon);
      });
    }
    
    // Load default folder info
    async function loadDefaultFolder() {
      currentDefaultFolder = await ipcRenderer.invoke('folders-get-default');
    }
    
    // Update default folder warning visibility
    function updateDefaultWarning() {
      if (folderDefaultToggle?.checked && currentDefaultFolder && currentDefaultFolder.id !== editingFolderId) {
        currentDefaultName.textContent = currentDefaultFolder.name;
        folderDefaultWarning.classList.remove('hidden');
      } else {
        folderDefaultWarning.classList.add('hidden');
      }
    }
    
    // Folder modal handlers
    addFolderBtn?.addEventListener('click', async () => {
      editingFolderId = null;
      folderModalTitle.textContent = 'Create Folder';
      folderNameInput.value = '';
      folderDescInput.value = '';
      folderDefaultToggle.checked = false;
      selectedFolderIcon = '';
      
      // Reset word counter
      updateDescWordCount();
      
      // Load current default folder info
      await loadDefaultFolder();
      updateDefaultWarning();
      updateIconSelection();
      
      // Show colors tab by default
      document.querySelectorAll('.folder-icon-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.folder-icon-tab[data-tab="colors"]')?.classList.add('active');
      document.querySelectorAll('.icon-tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector('.icon-tab-content[data-tab="colors"]')?.classList.add('active');
      
      folderCreateBtn.textContent = 'Create';
      folderModal.classList.remove('hidden');
      folderNameInput.focus();
    });
    
    // Add to folder button in editor (shows folder picker for current note)
    const addToFolderBtn = document.getElementById('addToFolderBtn');
    addToFolderBtn?.addEventListener('click', async () => {
      if (!currentNoteId) {
        console.log('[Editor] No current note to add to folder');
        return;
      }
      showFolderPicker(currentNoteId, addToFolderBtn);
    });
    
    // Icon tab switching
    document.querySelectorAll('.folder-icon-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        document.querySelectorAll('.folder-icon-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.icon-tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.icon-tab-content[data-tab="${tabName}"]`)?.classList.add('active');
      });
    });
    
    // Default toggle change handler
    folderDefaultToggle?.addEventListener('change', () => {
      updateDefaultWarning();
    });
    
    // Word counter for description
    const folderWordCountEl = document.getElementById('folderWordCount');
    const folderDescCounter = document.getElementById('folderDescCounter');
    const MAX_DESC_WORDS = 200;
    
    function countWords(text) {
      return text.trim().split(/\s+/).filter(w => w.length > 0).length;
    }
    
    function updateDescWordCount() {
      const words = countWords(folderDescInput.value);
      folderWordCountEl.textContent = words;
      
      if (words > MAX_DESC_WORDS) {
        folderDescCounter.classList.add('over-limit');
        folderCreateBtn.disabled = true;
        folderCreateBtn.style.opacity = '0.5';
      } else {
        folderDescCounter.classList.remove('over-limit');
        folderCreateBtn.disabled = false;
        folderCreateBtn.style.opacity = '1';
      }
    }
    
    folderDescInput?.addEventListener('input', updateDescWordCount);
    
    folderIconPicker?.addEventListener('click', (e) => {
      const btn = e.target.closest('.folder-icon-option');
      if (btn) {
        selectedFolderIcon = btn.dataset.icon;
        updateIconSelection();
      }
    });
    
    folderCancelBtn?.addEventListener('click', () => {
      folderModal.classList.add('hidden');
      editingFolderId = null;
    });
    
    folderCreateBtn?.addEventListener('click', async () => {
      const name = folderNameInput.value.trim();
      if (!name) return;
      
      const description = folderDescInput.value.trim();
      
      // Validate word limit
      if (countWords(description) > MAX_DESC_WORDS) {
        alert(`Description exceeds ${MAX_DESC_WORDS} words limit. Please shorten it.`);
        return;
      }
      
      const isDefault = folderDefaultToggle.checked;
      
      if (editingFolderId) {
        // Update existing folder
        await ipcRenderer.invoke('folders-update', editingFolderId, { 
          name, 
          icon: selectedFolderIcon,
          description,
          isDefault 
        });
      } else {
        // Create new folder
        await ipcRenderer.invoke('folders-create', name, selectedFolderIcon, '#6366f1', false, description, isDefault);
      }
      
      folderModal.classList.add('hidden');
      editingFolderId = null;
      await loadFolders();
    });
    
    // Close modal on escape
    folderModal?.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        folderModal.classList.add('hidden');
        editingFolderId = null;
      } else if (e.key === 'Enter') {
        folderCreateBtn.click();
      }
    });
    
    // Nav item click handlers
    navAllNotes?.addEventListener('click', () => selectFolder('all'));
    
    // ============================================================================
    // PEOPLE AND COMPANIES
    // ============================================================================
    
    let allPeople = [];
    let allCompanies = [];
    let currentPersonFilter = null;
    let currentCompanyFilter = null;
    
    // Sorting state for People/Companies tables
    let peopleSortColumn = 'lastNote'; // 'name', 'lastNote', 'notes'
    let peopleSortDirection = 'desc'; // 'asc', 'desc'
    let companiesSortColumn = 'lastNote';
    let companiesSortDirection = 'desc';
    const navPeople = document.getElementById('navPeople');
    const navCompanies = document.getElementById('navCompanies');
    const peopleCountEl = document.getElementById('peopleCount');
    const companiesCountEl = document.getElementById('companiesCount');
    
    async function loadPeopleAndCompanies() {
      // First, try to backfill any notes missing people/companies from calendar
      await ipcRenderer.invoke('backfill-people-companies');
      
      allPeople = await ipcRenderer.invoke('get-all-people');
      allCompanies = await ipcRenderer.invoke('get-all-companies');
      
      // Update counts in nav
      if (peopleCountEl) peopleCountEl.textContent = allPeople.length;
      if (companiesCountEl) companiesCountEl.textContent = allCompanies.length;
    }
    
    // Click "People" in nav -> show all people list in right panel
    window.handlePeopleClick = function() {
      console.log('[People] Clicked People nav');
      // Clear other selections
      currentFolderId = null;
      currentPersonFilter = null;
      currentCompanyFilter = null;
      
      // Update nav active states
      navAllNotes?.classList.remove('active');
      navPeople?.classList.add('active');
      navCompanies?.classList.remove('active');
      foldersList?.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
      
      showPeopleListView();
    };
    
    // Also add event listener as backup
    navPeople?.addEventListener('click', window.handlePeopleClick);
    
    // Click "Companies" in nav -> show all companies list in right panel
    window.handleCompaniesClick = function() {
      console.log('[Companies] Clicked Companies nav');
      // Clear other selections
      currentFolderId = null;
      currentPersonFilter = null;
      currentCompanyFilter = null;
      
      // Update nav active states
      navAllNotes?.classList.remove('active');
      navPeople?.classList.remove('active');
      navCompanies?.classList.add('active');
      foldersList?.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
      
      showCompaniesListView();
    };
    
    // Also add event listener as backup
    navCompanies?.addEventListener('click', window.handleCompaniesClick);
    
    function showPeopleListView(filter = '') {
      // Show home view (notes list), hide editor
      if (notesHome) notesHome.style.display = 'flex';
      if (editorContent) editorContent.classList.add('hidden');
      backBtn?.classList.add('hidden');
      document.body.classList.remove('viewing-note');
      
      // Hide calendar section
      const calendarSection = document.querySelector('.calendar-section');
      if (calendarSection) calendarSection.style.display = 'none';
      
      const filtered = filter 
        ? allPeople.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()))
        : allPeople;
      
      // Show back button in main header
      backBtn?.classList.remove('hidden');
      
      // Sort based on current sort state
      const sortIndicator = (col) => {
        if (peopleSortColumn !== col) return '';
        return `<span class="sort-indicator">${peopleSortDirection === 'asc' ? '' : ''}</span>`;
      };
      const activeClass = (col) => peopleSortColumn === col ? 'active' : '';
      
      let html = `
        <div class="entity-list-search">
          <input type="text" class="entity-list-search-input" id="peopleListSearch" placeholder="Search people..." value="${filter}">
        </div>
        <div class="entity-table-header">
          <span class="sortable-col ${activeClass('name')}" data-sort="name">Person ${sortIndicator('name')}</span>
          <span class="sortable-col ${activeClass('lastNote')}" data-sort="lastNote">Last note ${sortIndicator('lastNote')}</span>
          <span class="sortable-col ${activeClass('notes')}" data-sort="notes" style="text-align: right; justify-content: flex-end;">Notes ${sortIndicator('notes')}</span>
        </div>
        <div class="entity-list-items" id="peopleListItems">
      `;
      
      if (filtered.length === 0) {
        html += `<div class="entity-list-empty">
          ${filter ? 'No matches found.' : `
            <div style="text-align: center; padding: 40px 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;"></div>
              <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">No people found yet</div>
              <div style="font-size: 14px; color: var(--text-muted); line-height: 1.5;">
                People are automatically extracted from calendar event attendees when you record meetings.<br><br>
                <strong>To see people here:</strong><br>
                1. Connect your Google Calendar<br>
                2. Record a meeting with attendees<br>
                3. People will appear automatically
              </div>
            </div>
          `}
        </div>`;
      } else {
        // Sort based on current sort column and direction
        filtered.sort((a, b) => {
          let comparison = 0;
          switch (peopleSortColumn) {
            case 'name':
              comparison = a.name.localeCompare(b.name);
              break;
            case 'lastNote':
              const aDate = a.lastNoteDate ? new Date(a.lastNoteDate) : new Date(0);
              const bDate = b.lastNoteDate ? new Date(b.lastNoteDate) : new Date(0);
              comparison = aDate - bDate;
              break;
            case 'notes':
              comparison = a.noteCount - b.noteCount;
              break;
          }
          return peopleSortDirection === 'asc' ? comparison : -comparison;
        });
        
        filtered.forEach(person => {
          const initial = person.name.charAt(0).toUpperCase();
          const lastDate = person.lastNoteDate 
            ? new Date(person.lastNoteDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
            : '-';
          
          html += `
            <div class="entity-list-item" data-person="${person.name}">
              <div class="entity-list-item-left">
                <div class="entity-avatar">${initial}</div>
                <div class="entity-list-item-info">
                  <div class="entity-list-item-name">${person.name}</div>
                  <div class="entity-list-item-email">${person.email || ''}</div>
                </div>
              </div>
              <div class="entity-list-item-date">${lastDate}</div>
              <div class="entity-list-item-count">${person.noteCount}</div>
            </div>
          `;
        });
      }
      
      html += '</div>';
      notesList.innerHTML = html;
      
      // Back button uses existing header backBtn - handled separately
      
      // Add search handler - filter in place without re-rendering
      document.getElementById('peopleListSearch')?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const items = document.querySelectorAll('#peopleListItems .entity-list-item');
        items.forEach(item => {
          const name = item.dataset.person?.toLowerCase() || '';
          item.style.display = name.includes(query) ? '' : 'none';
        });
      });
      
      // Add click handlers for sortable columns
      notesList.querySelectorAll('.entity-table-header .sortable-col').forEach(col => {
        col.addEventListener('click', () => {
          const sortKey = col.dataset.sort;
          if (peopleSortColumn === sortKey) {
            // Toggle direction
            peopleSortDirection = peopleSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            // New column, default to desc for dates/counts, asc for name
            peopleSortColumn = sortKey;
            peopleSortDirection = sortKey === 'name' ? 'asc' : 'desc';
          }
          showPeopleListView(document.getElementById('peopleListSearch')?.value || '');
        });
      });
      
      // Add click handlers for people
      notesList.querySelectorAll('.entity-list-item').forEach(item => {
        item.addEventListener('click', () => {
          selectPerson(item.dataset.person);
        });
      });
    }
    
    function showCompaniesListView(filter = '') {
      // Show home view (notes list), hide editor
      if (notesHome) notesHome.style.display = 'flex';
      if (editorContent) editorContent.classList.add('hidden');
      backBtn?.classList.add('hidden');
      document.body.classList.remove('viewing-note');
      
      // Hide calendar section
      const calendarSection = document.querySelector('.calendar-section');
      if (calendarSection) calendarSection.style.display = 'none';
      
      const filtered = filter 
        ? allCompanies.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()))
        : allCompanies;
      
      // Show back button in main header
      backBtn?.classList.remove('hidden');
      
      // Sort based on current sort state
      const sortIndicator = (col) => {
        if (companiesSortColumn !== col) return '';
        return `<span class="sort-indicator">${companiesSortDirection === 'asc' ? '' : ''}</span>`;
      };
      const activeClass = (col) => companiesSortColumn === col ? 'active' : '';
      
      let html = `
        <div class="entity-list-search">
          <input type="text" class="entity-list-search-input" id="companiesListSearch" placeholder="Search companies..." value="${filter}">
        </div>
        <div class="entity-table-header">
          <span class="sortable-col ${activeClass('name')}" data-sort="name">Company ${sortIndicator('name')}</span>
          <span class="sortable-col ${activeClass('lastNote')}" data-sort="lastNote">Last note ${sortIndicator('lastNote')}</span>
          <span class="sortable-col ${activeClass('notes')}" data-sort="notes" style="text-align: right; justify-content: flex-end;">Notes ${sortIndicator('notes')}</span>
        </div>
        <div class="entity-list-items" id="companiesListItems">
      `;
      
      if (filtered.length === 0) {
        html += `<div class="entity-list-empty">
          ${filter ? 'No matches found.' : `
            <div style="text-align: center; padding: 40px 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;"></div>
              <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">No companies found yet</div>
              <div style="font-size: 14px; color: var(--text-muted); line-height: 1.5;">
                Companies are automatically extracted from attendee email domains when you record meetings.<br><br>
                <strong>To see companies here:</strong><br>
                1. Connect your Google Calendar<br>
                2. Record a meeting with external attendees<br>
                3. Companies will appear based on email domains<br>
                <em>(e.g., john@acme.com  Acme)</em>
              </div>
            </div>
          `}
        </div>`;
      } else {
        // Sort based on current sort column and direction
        filtered.sort((a, b) => {
          let comparison = 0;
          switch (companiesSortColumn) {
            case 'name':
              comparison = a.name.localeCompare(b.name);
              break;
            case 'lastNote':
              const aDate = a.lastNoteDate ? new Date(a.lastNoteDate) : new Date(0);
              const bDate = b.lastNoteDate ? new Date(b.lastNoteDate) : new Date(0);
              comparison = aDate - bDate;
              break;
            case 'notes':
              comparison = a.noteCount - b.noteCount;
              break;
          }
          return companiesSortDirection === 'asc' ? comparison : -comparison;
        });
        
        filtered.forEach(company => {
          const initial = company.name.charAt(0).toUpperCase();
          const lastDate = company.lastNoteDate 
            ? new Date(company.lastNoteDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
            : '-';
          
          html += `
            <div class="entity-list-item" data-company="${company.name}">
              <div class="entity-list-item-left">
                <div class="entity-avatar company">${initial}</div>
                <div class="entity-list-item-info">
                  <div class="entity-list-item-name">${company.name}</div>
                  <div class="entity-list-item-email">${company.domain || ''}</div>
                </div>
              </div>
              <div class="entity-list-item-date">${lastDate}</div>
              <div class="entity-list-item-count">${company.noteCount}</div>
            </div>
          `;
        });
      }
      
      html += '</div>';
      notesList.innerHTML = html;
      
      // Back button uses existing header backBtn - handled separately
      
      // Add search handler - filter in place without re-rendering
      document.getElementById('companiesListSearch')?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const items = document.querySelectorAll('#companiesListItems .entity-list-item');
        items.forEach(item => {
          const name = item.dataset.company?.toLowerCase() || '';
          item.style.display = name.includes(query) ? '' : 'none';
        });
      });
      
      // Add click handlers for sortable columns
      notesList.querySelectorAll('.entity-table-header .sortable-col').forEach(col => {
        col.addEventListener('click', () => {
          const sortKey = col.dataset.sort;
          if (companiesSortColumn === sortKey) {
            // Toggle direction
            companiesSortDirection = companiesSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            // New column, default to desc for dates/counts, asc for name
            companiesSortColumn = sortKey;
            companiesSortDirection = sortKey === 'name' ? 'asc' : 'desc';
          }
          showCompaniesListView(document.getElementById('companiesListSearch')?.value || '');
        });
      });
      
      // Add click handlers for companies
      notesList.querySelectorAll('.entity-list-item').forEach(item => {
        item.addEventListener('click', () => {
          selectCompany(item.dataset.company);
        });
      });
    }
    
    async function selectPerson(personName) {
      currentPersonFilter = personName;
      currentCompanyFilter = null;
      
      // Load notes for this person
      const notes = await ipcRenderer.invoke('get-notes-by-person', personName);
      filteredNotes = notes;
      
      // Show person's notes view
      showPersonNotesView(personName, notes);
    }
    
    async function selectCompany(companyName) {
      currentCompanyFilter = companyName;
      currentPersonFilter = null;
      
      // Load notes for this company
      const notes = await ipcRenderer.invoke('get-notes-by-company', companyName);
      filteredNotes = notes;
      
      // Show company's notes view
      showCompanyNotesView(companyName, notes);
    }
    
    function showPersonNotesView(personName, notes) {
      let html = `
        <div class="entity-detail-header">
          <button class="entity-back-btn" id="personBackBtn"> Back to People</button>
          <span class="entity-detail-icon"></span>
          <div class="entity-detail-info">
            <h2 class="entity-detail-name">${personName}</h2>
            <span class="entity-detail-count">${notes.length} note${notes.length !== 1 ? 's' : ''}</span>
          </div>
        </div>
        <div class="entity-notes-search">
          <input type="text" class="entity-notes-search-input" id="personNotesSearch" placeholder="Search notes...">
        </div>
        <div class="entity-notes-list">
      `;
      
      if (notes.length === 0) {
        html += `<div class="notes-empty">No notes found for ${personName}.</div>`;
      } else {
        notes.forEach(note => {
          const date = new Date(note.date);
          const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          html += `
            <div class="note-item" data-id="${note.id}">
              <div class="note-icon"></div>
              <div class="note-content">
                <div class="note-item-title">${note.title}</div>
                <div class="note-item-meta">${dateStr} at ${timeStr}</div>
              </div>
            </div>
          `;
        });
      }
      
      html += '</div>';
      notesList.innerHTML = html;
      
      // Back button
      document.getElementById('personBackBtn')?.addEventListener('click', () => {
        showPeopleListView();
      });
      
      // Note click handlers
      notesList.querySelectorAll('.note-item').forEach(item => {
        item.addEventListener('click', () => selectNote(item.dataset.id));
      });
      
      // Search handler
      document.getElementById('personNotesSearch')?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filtered = notes.filter(n => n.title.toLowerCase().includes(query));
        const container = notesList.querySelector('.entity-notes-list');
        if (container) {
          container.innerHTML = filtered.length === 0 
            ? '<div class="notes-empty">No matching notes.</div>'
            : filtered.map(note => {
                const date = new Date(note.date);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                return `
                  <div class="note-item" data-id="${note.id}">
                    <div class="note-icon"></div>
                    <div class="note-content">
                      <div class="note-item-title">${note.title}</div>
                      <div class="note-item-meta">${dateStr} at ${timeStr}</div>
                    </div>
                  </div>
                `;
              }).join('');
          container.querySelectorAll('.note-item').forEach(item => {
            item.addEventListener('click', () => selectNote(item.dataset.id));
          });
        }
      });
    }
    
    function showCompanyNotesView(companyName, notes) {
      let html = `
        <div class="entity-detail-header">
          <button class="entity-back-btn" id="companyBackBtn"> Back to Companies</button>
          <span class="entity-detail-icon"></span>
          <div class="entity-detail-info">
            <h2 class="entity-detail-name">${companyName}</h2>
            <span class="entity-detail-count">${notes.length} note${notes.length !== 1 ? 's' : ''}</span>
          </div>
        </div>
        <div class="entity-notes-search">
          <input type="text" class="entity-notes-search-input" id="companyNotesSearch" placeholder="Search notes...">
        </div>
        <div class="entity-notes-list">
      `;
      
      if (notes.length === 0) {
        html += `<div class="notes-empty">No notes found for ${companyName}.</div>`;
      } else {
        notes.forEach(note => {
          const date = new Date(note.date);
          const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          html += `
            <div class="note-item" data-id="${note.id}">
              <div class="note-icon"></div>
              <div class="note-content">
                <div class="note-item-title">${note.title}</div>
                <div class="note-item-meta">${dateStr} at ${timeStr}</div>
              </div>
            </div>
          `;
        });
      }
      
      html += '</div>';
      notesList.innerHTML = html;
      
      // Back button
      document.getElementById('companyBackBtn')?.addEventListener('click', () => {
        showCompaniesListView();
      });
      
      // Note click handlers
      notesList.querySelectorAll('.note-item').forEach(item => {
        item.addEventListener('click', () => selectNote(item.dataset.id));
      });
      
      // Search handler
      document.getElementById('companyNotesSearch')?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filtered = notes.filter(n => n.title.toLowerCase().includes(query));
        const container = notesList.querySelector('.entity-notes-list');
        if (container) {
          container.innerHTML = filtered.length === 0 
            ? '<div class="notes-empty">No matching notes.</div>'
            : filtered.map(note => {
                const date = new Date(note.date);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                return `
                  <div class="note-item" data-id="${note.id}">
                    <div class="note-icon"></div>
                    <div class="note-content">
                      <div class="note-item-title">${note.title}</div>
                      <div class="note-item-meta">${dateStr} at ${timeStr}</div>
                    </div>
                  </div>
                `;
              }).join('');
          container.querySelectorAll('.note-item').forEach(item => {
            item.addEventListener('click', () => selectNote(item.dataset.id));
          });
        }
      });
    }
    
    // Listen for people/companies updates
    ipcRenderer.on('people-companies-updated', loadPeopleAndCompanies);
    
    // Add note to folder function (called from note context menu)
    async function addNoteToFolder(noteId, folderId) {
      await ipcRenderer.invoke('folders-add-note', folderId, noteId);
      await loadFolders();
      await loadNotes();
      
      // Update the "Add to folder" button if this is the current note
      if (noteId === currentNoteId) {
        currentNoteFolderId = folderId; // Track so it's preserved on save
        updateAddToFolderButton(folderId);
      }
    }
    
    // Update the "Add to folder" button to show folder name or default text
    function updateAddToFolderButton(folderId) {
      const btn = document.getElementById('addToFolderBtn');
      if (!btn) return;
      
      if (folderId) {
        const folder = folders.find(f => f.id === folderId);
        if (folder) {
          btn.innerHTML = `${folder.icon} ${folder.name}`;
          btn.classList.add('has-folder');
        }
      } else {
        btn.innerHTML = '+ Add to folder';
        btn.classList.remove('has-folder');
      }
    }
    
    async function removeNoteFromFolder(noteId, folderId) {
      await ipcRenderer.invoke('folders-remove-note', folderId, noteId);
      await loadFolders();
      await loadNotes();
      
      // Clear folder tracking if this is the current note
      if (noteId === currentNoteId) {
        currentNoteFolderId = null;
        updateAddToFolderButton(null);
      }
    }
    
    // Show AI reason modal
    function showAIReasonModal(reason) {
      // Remove any existing modal
      document.querySelectorAll('.ai-reason-modal-overlay').forEach(m => m.remove());
      
      const overlay = document.createElement('div');
      overlay.className = 'ai-reason-modal-overlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10010;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      const modal = document.createElement('div');
      modal.className = 'ai-reason-modal';
      modal.style.cssText = `
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      `;
      
      modal.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="font-size: 20px;"></span>
          <span style="font-weight: 600; font-size: 15px; color: var(--text);">Why this folder?</span>
        </div>
        <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.6; margin: 0 0 16px 0;">
          ${reason}
        </p>
        <button class="ai-reason-close-btn" style="
          width: 100%;
          padding: 10px;
          background: var(--bg-secondary);
          border: 1px solid var(--border);
          border-radius: 8px;
          color: var(--text);
          font-size: 14px;
          cursor: pointer;
        ">Got it</button>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Prevent clicks from propagating to document (which would close folder picker)
      overlay.addEventListener('click', (e) => {
        e.stopPropagation();
        if (e.target === overlay) {
          overlay.remove();
        }
      });
      
      modal.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      
      // Close on button click
      modal.querySelector('.ai-reason-close-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        overlay.remove();
      });
    }
    
    // Show folder picker popup for adding note to folder
    async function showFolderPicker(noteId, menuItem) {
      // Remove any existing picker
      document.querySelectorAll('.folder-picker-popup').forEach(p => p.remove());
      
      // Get position BEFORE hiding the menu - try multiple reference points
      const noteItem = menuItem.closest('.note-item');
      const menuBtn = noteItem?.querySelector('.note-menu-btn');
      
      // Get rect from the most reliable source (menu button is always visible)
      let anchorRect;
      if (menuBtn) {
        anchorRect = menuBtn.getBoundingClientRect();
      } else if (noteItem) {
        anchorRect = noteItem.getBoundingClientRect();
      } else {
        // Fallback for editor header button
        anchorRect = menuItem.getBoundingClientRect();
      }
      
      // Hide the parent note menu to avoid overlap
      const parentMenu = menuItem.closest('.note-menu');
      if (parentMenu) {
        parentMenu.classList.remove('show');
      }
      
      // Use the captured anchor position
      const rect = anchorRect;
      const hasNoFolders = folders.length === 0;
      
      const picker = document.createElement('div');
      picker.className = 'folder-picker-popup';
      
      // If no folders, center the popup on screen
      if (hasNoFolders) {
        picker.style.cssText = `
          position: fixed;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          background: var(--bg);
          border: 1px solid var(--border);
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.25);
          z-index: 10002;
          min-width: 280px;
          padding: 8px;
        `;
      } else {
        const pickerWidth = 240;
        const pickerHeight = 350;
        
        // Smart positioning - same strategy as note menu
        // Start by positioning below and to the left of anchor (right-aligned with anchor)
        let leftPos = rect.right - pickerWidth;
        let topPos = rect.bottom + 8;
        
        // Check right edge - if would overflow, align to screen right
        if (rect.right > window.innerWidth - 20) {
          leftPos = window.innerWidth - pickerWidth - 20;
        }
        
        // Ensure left doesn't go negative
        if (leftPos < 20) {
          leftPos = 20;
        }
        
        // Check bottom edge - if would overflow, open upward instead
        if (topPos + pickerHeight > window.innerHeight - 20) {
          topPos = rect.top - pickerHeight - 8;
        }
        
        // If opening upward still doesn't fit, just cap at top
        if (topPos < 20) {
          topPos = 20;
        }
        
        picker.style.cssText = `
          position: fixed;
          left: ${leftPos}px;
          top: ${topPos}px;
          background: var(--bg);
          border: 1px solid var(--border);
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.2);
          z-index: 10002;
          width: ${pickerWidth}px;
          max-height: ${pickerHeight}px;
          overflow-y: auto;
          overflow-x: hidden;
          scrollbar-width: thin;
          scrollbar-color: var(--border) transparent;
        `;
        
        // Add webkit scrollbar styles
        const styleId = 'folder-picker-scrollbar-style';
        if (!document.getElementById(styleId)) {
          const style = document.createElement('style');
          style.id = styleId;
          style.textContent = `
            .folder-picker-popup::-webkit-scrollbar {
              width: 6px;
            }
            .folder-picker-popup::-webkit-scrollbar-track {
              background: transparent;
            }
            .folder-picker-popup::-webkit-scrollbar-thumb {
              background: var(--border);
              border-radius: 3px;
            }
            .folder-picker-popup::-webkit-scrollbar-thumb:hover {
              background: var(--text-muted);
            }
          `;
          document.head.appendChild(style);
        }
      }
      
      // Get note data to check current folder
      let currentFolderIdForNote = null;
      let noteData = null;
      try {
        noteData = await ipcRenderer.invoke('get-note', noteId);
        currentFolderIdForNote = noteData?.folderId || null;
      } catch (e) {
        console.log('[Picker] Could not load note');
      }
      
      // Build folder list with loading placeholder for AI suggestion
      let html = '';
      
      // Add header: "Move to..." if already in folder, "Add to..." if not
      if (folders.length > 0) {
        const headerText = currentFolderIdForNote ? 'Move to...' : 'Add to...';
        html += `
          <div style="padding: 10px 14px 6px; font-size: 12px; font-weight: 600; color: var(--text-muted);">
            ${headerText}
          </div>
        `;
        
        // Add search input if more than 3 folders
        if (folders.length > 3) {
          html += `
            <div style="padding: 4px 10px 8px;">
              <input type="text" id="folder-search-input" placeholder="Search folders..." style="
                width: 100%;
                padding: 8px 10px;
                border: 1px solid var(--border);
                border-radius: 6px;
                background: var(--bg-secondary);
                color: var(--text);
                font-size: 13px;
                outline: none;
                box-sizing: border-box;
              ">
            </div>
          `;
        }
        
        html += `<div style="height: 1px; background: var(--border); margin: 0 10px 8px;"></div>`;
        
        // Add AI suggestion loading placeholder
        html += `
          <div id="ai-suggestion-container" style="display: none;">
            <div style="padding: 6px 14px 4px; font-size: 10px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px;">
               AI Suggested
            </div>
            <div id="ai-suggestion-content" style="
              padding: 10px 14px;
              font-size: 13px;
              display: flex;
              align-items: center;
              gap: 8px;
              background: var(--bg-hover);
              margin: 0 4px 4px 4px;
              border-radius: 6px;
            ">
              <span class="ai-loading-spinner" style="
                width: 16px;
                height: 16px;
                border: 2px solid var(--border);
                border-top-color: var(--accent);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
              "></span>
              <span style="color: var(--text-muted);">Finding best folder...</span>
            </div>
            <div style="height: 1px; background: var(--border); margin: 8px 10px;"></div>
          </div>
        `;
      }
      
      // Show all folders
      const otherFolders = folders;
      
      otherFolders.forEach(folder => {
        html += `
          <div class="folder-picker-item" data-folder-id="${folder.id}" style="
            padding: 10px 14px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
          ">
            <span>${folder.icon}</span>
            <span>${folder.name}</span>
          </div>
        `;
      });
      
      if (folders.length === 0) {
        html = `
          <div style="padding: 24px 20px; text-align: center;">
            <div style="font-size: 32px; margin-bottom: 12px;"></div>
            <div style="color: var(--text); font-size: 15px; font-weight: 500; margin-bottom: 6px;">
              No folders yet
            </div>
            <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
              Create a folder to organize your notes
            </div>
            <button class="create-folder-cta" style="
              background: var(--accent);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              font-size: 14px;
              font-weight: 500;
              cursor: pointer;
              display: inline-flex;
              align-items: center;
              gap: 6px;
              transition: opacity 0.15s;
            ">
              <span style="font-size: 16px;">+</span> Create Folder
            </button>
          </div>
        `;
      }
      
      picker.innerHTML = html;
      document.body.appendChild(picker);
      
      // Handle create folder CTA click
      const createFolderCta = picker.querySelector('.create-folder-cta');
      if (createFolderCta) {
        createFolderCta.addEventListener('click', () => {
          picker.remove();
          // Close the note menu
          notesList.querySelectorAll('.note-menu').forEach(m => m.classList.remove('show'));
          // Open folder creation modal
          addFolderBtn?.click();
        });
      }
      
      // Handle folder selection
      picker.querySelectorAll('.folder-picker-item').forEach(item => {
        item.addEventListener('click', async (e) => {
          // Don't select folder if clicking the "Why?" button
          if (e.target.closest('.ai-reason-btn')) return;
          await addNoteToFolder(noteId, item.dataset.folderId);
          picker.remove();
          // Close the note menu
          notesList.querySelectorAll('.note-menu').forEach(m => m.classList.remove('show'));
        });
        
        item.addEventListener('mouseenter', () => {
          item.style.background = 'var(--bg-hover)';
        });
        item.addEventListener('mouseleave', () => {
          item.style.background = '';
        });
      });
      
      // Handle folder search
      const folderSearchInput = picker.querySelector('#folder-search-input');
      if (folderSearchInput) {
        folderSearchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase().trim();
          picker.querySelectorAll('.folder-picker-item:not(.ai-suggested)').forEach(item => {
            const folderName = item.textContent.toLowerCase();
            item.style.display = folderName.includes(query) ? '' : 'none';
          });
        });
        // Focus the search input
        setTimeout(() => folderSearchInput.focus(), 100);
      }
      
      // Fetch AI suggestion asynchronously if we have folders and content
      if (folders.length > 0 && noteData) {
        const suggestionContainer = picker.querySelector('#ai-suggestion-container');
        const suggestionContent = picker.querySelector('#ai-suggestion-content');
        
        // Get note content for AI analysis - include notes, transcript, and title for comprehensive hash
        const notesText = noteData.notes || '';
        const transcriptText = (noteData.transcript || []).map(t => 
          typeof t === 'string' ? t : t.text
        ).join(' ') || '';
        const meetingTitle = noteData.title || 'Untitled Note';
        // Hash all content that could affect folder suggestion
        const contentHash = hashContent(notesText + transcriptText + meetingTitle);
        const noteContent = notesText + '\n' + transcriptText;
        
        // Check cache first
        const cached = folderSuggestionCache.get(noteId);
        let suggestion = null;
        
        // Show suggestion container
        if (suggestionContainer) {
          suggestionContainer.style.display = 'block';
        }
        
        // Check if not enough content
        if (noteContent.trim().length <= 20) {
          // Not enough content to analyze
          if (suggestionContent) {
            suggestionContent.innerHTML = `
              <span style="color: var(--text-muted); font-size: 12px;">Not enough content to suggest a folder</span>
            `;
            suggestionContent.style.cursor = 'default';
            suggestionContent.style.background = 'transparent';
          }
        } else if (cached && cached.contentHash === contentHash) {
          // Use cached suggestion (could be null if no match found before)
          console.log('[FolderPicker] Using cached suggestion for note:', noteId);
          suggestion = cached.suggestion;
        } else {
          // Fetch new suggestion
          try {
            suggestion = await ipcRenderer.invoke('openai-suggest-folder', {
              noteContent: noteContent.substring(0, 3000),
              meetingTitle
            });
            
            // Cache the result (including null for no match)
            folderSuggestionCache.set(noteId, {
              contentHash,
              suggestion
            });
            console.log('[FolderPicker] Cached new suggestion for note:', noteId);
          } catch (err) {
            console.log('[FolderPicker] AI suggestion failed:', err);
            suggestion = null;
          }
        }
        
        // Display suggestion if we have one
        if (suggestion && suggestion.folderId && picker.parentNode) {
          const suggestedFolder = folders.find(f => f.id === suggestion.folderId);
          if (suggestedFolder && suggestionContent) {
            const reasonText = suggestion.reason || 'AI determined this folder matches the meeting content.';
            
            // Update suggestion UI
            suggestionContent.className = 'folder-picker-item ai-suggested';
            suggestionContent.dataset.folderId = suggestedFolder.id;
            suggestionContent.style.cursor = 'pointer';
            suggestionContent.innerHTML = `
              <span>${suggestedFolder.icon}</span>
              <span style="font-weight: 500; flex: 1;">${suggestedFolder.name}</span>
              <button class="ai-reason-btn" data-reason="${reasonText.replace(/"/g, '&quot;')}" style="
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 4px;
                padding: 2px 8px;
                font-size: 11px;
                color: var(--text-muted);
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 4px;
              ">
                <span style="font-size: 10px;"></span> Why?
              </button>
            `;
            
            // Add click handler for the suggested folder
            suggestionContent.addEventListener('click', async (e) => {
              if (e.target.closest('.ai-reason-btn')) return;
              await addNoteToFolder(noteId, suggestedFolder.id);
              picker.remove();
              notesList.querySelectorAll('.note-menu').forEach(m => m.classList.remove('show'));
            });
            
            // Add hover effect
            suggestionContent.addEventListener('mouseenter', () => {
              suggestionContent.style.background = 'var(--bg-hover)';
            });
            suggestionContent.addEventListener('mouseleave', () => {
              suggestionContent.style.background = 'var(--bg-hover)';
            });
            
            // Handle "Why?" button
            const whyBtn = suggestionContent.querySelector('.ai-reason-btn');
            if (whyBtn) {
              whyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showAIReasonModal(reasonText);
              });
            }
            
            // Hide this folder from the regular list
            const regularItem = picker.querySelector(`.folder-picker-item[data-folder-id="${suggestedFolder.id}"]:not(.ai-suggested)`);
            if (regularItem) {
              regularItem.style.display = 'none';
            }
            
            // Save suggestion to note
            await ipcRenderer.invoke('update-note-suggestion', noteId, suggestion.folderId, suggestion.confidence, suggestion.reason);
          } else if (suggestionContainer && suggestionContent && picker.parentNode) {
            // Folder not found in current list
            suggestionContent.innerHTML = `
              <span style="color: var(--text-muted); font-size: 12px;">No strong folder match found</span>
            `;
            suggestionContent.style.cursor = 'default';
            suggestionContent.style.background = 'transparent';
          }
        } else if (suggestionContainer && suggestionContent && picker.parentNode) {
          // No suggestion returned from AI
          suggestionContent.innerHTML = `
            <span style="color: var(--text-muted); font-size: 12px;">No strong folder match found</span>
          `;
          suggestionContent.style.cursor = 'default';
          suggestionContent.style.background = 'transparent';
        }
      }
      
      // Close on click outside
      const closePicker = (e) => {
        if (!picker.contains(e.target)) {
          picker.remove();
          document.removeEventListener('click', closePicker);
        }
      };
      setTimeout(() => document.addEventListener('click', closePicker), 0);
    }
    
    // ============================================================================
    // NOTES LIST
    // ============================================================================
    
    // Load notes list
    async function loadNotes() {
      notes = await ipcRenderer.invoke('get-notes');
      renderNotesList();
    }
    
    function renderNotesList() {
      // Reduced logging to avoid console spam during recording
      if (!notesList) {
        console.error('[Editor] notesList element not found!');
        return;
      }
      
      const isSpecificFolder = currentFolderId && currentFolderId !== 'all' && currentFolderId !== 'shared';
      const currentFolder = isSpecificFolder ? folders.find(f => f.id === currentFolderId) : null;
      
      if (notes.length === 0) {
        if (isSpecificFolder && currentFolder) {
          notesList.innerHTML = `
            <div class="folder-empty-state">
              <div class="folder-empty-icon">${currentFolder.icon}</div>
              <div class="folder-empty-title">No notes in ${currentFolder.name}</div>
              <div class="folder-empty-desc">Start a new meeting or add existing notes to this folder</div>
              <button class="folder-empty-cta" id="newNoteFolderBtn">
                <span>+</span> New Note
              </button>
            </div>
          `;
          document.getElementById('newNoteFolderBtn')?.addEventListener('click', () => {
            newNoteBtn?.click();
          });
        } else {
          notesList.innerHTML = `<div class="notes-empty">No notes yet.<br>Start recording a meeting!</div>`;
        }
        return;
      }
      
      // Helper to get date label
      function getDateLabel(date) {
        const now = new Date();
        const noteDate = new Date(date);
        
        // Reset times for comparison
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const noteDay = new Date(noteDate.getFullYear(), noteDate.getMonth(), noteDate.getDate());
        
        if (noteDay.getTime() === today.getTime()) {
          return 'Today';
        } else if (noteDay.getTime() === yesterday.getTime()) {
          return 'Yesterday';
        } else {
          return noteDate.toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
          });
        }
      }
      
      // Only show PAST notes in the notes list
      // Notes for upcoming events are accessible via the calendar event card
      // Once the event date passes, the note moves here
      const now = new Date();
      let past = notes.filter(note => {
        const noteDate = new Date(note.date);
        return noteDate <= now;
      });
      
      // Filter by folder if viewing a specific folder
      if (isSpecificFolder) {
        past = past.filter(note => note.folderId === currentFolderId);
      }
      
      // Sort past by date descending (most recent first)
      past.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // If folder is selected but has no notes, show empty state
      if (isSpecificFolder && past.length === 0 && currentFolder) {
        notesList.innerHTML = `
          <div class="folder-empty-state">
            <div class="folder-empty-icon">${currentFolder.icon}</div>
            <div class="folder-empty-title">No notes in ${currentFolder.name}</div>
            <div class="folder-empty-desc">Start a new meeting or add existing notes to this folder</div>
            <button class="folder-empty-cta" id="newNoteFolderBtn">
              <span>+</span> New Note
            </button>
          </div>
        `;
        document.getElementById('newNoteFolderBtn')?.addEventListener('click', () => {
          newNoteBtn?.click();
        });
        return;
      }
      
      let html = '';
      
      // Group past notes by date
      const grouped = {};
      past.forEach(note => {
        const label = getDateLabel(note.date);
        if (!grouped[label]) grouped[label] = [];
        grouped[label].push(note);
      });
      
      // Render grouped past notes (with visual separation from calendar section)
      const groupEntries = Object.entries(grouped);
      if (groupEntries.length > 0) {
        // Add section wrapper for past notes if there are any
        html += `<div class="past-notes-wrapper">`;
      }
      
      groupEntries.forEach(([dateLabel, dateNotes], index) => {
        // Add date header for each group
        html += `<div class="date-header">${dateLabel}</div>`;
        
        dateNotes.forEach(note => {
          const date = new Date(note.date);
          const timeStr = date.toLocaleTimeString('en-US', { 
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });
          const isActive = note.id === currentNoteId;
          const icon = note.provider === 'meet' ? '' : note.provider === 'zoom' ? '' : '';
          
          html += `
            <div class="note-item ${isActive ? 'active' : ''}" data-id="${note.id}">
              <div class="note-icon">${icon}</div>
              <div class="note-content">
                <div class="note-item-title">${note.title}</div>
                <div class="note-item-meta">
                  <span>${note.provider || 'Me'}</span>
                </div>
              </div>
              <div class="note-time">${timeStr}</div>
              <button class="note-menu-btn" data-id="${note.id}" title="More options"></button>
              <div class="note-menu" data-id="${note.id}">
                <div class="note-menu-item" data-action="add-to-folder" data-id="${note.id}"> Add to folder</div>
                <div class="note-menu-item danger" data-action="delete" data-id="${note.id}"> Delete</div>
              </div>
            </div>
          `;
        });
      });
      
      // Close past notes wrapper if we opened it
      if (groupEntries.length > 0) {
        html += `</div>`;
      }
      
      notesList.innerHTML = html;
      
      // Add click handlers for note items
      notesList.querySelectorAll('.note-item').forEach(item => {
        item.addEventListener('click', (e) => {
          // Don't select if clicking menu button or menu
          if (e.target.closest('.note-menu-btn') || e.target.closest('.note-menu')) return;
          selectNote(item.dataset.id);
        });
      });
      
      // Add menu button handlers
      notesList.querySelectorAll('.note-menu-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const menu = notesList.querySelector(`.note-menu[data-id="${id}"]`);
          
          // Close all other menus
          notesList.querySelectorAll('.note-menu').forEach(m => {
            if (m !== menu) m.classList.remove('show');
          });
          
          if (menu) {
            // Position menu dynamically to avoid cutoff
            const btnRect = btn.getBoundingClientRect();
            const menuWidth = 150; // Approximate menu width
            const menuHeight = 80; // Approximate menu height
            
            // Reset any previous positioning
            menu.style.left = '';
            menu.style.right = '';
            menu.style.top = '';
            menu.style.bottom = '';
            
            // Check if menu would go off right edge
            if (btnRect.right + menuWidth > window.innerWidth) {
              // Align to right edge of button
              menu.style.right = '0';
              menu.style.left = 'auto';
            } else {
              menu.style.right = '8px';
            }
            
            // Check if menu would go off bottom edge
            if (btnRect.bottom + menuHeight > window.innerHeight) {
              // Open upward
              menu.style.bottom = '100%';
              menu.style.top = 'auto';
            } else {
              menu.style.top = '100%';
            }
            
            menu.classList.toggle('show');
          }
        });
      });
      
      // Add menu item handlers
      notesList.querySelectorAll('.note-menu-item').forEach(item => {
        item.addEventListener('click', async (e) => {
          e.stopPropagation();
          const action = item.dataset.action;
          const id = item.dataset.id;
          
          if (action === 'add-to-folder') {
            // Show folder picker
            showFolderPicker(id, item);
          } else if (action === 'delete') {
            const noteItem = item.closest('.note-item');
            const title = noteItem?.querySelector('.note-item-title')?.textContent || 'this note';
            
            // Show confirmation modal
            showDeleteNoteModal(id, title);
          }
          
          // Close menu
          item.closest('.note-menu')?.classList.remove('show');
        });
      });
      
      // Close menus when clicking outside
      document.addEventListener('click', () => {
        notesList.querySelectorAll('.note-menu').forEach(m => m.classList.remove('show'));
      });
    }
    
    async function selectNote(id) {
      currentNoteId = id;
      
      const note = await ipcRenderer.invoke('get-note', id);
      if (!note) return;
      
      // Track folder so it's preserved on save
      currentNoteFolderId = note.folderId || null;
      updateAddToFolderButton(currentNoteFolderId);
      
      // Track template so it's preserved on save and shown in dropdown
      currentTemplateId = note.templateId || null;
      console.log('[SelectNote] Loaded template:', currentTemplateId);
      
      meetingTitle.textContent = note.title;
      transcript = note.transcript || [];
      
      // Load both raw notes and enhanced notes
      storedRawNotes = note.notes || '';
      storedEnhancedNotes = note.enhancedNotes || '';
      rawNotesAtStart = storedRawNotes; // For toggle functionality
      
      // DON'T update meeting meta - it changes the note's date!
      // Just display the note as-is
      
      // Update recording/mic state for viewing old notes
      isRecording = false;
      isMicActive = false;
      updateMicUI();
      renderTranscript();
      renderNotesList();
      
      // Check if this note has AI-generated content
      const hasAINotes = !!note.enhancedNotes;
      
      // Reset generation state but KEEP template from note
      isGeneratingAINotes = false;
      // currentTemplateId was already set above from note.templateId
      
      if (hasAINotes) {
        // Note has AI notes - show toggle, hide generate button
        currentAINotes = { enhancedNotes: note.enhancedNotes };
        hideGenerateNotesButton();
        showNotesViewToggle();
        // Default to AI view when loading a note with AI notes
        currentViewIsAI = true;
        rawNotesBtn?.classList.remove('active');
        aiNotesBtn?.classList.add('active');
        isTogglingView = true;
        setEditorContent(storedEnhancedNotes);
        setTimeout(() => { isTogglingView = false; }, 100);
        // Update template display for the loaded note's template
        updateCurrentTemplateDisplay();
      } else if (transcript.length > 0 && hasOpenAIKey) {
        // Note has transcript but no AI notes - show generate button
        currentAINotes = null;
        currentViewIsAI = false;
        isTogglingView = true;
        setEditorContent(storedRawNotes);
        setTimeout(() => { isTogglingView = false; }, 100);
        showGenerateNotesButton();
        hideNotesViewToggle();
      } else {
        // No transcript or no API key - hide both, show raw notes
        currentAINotes = null;
        currentViewIsAI = false;
        isTogglingView = true;
        setEditorContent(storedRawNotes);
        setTimeout(() => { isTogglingView = false; }, 100);
        hideGenerateNotesButton();
        hideNotesViewToggle();
      }
      
      // Update the "Add to folder" button to show current folder
      updateAddToFolderButton(note.folderId);
      
      showEditor();
    }
    
    // Set meeting info for new recording
    ipcRenderer.on('set-meeting', (_, meeting) => {
      console.log('[Editor] ====== SET-MEETING RECEIVED ======', meeting);
      
      // IMPORTANT: Show editor FIRST to prevent race conditions
      showEditor();
      
      meetingTitle.textContent = meeting.title || 'Meeting Notes';
      currentNoteId = null;
      transcript = [];
      setEditorContent('');
      isRecording = true;
      recordingStartTime = Date.now();
      isMicActive = true;
      currentAINotes = null;
      currentTemplateId = null;
      isGeneratingAINotes = false;
      hideNotesViewToggle();
      currentMeetingInfo = meeting;
      
      // Reset folder button for new note
      updateAddToFolderButton(null);
      
      // Don't show AI panel during meeting
      // Notes will be generated after meeting ends
      onRecordingStart();
      
      // Update mic UI
      updateMicUI();
      micLabel.textContent = 'Stop';
      renderTranscript();
      
      // Update meeting meta (Today badge, participants, etc.)
      updateMeetingMeta({
        date: Date.now(),
        provider: meeting.provider,
        participants: meeting.participants,
        meetingLink: meeting.meetingLink,
        calendarLink: meeting.calendarLink,
        startTime: meeting.startTime,
        endTime: meeting.endTime
      });
      
      // Ensure editor is shown (call again in case any above code triggered empty state)
      showEditor();
      loadNotes();
      
      // Just check if we have OpenAI key for later
      checkOpenAIKey().then(() => {
        // AI notes will be generated when meeting ends
      });
    });
    
    // Transcription is now handled by main process (multichannel audio)
    // Main process streams system audio + mic to Deepgram and sends segments here
    
    // Start transcription from main process
    ipcRenderer.on('start-transcription', () => {
      console.log('[Editor] Transcription started (multichannel via main process)');
      // Main process handles Deepgram connection with multichannel audio
      // We just receive transcript-segment events
    });
    
    // Enter recording mode when triggered from main process (e.g., from meeting bar)
    ipcRenderer.on('enter-recording-mode-from-main', () => {
      console.log('[Editor] Entering recording mode (from main process)');
      console.log('[Editor] currentMeetingInfo:', currentMeetingInfo);
      console.log('[Editor] meetingTitle text:', meetingTitle?.textContent);
      
      // CRITICAL: Show editor view (not empty state)
      showEditor();
      
      // Set a placeholder title if meeting title is empty
      if (meetingTitle && !meetingTitle.textContent?.trim()) {
        if (currentMeetingInfo?.title) {
          meetingTitle.textContent = currentMeetingInfo.title;
        } else {
          meetingTitle.textContent = 'Recording...';
        }
      }
      
      document.body.classList.add('recording-mode');
      isRecording = true;
      recordingStartTime = Date.now();
      isMicActive = true;
      
      // Reset transcript for new recording
      transcript = [];
      renderTranscript();
      
      // Update mic UI
      updateMicUI();
      if (micLabel) micLabel.textContent = 'Stop';
      
      // Collapse transcript section by default
      if (transcriptSection && !transcriptSection.classList.contains('collapsed')) {
        transcriptSection.classList.add('collapsed');
      }
      
      // Collapse sidebar for more space
      if (sidebar && !sidebar.classList.contains('collapsed')) {
        sidebar.classList.add('collapsed');
      }
      
      if (nextMeeting) nextMeeting.style.display = 'none';
      
      // Start silence detection
      startSilenceDetection();
      
      console.log('[Editor] Recording mode setup complete');
    });
    
    // Receive transcript segments from main process (multichannel format)
    // Track current interim segment (only ONE at a time - the latest)
    let currentInterim = null;
    
    // segment: { text, speaker, channel, timestamp, isYou, isFinal, speechFinal }
    ipcRenderer.on('transcript-segment', (_, segment) => {
      const finalLabel = segment.isFinal ? '' : '...';
      const speakerLabel = segment.isYou ? 'YOU' : 'THEM';
      const channelLabel = `CH${segment.channel}`;
      console.log(`[Transcript] ${speakerLabel} ${channelLabel} [${finalLabel}]: ${segment.text.substring(0, 50)}`);
      
      if (!segment.isFinal) {
        // Interim result - replace the single interim display
        currentInterim = {
          text: segment.text,
          timestamp: segment.timestamp,
          channel: segment.channel,
          speaker: segment.speaker,
          isYou: segment.isYou
        };
      } else {
        // Final result - smart deduplication
        // Check if this final overlaps with the last segment (common with Deepgram)
        const lastSegment = transcript.length > 0 ? transcript[transcript.length - 1] : null;
        
        let shouldAdd = true;
        if (lastSegment && typeof lastSegment === 'object') {
          // If new text starts with the last segment's text, it's an extension - replace
          if (segment.text.startsWith(lastSegment.text.substring(0, Math.min(30, lastSegment.text.length)))) {
            // Replace the last segment with the extended version
            lastSegment.text = segment.text;
            lastSegment.timestamp = segment.timestamp;
            shouldAdd = false;
          }
          // If last text contains most of this text, skip (duplicate)
          else if (lastSegment.text.includes(segment.text.substring(0, Math.min(20, segment.text.length)))) {
            shouldAdd = false;
          }
        }
        
        if (shouldAdd) {
          transcript.push({
            text: segment.text,
            speaker: segment.speaker,
            channel: segment.channel,
            timestamp: segment.timestamp,
            isYou: segment.isYou,
            isFinal: true,
            speechFinal: segment.speechFinal || false  // Deepgram's utterance end signal
          });
        }
        
        // Clear interim
        currentInterim = null;
        
        // Trigger auto-save for final transcript changes
        hasUnsavedChanges = true;
        scheduleAutoSave();
      }
      
      lastTranscriptTime = Date.now();
      renderTranscript();
      
      // Update ask input visibility when transcript content arrives
      if (segment.isFinal && transcript.length > 0) {
        updateAskInputVisibility();
      }
    });
    
    // Receive transcript text (legacy - from widget)
    ipcRenderer.on('transcript-text', (_, text) => {
      transcript.push(text);
      lastTranscriptTime = Date.now(); // Reset silence timer
      renderTranscript();
      
      // Trigger auto-save for transcript changes
      hasUnsavedChanges = true;
      scheduleAutoSave();
    });
    
    // Recording stopped (from main process) - AUTO-GENERATE AI NOTES
    ipcRenderer.on('recording-stopped', async (_, data) => {
      isRecording = false;
      isMicActive = false;
      updateMicUI();
      micLabel.textContent = 'Start';
      
      // Update ask input visibility now that recording has stopped
      updateAskInputVisibility();
      
      // Auto-generate AI notes if we have enough transcript
      const transcriptText = transcript.map(t => typeof t === 'object' ? t.text : t).join(' ');
      const hasEnoughContent = transcriptText.length > 100;
      
      if (transcript.length > 0 && hasEnoughContent && !currentAINotes) {
        console.log('[App] Meeting ended - auto-generating AI notes...');
        // Small delay to let final transcript segments arrive
        setTimeout(() => {
          if (!currentAINotes) {
            generateEnhancedNotes();
          }
        }, 2000);
      } else if (transcript.length > 0 && !currentAINotes) {
        // Not enough content - show manual button
        showGenerateNotesButton();
      }
    });
    
    // Note saved - refresh list (but not during active recording to avoid excessive re-renders)
    let lastNotesRefresh = 0;
    const NOTES_REFRESH_DEBOUNCE = 5000; // Only refresh notes list every 5 seconds max
    
    ipcRenderer.on('note-saved', async (_, savedNote) => {
      if (savedNote && savedNote.id) {
        currentNoteId = savedNote.id;
      }
      hasUnsavedChanges = false;
      saveStatus.textContent = 'Saved';
      setTimeout(() => {
        if (!hasUnsavedChanges) saveStatus.textContent = '';
      }, 2000);
      
      // Skip refreshing notes list during active recording (causes excessive re-renders)
      // Only refresh if enough time has passed since last refresh
      const now = Date.now();
      if (!isRecording || (now - lastNotesRefresh > NOTES_REFRESH_DEBOUNCE)) {
        lastNotesRefresh = now;
        await loadNotes();
        await loadPeopleAndCompanies();
      }
    });
    
    // Notes updated - refresh list
    ipcRenderer.on('notes-updated', loadNotes);
    
    // Show settings from tray menu
    ipcRenderer.on('show-settings', () => {
      showSettings();
    });
    
    // Show home view (triggered from main when "Open Notes" is clicked)
    ipcRenderer.on('show-home-view', () => {
      console.log('[Editor] show-home-view received - showing home');
      showEmptyState();
    });
    
    // Show editor view (triggered from main when "Open Current Note" is clicked)
    ipcRenderer.on('show-editor-view', () => {
      console.log('[Editor] show-editor-view received - showing editor');
      showEditor();
    });
    
    // ============================================
    // CALENDAR
    // ============================================
    async function checkCalendarConnection() {
      console.log('[Editor] ====== checkCalendarConnection STARTING ======');
      try {
        console.log('[Editor] Calling calendar-is-connected IPC...');
        calendarConnected = await ipcRenderer.invoke('calendar-is-connected');
        console.log('[Editor] calendar-is-connected returned:', calendarConnected);
        updateCalendarUI();
        console.log('[Editor] updateCalendarUI completed');
      } catch (err) {
        console.error('[Editor] checkCalendarConnection ERROR:', err);
        calendarConnected = false;
        updateCalendarUI();
      }
    }
    
    function updateCalendarUI() {
      console.log('[Editor] updateCalendarUI called, connected:', calendarConnected);
      const calendarSection = document.querySelector('.calendar-section');
      
      if (calendarConnected) {
        // Hide the connect button when connected
        if (connectCalendarBtn) connectCalendarBtn.style.display = 'none';
        loadCalendarEvents();
      } else {
        // Show connect button, hide calendar section
        if (connectCalendarBtn) {
          connectCalendarBtn.style.display = 'block';
          connectCalendarBtn.textContent = ' Connect Google Calendar to see upcoming meetings';
          connectCalendarBtn.disabled = false;
        }
        if (calendarSection) calendarSection.style.display = 'none';
      }
    }
    
    async function connectCalendar() {
      console.log('[Editor] connectCalendar() called');
      
      // Check if Client ID is configured
      console.log('[Editor] Checking calendar-has-client-id...');
      const hasClientId = await ipcRenderer.invoke('calendar-has-client-id');
      console.log('[Editor] hasClientId:', hasClientId);
      
      if (!hasClientId) {
        alert('Calendar integration is not configured yet.\n\nPlease contact the developer to set up Google Calendar API.');
        return;
      }
      
      connectCalendarBtn.textContent = 'Connecting...';
      connectCalendarBtn.disabled = true;
      
      console.log('[Editor] Calling calendar-connect...');
      const connected = await ipcRenderer.invoke('calendar-connect');
      console.log('[Editor] calendar-connect result:', connected);
      
      if (connected) {
        calendarConnected = true;
        updateCalendarUI();
      } else {
        alert('Failed to connect to Google Calendar.\n\nPlease try again or check your internet connection.');
        connectCalendarBtn.textContent = 'Connect Google Calendar';
      }
      
      connectCalendarBtn.disabled = false;
    }
    
    async function loadCalendarEvents() {
      // Reset to show only first week when refreshing
      calendarWeeksShowing = 1;
      
      const events = await ipcRenderer.invoke('calendar-get-events');
      console.log('[Editor] Received calendar events:', events?.length || 0, events);
      
      // Re-check connection status after fetching (in case token expired during fetch)
      const stillConnected = await ipcRenderer.invoke('calendar-is-connected');
      if (calendarConnected && !stillConnected) {
        // Connection was lost (e.g., token expired during fetch)
        console.log('[Editor] Calendar connection lost during fetch, updating UI');
        calendarConnected = false;
        updateCalendarUI();
        return;
      }
      
      renderCalendarEvents(events);
    }
    
    // Store all calendar events and loading state
    let allCalendarEvents = [];
    let calendarWeeksShowing = 1; // Start with 1 week, max 4 weeks (1 month)
    const MAX_INITIAL_EVENTS = 5; // Show max 5 events initially
    const MAX_WEEKS = 4; // Maximum 4 weeks (1 month) lookahead
    
    function renderCalendarEvents(events, loadMore = false) {
      allCalendarEvents = events || [];
      
      if (allCalendarEvents.length === 0) {
        const calendarSection = document.querySelector('.calendar-section');
        if (calendarSection) calendarSection.style.display = 'none';
        return;
      }
      
      const now = new Date();
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      // Calculate date range based on weeks showing
      const dateRangeEnd = new Date();
      dateRangeEnd.setDate(dateRangeEnd.getDate() + (calendarWeeksShowing * 7));
      
      // Get all events within the current date range
      const eventsInRange = allCalendarEvents
        .filter(event => {
          const start = new Date(event.start);
          return start >= now && start < dateRangeEnd;
        })
        .sort((a, b) => new Date(a.start) - new Date(b.start));
      
      // For initial load (not loadMore), limit to MAX_INITIAL_EVENTS
      // For subsequent loads, show all events in range
      const isInitialLoad = calendarWeeksShowing === 1 && !loadMore;
      const eventsToShow = isInitialLoad ? eventsInRange.slice(0, MAX_INITIAL_EVENTS) : eventsInRange;
      
      if (eventsToShow.length === 0) {
        const calendarSection = document.querySelector('.calendar-section');
        if (calendarSection) calendarSection.style.display = 'none';
        return;
      }
      
      // Show calendar section ONLY if not viewing a specific folder
      const calendarSection = document.querySelector('.calendar-section');
      const isSpecificFolder = currentFolderId && currentFolderId !== 'all' && currentFolderId !== 'shared';
      if (calendarSection && !isSpecificFolder) {
        calendarSection.style.display = 'block';
      }
      
      // Check if there are more events we can load
      const oneMonthOut = new Date();
      oneMonthOut.setDate(oneMonthOut.getDate() + (MAX_WEEKS * 7));
      
      // Get ALL events up to 1 month
      const allEventsInMonth = allCalendarEvents
        .filter(event => {
          const start = new Date(event.start);
          return start >= now && start < oneMonthOut;
        })
        .sort((a, b) => new Date(a.start) - new Date(b.start));
      
      // Determine button states
      const isExpanded = loadMore; // We've clicked "Show more" at least once
      const hasMoreEventsToLoad = allEventsInMonth.length > eventsToShow.length;
      const canExpandMore = calendarWeeksShowing < MAX_WEEKS && hasMoreEventsToLoad;
      
      const showMoreBtn = document.getElementById('showMoreEventsBtn');
      const showLessBtn = document.getElementById('showLessEventsBtn');
      
      // Show "Show more" if there are more events to load
      if (showMoreBtn) {
        if (hasMoreEventsToLoad && canExpandMore) {
          showMoreBtn.style.display = 'block';
        } else {
          showMoreBtn.style.display = 'none';
        }
      }
      
      // Show "Show less" if we've expanded beyond initial state
      if (showLessBtn) {
        if (isExpanded && eventsToShow.length > MAX_INITIAL_EVENTS) {
          showLessBtn.style.display = 'block';
        } else {
          showLessBtn.style.display = 'none';
        }
      }
      
      const filteredEvents = eventsToShow;
      
      // Render events directly (no day headers needed - date badges show the date)
      let html = filteredEvents.map(event => renderEventCard(event, now)).join('');
      
      calendarEvents.innerHTML = html;
      
      function renderEventCard(event, now) {
        const start = new Date(event.start);
        const end = new Date(event.end);
        const isNow = now >= start && now <= end;
        const minutesUntil = (start.getTime() - now.getTime()) / 60000;
        
        const timeStr = start.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        const endTimeStr = end.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        
        const monthStr = start.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
        const dayStr = start.getDate();
        
        let timeDisplay = `${timeStr} - ${endTimeStr}`;
        if (isNow) {
          timeDisplay = '<span class="event-time now-badge">Now</span>';
        } else if (minutesUntil > 0 && minutesUntil <= 60) {
          timeDisplay = `<span style="color: #f59e0b;">In ${Math.round(minutesUntil)} min</span>  ${timeStr}`;
        }
        
        // Encode attendees as JSON for data attribute
        const attendeesJson = event.attendees ? encodeURIComponent(JSON.stringify(event.attendees)) : '';
        
        return `
          <div class="calendar-event ${isNow ? 'now' : ''}" 
               data-link="${event.meetingLink || ''}"
               data-title="${event.title}"
               data-start="${event.start}"
               data-end="${event.end}"
               data-calendar-link="${event.htmlLink || ''}"
               data-attendees="${attendeesJson}">
            <div class="event-date ${isNow ? 'now' : ''}">
              <div class="event-month">${monthStr}</div>
              <div class="event-day">${dayStr}</div>
            </div>
            <div class="event-info">
              <div class="event-title">${event.title}</div>
              <div class="event-time">${timeDisplay}</div>
            </div>
            ${event.meetingLink ? '<button class="event-join">Join</button>' : ''}
          </div>
        `;
      }
      
      // Add click handlers
      calendarEvents.querySelectorAll('.calendar-event').forEach(el => {
        const link = el.dataset.link;
        const title = el.dataset.title;
        const startTime = el.dataset.start;
        const endTime = el.dataset.end;
        const calendarLink = el.dataset.calendarLink;
        const attendeesData = el.dataset.attendees;
        let attendees = null;
        try {
          if (attendeesData) attendees = JSON.parse(decodeURIComponent(attendeesData));
        } catch (e) {}
        
        // Click on event to open note editor for that meeting
        el.addEventListener('click', (e) => {
          if (e.target.classList.contains('event-join')) return;
          openMeetingNote({
            title: title,
            startTime: startTime,
            endTime: endTime,
            meetingLink: link,
            calendarLink: calendarLink,
            attendees: attendees
          });
        });
        
        if (link) {
          el.querySelector('.event-join')?.addEventListener('click', (e) => {
            e.stopPropagation();
            shell.openExternal(link);
          });
        }
      });
    }
    
    // Find existing saved note for a calendar event
    async function findExistingNoteForEvent(meetingInfo) {
      if (!meetingInfo) return null;
      
      try {
        const allNotes = await ipcRenderer.invoke('get-notes');
        console.log('[Editor] Looking for note for event:', meetingInfo.title, meetingInfo.id);
        console.log('[Editor] All saved notes:', allNotes?.length || 0);
        
        if (!allNotes || allNotes.length === 0) return null;
        
        // Try to match by calendar event ID if available
        if (meetingInfo.id) {
          const byId = allNotes.find(n => n.calendarEventId === meetingInfo.id);
          if (byId) {
            console.log('[Editor] Found by calendarEventId:', byId.id);
            return byId;
          }
        }
        
        // Fall back to matching by title (case-insensitive) and approximate date
        const eventDate = meetingInfo.startTime ? new Date(meetingInfo.startTime) : null;
        const eventTitle = (meetingInfo.title || '').toLowerCase().trim();
        
        // Find notes with matching title
        const matchingNote = allNotes.find(n => {
          const noteTitle = (n.title || '').toLowerCase().trim();
          
          // Check title match (exact or contains)
          const titleMatch = noteTitle === eventTitle || 
                            noteTitle.includes(eventTitle) || 
                            eventTitle.includes(noteTitle);
          
          if (!titleMatch) return false;
          
          // If we have dates, check if within same day or close
          if (eventDate && n.date) {
            const noteDate = new Date(n.date);
            const sameDay = noteDate.toDateString() === eventDate.toDateString();
            // Also check if note date is within a day of event date
            const dayDiff = Math.abs(noteDate.getTime() - eventDate.getTime()) / (1000 * 60 * 60 * 24);
            return sameDay || dayDiff < 1;
          }
          
          return titleMatch;
        });
        
        if (matchingNote) {
          console.log('[Editor] Found by title match:', matchingNote.id, matchingNote.title);
        } else {
          console.log('[Editor] No matching note found');
        }
        
        return matchingNote || null;
      } catch (err) {
        console.error('[Editor] Error finding existing note:', err);
        return null;
      }
    }
    
    // Open note editor for upcoming/current meeting
    async function openMeetingNote(meetingInfo) {
      // Clear any existing scheduled start
      if (scheduledStartTimer) {
        clearTimeout(scheduledStartTimer);
        scheduledStartTimer = null;
      }
      
      // Check if there's an existing saved note for this calendar event
      const existingNote = await findExistingNoteForEvent(meetingInfo);
      
      if (existingNote) {
        // Load existing note
        console.log('[Editor] Loading existing note:', existingNote.id);
        console.log('[Editor] Note content:', existingNote.notes?.substring(0, 100) + '...');
        console.log('[Editor] Transcript segments:', existingNote.transcript?.length || 0);
        
        currentNoteId = existingNote.id;
        meetingTitle.textContent = existingNote.title || meetingInfo.title || 'Meeting Notes';
        setEditorContent(existingNote.notes || '');
        transcript = existingNote.transcript || [];
        currentAINotes = null;
        currentMeetingInfo = meetingInfo;
        
        // Also render transcript if exists
        renderTranscript();
      } else {
        // Create new note
        currentNoteId = null;
        meetingTitle.textContent = meetingInfo.title || 'Meeting Notes';
        setEditorContent('');
        transcript = [];
        currentAINotes = null;
        currentMeetingInfo = meetingInfo;
      }
      
      isRecording = false;
      isMicActive = false;
      
      // Update meeting meta
      updateMeetingMeta({
        date: meetingInfo.startTime || Date.now(),
        startTime: meetingInfo.startTime,
        endTime: meetingInfo.endTime,
        meetingLink: meetingInfo.meetingLink,
        calendarLink: meetingInfo.calendarLink,
        attendees: meetingInfo.attendees
      });
      
      // Update footer with meeting start time
      const startTimeDate = meetingInfo.startTime ? new Date(meetingInfo.startTime) : null;
      const now = new Date();
      const isInFuture = startTimeDate && startTimeDate > now;
      
      if (isInFuture) {
        const timeStr = startTimeDate.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        if (micLabel) micLabel.textContent = `Starts ${timeStr}`;
        
        // Schedule auto-start at meeting time
        const msUntilStart = startTimeDate.getTime() - now.getTime();
        if (msUntilStart > 0 && msUntilStart < 24 * 60 * 60 * 1000) { // Within 24 hours
          console.log(`[App] Scheduling auto-start in ${Math.round(msUntilStart / 1000 / 60)} minutes`);
          scheduledStartTimer = setTimeout(() => {
            console.log('[App] Auto-starting transcription at scheduled time');
            startTranscription();
          }, msUntilStart);
        }
      } else {
        // Meeting is happening NOW or past - show Start button
        if (micLabel) micLabel.textContent = 'Start';
      }
      
      updateMicUI();
      showEditor();
      renderNotesList();
    }
    
    // Start transcription
    function startTranscription() {
      if (isRecording || isMicActive) return;
      
      console.log('[App] Starting transcription');
      isMicActive = true;
      isRecording = true;
      recordingStartTime = Date.now();
      lastTranscriptTime = Date.now();
      
      // Store raw notes state at start
      onRecordingStart();
      
      // Start mic recording
      ipcRenderer.send('start-manual-recording', {
        title: meetingTitle.textContent || 'Meeting Notes'
      });
      
      // ENTER RECORDING MODE: Move window to right side of screen
      ipcRenderer.send('enter-recording-mode');
      document.body.classList.add('recording-mode');
      
      // Collapse transcript section by default when recording starts
      if (transcriptSection && !transcriptSection.classList.contains('collapsed')) {
        transcriptSection.classList.add('collapsed');
      }
      
      // Hide sidebar in recording mode for more space
      if (sidebar && !sidebar.classList.contains('collapsed')) {
        sidebar.classList.add('collapsed');
      }
      
      // Update UI
      updateMicUI();
      if (micLabel) micLabel.textContent = 'Stop';
      if (nextMeeting) nextMeeting.style.display = 'none';
      
      // Update floating indicator
      updateFloatingIndicator();
      
      // Start silence detection
      startSilenceDetection();
    }
    
    // Stop transcription
    function stopTranscription() {
      console.log('[App] Stopping transcription');
      isMicActive = false;
      isRecording = false;
      
      // Clear timers
      if (scheduledStartTimer) {
        clearTimeout(scheduledStartTimer);
        scheduledStartTimer = null;
      }
      stopSilenceDetection();
      
      // Disconnect Deepgram
      disconnectDeepgram();
      
      // Stop recording
      ipcRenderer.send('stop-recording');
      
      // Only exit recording mode and restore window if we're in editor view
      // If we're on home view, don't move the window
      const isInEditorView = document.body.classList.contains('viewing-note');
      if (isInEditorView) {
        // EXIT RECORDING MODE: Restore window to center
        ipcRenderer.send('exit-recording-mode');
        document.body.classList.remove('recording-mode');
      }
      
      // Hide floating indicator
      updateFloatingIndicator();
      
      // Update UI
      updateMicUI();
      micLabel.textContent = 'Start';
      
      // Show "Generate notes" button if we have transcript
      if (transcript.length > 0 && !currentAINotes) {
        showGenerateNotesButton();
      }
    }
    
    // Stop transcription streaming - tell main process to stop
    function disconnectDeepgram() {
      console.log('[Editor] Stopping transcription stream');
      ipcRenderer.send('stop-deepgram-stream');
    }
    
    // Silence detection - auto-stop after 15 min of no audio
    function startSilenceDetection() {
      stopSilenceDetection();
      silenceTimer = setInterval(() => {
        if (lastTranscriptTime && Date.now() - lastTranscriptTime > SILENCE_TIMEOUT) {
          console.log('[App] Auto-stopping due to 15 min silence');
          stopTranscription();
        }
      }, 60000); // Check every minute
    }
    
    function stopSilenceDetection() {
      if (silenceTimer) {
        clearInterval(silenceTimer);
        silenceTimer = null;
      }
    }
    
    // Refresh calendar every 1 minute (free API, no cost)
    setInterval(() => {
      if (calendarConnected) {
        loadCalendarEvents();
      }
    }, 60000);
    
    // ============================================================================
    // FOLDER SEARCH (LLM-powered semantic search within folder)
    // ============================================================================
    const folderSearchInput = document.getElementById('folderSearchInput');
    const folderSearchBtn = document.getElementById('folderSearchBtn');
    const folderSearchResults = document.getElementById('folderSearchResults');
    let isSearching = false;
    
    async function performFolderSearch() {
      if (!currentFolderId || currentFolderId === 'all' || currentFolderId === 'shared') return;
      
      const query = folderSearchInput.value.trim();
      if (!query) return;
      
      if (isSearching) return;
      isSearching = true;
      folderSearchBtn.disabled = true;
      folderSearchBtn.innerHTML = '<span>Asking...</span>';
      
      folderSearchResults.innerHTML = `
        <div class="folder-search-loading">
          <span> Searching...</span>
        </div>
      `;
      
      try {
        // First, do vector search to get relevant segments
        const searchResults = await ipcRenderer.invoke('vector-search-query', query, currentFolderId, 10);
        
        if (!searchResults || !Array.isArray(searchResults) || searchResults.length === 0) {
          folderSearchResults.innerHTML = `
            <div class="folder-search-empty">
              No relevant results found in this folder. Make sure notes have been indexed.
            </div>
          `;
          return;
        }
        
        // Then ask LLM to synthesize an answer from the segments
        const contextChunks = searchResults.map(r => 
          `[From "${r.noteTitle}"]: ${r.text}`
        ).join('\n\n');
        
        const llmResult = await ipcRenderer.invoke('folder-search-llm', {
          question: query,
          context: contextChunks,
          folderId: currentFolderId
        });
        
        // Show results
        let resultsHtml = '';
        
        if (llmResult && llmResult.answer) {
          resultsHtml += `
            <div class="folder-search-answer" style="
              padding: 16px;
              background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05));
              border-radius: 10px;
              margin-bottom: 16px;
              border: 1px solid rgba(139, 92, 246, 0.2);
            ">
              <div style="font-size: 11px; color: var(--accent); font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">
                 AI Answer
              </div>
              <div style="font-size: 14px; color: var(--text); line-height: 1.6;" class="markdown-content">
                ${renderMarkdown(llmResult.answer)}
              </div>
            </div>
          `;
        }
        
        // Show source segments
        if (searchResults.length > 0) {
          resultsHtml += `<div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Sources</div>`;
          
          searchResults.forEach(result => {
            resultsHtml += `
              <div class="folder-search-result" data-note-id="${result.noteId}">
                <div class="folder-search-result-title"> ${result.noteTitle}</div>
                <div class="folder-search-result-snippet">"${result.text.substring(0, 200)}${result.text.length > 200 ? '...' : ''}"</div>
              </div>
            `;
          });
        }
        
        folderSearchResults.innerHTML = resultsHtml;
        
        // Ensure panel stays visible
        folderSearchPanel?.classList.remove('hidden');
        
        // Add click handlers to results
        folderSearchResults.querySelectorAll('.folder-search-result').forEach(el => {
          el.addEventListener('click', () => {
            const noteId = el.dataset.noteId;
            if (noteId) selectNote(noteId);
          });
        });
        
      } catch (err) {
        console.error('[FolderSearch] Error:', err);
        folderSearchResults.innerHTML = `
          <div class="folder-search-empty">
            Error searching. Please try again.
          </div>
        `;
      } finally {
        isSearching = false;
        folderSearchBtn.disabled = false;
        folderSearchBtn.innerHTML = '<span>Ask</span><span class="folder-search-shortcut"></span>';
      }
    }
    
    folderSearchBtn?.addEventListener('click', performFolderSearch);
    folderSearchInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') performFolderSearch();
      if (e.key === 'Escape') closeFolderSearchPanel();
    });
    
    // Folder search floating panel controls
    const folderSearchOverlay = document.getElementById('folderSearchOverlay');
    const folderSearchClose = document.getElementById('folderSearchClose');
    const folderAskBtn = document.getElementById('folderAskBtn');
    const folderAskTrigger = document.getElementById('folderAskTrigger');
    
    function openFolderSearchPanel() {
      folderSearchPanel?.classList.remove('hidden');
      folderSearchOverlay?.classList.remove('hidden');
      folderSearchInput?.focus();
    }
    
    function closeFolderSearchPanel() {
      folderSearchPanel?.classList.add('hidden');
      folderSearchOverlay?.classList.add('hidden');
      // Clear search input and results
      if (folderSearchInput) folderSearchInput.value = '';
      if (folderSearchResults) folderSearchResults.innerHTML = '';
    }
    
    folderAskBtn?.addEventListener('click', openFolderSearchPanel);
    folderSearchClose?.addEventListener('click', closeFolderSearchPanel);
    folderSearchOverlay?.addEventListener('click', closeFolderSearchPanel);
    
    // Keyboard shortcut Cmd+K to open folder search when in folder view
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k' && currentFolderId && currentFolderId !== 'all') {
        e.preventDefault();
        openFolderSearchPanel();
      }
    });
    
    // ============================================================================
    // GLOBAL SEARCH
    // ============================================================================
    
    let searchDebounceTimer = null;
    let isSearchActive = false;
    
    // Debounced search function
    function performGlobalSearch(query) {
      if (!query.trim()) {
        clearSearch();
        return;
      }
      
      isSearchActive = true;
      ipcRenderer.invoke('global-search', query).then(results => {
        renderSearchResults(results, query);
      });
    }
    
    // Clear search and return to normal view
    function clearSearch() {
      isSearchActive = false;
      if (globalSearchInput) globalSearchInput.value = '';
      
      // Show calendar section again (it will be hidden if no events)
      const calendarSection = document.getElementById('calendarSection');
      if (calendarSection && allCalendarEvents && allCalendarEvents.length > 0) {
        calendarSection.style.display = 'block';
      }
      
      // Hide back button when clearing search
      if (backBtn) backBtn.classList.add('hidden');
      
      renderNotesList();
    }
    
    // Render search results in the right panel
    function renderSearchResults(results, query) {
      if (!notesList) return;
      
      // Hide calendar section during search
      const calendarSection = document.getElementById('calendarSection');
      if (calendarSection) calendarSection.style.display = 'none';
      
      const { notes, people, companies, folders } = results;
      const hasResults = notes.length > 0 || people.length > 0 || companies.length > 0 || folders.length > 0;
      
      // Show back button when search results are displayed
      if (backBtn) backBtn.classList.remove('hidden');
      
      if (!hasResults) {
        notesList.innerHTML = `
          <div class="search-results-view">
            <div class="search-results-header">
              <button class="search-back-btn" id="searchBackBtn"></button>
              <span class="search-results-title">Results for "${query}"</span>
              <button class="search-results-clear" id="clearSearchBtn">Clear</button>
            </div>
            <div class="search-empty">
              <div class="search-empty-icon"></div>
              <div>No results found for "${query}"</div>
            </div>
          </div>
        `;
        document.getElementById('clearSearchBtn')?.addEventListener('click', clearSearch);
        document.getElementById('searchBackBtn')?.addEventListener('click', clearSearch);
        return;
      }
      
      let html = `
        <div class="search-results-view">
          <div class="search-results-header">
            <button class="search-back-btn" id="searchBackBtn"></button>
            <span class="search-results-title">Results for "${query}"</span>
            <button class="search-results-clear" id="clearSearchBtn">Clear</button>
          </div>
      `;
      
      // Group notes by date
      if (notes.length > 0) {
        html += `<div class="search-section">
          <div class="search-section-header"> Notes (${notes.length})</div>`;
        
        // Group by date
        const notesByDate = {};
        notes.forEach(note => {
          const date = new Date(note.date);
          const dateKey = date.toDateString();
          if (!notesByDate[dateKey]) notesByDate[dateKey] = [];
          notesByDate[dateKey].push(note);
        });
        
        Object.entries(notesByDate).forEach(([dateKey, dateNotes]) => {
          const date = new Date(dateKey);
          const dateLabel = formatDateHeader(date);
          html += `<div class="search-date-group">
            <div class="search-date-header">${dateLabel}</div>`;
          
          dateNotes.forEach(note => {
            const time = note.startTime 
              ? new Date(note.startTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
              : '';
            const attendees = note.people?.length > 0 
              ? (note.people.slice(0, 2).join(', ') + (note.people.length > 2 ? ` & ${note.people.length - 2} others` : ''))
              : '';
            const snippet = getSearchSnippet(note, query);
            
            html += `
              <div class="search-result-item" data-note-id="${note.id}">
                <div class="search-result-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                  </svg>
                </div>
                <div class="search-result-content">
                  <div class="search-result-title">${note.title || 'Untitled'}</div>
                  ${attendees ? `<div class="search-result-meta">${attendees}</div>` : ''}
                  ${snippet ? `<div class="search-result-snippet">${snippet}</div>` : ''}
                </div>
                ${time ? `<div class="search-result-time">${time}</div>` : ''}
              </div>
            `;
          });
          
          html += `</div>`;
        });
        
        html += `</div>`;
      }
      
      // People results
      if (people.length > 0) {
        html += `<div class="search-section">
          <div class="search-section-header"> People (${people.length})</div>`;
        
        people.forEach(person => {
          html += `
            <div class="search-result-item" data-person="${person.name}">
              <div class="search-result-icon" style="background: var(--accent); color: white; font-weight: 600; font-size: 14px;">
                ${person.name.charAt(0).toUpperCase()}
              </div>
              <div class="search-result-content">
                <div class="search-result-title">${highlightMatch(person.name, query)}</div>
                <div class="search-result-meta">${person.noteCount} note${person.noteCount !== 1 ? 's' : ''}</div>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
      }
      
      // Companies results
      if (companies.length > 0) {
        html += `<div class="search-section">
          <div class="search-section-header"> Companies (${companies.length})</div>`;
        
        companies.forEach(company => {
          html += `
            <div class="search-result-item" data-company="${company.name}">
              <div class="search-result-icon" style="background: #10b981; color: white; font-weight: 600; font-size: 14px;">
                ${company.name.charAt(0).toUpperCase()}
              </div>
              <div class="search-result-content">
                <div class="search-result-title">${highlightMatch(company.name, query)}</div>
                <div class="search-result-meta">${company.noteCount} note${company.noteCount !== 1 ? 's' : ''}</div>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
      }
      
      // Folders results
      if (folders.length > 0) {
        html += `<div class="search-section">
          <div class="search-section-header"> Folders (${folders.length})</div>`;
        
        folders.forEach(folder => {
          html += `
            <div class="search-result-item" data-folder-id="${folder.id}">
              <div class="search-result-icon">
                ${folder.icon || ''}
              </div>
              <div class="search-result-content">
                <div class="search-result-title">${highlightMatch(folder.name, query)}</div>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
      }
      
      html += `</div>`;
      notesList.innerHTML = html;
      
      // Add click handlers
      document.getElementById('clearSearchBtn')?.addEventListener('click', clearSearch);
      document.getElementById('searchBackBtn')?.addEventListener('click', clearSearch);
      
      notesList.querySelectorAll('.search-result-item[data-note-id]').forEach(item => {
        item.addEventListener('click', () => {
          const noteId = item.dataset.noteId;
          if (noteId) {
            clearSearch();
            selectNote(noteId);
          }
        });
      });
      
      notesList.querySelectorAll('.search-result-item[data-person]').forEach(item => {
        item.addEventListener('click', () => {
          clearSearch();
          selectPerson(item.dataset.person);
        });
      });
      
      notesList.querySelectorAll('.search-result-item[data-company]').forEach(item => {
        item.addEventListener('click', () => {
          clearSearch();
          selectCompany(item.dataset.company);
        });
      });
      
      notesList.querySelectorAll('.search-result-item[data-folder-id]').forEach(item => {
        item.addEventListener('click', () => {
          clearSearch();
          selectFolder(item.dataset.folderId);
        });
      });
    }
    
    // Format date header like "Fri, Oct 17"
    function formatDateHeader(date) {
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
    }
    
    // Get a snippet of text containing the search term
    function getSearchSnippet(note, query) {
      const sources = [
        note.notes || '',
        note.enhancedNotes || '',
        JSON.stringify(note.transcript || [])
      ];
      
      const q = query.toLowerCase();
      
      for (const source of sources) {
        const idx = source.toLowerCase().indexOf(q);
        if (idx !== -1) {
          const start = Math.max(0, idx - 30);
          const end = Math.min(source.length, idx + query.length + 50);
          let snippet = source.substring(start, end);
          
          // Clean up the snippet
          snippet = snippet.replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim();
          
          // Add ellipsis
          if (start > 0) snippet = '...' + snippet;
          if (end < source.length) snippet = snippet + '...';
          
          // Highlight the match
          return highlightMatch(snippet, query);
        }
      }
      
      return '';
    }
    
    // Highlight matching text
    function highlightMatch(text, query) {
      if (!query) return text;
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }
    
    // Search input handler with debounce
    globalSearchInput?.addEventListener('input', (e) => {
      const query = e.target.value;
      
      if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
      
      searchDebounceTimer = setTimeout(() => {
        performGlobalSearch(query);
      }, 300);
    });
    
    // Keyboard shortcut (Cmd+K) to focus search
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        globalSearchInput?.focus();
      }
      
      // Escape to clear search
      if (e.key === 'Escape' && isSearchActive) {
        clearSearch();
        globalSearchInput?.blur();
      }
    });
    
    // Clear search when clicking back button or navigating
    backBtn?.addEventListener('click', () => {
      if (isSearchActive) clearSearch();
    });
    
    // ============================================================================
    
    // Initial load - show empty state with All Notes selected
    loadFolders();
    loadNotes();
    loadPeopleAndCompanies();
    checkCalendarConnection();
    showEmptyState();
    selectFolder('all'); // Ensure "All Notes" is selected on startup
    
    // Initialize vector search (only reindexes if needed - corrupt or missing items)
    ipcRenderer.invoke('vector-search-init').then(ready => {
      console.log('[Editor] Vector search ready:', ready);
    });
    
    // Connect Calendar button - must be added after function is defined
    // Show more button - progressively loads more events (extends date range by 1 week each click)
    const showMoreEventsBtn = document.getElementById('showMoreEventsBtn');
    if (showMoreEventsBtn) {
      showMoreEventsBtn.addEventListener('click', () => {
        // Extend date range by 1 week, up to MAX_WEEKS
        if (calendarWeeksShowing < MAX_WEEKS) {
          calendarWeeksShowing++;
        }
        renderCalendarEvents(allCalendarEvents, true); // true = loadMore mode
      });
    }
    
    // Show less button - revert to initial state (5 events)
    const showLessEventsBtn = document.getElementById('showLessEventsBtn');
    if (showLessEventsBtn) {
      showLessEventsBtn.addEventListener('click', () => {
        calendarWeeksShowing = 1; // Reset to 1 week
        renderCalendarEvents(allCalendarEvents, false); // false = initial mode
      });
    }
    
    connectCalendarBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      console.log('[Editor] ====== CONNECT CALENDAR BUTTON CLICKED ======');
      if (connectCalendarBtn.disabled) {
        console.log('[Editor] Button is disabled, ignoring click');
        return;
      }
      try {
        await connectCalendar();
      } catch (err) {
        console.error('[Editor] Error:', err);
        alert('Error: ' + err.message);
      }
    });
    
    console.log('[Editor]  Script fully loaded - calendar button listener attached');
    console.log('[Editor] Button element:', connectCalendarBtn);
    console.log('[Editor] Button display:', connectCalendarBtn.style.display);
    console.log('[Editor] Button disabled:', connectCalendarBtn.disabled);
    
    // ============================================================================
    // AI Q&A PANEL - Ask anything about meeting
    // ============================================================================
    let currentAIAnswer = '';
    
    // Open AI Q&A panel when clicking Ask input
    askInputWrapper?.addEventListener('click', () => {
      openAIQAPanel();
    });
    
    askInput?.addEventListener('focus', () => {
      openAIQAPanel();
    });
    
    function openAIQAPanel() {
      if (!aiQAPanel) return;
      aiQAPanel.classList.remove('hidden');
      aiQAAnswer.classList.add('hidden');
      aiQALoading.classList.add('hidden');
      aiQATextarea.value = '';
      aiQATextarea.focus();
    }
    
    function closeAIQAPanel() {
      if (!aiQAPanel) return;
      aiQAPanel.classList.add('hidden');
    }
    
    // Close button
    aiQAClose?.addEventListener('click', closeAIQAPanel);
    
    // Close on Escape
    aiQATextarea?.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeAIQAPanel();
      }
      // Submit on Cmd+Enter
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        submitAIQuestion();
      }
    });
    
    // Auto-resize textarea
    aiQATextarea?.addEventListener('input', () => {
      aiQATextarea.style.height = 'auto';
      aiQATextarea.style.height = Math.min(aiQATextarea.scrollHeight, 120) + 'px';
    });
    
    // Submit button
    aiQASubmit?.addEventListener('click', submitAIQuestion);
    
    async function submitAIQuestion() {
      const question = aiQATextarea?.value.trim();
      if (!question) return;
      
      if (!hasOpenAIKey) {
        alert('Please configure your OpenAI API key in Settings first.');
        return;
      }
      
      // Show loading
      aiQAAnswer.classList.add('hidden');
      aiQALoading.classList.remove('hidden');
      aiQASubmit.disabled = true;
      
      try {
        // Build context from transcript and notes
        // Don't include speaker labels - just the text
        const transcriptText = transcript.map(item => {
          if (typeof item === 'string') return item;
          return item.text;
        }).join('\n');
        
        const notesContent = getEditorContent();
        const meetingTitleText = meetingTitle?.textContent || 'Meeting';
        
        const result = await ipcRenderer.invoke('openai-ask-question', {
          question,
          transcript: transcriptText,
          notes: notesContent,
          meetingTitle: meetingTitleText
        });
        
        if (result && result.answer) {
          currentAIAnswer = result.answer;
          aiQAAnswerContent.innerHTML = renderMarkdown(result.answer);
          aiQAAnswer.classList.remove('hidden');
        } else {
          aiQAAnswerContent.innerHTML = '<p>Sorry, I couldn\'t generate an answer. Please try again.</p>';
          aiQAAnswer.classList.remove('hidden');
        }
      } catch (err) {
        console.error('[AI Q&A] Error:', err);
        aiQAAnswerContent.innerHTML = '<p>Error: ' + (err.message || 'Failed to get answer') + '</p>';
        aiQAAnswer.classList.remove('hidden');
      } finally {
        aiQALoading.classList.add('hidden');
        aiQASubmit.disabled = false;
      }
    }
    
    // Copy answer
    aiQACopy?.addEventListener('click', () => {
      if (currentAIAnswer) {
        navigator.clipboard.writeText(currentAIAnswer);
        aiQACopy.textContent = ' Copied!';
        setTimeout(() => {
          aiQACopy.textContent = ' Copy';
        }, 2000);
      }
    });
    
    
    // Click outside to close
    document.addEventListener('click', (e) => {
      if (aiQAPanel && !aiQAPanel.classList.contains('hidden')) {
        const target = e.target;
        if (!aiQAPanel.contains(target) && !askInputWrapper?.contains(target)) {
          closeAIQAPanel();
        }
      }
    });
  </script>
</body>
</html>
